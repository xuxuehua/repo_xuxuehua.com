<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>gitlab - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Git">Git</a>&nbsp;&#187;&nbsp;gitlab
    <span class="updated">Page Updated&nbsp;
      2020-03-04 23:07
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">gitlab</div>

  <p>[toc]</p>
<h1 id="gitlab">gitlab</h1>
<h2 id="installation">installation</h2>
<h3 id="ubuntu">Ubuntu</h3>
<ul>
<li>12.8.1</li>
</ul>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">ca</span><span class="o">-</span><span class="n">certificates</span> <span class="n">curl</span> <span class="n">openssh</span><span class="o">-</span><span class="n">server</span> <span class="n">postfix</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">sS</span> <span class="n">https</span><span class="o">:</span><span class="c1">//packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash</span>

<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ce</span> <span class="o">-</span><span class="n">y</span>

<span class="n">gitlab</span><span class="o">-</span><span class="n">ctl</span> <span class="n">reconfigure</span>
</pre></div>


<ul>
<li>
<p>enable ssl by Letsencrypt </p>
<p>Your domain’s Certification Authority Authorization (CAA) record must allow Let’s Encrypt to issue a certificate for your domain.</p>
</li>
</ul>
<div class="hlcode"><pre><span class="n">apt</span> <span class="n">install</span> <span class="n">letsencrypt</span> <span class="o">-</span><span class="n">y</span>

<span class="n">sudo</span> <span class="n">letsencrypt</span> <span class="n">certonly</span> <span class="o">--</span><span class="n">standalone</span> <span class="o">--</span><span class="n">agree</span><span class="o">-</span><span class="n">tos</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">eff</span><span class="o">-</span><span class="n">email</span> <span class="o">--</span><span class="n">agree</span><span class="o">-</span><span class="n">tos</span> <span class="o">--</span><span class="n">email</span> <span class="n">rickxu1989</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">d</span> <span class="n">git</span><span class="p">.</span><span class="n">xurick</span><span class="p">.</span><span class="n">com</span>

<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">openssl</span> <span class="n">dhparam</span> <span class="o">-</span><span class="n">out</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">dhparams</span><span class="p">.</span><span class="n">pem</span> <span class="mi">2048</span>

<span class="cp"># After long time</span>
<span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">ssl</span><span class="cm">/*</span>

<span class="cm">vim /etc/gitlab/gitlab.rb</span>
<span class="cm">external_url &#39;https://git.xurick.com&#39;</span>
<span class="cm">registry_external_url &#39;https://registry.xurick.com&#39;</span>
<span class="cm">nginx[&#39;redirect_http_to_https&#39;] = true</span>
<span class="cm">nginx[&#39;redirect_http_to_https_port&#39;] = 80</span>
<span class="cm">mattermost_external_url &#39;http://mattermost.xurick.com&#39;</span>
<span class="cm">letsencrypt[&#39;enable&#39;] = true</span>
<span class="cm">letsencrypt[&#39;contact_emails&#39;] = [&#39;rickxu1989@gmail.com&#39;] # This should be an array of email addresses to add as contacts</span>
<span class="cm">letsencrypt[&#39;auto_renew&#39;] = true</span>
<span class="cm">letsencrypt[&#39;auto_renew_hour&#39;] = 12</span>
<span class="cm">letsencrypt[&#39;auto_renew_minute&#39;] = &quot;30&quot;</span>
<span class="cm">letsencrypt[&#39;auto_renew_day_of_month&#39;] = &quot;*/</span><span class="mi">7</span><span class="s">&quot;</span>

<span class="n">gitlab</span><span class="o">-</span><span class="n">ctl</span> <span class="n">reconfigure</span>
</pre></div>


<h3 id="docker">docker</h3>
<div class="hlcode"><pre>sudo docker run --detach <span class="se">\</span>
  --hostname gitlab.xurick.com <span class="se">\</span>
  --publish 127.0.0.1:4443:443 --publish 127.0.0.1:4000:80 <span class="se">\</span>
  --name gitlab <span class="se">\</span>
  --restart always <span class="se">\</span>
  --volume /srv/gitlab/config:/etc/gitlab <span class="se">\</span>
  --volume /srv/gitlab/logs:/var/log/gitlab <span class="se">\</span>
  --volume /srv/gitlab/data:/var/opt/gitlab <span class="se">\</span>
  gitlab/gitlab-ce:latest
</pre></div>


<ul>
<li>/srv/gitlab/config will hold GitLab's configuration</li>
<li>/srv/gitlab/logs will hold the GitLab's logs</li>
<li>/srv/gitlab/data will hold the actual git repo's data.</li>
</ul>
<div class="hlcode"><pre><span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">nginx</span> <span class="o">-</span><span class="n">y</span> 
</pre></div>


<p>vim /etc/nginx/sites-enabled/default</p>
<div class="hlcode"><pre><span class="n">map</span> <span class="err">$</span><span class="n">http_upgrade</span> <span class="err">$</span><span class="n">connection_upgrade</span> <span class="p">{</span>
        <span class="k">default</span> <span class="n">upgrade</span><span class="p">;</span>
        <span class="err">&#39;&#39;</span> <span class="n">close</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">80</span> <span class="n">default_server</span><span class="p">;</span>
        <span class="n">listen</span> <span class="p">[</span><span class="o">::</span><span class="p">]</span><span class="o">:</span><span class="mi">80</span> <span class="n">default_server</span><span class="p">;</span>


        <span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>

        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="n">index</span><span class="p">.</span><span class="n">htm</span> <span class="n">index</span><span class="p">.</span><span class="n">nginx</span><span class="o">-</span><span class="n">debian</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>

        <span class="n">server_name</span> <span class="n">_</span><span class="p">;</span>

        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
                                <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//localhost:4000;</span>

                <span class="n">proxy_read_timeout</span> <span class="mi">3600</span><span class="n">s</span><span class="p">;</span>
                <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> <span class="err">$</span><span class="n">http_upgrade</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="err">$</span><span class="n">connection_upgrade</span><span class="p">;</span>
        <span class="p">}</span>


<span class="p">}</span>
</pre></div>


<p>Go to web UI to complete Gitlab initilization</p>
<h3 id="gitlab-runner">Gitlab-runner</h3>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">name</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span> <span class="o">--</span><span class="n">restart</span> <span class="n">always</span> \
  <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="o">/</span><span class="n">config</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span> \
  <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span> \
  <span class="n">gitlab</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="o">:</span><span class="n">latest</span>
</pre></div>


<blockquote>
<p>mount the host’s <code>/srv/gitlab-runner/config</code> folder to the <code>/etc/gitlab-runner</code> location of the container</p>
</blockquote>
<p>Go to http://your_domain.com/admin/runners</p>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">ti</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span> <span class="n">bash</span>
</pre></div>


<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">55</span><span class="n">d9aff26c4d</span><span class="o">:/</span><span class="err">#</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span> <span class="k">register</span>
<span class="n">Runtime</span> <span class="n">platform</span>                                    <span class="n">arch</span><span class="o">=</span><span class="n">amd64</span> <span class="n">os</span><span class="o">=</span><span class="n">linux</span> <span class="n">pid</span><span class="o">=</span><span class="mi">65</span> <span class="n">revision</span><span class="o">=</span><span class="mf">6f</span><span class="n">bc7474</span> <span class="n">version</span><span class="o">=</span><span class="mf">13.1.1</span>
<span class="n">Running</span> <span class="n">in</span> <span class="n">system</span><span class="o">-</span><span class="n">mode</span><span class="p">.</span>                            

<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span> <span class="n">coordinator</span> <span class="n">URL</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">https</span><span class="o">:</span><span class="c1">//gitlab.com/):</span>
<span class="nl">http:</span><span class="c1">//public_ip</span>
<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span> <span class="n">token</span> <span class="k">for</span> <span class="n">this</span> <span class="n">runner</span><span class="o">:</span>
<span class="n">ukcmybsDQxxzsom3RB6CN</span>
<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span> <span class="n">description</span> <span class="k">for</span> <span class="n">this</span> <span class="n">runner</span><span class="o">:</span>
<span class="p">[</span><span class="mi">55</span><span class="n">d9aff26c4d</span><span class="p">]</span><span class="o">:</span> <span class="n">sample</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">runner</span>
<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span> <span class="n">tags</span> <span class="k">for</span> <span class="n">this</span> <span class="n">runner</span> <span class="p">(</span><span class="n">comma</span> <span class="n">separated</span><span class="p">)</span><span class="o">:</span>

<span class="n">Registering</span> <span class="n">runner</span><span class="p">...</span> <span class="n">succeeded</span>                     <span class="n">runner</span><span class="o">=</span><span class="n">ukcmybsD</span>
<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">executor</span><span class="o">:</span> <span class="n">kubernetes</span><span class="p">,</span> <span class="n">custom</span><span class="p">,</span> <span class="n">docker</span><span class="p">,</span> <span class="n">docker</span><span class="o">-</span><span class="n">ssh</span><span class="p">,</span> <span class="n">parallels</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">docker</span><span class="o">+</span><span class="n">machine</span><span class="p">,</span> <span class="n">virtualbox</span><span class="p">,</span> <span class="n">docker</span><span class="o">-</span><span class="n">ssh</span><span class="o">+</span><span class="n">machine</span><span class="o">:</span>
<span class="n">docker</span>
<span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="k">default</span> <span class="n">Docker</span> <span class="n">image</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">ruby</span><span class="o">:</span><span class="mf">2.6</span><span class="p">)</span><span class="o">:</span>
<span class="nl">alpine:</span><span class="n">latest</span>
<span class="n">Runner</span> <span class="n">registered</span> <span class="n">successfully</span><span class="p">.</span> <span class="n">Feel</span> <span class="n">free</span> <span class="n">to</span> <span class="n">start</span> <span class="n">it</span><span class="p">,</span> <span class="n">but</span> <span class="k">if</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">running</span> <span class="n">already</span> <span class="n">the</span> <span class="n">config</span> <span class="n">should</span> <span class="n">be</span> <span class="n">automatically</span> <span class="n">reloaded</span><span class="o">!</span> 
</pre></div>


<p>docker network</p>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">network</span> <span class="n">create</span> <span class="n">gitlabnet</span>
<span class="n">docker</span> <span class="n">network</span> <span class="n">connect</span> <span class="n">gitlabnet</span> <span class="n">gitlab</span>
<span class="n">docker</span> <span class="n">network</span> <span class="n">connect</span> <span class="n">gitlabnet</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span>
</pre></div>


<p>Avoiding Docker-In-Docker and resolve public domain</p>
<p>This will give your Dockerfile full control, there is another option. You can configure your runner to use the host's docker when executing the Dockerfile commands. You can do that by configuring the <code>gitlab-runner</code> configuration to use the host docker. In our example, the configuration is located at <code>/srv/gitlab-runner/config/config.toml</code>. edit the file</p>
<div class="hlcode"><pre><span class="n">concurrent</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">check_interval</span> <span class="o">=</span> <span class="mi">0</span>

<span class="p">[</span><span class="n">session_server</span><span class="p">]</span>
  <span class="n">session_timeout</span> <span class="o">=</span> <span class="mi">1800</span>

<span class="p">[[</span><span class="n">runners</span><span class="p">]]</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sample-docker-runner&quot;</span>
  <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://45.77.13.173&quot;</span>
  <span class="n">token</span> <span class="o">=</span> <span class="s">&quot;Liqf4STtEBdsasUZjqWD&quot;</span>
  <span class="n">executor</span> <span class="o">=</span> <span class="s">&quot;docker&quot;</span>
  <span class="n">clone_url</span> <span class="o">=</span> <span class="s">&quot;http://45.77.13.173&quot;</span>
  <span class="p">[</span><span class="n">runners</span><span class="p">.</span><span class="n">custom_build_dir</span><span class="p">]</span>
  <span class="p">[</span><span class="n">runners</span><span class="p">.</span><span class="n">cache</span><span class="p">]</span>
    <span class="p">[</span><span class="n">runners</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">s3</span><span class="p">]</span>
    <span class="p">[</span><span class="n">runners</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">gcs</span><span class="p">]</span>
  <span class="p">[</span><span class="n">runners</span><span class="p">.</span><span class="n">docker</span><span class="p">]</span>
    <span class="n">tls_verify</span> <span class="o">=</span> <span class="nb">false</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s">&quot;alpine:latest&quot;</span>
    <span class="n">privileged</span> <span class="o">=</span> <span class="nb">false</span>
    <span class="n">disable_entrypoint_overwrite</span> <span class="o">=</span> <span class="nb">false</span>
    <span class="n">oom_kill_disable</span> <span class="o">=</span> <span class="nb">false</span>
    <span class="n">disable_cache</span> <span class="o">=</span> <span class="nb">false</span>
    <span class="n">volumes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><span class="p">,</span> <span class="s">&quot;/cache&quot;</span><span class="p">]</span>
    <span class="n">shm_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">extra_hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;localhost:45.77.13.173&quot;</span><span class="p">]</span>
</pre></div>


<h4 id="gitlab-ciyml">gitlab-ci.yml</h4>
<div class="hlcode"><pre><span class="n">image</span><span class="o">:</span> <span class="n">docker</span><span class="o">:</span><span class="n">latest</span>

<span class="n">build_job</span><span class="o">:</span>
  <span class="n">stage</span><span class="o">:</span> <span class="n">build</span>
  <span class="n">script</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">ls</span>
    <span class="o">-</span> <span class="n">echo</span> <span class="s2">&quot;starting job...&quot;</span>
    <span class="o">-</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="s2">&quot;${CI_PROJECT_NAME}:${CI_COMMIT_REF_NAME}-0.1.${CI_JOB_ID}&quot;</span> <span class="o">.</span>
    <span class="o">-</span> <span class="n">echo</span> <span class="n">job</span> <span class="n">finished</span>
  <span class="n">only</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">develop</span>
    <span class="o">-</span> <span class="n">master</span>
</pre></div>


<h3 id="note">note</h3>
<p>to do after completing the steps in this post.</p>
<ul>
<li>Configure SSH checkouts. With this configuration, you should be able to use HTTPS for pulls and pushes. If you want to enable SSL, you will need to expose port 22 from the GitLab container and perform some more advanced configuration to avoid mixing GitLab’s SSL with your host machine’s SSL (which would run in the same port by default).</li>
<li>Use external Docker Container Registries. You can use a free service like <a href="https://git.oramind.net/unicorn/unicorn-api/pipelines">canister.io</a> to host your docker images.</li>
<li>Use an image/container management tool like https://www.portainer.io/ to manage your containers/images on your host machine. That includes your GitLab installation and GitLab runners.</li>
</ul>
<h4 id="https-failed">https (failed)</h4>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
<span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">universe</span>
<span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="o">:</span><span class="n">certbot</span><span class="o">/</span><span class="n">certbotsudo</span> 
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">certbot</span> <span class="o">-</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">certbot</span><span class="o">-</span><span class="n">nginx</span> <span class="o">-</span><span class="n">y</span> 
</pre></div>


<p>Setup certification</p>
<div class="hlcode"><pre><span class="n">certbot</span> <span class="o">--</span><span class="n">nginx</span>
</pre></div>


<p>set up your server inside the Nginx configuration. Certbot has already created a configuration for you inside <code>/etc/nginx/sites-enabled</code>. Alter the configuration for the host and the port that it points to like this</p>
<div class="hlcode"><pre><span class="cp"># make sure this map append into the config</span>
<span class="n">map</span> <span class="err">$</span><span class="n">http_upgrade</span> <span class="err">$</span><span class="n">connection_upgrade</span> <span class="p">{</span>
        <span class="k">default</span> <span class="n">upgrade</span><span class="p">;</span>
        <span class="err">&#39;&#39;</span> <span class="n">close</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">server</span> <span class="p">{</span>
    <span class="n">server_name</span> <span class="n">git</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
    <span class="n">client_max_body_size</span> <span class="mi">256</span><span class="n">M</span><span class="p">;</span>

    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//localhost:4000;</span>

        <span class="n">proxy_read_timeout</span> <span class="mi">3600</span><span class="n">s</span><span class="p">;</span>
        <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
        <span class="err">#</span> <span class="n">Websocket</span> <span class="n">connection</span>
        <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> <span class="err">$</span><span class="n">http_upgrade</span><span class="p">;</span>
        <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="err">$</span><span class="n">connection_upgrade</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">listen</span> <span class="p">[</span><span class="o">::</span><span class="p">]</span><span class="o">:</span><span class="mi">443</span><span class="p">;</span>

    <span class="n">listen</span> <span class="mi">443</span> <span class="n">ssl</span><span class="p">;</span> <span class="err">#</span> <span class="n">managed</span> <span class="n">by</span> <span class="n">Certbot</span>
    <span class="n">ssl_certificate</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">git</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">fullchain</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span> <span class="err">#</span> <span class="n">managed</span> <span class="n">by</span> <span class="n">Certbot</span>
    <span class="n">ssl_certificate_key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">git</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">privkey</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span> <span class="err">#</span> <span class="n">managed</span> <span class="n">by</span> <span class="n">Certbot</span>
    <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">options</span><span class="o">-</span><span class="n">ssl</span><span class="o">-</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span><span class="p">;</span> <span class="err">#</span> <span class="n">managed</span> <span class="n">by</span> <span class="n">Certbot</span>
    <span class="n">ssl_dhparam</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">dhparams</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span> <span class="err">#</span> <span class="n">managed</span> <span class="n">by</span> <span class="n">Certbot</span>

<span class="p">}</span>
</pre></div>


<h1 id="backup">backup</h1>
<h2 id="create-backup">create backup</h2>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">gitlab</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="n">gitlab</span><span class="o">:</span><span class="n">backup</span><span class="o">:</span><span class="n">create</span>
</pre></div>


<p>or</p>
<div class="hlcode"><pre><span class="n">tar</span> <span class="n">zcvf</span> <span class="n">gitlab</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="n">gitlab</span>
</pre></div>


<h2 id="restore-backup">restore backup</h2>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">gitlab</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="n">gitlab</span><span class="o">:</span><span class="n">backup</span><span class="o">:</span><span class="n">restore</span> <span class="o">--</span><span class="n">trace</span>
</pre></div>


<h2 id="verify-backup">verify backup</h2>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">gitlab</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="n">gitlab</span><span class="o">:</span><span class="n">check</span> <span class="n">SANITIZE</span><span class="o">=</span><span class="nb">true</span>
</pre></div>


<h1 id="gitlabyml">gitlab.yml</h1>
<div class="hlcode"><pre><span class="n">variables</span><span class="o">:</span>
  <span class="n">S3_BUCKET</span><span class="o">:</span> <span class="s2">&quot;s3://xx&quot;</span>


<span class="n">before_script</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">echo</span> <span class="s2">&quot;Job-${CI_JOB_ID} ${CI_JOB_NAME} of ${CI_JOB_STAGE} is starting&quot;</span>

<span class="n">after_script</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">echo</span> <span class="s2">&quot;Job-${CI_JOB_ID} ${CI_JOB_NAME} of ${CI_JOB_STAGE} is finished&quot;</span>

<span class="n">stages</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">deploy_stg_v1</span>

<span class="n">stg_v1_5</span><span class="o">.</span><span class="mf">21.0</span><span class="o">:</span>
  <span class="n">stage</span><span class="o">:</span> <span class="n">deploy_stg_v1</span>
  <span class="n">when</span><span class="o">:</span> <span class="n">manual</span>
  <span class="n">only</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">branches</span><span class="err">@</span><span class="n">repo</span>
  <span class="n">variables</span><span class="o">:</span>
    <span class="n">BDP_VERSION</span><span class="o">:</span> <span class="s2">&quot;1.0&quot;</span>
    <span class="n">IMAGE_VERSION</span><span class="o">:</span> <span class="s2">&quot;5.21.0&quot;</span>
  <span class="n">script</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">echo</span> <span class="s2">&quot;Deploying ${CI_COMMIT_REF_NAME}/${CI_COMMIT_SHA} to ${S3_STG_CODE_PATH}&quot;</span>
    <span class="o">-</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="n">$</span><span class="o">{</span><span class="n">CI_PROJECT_DIR</span><span class="o">}/</span><span class="n">configs</span><span class="sr">/${BD_VERSION}/${IMAGE_VERSION}/build/</span>
</pre></div>


<h1 id="example">example</h1>
<h2 id="gitlab-cicd">gitlab ci/cd</h2>
<p>https://gitlab.com/kargo-ci/kubernetes-sigs-kubespray</p>
<p><img alt="image-20201115100046158" src="gitlab.assets/image-20201115100046158.png" /></p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>