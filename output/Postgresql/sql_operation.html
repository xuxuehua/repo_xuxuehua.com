<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>sql_operation - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Postgresql">Postgresql</a>&nbsp;&#187;&nbsp;sql_operation
    <span class="updated">Page Updated&nbsp;
      2020-09-16 14:45
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">sql_operation</div>

  <p>[toc]</p>
<h1 id="insert">insert</h1>
<h2 id="into">into</h2>
<div class="hlcode"><pre><span class="n">CREATE</span> <span class="n">SEQUENCE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">app4_id_seq</span> <span class="n">START</span> <span class="mi">20600000000001</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="nf">app4</span> <span class="p">(</span><span class="n">id</span> <span class="n">bigint</span> <span class="k">default</span> <span class="n">nextval</span><span class="p">(</span><span class="err">&#39;</span><span class="n">app4_id_seq</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">original_code</span> <span class="n">text</span><span class="p">);</span>
<span class="n">CREATE</span> <span class="n">UNIQUE</span> <span class="n">INDEX</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">app4_id</span> <span class="n">ON</span> <span class="nf">app4</span><span class="p">(</span><span class="n">original_code</span><span class="p">);</span>
</pre></div>


<div class="hlcode"><pre><span class="n">insert</span> <span class="n">into</span> <span class="n">app4</span> <span class="p">(</span><span class="n">original_code</span><span class="p">)</span> <span class="n">values</span>  <span class="p">(</span><span class="err">&#39;</span><span class="n">c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2d1</span><span class="err">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="err">&#39;</span><span class="mi">3</span><span class="n">bb48267ca4a47d8de97ad3f45919e883bb48267ca4a47d8de97ad3f45919e883bb48267ca4a47d8de97ad3f45919e883bb2</span><span class="err">&#39;</span><span class="p">)</span>  <span class="n">on</span> <span class="n">conflict</span> <span class="p">(</span><span class="n">original_code</span><span class="p">)</span> <span class="k">do</span> <span class="n">nothing</span> <span class="n">returning</span> <span class="n">id</span><span class="p">,</span> <span class="n">original_code</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">insert</span> <span class="n">into</span> <span class="n">app4</span> <span class="p">(</span><span class="n">original_code</span><span class="p">)</span>  <span class="p">(</span>

<span class="n">select</span> <span class="n">original_code</span> <span class="n">from</span> <span class="p">(</span><span class="n">values</span> 
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2d</span><span class="err">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c21</span><span class="err">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c22</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c23</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c24</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c25</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c26</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c27</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c28</span><span class="err">&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c29</span><span class="err">&#39;</span><span class="p">)</span> 

<span class="p">)</span> <span class="n">as</span> <span class="n">vt</span><span class="p">(</span><span class="n">original_code</span><span class="p">)</span>

<span class="n">except</span>

<span class="n">select</span> <span class="n">original_code</span> <span class="n">from</span> <span class="n">app4</span> <span class="n">where</span> <span class="n">original_code</span> <span class="n">in</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2d</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c21</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c22</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c23</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c24</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c25</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c26</span><span class="err">&#39;</span><span class="p">,</span> 
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c27</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c28</span><span class="err">&#39;</span><span class="p">,</span>
<span class="err">&#39;</span><span class="n">c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c2de9e0cea2fe4569c56d05bbc061697c29</span><span class="err">&#39;</span><span class="p">)</span> 

<span class="p">)</span> <span class="n">on</span> <span class="n">conflict</span> <span class="p">(</span><span class="n">original_code</span><span class="p">)</span> <span class="k">do</span> <span class="n">nothing</span><span class="p">;</span>
</pre></div>


<h3 id="multi-columns">Multi columns</h3>
<div class="hlcode"><pre><span class="n">insert</span> <span class="n">into</span> <span class="n">app</span> <span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="n">select</span> <span class="n">class</span><span class="p">,</span> <span class="mi">3</span> <span class="n">as</span> <span class="n">status</span> <span class="n">from</span> <span class="p">(</span>
    <span class="n">select</span> <span class="n">class</span> <span class="n">from</span> <span class="p">(</span><span class="n">values</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">sstf</span><span class="p">.</span><span class="n">catphotographycoloringbook</span><span class="p">.</span><span class="n">colorbynumber111</span><span class="err">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">MenuDino</span><span class="p">.</span><span class="n">TopfitComidaSaudavel</span><span class="err">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="err">&#39;</span><span class="mi">111</span><span class="err">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="err">&#39;</span><span class="mi">222</span><span class="err">&#39;</span><span class="p">))</span> <span class="n">as</span> <span class="n">vt</span><span class="p">(</span><span class="n">class</span><span class="p">)</span>
    <span class="n">except</span>
    <span class="n">select</span> <span class="n">class</span> <span class="n">from</span> <span class="n">app</span> <span class="n">where</span> <span class="n">class</span> <span class="n">in</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">sstf</span><span class="p">.</span><span class="n">catphotographycoloringbook</span><span class="p">.</span><span class="n">colorbynumber</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">MenuDino</span><span class="p">.</span><span class="n">TopfitComidaSaudavel</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="mi">111</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="mi">222</span><span class="err">&#39;</span><span class="p">)</span> 
<span class="p">)</span> <span class="n">a</span> <span class="n">on</span> <span class="n">conflict</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="k">do</span> <span class="n">nothing</span> <span class="n">returning</span> <span class="n">id</span><span class="p">,</span> <span class="n">class</span><span class="p">;</span>
</pre></div>


<h1 id="select">select</h1>
<h2 id="describe-table">describe table</h2>
<div class="hlcode"><pre><span class="n">select</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">character_maximum_length</span><span class="p">,</span> <span class="n">column_default</span><span class="p">,</span> <span class="n">is_nullable</span>
<span class="n">from</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span> <span class="n">where</span> <span class="n">table_name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="o">&lt;</span><span class="n">name</span> <span class="n">of</span> <span class="n">table</span><span class="o">&gt;</span><span class="err">&#39;</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="p">(</span><span class="n">in</span> <span class="n">the</span> <span class="n">psql</span> <span class="n">command</span><span class="o">-</span><span class="n">line</span> <span class="n">tool</span><span class="p">)</span><span class="o">:</span>

<span class="err">\</span><span class="n">d</span><span class="o">+</span> <span class="n">tablename</span>
</pre></div>


<h2 id="item">重复item</h2>
<div class="hlcode"><pre><span class="n">SELECT</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">COUNT</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span> <span class="n">FROM</span>  <span class="n">prod_usage</span><span class="p">.</span><span class="n">task_attempts</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">attempt</span> <span class="n">HAVING</span> <span class="n">COUNT</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>


<h1 id="faq">FAQ</h1>
<h2 id="good-sql">Good SQL</h2>
<p>BAD QUERY which will load all  data of 2020-09-30 on each plproxy node, and SLOW DOWN  production DB</p>
<div class="hlcode"><pre><span class="n">SELECT</span> <span class="n">date</span><span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">plproxy</span><span class="p">.</span><span class="n">execute_select</span><span class="p">(</span><span class="err">\$</span><span class="n">proxy</span><span class="err">\$</span>
    <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">mw</span><span class="p">.</span><span class="n">domain_x_domain_m</span> <span class="n">WHERE</span> <span class="n">date</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span><span class="err">&#39;</span> 
<span class="err">\$</span><span class="n">proxy</span><span class="err">\$</span><span class="p">)</span> <span class="n">t</span> <span class="p">(.......)</span> <span class="n">group</span> <span class="n">by</span> <span class="n">date</span> <span class="n">order</span> <span class="n">by</span> <span class="n">date</span> <span class="n">desc</span><span class="p">;</span>
</pre></div>


<p>should do the aggregation(count/sum) in the query inside, and sum the count from outside query</p>
<div class="hlcode"><pre><span class="n">SELECT</span>  <span class="nf">sum</span><span class="p">(</span><span class="n">count_a</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">plproxy</span><span class="p">.</span><span class="n">execute_select</span><span class="p">(</span><span class="err">\$</span><span class="n">proxy</span><span class="err">\$</span>
    <span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">as</span> <span class="n">count_a</span> <span class="n">FROM</span> <span class="n">mw</span><span class="p">.</span><span class="n">domain_x_domain_m</span> <span class="n">WHERE</span> <span class="n">date</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span><span class="err">&#39;</span> 
<span class="err">\$</span><span class="n">proxy</span><span class="err">\$</span><span class="p">)</span> <span class="n">t</span> <span class="p">(</span><span class="n">count_a</span> <span class="n">bigint</span><span class="p">)</span> <span class="p">;</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>