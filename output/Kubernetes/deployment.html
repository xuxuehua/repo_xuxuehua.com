<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Deployment - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;Deployment
    <span class="updated">Page Updated&nbsp;
      2020-04-18 16:10
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Deployment</div>

  <p>[toc]</p>
<h1 id="deployment">Deployment  无状态（常用）</h1>
<p>Deployment 为Pod和ReplicaSet提供一个声明方法，用来替代Replication Controller 来方便管理</p>
<p>Deployment 控制器实际操纵的，是ReplicaSet 对象，而不是 Pod 对 象。</p>
<p>可以声明一个yaml文件，确保deployment的状态信息</p>
<p>管理无状态的应用</p>
<p>Deployment可以建立在ReplicasSet之上， 控制多个rs</p>
<p><img alt="image-20200412004503760" src="deployment.assets/image-20200412004503760-7197579.png" /></p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">myapp</span>
      <span class="n">release</span><span class="o">:</span> <span class="n">canary</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">myapp</span>
        <span class="n">release</span><span class="o">:</span> <span class="n">canary</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
          <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
</pre></div>


<div class="hlcode"><pre><span class="cp"># kubectl get pods</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">7</span><span class="n">d574d56c7</span><span class="o">-</span><span class="n">nphdc</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">104</span><span class="n">s</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">7</span><span class="n">d574d56c7</span><span class="o">-</span><span class="n">t989l</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">104</span><span class="n">s</span>
</pre></div>


<h2 id="pod-template">Pod Template</h2>
<p>像 Deployment 这种控制器的设计原理</p>
<p>用一种对象管理另一种 对象”的“艺术”。其中，这个控制器对象本身，负责定义被管理对象的期望状态。比如，Deployment 里的 replicas=2 这个字段。</p>
<p>而被控制对象的定义，则来自于一个“模板”。比如，Deployment 里的 template 字段。</p>
<p>可以看到，Deployment 这个 template 字段里的内容，跟一个标准的 Pod 对象的 API 定义，丝毫 不差。而所有被这个 Deployment 管理的 Pod 实例，其实都是根据这个 template 字段的内容创 建出来的。</p>
<p>像 Deployment 定义的 template 字段，在 Kubernetes 项目中有一个专有的名字，叫作 PodTemplate(Pod 模板)。</p>
<p><img alt="image-20200412004817460" src="deployment.assets/image-20200412004817460-7197579.png" /></p>
<p>类似 Deployment 这样的一个控制器，实际上都是由上半部分的控制器定义(包括期 望状态)，加上下半部分的被控制对象的模板组成的</p>
<h2 id="_1">水平扩展/收缩</h2>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">scale</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">4</span> 
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="n">scaled</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="p">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">record</span>

<span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">deployments</span>
<span class="n">NAME</span>                            <span class="n">DESIRED</span>     <span class="n">CURRENT</span>     <span class="n">UP</span><span class="o">-</span><span class="n">TO</span><span class="o">-</span><span class="n">DATE</span>  <span class="n">AVAILABLE</span>   <span class="n">AGE</span> 
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>    <span class="mi">3</span>               <span class="mi">0</span>               <span class="mi">0</span>                   <span class="mi">0</span>                   <span class="mi">1</span><span class="n">s</span>
</pre></div>


<blockquote>
<p>DESIRED: 用户期望的 Pod 副本个数(spec.replicas 的值);</p>
<p>CURRENT: 当前处于 Running 状态的 Pod 的个数;</p>
<p>UP-TO-DATE: 当前处于最新版本的 Pod 的个数，所谓最新版本指的是 Pod 的 Spec 部分 与 Deployment 里 Pod 模板里定义的完全一致;</p>
<p>AVAILABLE: 当前已经可用的 Pod 的个数，即:既是 Running 状态，又是最新版本，并 且已经处于 Ready(健康检查正确)状态的 Pod 的个数。这是用户所期望的最终状态。</p>
</blockquote>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">rs</span>
<span class="n">NAME</span>                          <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">5</span><span class="n">bf87f5f59</span>   <span class="mi">3</span>         <span class="mi">3</span>         <span class="mi">3</span>       <span class="mi">42</span><span class="n">s</span>
</pre></div>


<blockquote>
<p>这个 ReplicaSet 的名字，则是由 Deployment 的名字和 一个随机字符串共同组成</p>
<p>ReplicaSet 会把这个随机字符串加在它所控制的所有 Pod 的标签里，从而保证这些 Pod 不会 与集群里的其他 Pod 混淆</p>
</blockquote>
<div class="hlcode"><pre><span class="nb">root</span><span class="p">@</span><span class="nx">master</span><span class="p">:</span><span class="err">~#</span> <span class="nx">kubectl</span> <span class="nx">rollout</span> <span class="nb">status</span> <span class="nx">deployment</span><span class="p">/</span><span class="nx">nginx</span><span class="na">-deployment</span>
<span class="nx">deployment</span> <span class="s2">&quot;nginx-deployment&quot;</span> <span class="nx">successfully</span> <span class="nx">rolled</span> <span class="nb">out</span>
<span class="nb">root</span><span class="p">@</span><span class="nx">master</span><span class="p">:</span><span class="err">~#</span> <span class="nx">kubectl</span> <span class="nb">describe</span> <span class="nx">deployment</span> <span class="nx">nginx</span><span class="na">-deployment</span>
<span class="nb">Name</span><span class="p">:</span>                   <span class="nx">nginx</span><span class="na">-deployment</span>
<span class="nx">Namespace</span><span class="p">:</span>              <span class="nb">default</span>
<span class="nx">CreationTimestamp</span><span class="p">:</span>      <span class="nx">Sun</span><span class="p">,</span> <span class="mi">12</span> <span class="nx">Apr</span> <span class="mi">2020</span> <span class="mi">05</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">34</span> <span class="o">+</span><span class="mi">0000</span>
<span class="nx">Labels</span><span class="p">:</span>                 <span class="n">app</span><span class="o">=</span><span class="nx">nginx</span>
<span class="nx">Annotations</span><span class="p">:</span>            <span class="nx">deployment.kubernetes.io</span><span class="p">/</span><span class="nx">revision</span><span class="p">:</span> <span class="mi">1</span>
<span class="nx">Selector</span><span class="p">:</span>               <span class="n">app</span><span class="o">=</span><span class="nx">nginx</span>
<span class="nx">Replicas</span><span class="p">:</span>               <span class="mi">5</span> <span class="nx">desired</span> <span class="o">|</span> <span class="mi">5</span> <span class="nx">updated</span> <span class="o">|</span> <span class="mi">5</span> <span class="nx">total</span> <span class="o">|</span> <span class="mi">5</span> <span class="nx">available</span> <span class="o">|</span> <span class="mi">0</span> <span class="nx">unavailable</span>
<span class="nx">StrategyType</span><span class="p">:</span>           <span class="nx">RollingUpdate</span>
<span class="nx">MinReadySeconds</span><span class="p">:</span>        <span class="mi">0</span>
<span class="nx">RollingUpdateStrategy</span><span class="p">:</span>  <span class="mi">25</span><span class="o">%</span> <span class="k">max</span> <span class="nx">unavailable</span><span class="p">,</span> <span class="mi">25</span><span class="o">%</span> <span class="k">max</span> <span class="nx">surge</span>
<span class="nx">Pod</span> <span class="nx">Template</span><span class="p">:</span>
  <span class="nx">Labels</span><span class="p">:</span>  <span class="n">app</span><span class="o">=</span><span class="nx">nginx</span>
  <span class="nx">Containers</span><span class="p">:</span>
   <span class="nx">nginx</span><span class="p">:</span>
    <span class="nb">Image</span><span class="p">:</span>        <span class="nx">nginx</span><span class="p">:</span><span class="mf">1.7.9</span>
    <span class="nb">Port</span><span class="p">:</span>         <span class="mi">80</span><span class="p">/</span><span class="nx">TCP</span>
    <span class="nb">Host</span> <span class="nb">Port</span><span class="p">:</span>    <span class="mi">0</span><span class="p">/</span><span class="nx">TCP</span>
    <span class="nx">Environment</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
    <span class="nx">Mounts</span><span class="p">:</span>       <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
  <span class="nx">Volumes</span><span class="p">:</span>        <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Conditions</span><span class="p">:</span>
  <span class="k">Type</span>           <span class="nb">Status</span>  <span class="nx">Reason</span>
  <span class="o">----</span>           <span class="o">------</span>  <span class="o">------</span>
  <span class="nx">Progressing</span>    <span class="kc">True</span>    <span class="nx">NewReplicaSetAvailable</span>
  <span class="nx">Available</span>      <span class="kc">True</span>    <span class="nx">MinimumReplicasAvailable</span>
<span class="nx">OldReplicaSets</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">NewReplicaSet</span><span class="p">:</span>   <span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">5</span><span class="nx">bf87f5f59</span> <span class="p">(</span><span class="mi">5</span><span class="p">/</span><span class="nx">5</span> <span class="nx">replicas</span> <span class="nx">created</span><span class="p">)</span>
<span class="nb">Events</span><span class="p">:</span>
  <span class="k">Type</span>    <span class="nx">Reason</span>             <span class="nx">Age</span>   <span class="nb">From</span>                   <span class="nx">Message</span>
  <span class="o">----</span>    <span class="o">------</span>             <span class="o">----</span>  <span class="o">----</span>                   <span class="o">-------</span>
  <span class="nx">Normal</span>  <span class="nx">ScalingReplicaSet</span>  <span class="mi">20</span><span class="nx">m</span>   <span class="nx">deployment</span><span class="na">-controller</span>  <span class="nx">Scaled</span> <span class="nb">up</span> <span class="nx">replica</span> <span class="nb">set</span> <span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">5</span><span class="nx">bf87f5f59</span> <span class="k">to</span> <span class="mi">3</span>
  <span class="nx">Normal</span>  <span class="nx">ScalingReplicaSet</span>  <span class="mi">21</span><span class="nb">s</span>   <span class="nx">deployment</span><span class="na">-controller</span>  <span class="nx">Scaled</span> <span class="nb">up</span> <span class="nx">replica</span> <span class="nb">set</span> <span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">5</span><span class="nx">bf87f5f59</span> <span class="k">to</span> <span class="mi">5</span>
</pre></div>


<h2 id="rollingupdatestrategy">RollingUpdateStrategy</h2>
<p>那么控制器在“滚动更 新”的过程中永远都会确保至少有 2 个 Pod 处于可用状态，至多只有 4 个 Pod 同时存在于集 群中。这个策略，是 Deployment 对象的一个字段</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> 
    <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="o">:</span>
<span class="o">...</span>
  <span class="n">strategy</span><span class="o">:</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">RollingUpdate</span>
    <span class="n">rollingUpdate</span><span class="o">:</span>
      <span class="n">maxSurge</span><span class="o">:</span> <span class="mi">1</span>
      <span class="n">maxUnavailable</span><span class="o">:</span> <span class="mi">1</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>