<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>CronJob - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;CronJob
    <span class="updated">Page Updated&nbsp;
      2020-04-18 16:17
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">CronJob</div>

  <p>[toc]</p>
<h1 id="cronjob">CronJob</h1>
<p>CronJob 是一个 Job 对象的控制器(Controller)</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">CronJob</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">hello</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">schedule</span><span class="o">:</span> <span class="s2">&quot;*/1 * * * *&quot;</span>
  <span class="n">jobTemplate</span><span class="o">:</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">template</span><span class="o">:</span>
        <span class="n">spec</span><span class="o">:</span>
          <span class="n">containers</span><span class="o">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">hello</span> 
            <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span> 
            <span class="n">args</span><span class="o">:</span>
            <span class="o">-</span> <span class="sr">/bin/s</span><span class="n">h</span>
            <span class="o">-</span> <span class="o">-</span><span class="n">c</span>
            <span class="o">-</span> <span class="n">date</span><span class="o">;</span> <span class="n">echo</span> <span class="n">Hello</span> <span class="n">from</span> <span class="n">the</span> <span class="n">Kubernetes</span> <span class="n">cluster</span> 
          <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
</pre></div>


<p>1min 后，会有对应的job产生</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">jobs</span> <span class="o">-</span><span class="n">w</span>
<span class="n">NAME</span>               <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">hello</span><span class="o">-</span><span class="mi">1587400860</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>                      <span class="mi">0</span><span class="n">s</span>
<span class="n">hello</span><span class="o">-</span><span class="mi">1587400860</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>           <span class="mi">1</span><span class="n">s</span>         <span class="mi">1</span><span class="n">s</span>
<span class="n">hello</span><span class="o">-</span><span class="mi">1587400860</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>           <span class="mi">4</span><span class="n">s</span>         <span class="mi">4</span><span class="n">s</span>

<span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">cronjob</span> <span class="n">hello</span>
<span class="n">NAME</span>    <span class="n">SCHEDULE</span>      <span class="n">SUSPEND</span>   <span class="n">ACTIVE</span>   <span class="n">LAST</span> <span class="n">SCHEDULE</span>   <span class="n">AGE</span>
<span class="n">hello</span>   <span class="err">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">False</span>     <span class="mi">0</span>        <span class="mi">35</span><span class="n">s</span>             <span class="mi">85</span><span class="n">s</span>
</pre></div>


<h2 id="concurrencypolicy">concurrencyPolicy</h2>
<p>由于定时任务的特殊性，很可能某个 Job 还没有执行完，另外一个新 Job 就产 生了。这时候，你可以通过 spec.concurrencyPolicy 字段来定义具体的处理策略。比如:</p>
<p>concurrencyPolicy=Allow，这也是默认情况，这意味着这些 Job 可以同时存在;<br />
concurrencyPolicy=Forbid，这意味着不会创建新的 Pod，该创建周期被跳过;<br />
concurrencyPolicy=Replace，这意味着新产生的 Job 会替换旧的、没有执行完的 Job。</p>
<p>而如果某一次 Job 创建失败，这次创建就会被标记为“miss”。当在指定的时间窗口内，miss 的数目达到 100 时，那么 CronJob 会停止再创建这个 Job。</p>
<p>这个时间窗口，可以由 spec.startingDeadlineSeconds 字段指定。比如 startingDeadlineSeconds=200，意味着在过去 200 s 里，如果 miss 的数目达到了 100 次， 那么这个 Job 就不会被创建执行了。</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>