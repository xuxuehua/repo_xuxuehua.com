<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Job - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;Job
    <span class="updated">Page Updated&nbsp;
      2020-04-18 16:17
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Job</div>

  <p>[toc]</p>
<h1 id="job">Job</h1>
<p>“离线业务”，或者叫作 Batch Job(计算业务)。这种业务在计算完成后就直接退出了</p>
<p>Pods管理程序，包含一系列job</p>
<p>类似于cronjob，一次性任务</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pi</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span> 
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">pi</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">resouer</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">bc</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo &#39;scale=10000; 4*a(1)&#39; | bc -l &quot;</span><span class="o">]</span> 
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
  <span class="n">backoffLimit</span><span class="o">:</span> <span class="mi">4</span>
</pre></div>


<blockquote>
<p>scale=10000，指定了输出的小数点后的位数是10000</p>
<p>tan(π/4) = 1。所以，4*atan(1)正好就是π，也就是 3.1415926...</p>
<p>restartPolicy=Never 的原因:离线计算的 Pod 永远都不应 该被重启，否则它们会再重新计算一遍</p>
<p>spec.backoffLimit 字段 里定义了重试次数为 4(即，backoffLimit=4)，而这个字段的默认值是 6</p>
</blockquote>
<p>事实上，restartPolicy 在 Job 对象里只允许被设置为 Never 和 OnFailure;而在 Deployment 对象里，restartPolicy 则只允许被设置为 Always。</p>
<p>需要注意的是，Job Controller 重新创建 Pod 的间隔是呈指数增加的，即下一次重新创建 Pod 的动作会分别发生在 10 s、20 s、40 s ...后。</p>
<h2 id="_1">部署</h2>
<div class="hlcode"><pre><span class="nb">root</span><span class="p">@</span><span class="nx">master</span><span class="p">:</span><span class="err">~#</span> <span class="nx">kubectl</span> <span class="nb">describe</span> <span class="nx">jobs</span><span class="p">/</span><span class="nb">pi</span>
<span class="nb">Name</span><span class="p">:</span>           <span class="nb">pi</span>
<span class="nx">Namespace</span><span class="p">:</span>      <span class="nb">default</span>
<span class="nx">Selector</span><span class="p">:</span>       <span class="nx">controller</span><span class="na">-uid</span><span class="o">=</span><span class="nx">b56ea22a</span><span class="o">-</span><span class="mi">7</span><span class="nx">b68</span><span class="o">-</span><span class="mi">4443</span><span class="na">-bdbe</span><span class="o">-</span><span class="mi">478192022</span><span class="nx">f77</span>
<span class="nx">Labels</span><span class="p">:</span>         <span class="nx">controller</span><span class="na">-uid</span><span class="o">=</span><span class="nx">b56ea22a</span><span class="o">-</span><span class="mi">7</span><span class="nx">b68</span><span class="o">-</span><span class="mi">4443</span><span class="na">-bdbe</span><span class="o">-</span><span class="mi">478192022</span><span class="nx">f77</span>
                <span class="nx">job</span><span class="na">-name</span><span class="o">=</span><span class="nb">pi</span>
<span class="nx">Annotations</span><span class="p">:</span>    <span class="nx">Parallelism</span><span class="p">:</span>  <span class="mi">1</span>
<span class="nx">Completions</span><span class="p">:</span>    <span class="mi">1</span>
<span class="nb">Start</span> <span class="nb">Time</span><span class="p">:</span>     <span class="nx">Mon</span><span class="p">,</span> <span class="mi">20</span> <span class="nx">Apr</span> <span class="mi">2020</span> <span class="mi">15</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">19</span> <span class="o">+</span><span class="mi">0000</span>
<span class="nx">Pods</span> <span class="nx">Statuses</span><span class="p">:</span>  <span class="mi">1</span> <span class="nb">Running</span> <span class="o">/</span> <span class="mi">0</span> <span class="nx">Succeeded</span> <span class="o">/</span> <span class="mi">0</span> <span class="nx">Failed</span>
<span class="nx">Pod</span> <span class="nx">Template</span><span class="p">:</span>
  <span class="nx">Labels</span><span class="p">:</span>  <span class="nx">controller</span><span class="na">-uid</span><span class="o">=</span><span class="nx">b56ea22a</span><span class="o">-</span><span class="mi">7</span><span class="nx">b68</span><span class="o">-</span><span class="mi">4443</span><span class="na">-bdbe</span><span class="o">-</span><span class="mi">478192022</span><span class="nx">f77</span>
           <span class="nx">job</span><span class="na">-name</span><span class="o">=</span><span class="nb">pi</span>
  <span class="nx">Containers</span><span class="p">:</span>
   <span class="nb">pi</span><span class="p">:</span>
    <span class="nb">Image</span><span class="p">:</span>      <span class="nx">resouer</span><span class="p">/</span><span class="nx">ubuntu</span><span class="na">-bc</span>
    <span class="nb">Port</span><span class="p">:</span>       <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
    <span class="nb">Host</span> <span class="nb">Port</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
    <span class="nb">Command</span><span class="p">:</span>
      <span class="nx">sh</span>
      <span class="na">-c</span>
      <span class="nx">echo</span> <span class="s1">&#39;scale=10000; 4*a(1)&#39;</span> <span class="o">|</span> <span class="nx">bc</span> <span class="na">-l</span> 
    <span class="nx">Environment</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
    <span class="nx">Mounts</span><span class="p">:</span>       <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
  <span class="nx">Volumes</span><span class="p">:</span>        <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nb">Events</span><span class="p">:</span>
  <span class="k">Type</span>    <span class="nx">Reason</span>            <span class="nx">Age</span>   <span class="nb">From</span>            <span class="nx">Message</span>
  <span class="o">----</span>    <span class="o">------</span>            <span class="o">----</span>  <span class="o">----</span>            <span class="o">-------</span>
  <span class="nx">Normal</span>  <span class="nx">SuccessfulCreate</span>  <span class="mi">9</span><span class="nb">s</span>    <span class="nx">job</span><span class="na">-controller</span>  <span class="nx">Created</span> <span class="nx">pod</span><span class="p">:</span> <span class="nb">pi</span><span class="na">-bfz7f</span>
</pre></div>


<blockquote>
<p>controller-uid 是随机字符串，作为job 这个对象的label保证了 Job 与它所管理的 Pod 之间的匹配关系</p>
<p>Job Controller 之所以要使用这种携带了 UID 的 Label，就是为了避免不同 Job 对象所管理 的 Pod 发生重合</p>
</blockquote>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">NAME</span>       <span class="n">READY</span>   <span class="n">STATUS</span>      <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pi</span><span class="o">-</span><span class="n">bfz7f</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">20</span><span class="n">m</span>
<span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">logs</span> <span class="n">pi</span><span class="o">-</span><span class="n">bfz7f</span>
<span class="mf">3.141592653589793238462643383279502884197169399375105820974944592307</span>\
</pre></div>


<h2 id="_2"></h2>
<h2 id="activedeadlineseconds">activeDeadlineSeconds</h2>
<p>spec.activeDeadlineSeconds 字段可以设置最长运行时间</p>
<div class="hlcode"><pre><span class="n">spec</span><span class="o">:</span>
  <span class="n">backoffLimit</span><span class="o">:</span> <span class="mi">5</span>
  <span class="n">activeDeadlineSeconds</span><span class="o">:</span> <span class="mi">100</span>
</pre></div>


<blockquote>
<p>一旦运行超过了 100 s，这个 Job 的所有 Pod 都会被终止。并且，你可以在 Pod 的状态里看到 终止的原因是 reason: DeadlineExceeded。</p>
</blockquote>
<h1 id="batch">Batch 并行作业</h1>
<p>在 Job 对象中，负责并行控制的参数有两个</p>
<ol>
<li>spec.parallelism</li>
</ol>
<p>定义的是一个 Job 在任意时间最多可以启动多少个 Pod 同时运行;</p>
<ol>
<li>spec.completions</li>
</ol>
<p>定义的是 Job 至少要完成的 Pod 数目，即 Job 的最小完成数。</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pi</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">parallelism</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">completions</span><span class="o">:</span> <span class="mi">4</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span> 
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">pi</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">resouer</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">bc</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo &#39;scale=5000; 4*a(1)&#39; | bc -l &quot;</span><span class="o">]</span> 
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
  <span class="n">backoffLimit</span><span class="o">:</span> <span class="mi">4</span>
</pre></div>


<p>每当有一个 Pod 完成计算进入 Completed 状态时，就会有一个新的 Pod 被自动创建出来，并且快速地从 Pending 状态进入到 ContainerCreating 状态</p>
<p>紧接着，Job Controller 第二次创建出来的两个并行的 Pod 也进入了 Running 状态</p>
<p>最终，后面创建的这两个 Pod 也完成了计算，进入了 Completed 状态</p>
<p>由于所有的 Pod 均已经成功退出，这个 Job 也就执行完了，所以你会看到它的 SUCCESSFUL 字段的值变成了 4</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">job</span><span class="p">.</span><span class="n">yaml</span>  <span class="o">&amp;&amp;</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">w</span>
<span class="n">job</span><span class="p">.</span><span class="n">batch</span><span class="o">/</span><span class="n">pi</span> <span class="n">created</span>
<span class="n">NAME</span>       <span class="n">READY</span>   <span class="n">STATUS</span>              <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pi</span><span class="o">-</span><span class="mi">5</span><span class="n">wlr9</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f582v</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f582v</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">2</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="mi">5</span><span class="n">wlr9</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">3</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f582v</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>           <span class="mi">0</span>          <span class="mi">30</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f65qr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>             <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f65qr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>             <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f65qr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="mi">5</span><span class="n">wlr9</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>           <span class="mi">0</span>          <span class="mi">32</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">gwf4g</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>             <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">gwf4g</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>             <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">gwf4g</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f65qr</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">3</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">gwf4g</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">3</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">f65qr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>           <span class="mi">0</span>          <span class="mi">30</span><span class="n">s</span>
<span class="n">pi</span><span class="o">-</span><span class="n">gwf4g</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>           <span class="mi">0</span>          <span class="mi">37</span><span class="n">s</span>


<span class="n">root</span><span class="err">@</span><span class="n">master</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">job</span>
<span class="n">NAME</span>   <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">pi</span>     <span class="mi">4</span><span class="o">/</span><span class="mi">4</span>           <span class="mi">69</span><span class="n">s</span>        <span class="mi">102</span><span class="n">s</span>
</pre></div>


<h1 id="job_1">使用job 对象</h1>
<h2 id="job_2">外部管理器 +Job 模板</h2>
<p>把 Job 的 YAML 文件定义为一个“模板”，然后用一个外部工具控制 这些“模板”来生成 Job</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">process</span><span class="o">-</span><span class="n">item</span><span class="o">-</span><span class="n">$ITEM</span> 
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">jobgroup</span><span class="o">:</span> <span class="n">jobexample</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">jobexample</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">jobgroup</span><span class="o">:</span> <span class="n">jobexample</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span> 
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">c</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo Processing item $ITEM &amp;&amp; sleep 5&quot;</span><span class="o">]</span> 
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
</pre></div>


<p>使用shell 把 $ITEM 替换掉</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mkdir</span> <span class="p">.</span><span class="o">/</span><span class="n">jobs</span>
<span class="err">$</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">apple</span> <span class="n">banana</span> <span class="n">cherry</span>
<span class="k">do</span>
  <span class="n">cat</span> <span class="n">job</span><span class="o">-</span><span class="n">tmpl</span><span class="p">.</span><span class="n">yaml</span> <span class="o">|</span> <span class="n">sed</span> <span class="s">&quot;s/\$ITEM/$i/&quot;</span> <span class="o">&gt;</span> <span class="p">.</span><span class="o">/</span><span class="n">jobs</span><span class="o">/</span><span class="n">job</span><span class="o">-</span><span class="err">$</span><span class="n">i</span><span class="p">.</span><span class="n">yaml</span> 
<span class="n">done</span>
</pre></div>


<p>这个模式看起来虽然很“傻”，但却是 Kubernetes 社区里使用 Job 的一个很普遍的模式。</p>
<p>原因很简单:大多数用户在需要管理 Batch Job 的时候，都已经有了一套自己的方案，需要做 的往往就是集成工作。这时候，Kubernetes 项目对这些方案来说最有价值的，就是 Job 这个 API 对象。所以，你只需要编写一个外部工具(等同于我们这里的 for 循环)来管理这些 Job 即可。</p>
<p>这种模式最典型的应用，就是 TensorFlow 社区的 KubeFlow 项目。</p>
<p>很容易理解，在这种模式下使用 Job 对象，completions 和 parallelism 这两个字段都应该使 用默认值 1，而不应该由我们自行设置。而作业 Pod 的并行控制，应该完全交由外部工具来进 行管理(比如，KubeFlow)</p>
<h2 id="job_3">拥有固定任务数目的并行 Job</h2>
<p>这种模式下，我只关心最后是否有指定数目(spec.completions)个任务成功退出。至于执行时的并行度是多少，我并不关心</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span> 
<span class="n">spec</span><span class="o">:</span>
  <span class="n">completions</span><span class="o">:</span> <span class="mi">8</span>
  <span class="n">parallelism</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">c</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">myrepo</span><span class="o">/</span><span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span> 
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">BROKER_URL</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">amqp</span><span class="o">://</span><span class="n">guest</span><span class="o">:</span><span class="n">guest</span><span class="err">@</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">service</span><span class="o">:</span><span class="mi">5672</span> 
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">QUEUE</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">job1</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
</pre></div>


<blockquote>
<p>completions 的值是:8，这意味着我们总共要处理的任务数目是 8 个。 也就是说，总共会有 8 个任务会被逐一放入工作队列里</p>
</blockquote>
<p>在这个实例中，我选择充当工作队列的是一个运行在 Kubernetes 里的 RabbitMQ。所以，我 们需要在 Pod 模板里定义 BROKER_URL，来作为消费者。</p>
<p>所以，一旦你用 kubectl create 创建了这个 Job，它就会以并发度为 2 的方式，每两个 Pod 一 组，创建出 8 个 Pod。每个 Pod 都会去连接 BROKER_URL，从 RabbitMQ 里读取任务，然后 各自进行处理。这个 Pod 里的执行逻辑，我们可以用这样一段伪代码来表示</p>
<div class="hlcode"><pre><span class="cm">/* job-wq-1 的伪代码 */</span>
<span class="n">queue</span> <span class="o">:=</span> <span class="n">newQueue</span><span class="p">(</span><span class="err">$</span><span class="no">BROKER_URL</span><span class="p">,</span> <span class="err">$</span><span class="no">QUEUE</span><span class="p">)</span> <span class="mh">3</span> <span class="k">task</span> <span class="o">:=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
<span class="n">process</span><span class="p">(</span><span class="k">task</span><span class="p">)</span>
<span class="n">exit</span>
</pre></div>


<p>可以看到，每个 Pod 只需要将任务信息读取出来，处理完成，然后退出即可。而作为用户，我 只关心最终一共有 8 个计算任务启动并且退出，只要这个目标达到，我就认为整个 Job 处理完 成了。所以说，这种用法，对应的就是“任务总数固定”的场景</p>
<h2 id="parallelism">指定并行度(parallelism) (常用)</h2>
<p>不设置固定的 completions 的值</p>
<p>你就必须自己想办法，来决定什么时候启动新 Pod，什么时候 Job 才算执行完成。在这 种情况下，任务的总数是未知的，所以你不仅需要一个工作队列来负责任务分发，还需要能够判断工作队列已经为空(即:所有的工作已经结束了)</p>
<p>Job 的定义基本上没变化，只不过是不再需要定义 completions 的值了而已</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">2</span> 
<span class="n">spec</span><span class="o">:</span>
  <span class="n">parallelism</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">c</span>
          <span class="n">image</span><span class="o">:</span> <span class="n">gcr</span><span class="o">.</span><span class="na">io</span><span class="sr">/myproject/</span><span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">2</span> 
          <span class="n">env</span><span class="o">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">BROKER_URL</span>
            <span class="n">value</span><span class="o">:</span> <span class="n">amqp</span><span class="o">://</span><span class="n">guest</span><span class="o">:</span><span class="n">guest</span><span class="err">@</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">service</span><span class="o">:</span><span class="mi">5672</span> 
          <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">QUEUE</span>
            <span class="n">value</span><span class="o">:</span> <span class="n">job2</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
</pre></div>


<p>而对应的 Pod 的逻辑会稍微复杂一些，可以用这样一段伪代码来描述</p>
<div class="hlcode"><pre><span class="cm">/* job-wq-2 的伪代码 */</span>
<span class="k">for</span> <span class="o">!</span><span class="n">queue</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">(</span><span class="err">$</span><span class="no">BROKER_URL</span><span class="p">,</span> <span class="err">$</span><span class="no">QUEUE</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">task</span> <span class="o">:=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
    <span class="n">process</span><span class="p">(</span><span class="k">task</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">print</span><span class="p">(</span><span class="s">&quot;Queue empty, exiting&quot;</span><span class="p">)</span>
<span class="n">exit</span>
</pre></div>


<p>由于任务数目的总数不固定，所以每一个 Pod 必须能够知道，自己什么时候可以退出。比如， 在这个例子中，我简单地以“队列为空”，作为任务全部完成的标志。所以说，这种用法，对应 的是“任务总数不固定”的场景。</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>