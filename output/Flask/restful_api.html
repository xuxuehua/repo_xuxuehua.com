<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>restful_api - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Flask">Flask</a>&nbsp;&#187;&nbsp;restful_api
    <span class="updated">Page Updated&nbsp;
      2019-08-03 16:32
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">restful_api</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#restful-api">Restful API</a><ul>
<li><a href="#_1">优点</a></li>
<li><a href="#_2">缺点</a></li>
<li><a href="#api">内部开发API</a></li>
<li><a href="#api_1">开放性的API</a></li>
<li><a href="#_3">方法</a><ul>
<li><a href="#get">get</a></li>
<li><a href="#post">post</a></li>
<li><a href="#put">put</a></li>
<li><a href="#delete">delete</a></li>
<li><a href="#patch">patch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#flask_restful">flask_restful</a><ul>
<li><a href="#helloworld">HelloWorld</a></li>
<li><a href="#requestparser">RequestParser</a></li>
<li><a href="#responses">Responses</a><ul>
<li><a href="#marshal">marshal</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#example">example</a></li>
<li><a href="#authentication">Authentication</a><ul>
<li><a href="#database">Database</a></li>
<li><a href="#password-hashing">Password Hashing</a><ul>
<li><a href="#user-registration">User Registration</a></li>
</ul>
</li>
<li><a href="#password-based-authentication">Password Based Authentication</a><ul>
<li><a href="#verify-password">Verify password</a></li>
</ul>
</li>
<li><a href="#token-based-authentication">Token Based Authentication</a></li>
<li><a href="#oauth-authentication">OAuth Authentication</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="restful-api">Restful API</h1>
<h2 id="_1">优点</h2>
<p>强制输入输出为json，可读性很强</p>
<p>指定版本号，可以放在header的key value 中，或者query里面指定版本号</p>
<h2 id="_2">缺点</h2>
<p>接口力度比较粗</p>
<p>造成HTTP请求数量大量增加</p>
<h2 id="api">内部开发API</h2>
<p>内部调用的API</p>
<h2 id="api_1">开放性的API</h2>
<p>可以公网的访问的API，如Github </p>
<h2 id="_3">方法</h2>
<h3 id="get">get</h3>
<h3 id="post">post</h3>
<h3 id="put">put</h3>
<h3 id="delete">delete</h3>
<h3 id="patch">patch</h3>
<p>PATCH was only officially adopted as part of HTTP in 2010. The goal is to provide a standardized way to express partial updates. A PATCH request in a standard format allows an interaction to be more explicit about the intent. This is the reason one would use PATCH over POST, even though POST can be used for anything.</p>
<h1 id="flask_restful">flask_restful</h1>
<h2 id="helloworld">HelloWorld</h2>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span>
<span class="n">from</span> <span class="n">flask_restful</span> <span class="n">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">class</span> <span class="n">UserAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
        <span class="n">pass</span>

    <span class="n">def</span> <span class="n">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
        <span class="n">pass</span>

    <span class="n">def</span> <span class="n">delete</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
        <span class="n">pass</span>

<span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">UserAPI</span><span class="p">,</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">users</span><span class="o">/&lt;</span><span class="kt">int</span><span class="o">:</span><span class="n">id</span><span class="o">&gt;</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">user</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<h2 id="requestparser">RequestParser</h2>
<p>This class works in a similar way as <code>argparse</code> for command line arguments.</p>
<p>for handling multi-arguments </p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask_restful</span> <span class="n">import</span> <span class="n">reqparse</span>

<span class="n">class</span> <span class="n">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="p">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="err">&#39;</span><span class="n">title</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">str</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="n">True</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">No</span> <span class="n">task</span> <span class="n">title</span> <span class="n">provided</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">json</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="err">&#39;</span><span class="n">description</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">str</span><span class="p">,</span> <span class="k">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">json</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">filter</span><span class="p">(</span><span class="n">lambda</span> <span class="n">t</span><span class="o">:</span> <span class="n">t</span><span class="p">[</span><span class="err">&#39;</span><span class="n">id</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">id</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="n">in</span> <span class="n">args</span><span class="p">.</span><span class="n">iteritems</span><span class="p">()</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">None</span><span class="o">:</span>
                <span class="n">task</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">task</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>

<span class="n">class</span> <span class="n">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="p">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="err">&#39;</span><span class="n">title</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">str</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">json</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="err">&#39;</span><span class="n">description</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">str</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">json</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reqparse</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="err">&#39;</span><span class="n">done</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">json</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>

    <span class="err">#</span> <span class="p">...</span>
</pre></div>


<blockquote>
<p>the <code>location</code> optional argument must be set to indicate that the fields are coming in <code>request.json</code></p>
</blockquote>
<h2 id="responses">Responses</h2>
<p>Flask-RESTful automatically handles the conversion to JSON, so instead of this</p>
<div class="hlcode"><pre><span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">task</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>


<p>or </p>
<div class="hlcode"><pre><span class="k">return</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">task</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">}</span>
</pre></div>


<p>or</p>
<div class="hlcode"><pre><span class="k">return</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">task</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">},</span> <span class="mi">201</span>
</pre></div>


<h3 id="marshal">marshal</h3>
<div class="hlcode"><pre><span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">title</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">description</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">done</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">Boolean</span>
<span class="p">}</span>
<span class="n">class</span> <span class="n">UserAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;a&#39;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span> <span class="n">id</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">task</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>


<span class="o">&gt;&gt;&gt;</span>
<span class="p">{</span>
    <span class="s">&quot;task&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s">&quot;title&quot;</span><span class="o">:</span> <span class="n">null</span><span class="p">,</span>
        <span class="s">&quot;description&quot;</span><span class="o">:</span> <span class="n">null</span><span class="p">,</span>
        <span class="s">&quot;done&quot;</span><span class="o">:</span> <span class="n">null</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h1 id="example">example</h1>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre></div></td><td class="code"><div class="hlcode"><pre><span class="nt">import</span> <span class="nt">six</span>
<span class="nt">from</span> <span class="nt">flask</span> <span class="nt">import</span> <span class="nt">Flask</span><span class="o">,</span> <span class="nt">jsonify</span><span class="o">,</span> <span class="nt">abort</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">make_response</span><span class="o">,</span> <span class="nt">url_for</span>
<span class="nt">from</span> <span class="nt">flask_httpauth</span> <span class="nt">import</span> <span class="nt">HTTPBasicAuth</span>

<span class="nt">app</span> <span class="o">=</span> <span class="nt">Flask</span><span class="o">(</span><span class="nt">__name__</span><span class="o">,</span> <span class="nt">static_url_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span>
<span class="nt">auth</span> <span class="o">=</span> <span class="nt">HTTPBasicAuth</span><span class="o">()</span>


<span class="k">@auth</span><span class="nc">.get_password</span>
<span class="nt">def</span> <span class="nt">get_password</span><span class="o">(</span><span class="nt">username</span><span class="o">):</span>
    <span class="nt">if</span> <span class="nt">username</span> <span class="o">==</span> <span class="s1">&#39;miguel&#39;</span><span class="o">:</span>
        <span class="nt">return</span> <span class="s1">&#39;python&#39;</span>
    <span class="nt">return</span> <span class="nt">None</span>


<span class="k">@auth</span><span class="nc">.error_handler</span>
<span class="nt">def</span> <span class="nt">unauthorized</span><span class="o">():</span>
    <span class="err">#</span> <span class="nt">return</span> <span class="nt">403</span> <span class="nt">instead</span> <span class="nt">of</span> <span class="nt">401</span> <span class="nt">to</span> <span class="nt">prevent</span> <span class="nt">browsers</span> <span class="nt">from</span> <span class="nt">displaying</span> <span class="nt">the</span> <span class="nt">default</span>
    <span class="err">#</span> <span class="nt">auth</span> <span class="nt">dialog</span>
    <span class="nt">return</span> <span class="nt">make_response</span><span class="o">(</span><span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="s1">&#39;Unauthorized access&#39;</span><span class="p">}</span><span class="o">),</span> <span class="nt">403</span><span class="o">)</span>


<span class="k">@app</span><span class="nc">.errorhandler</span><span class="o">(</span><span class="nt">400</span><span class="o">)</span>
<span class="nt">def</span> <span class="nt">bad_request</span><span class="o">(</span><span class="nt">error</span><span class="o">):</span>
    <span class="nt">return</span> <span class="nt">make_response</span><span class="o">(</span><span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">}</span><span class="o">),</span> <span class="nt">400</span><span class="o">)</span>


<span class="k">@app</span><span class="nc">.errorhandler</span><span class="o">(</span><span class="nt">404</span><span class="o">)</span>
<span class="nt">def</span> <span class="nt">not_found</span><span class="o">(</span><span class="nt">error</span><span class="o">):</span>
    <span class="nt">return</span> <span class="nt">make_response</span><span class="o">(</span><span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="s1">&#39;Not found&#39;</span><span class="p">}</span><span class="o">),</span> <span class="nt">404</span><span class="o">)</span>


<span class="nt">tasks</span> <span class="o">=</span> <span class="cp">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="cp">]</span>


<span class="nt">def</span> <span class="nt">make_public_task</span><span class="o">(</span><span class="nt">task</span><span class="o">):</span>
    <span class="nt">new_task</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nt">for</span> <span class="nt">field</span> <span class="nt">in</span> <span class="nt">task</span><span class="o">:</span>
        <span class="nt">if</span> <span class="nt">field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="o">:</span>
            <span class="nt">new_task</span><span class="cp">[</span><span class="s1">&#39;uri&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">url_for</span><span class="o">(</span><span class="s1">&#39;get_task&#39;</span><span class="o">,</span> <span class="nt">task_id</span><span class="o">=</span><span class="nt">task</span><span class="cp">[</span><span class="s1">&#39;id&#39;</span><span class="cp">]</span><span class="o">,</span>
                                      <span class="nt">_external</span><span class="o">=</span><span class="nt">True</span><span class="o">)</span>
        <span class="nt">else</span><span class="o">:</span>
            <span class="nt">new_task</span><span class="cp">[</span><span class="nb">field</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">task</span><span class="cp">[</span><span class="nb">field</span><span class="cp">]</span>
    <span class="nt">return</span> <span class="nt">new_task</span>


<span class="k">@app</span><span class="nc">.route</span><span class="o">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="o">,</span> <span class="nt">methods</span><span class="o">=</span><span class="cp">[</span><span class="s1">&#39;GET&#39;</span><span class="cp">]</span><span class="o">)</span>
<span class="k">@auth</span><span class="nc">.login_required</span>
<span class="nt">def</span> <span class="nt">get_tasks</span><span class="o">():</span>
    <span class="nt">return</span> <span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;tasks&#39;</span><span class="o">:</span> <span class="cp">[</span><span class="nx">make_public_task</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span> <span class="nb">for</span> <span class="n">task</span> <span class="k">in</span> <span class="nb">tasks</span><span class="cp">]</span><span class="p">}</span><span class="o">)</span>


<span class="k">@app</span><span class="nc">.route</span><span class="o">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="o">,</span> <span class="nt">methods</span><span class="o">=</span><span class="cp">[</span><span class="s1">&#39;GET&#39;</span><span class="cp">]</span><span class="o">)</span>
<span class="k">@auth</span><span class="nc">.login_required</span>
<span class="nt">def</span> <span class="nt">get_task</span><span class="o">(</span><span class="nt">task_id</span><span class="o">):</span>
    <span class="nt">task</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">task</span> <span class="nb">for</span> <span class="n">task</span> <span class="k">in</span> <span class="nb">tasks</span> <span class="k">if</span> <span class="nx">task</span><span class="err">[</span><span class="s1">&#39;id&#39;</span><span class="cp">]</span> <span class="o">==</span> <span class="nt">task_id</span><span class="o">]</span>
    <span class="nt">if</span> <span class="nt">len</span><span class="o">(</span><span class="nt">task</span><span class="o">)</span> <span class="o">==</span> <span class="nt">0</span><span class="o">:</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">404</span><span class="o">)</span>
    <span class="nt">return</span> <span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="o">:</span> <span class="nt">make_public_task</span><span class="o">(</span><span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">)</span><span class="p">}</span><span class="o">)</span>


<span class="k">@app</span><span class="nc">.route</span><span class="o">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="o">,</span> <span class="nt">methods</span><span class="o">=</span><span class="cp">[</span><span class="s1">&#39;POST&#39;</span><span class="cp">]</span><span class="o">)</span>
<span class="k">@auth</span><span class="nc">.login_required</span>
<span class="nt">def</span> <span class="nt">create_task</span><span class="o">():</span>
    <span class="nt">if</span> <span class="nt">not</span> <span class="nt">request</span><span class="nc">.json</span> <span class="nt">or</span> <span class="s1">&#39;title&#39;</span> <span class="nt">not</span> <span class="nt">in</span> <span class="nt">request</span><span class="nc">.json</span><span class="o">:</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">400</span><span class="o">)</span>
    <span class="nt">task</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="nt">tasks</span><span class="cp">[</span><span class="o">-</span><span class="mi">1</span><span class="cp">][</span><span class="s1">&#39;id&#39;</span><span class="cp">]</span> <span class="o">+</span> <span class="nt">1</span> <span class="nt">if</span> <span class="nt">len</span><span class="o">(</span><span class="nt">tasks</span><span class="o">)</span> <span class="o">&gt;</span> <span class="nt">0</span> <span class="nt">else</span> <span class="nt">1</span><span class="o">,</span>
        <span class="s1">&#39;title&#39;</span><span class="o">:</span> <span class="nt">request</span><span class="nc">.json</span><span class="cp">[</span><span class="s1">&#39;title&#39;</span><span class="cp">]</span><span class="o">,</span>
        <span class="s1">&#39;description&#39;</span><span class="o">:</span> <span class="nt">request</span><span class="nc">.json.get</span><span class="o">(</span><span class="s1">&#39;description&#39;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">),</span>
        <span class="s1">&#39;done&#39;</span><span class="o">:</span> <span class="nt">False</span>
    <span class="p">}</span>
    <span class="nt">tasks</span><span class="nc">.append</span><span class="o">(</span><span class="nt">task</span><span class="o">)</span>
    <span class="nt">return</span> <span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="o">:</span> <span class="nt">make_public_task</span><span class="o">(</span><span class="nt">task</span><span class="o">)</span><span class="p">}</span><span class="o">),</span> <span class="nt">201</span>


<span class="k">@app</span><span class="nc">.route</span><span class="o">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="o">,</span> <span class="nt">methods</span><span class="o">=</span><span class="cp">[</span><span class="s1">&#39;PUT&#39;</span><span class="cp">]</span><span class="o">)</span>
<span class="k">@auth</span><span class="nc">.login_required</span>
<span class="nt">def</span> <span class="nt">update_task</span><span class="o">(</span><span class="nt">task_id</span><span class="o">):</span>
    <span class="nt">task</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">task</span> <span class="nb">for</span> <span class="n">task</span> <span class="k">in</span> <span class="nb">tasks</span> <span class="k">if</span> <span class="nx">task</span><span class="err">[</span><span class="s1">&#39;id&#39;</span><span class="cp">]</span> <span class="o">==</span> <span class="nt">task_id</span><span class="o">]</span>
    <span class="nt">if</span> <span class="nt">len</span><span class="o">(</span><span class="nt">task</span><span class="o">)</span> <span class="o">==</span> <span class="nt">0</span><span class="o">:</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">404</span><span class="o">)</span>
    <span class="nt">if</span> <span class="nt">not</span> <span class="nt">request</span><span class="nc">.json</span><span class="o">:</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">400</span><span class="o">)</span>
    <span class="nt">if</span> <span class="s1">&#39;title&#39;</span> <span class="nt">in</span> <span class="nt">request</span><span class="nc">.json</span> <span class="nt">and</span> <span class="err">\</span>
            <span class="nt">not</span> <span class="nt">isinstance</span><span class="o">(</span><span class="nt">request</span><span class="nc">.json</span><span class="cp">[</span><span class="s1">&#39;title&#39;</span><span class="cp">]</span><span class="o">,</span> <span class="nt">six</span><span class="nc">.string_types</span><span class="o">):</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">400</span><span class="o">)</span>
    <span class="nt">if</span> <span class="s1">&#39;description&#39;</span> <span class="nt">in</span> <span class="nt">request</span><span class="nc">.json</span> <span class="nt">and</span> <span class="err">\</span>
            <span class="nt">not</span> <span class="nt">isinstance</span><span class="o">(</span><span class="nt">request</span><span class="nc">.json</span><span class="cp">[</span><span class="s1">&#39;description&#39;</span><span class="cp">]</span><span class="o">,</span> <span class="nt">six</span><span class="nc">.string_types</span><span class="o">):</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">400</span><span class="o">)</span>
    <span class="nt">if</span> <span class="s1">&#39;done&#39;</span> <span class="nt">in</span> <span class="nt">request</span><span class="nc">.json</span> <span class="nt">and</span> <span class="nt">type</span><span class="o">(</span><span class="nt">request</span><span class="nc">.json</span><span class="cp">[</span><span class="s1">&#39;done&#39;</span><span class="cp">]</span><span class="o">)</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">bool</span><span class="o">:</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">400</span><span class="o">)</span>
    <span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">][</span><span class="s1">&#39;title&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">request</span><span class="nc">.json.get</span><span class="o">(</span><span class="s1">&#39;title&#39;</span><span class="o">,</span> <span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">][</span><span class="s1">&#39;title&#39;</span><span class="cp">]</span><span class="o">)</span>
    <span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">][</span><span class="s1">&#39;description&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">request</span><span class="nc">.json.get</span><span class="o">(</span><span class="s1">&#39;description&#39;</span><span class="o">,</span>
                                              <span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">][</span><span class="s1">&#39;description&#39;</span><span class="cp">]</span><span class="o">)</span>
    <span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">][</span><span class="s1">&#39;done&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">request</span><span class="nc">.json.get</span><span class="o">(</span><span class="s1">&#39;done&#39;</span><span class="o">,</span> <span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">][</span><span class="s1">&#39;done&#39;</span><span class="cp">]</span><span class="o">)</span>
    <span class="nt">return</span> <span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="o">:</span> <span class="nt">make_public_task</span><span class="o">(</span><span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">)</span><span class="p">}</span><span class="o">)</span>


<span class="k">@app</span><span class="nc">.route</span><span class="o">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="o">,</span> <span class="nt">methods</span><span class="o">=</span><span class="cp">[</span><span class="s1">&#39;DELETE&#39;</span><span class="cp">]</span><span class="o">)</span>
<span class="k">@auth</span><span class="nc">.login_required</span>
<span class="nt">def</span> <span class="nt">delete_task</span><span class="o">(</span><span class="nt">task_id</span><span class="o">):</span>
    <span class="nt">task</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">task</span> <span class="nb">for</span> <span class="n">task</span> <span class="k">in</span> <span class="nb">tasks</span> <span class="k">if</span> <span class="nx">task</span><span class="err">[</span><span class="s1">&#39;id&#39;</span><span class="cp">]</span> <span class="o">==</span> <span class="nt">task_id</span><span class="o">]</span>
    <span class="nt">if</span> <span class="nt">len</span><span class="o">(</span><span class="nt">task</span><span class="o">)</span> <span class="o">==</span> <span class="nt">0</span><span class="o">:</span>
        <span class="nt">abort</span><span class="o">(</span><span class="nt">404</span><span class="o">)</span>
    <span class="nt">tasks</span><span class="nc">.remove</span><span class="o">(</span><span class="nt">task</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">)</span>
    <span class="nt">return</span> <span class="nt">jsonify</span><span class="o">(</span><span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="o">:</span> <span class="nt">True</span><span class="p">}</span><span class="o">)</span>


<span class="nt">if</span> <span class="nt">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="o">:</span>
    <span class="nt">app</span><span class="nc">.run</span><span class="o">(</span><span class="nt">debug</span><span class="o">=</span><span class="nt">True</span><span class="o">)</span>
</pre></div>
</td></tr></table>

<h1 id="authentication">Authentication</h1>
<h2 id="database">Database</h2>
<p>For security reasons the original password will not be stored</p>
<div class="hlcode"><pre><span class="n">class</span> <span class="n">User</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">users</span><span class="err">&#39;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="n">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">True</span><span class="p">)</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
</pre></div>


<h2 id="password-hashing">Password Hashing</h2>
<p>PassLib provides several hashing algorithms to choose from. The <code>custom_app_context</code> object is an easy to use option based on the sha256_crypt hashing algorithm</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">passlib</span><span class="p">.</span><span class="n">apps</span> <span class="n">import</span> <span class="n">custom_app_context</span> <span class="n">as</span> <span class="n">pwd_context</span>

<span class="n">class</span> <span class="n">User</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="p">...</span>

    <span class="n">def</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">password_hash</span> <span class="o">=</span> <span class="n">pwd_context</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">pwd_context</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">password_hash</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>The <code>verify_password()</code> method takes a plain password as argument and returns <code>True</code> if the password is correct or <code>False</code> if not. </p>
</blockquote>
<h3 id="user-registration">User Registration</h3>
<div class="hlcode"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">users</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">POST</span><span class="err">&#39;</span><span class="p">])</span>
<span class="n">def</span> <span class="n">new_user</span><span class="p">()</span><span class="o">:</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">username</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">password</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">username</span> <span class="n">is</span> <span class="n">None</span> <span class="n">or</span> <span class="n">password</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span> <span class="err">#</span> <span class="n">missing</span> <span class="n">arguments</span>
    <span class="k">if</span> <span class="n">User</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">).</span><span class="n">first</span><span class="p">()</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span> <span class="err">#</span> <span class="n">existing</span> <span class="n">user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">user</span><span class="p">.</span><span class="n">hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="err">&#39;</span><span class="n">username</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">user</span><span class="p">.</span><span class="n">username</span> <span class="p">}),</span> <span class="mi">201</span><span class="p">,</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">Location</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">url_for</span><span class="p">(</span><span class="err">&#39;</span><span class="n">get_user</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">_external</span> <span class="o">=</span> <span class="n">True</span><span class="p">)}</span>
</pre></div>


<blockquote>
<p>The <code>username</code> and <code>password</code> arguments are obtained from the JSON input coming with the request and then validated.</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">H</span> <span class="s">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;username&quot;</span><span class="o">:</span><span class="s">&quot;rick&quot;</span><span class="p">,</span><span class="s">&quot;password&quot;</span><span class="o">:</span><span class="s">&quot;python&quot;</span><span class="p">}</span><span class="err">&#39;</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:5000/api/users</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">201</span> <span class="n">CREATED</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">27</span>
<span class="nl">Location:</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:5000/api/users/1</span>
<span class="nl">Server:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9.4</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7.3</span>
<span class="nl">Date:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Nov</span> <span class="mi">2013</span> <span class="mi">19</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">39</span> <span class="n">GMT</span>

<span class="p">{</span>
  <span class="s">&quot;username&quot;</span><span class="o">:</span> <span class="s">&quot;miguel&quot;</span>
<span class="p">}</span>
</pre></div>


<h2 id="password-based-authentication">Password Based Authentication</h2>
<p>Using Flask-HTTPAuth an endpoint is protected by adding the <code>login_required</code> decorator to it</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask_httpauth</span> <span class="n">import</span> <span class="n">HTTPBasicAuth</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">resource</span><span class="err">&#39;</span><span class="p">)</span>
<span class="err">@</span><span class="n">auth</span><span class="p">.</span><span class="n">login_required</span>
<span class="n">def</span> <span class="n">get_resource</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="err">&#39;</span><span class="n">data</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Hello</span><span class="p">,</span> <span class="o">%</span><span class="n">s</span><span class="o">!</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">username</span> <span class="p">})</span>
</pre></div>


<h3 id="verify-password">Verify password</h3>
<div class="hlcode"><pre><span class="err">@</span><span class="n">auth</span><span class="p">.</span><span class="n">verify_password</span>
<span class="n">def</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span><span class="o">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">).</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">user</span> <span class="n">or</span> <span class="n">not</span> <span class="n">user</span><span class="p">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">False</span>
    <span class="n">g</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">return</span> <span class="n">True</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="n">miguel</span><span class="o">:</span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:5000/api/resource</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">30</span>
<span class="nl">Server:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9.4</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7.3</span>
<span class="nl">Date:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Nov</span> <span class="mi">2013</span> <span class="mi">20</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">25</span> <span class="n">GMT</span>

<span class="p">{</span>
  <span class="s">&quot;data&quot;</span><span class="o">:</span> <span class="s">&quot;Hello, miguel!&quot;</span>
<span class="p">}</span>


<span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="n">miguel</span><span class="o">:</span><span class="n">ruby</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:5000/api/resource</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">401</span> <span class="n">UNAUTHORIZED</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">19</span>
<span class="n">WWW</span><span class="o">-</span><span class="n">Authenticate</span><span class="o">:</span> <span class="n">Basic</span> <span class="n">realm</span><span class="o">=</span><span class="s">&quot;Authentication Required&quot;</span>
<span class="nl">Server:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9.4</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7.3</span>
<span class="nl">Date:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Nov</span> <span class="mi">2013</span> <span class="mi">20</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mi">18</span> <span class="n">GMT</span>

<span class="n">Unauthorized</span> <span class="n">Access</span>
</pre></div>


<h2 id="token-based-authentication">Token Based Authentication</h2>
<p>Tokens are usually given out with an expiration time, after which they become invalid and a new token needs to be obtained. </p>
<p>A more elaborated implementation that requires no server side storage is to use a cryptographically signed message as a token. This has the advantage that the information related to the token, namely the user for which the token was generated, is encoded in the token itself and protected against tampering with a strong cryptographic signature.</p>
<p>The token generation and verification can be implemented as additional methods in the <code>User</code> model</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">itsdangerous</span> <span class="n">import</span> <span class="p">(</span><span class="n">TimedJSONWebSignatureSerializer</span>
                          <span class="n">as</span> <span class="n">Serializer</span><span class="p">,</span> <span class="n">BadSignature</span><span class="p">,</span> <span class="n">SignatureExpired</span><span class="p">)</span>

<span class="n">class</span> <span class="n">User</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="p">...</span>

    <span class="n">def</span> <span class="n">generate_auth_token</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">expiration</span> <span class="o">=</span> <span class="mi">600</span><span class="p">)</span><span class="o">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SECRET_KEY</span><span class="err">&#39;</span><span class="p">],</span> <span class="n">expires_in</span> <span class="o">=</span> <span class="n">expiration</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span> <span class="err">&#39;</span><span class="n">id</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">id</span> <span class="p">})</span>

    <span class="err">@</span><span class="n">staticmethod</span>
    <span class="n">def</span> <span class="n">verify_auth_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SECRET_KEY</span><span class="err">&#39;</span><span class="p">])</span>
        <span class="nl">try:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">except</span> <span class="n">SignatureExpired</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">None</span> <span class="err">#</span> <span class="n">valid</span> <span class="n">token</span><span class="p">,</span> <span class="n">but</span> <span class="n">expired</span>
        <span class="n">except</span> <span class="n">BadSignature</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">None</span> <span class="err">#</span> <span class="n">invalid</span> <span class="n">token</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="err">&#39;</span><span class="n">id</span><span class="err">&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">user</span>
</pre></div>


<blockquote>
<p>In the <code>generate_auth_token()</code> method the token is an encrypted version of a dictionary that has the <code>id</code> of the user.</p>
<p>a <code>verify_auth_token()</code> static method. A static method is used because the user will only be known once the token is decoded. If the token can be decoded then the <code>id</code> encoded in it is used to load the user, and that user is returned.</p>
</blockquote>
<div class="hlcode"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">token</span><span class="err">&#39;</span><span class="p">)</span>
<span class="err">@</span><span class="n">auth</span><span class="p">.</span><span class="n">login_required</span>
<span class="n">def</span> <span class="n">get_auth_token</span><span class="p">()</span><span class="o">:</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">generate_auth_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="err">&#39;</span><span class="n">token</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">token</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">ascii</span><span class="err">&#39;</span><span class="p">)</span> <span class="p">})</span>
</pre></div>


<p>The <code>verify_password</code> callback needs to support both authentication styles</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">auth</span><span class="p">.</span><span class="n">verify_password</span>
<span class="n">def</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">username_or_token</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">first</span> <span class="n">try</span> <span class="n">to</span> <span class="n">authenticate</span> <span class="n">by</span> <span class="n">token</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">verify_auth_token</span><span class="p">(</span><span class="n">username_or_token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">user</span><span class="o">:</span>
        <span class="err">#</span> <span class="n">try</span> <span class="n">to</span> <span class="n">authenticate</span> <span class="n">with</span> <span class="n">username</span><span class="o">/</span><span class="n">password</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username_or_token</span><span class="p">).</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">user</span> <span class="n">or</span> <span class="n">not</span> <span class="n">user</span><span class="p">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">False</span>
    <span class="n">g</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">return</span> <span class="n">True</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="n">miguel</span><span class="o">:</span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:5000/api/token</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">139</span>
<span class="nl">Server:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9.4</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7.3</span>
<span class="nl">Date:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Nov</span> <span class="mi">2013</span> <span class="mi">20</span><span class="o">:</span><span class="mo">04</span><span class="o">:</span><span class="mi">15</span> <span class="n">GMT</span>

<span class="p">{</span>
  <span class="s">&quot;token&quot;</span><span class="o">:</span> <span class="s">&quot;eyJhbGciOiJIUzI1NiIsImV4cCI6MTM4NTY2OTY1NSwiaWF0IjoxMzg1NjY5MDU1fQ.eyJpZCI6MX0.XbOEFJkhjHJ5uRINh2JA1BPzXjSohKYDRT472wGOvjc&quot;</span>

<span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="n">eyJhbGciOiJIUzI1NiIsImV4cCI6MTM4NTY2OTY1NSwiaWF0IjoxMzg1NjY5MDU1fQ</span><span class="p">.</span><span class="n">eyJpZCI6MX0</span><span class="p">.</span><span class="n">XbOEFJkhjHJ5uRINh2JA1BPzXjSohKYDRT472wGOvjc</span><span class="o">:</span><span class="n">unused</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:5000/api/resource</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">30</span>
<span class="nl">Server:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9.4</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7.3</span>
<span class="nl">Date:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Nov</span> <span class="mi">2013</span> <span class="mi">20</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">08</span> <span class="n">GMT</span>

<span class="p">{</span>
  <span class="s">&quot;data&quot;</span><span class="o">:</span> <span class="s">&quot;Hello, miguel!&quot;</span>
<span class="p">}</span>
</pre></div>


<h2 id="oauth-authentication">OAuth Authentication</h2>
<p>OAuth is most commonly used to allow an application (the <em>consumer</em>) to access data or services that the user (the <em>resource owner</em>) has with another service (the <em>provider</em>), and this is done in a way that prevents the consumer from knowing the login credentials that the user has with the provider</p>
<p>For example, consider a website or application that asks you for permission to access your Facebook account and post something to your timeline. In this example you are the resource holder (you own your Facebook timeline), the third party application is the consumer and Facebook is the provider. Even if you grant access and the consumer application writes to your timeline, it never sees your Facebook login information.</p>
<p>https://oauth.net/code/</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>