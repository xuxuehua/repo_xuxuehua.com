<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>circleci - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Tools">Tools</a>&nbsp;&#187;&nbsp;circleci
    <span class="updated">Page Updated&nbsp;
      2020-06-14 11:44
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">circleci</div>

  <p>[toc]</p>
<h1 id="circleci">circleci</h1>
<p><img alt="image-20200614114945907" src="circleci.assets/image-20200614114945907.png" /></p>
<h2 id="_1">特点</h2>
<p>通过workflows编排强大的控制执行能力</p>
<p>一流的docker支持（支持运行任意的公共或私服docker仓库、通过executor自定义编排到job中、支持layer缓存等等）</p>
<p>支持自定义CPU/RAM</p>
<p>无论什么语言都可运行</p>
<p>强大的缓存能力</p>
<p>通过ssh或者本地build可以非常简单上手的debug</p>
<p>强大的安全保障</p>
<p>丰富的CI/CD数据视图</p>
<h2 id="hello-world">hello world</h2>
<p>通过workfows编排任务，并且内置了多种功能强大的step，包括run（自定义脚本）、checkout（下载代码）、save_cache／restore_cache（保存和恢复缓存）、store_artifacts／store_test_results（产物存储）等多种能力。</p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="err">#</span><span class="mi">1</span><span class="o">.</span><span class="err">定义运行的环境</span><span class="o">,</span><span class="err">这里是包含</span><span class="n">jdk8</span><span class="err">的一个</span><span class="n">image</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">openjdk</span><span class="o">:</span><span class="mi">8</span><span class="o">-</span><span class="n">jdk</span>

    <span class="err">#</span><span class="mi">2</span><span class="o">.</span><span class="err">设置</span><span class="n">step</span><span class="err">共享的工作目录</span><span class="o">(</span><span class="n">step</span><span class="err">脚本相对这个目录执行</span><span class="o">)</span>
    <span class="n">working_directory</span><span class="o">:</span> <span class="o">~/</span><span class="n">circleci</span><span class="o">-</span><span class="n">demo</span>

        <span class="err">#</span><span class="mi">3</span><span class="o">.</span><span class="err">定义</span><span class="n">job</span><span class="err">级别的环境变量</span><span class="o">,</span><span class="err">所有</span><span class="n">step</span><span class="err">共享</span>
    <span class="n">environment</span><span class="o">:</span>
      <span class="n">JVM_OPTS</span><span class="o">:</span> <span class="o">-</span><span class="n">Xmx3200m</span>
      <span class="n">MVN_ARGS</span><span class="o">:</span> <span class="o">-</span><span class="n">Dmaven</span><span class="o">.</span><span class="na">repo</span><span class="o">.</span><span class="na">local</span><span class="o">=.</span><span class="n">repo</span>

        <span class="err">#</span><span class="mi">4</span><span class="o">.</span><span class="na">steps</span>
    <span class="n">steps</span><span class="o">:</span>
        <span class="err">#</span><span class="mf">4.1</span> <span class="err">下载代码</span>
      <span class="o">-</span> <span class="n">checkout</span>

      <span class="err">#</span><span class="mf">4.2</span> <span class="err">拉取</span><span class="n">maven</span><span class="err">缓存</span>
      <span class="o">-</span> <span class="n">restore_cache</span><span class="o">:</span>
          <span class="n">keys</span><span class="o">:</span>
              <span class="err">#</span> <span class="n">cachae</span> <span class="n">key</span><span class="o">,</span> <span class="err">仅当</span><span class="n">pom</span><span class="o">.</span><span class="na">xml</span><span class="err">文件的校验和和上次一样（也就是没有变更）才会更新</span>
            <span class="o">-</span> <span class="n">v1</span><span class="o">-</span><span class="n">dependencies</span><span class="o">-{{</span> <span class="n">checksum</span> <span class="s2">&quot;pom.xml&quot;</span> <span class="o">}}</span> <span class="err">#</span>
            <span class="err">#</span> <span class="err">如果上面的</span><span class="n">key</span><span class="err">失效用这个</span><span class="n">key</span><span class="err">代替</span>
            <span class="o">-</span> <span class="n">v1</span><span class="o">-</span><span class="n">dependencies</span><span class="o">-</span>

            <span class="err">#</span><span class="mf">4.3</span> <span class="err">打包</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">mvn</span> <span class="n">clean</span> <span class="n">install</span> <span class="k">package</span> <span class="nn">$</span><span class="o">{</span><span class="n">MVN_ARGS</span><span class="o">}</span>

            <span class="err">#</span><span class="mf">4.4</span> <span class="err">上传缓存</span>
      <span class="o">-</span> <span class="n">save_cache</span><span class="o">:</span>
              <span class="err">#缓存目录</span>
          <span class="n">paths</span><span class="o">:</span>
            <span class="o">-</span>  <span class="o">.</span><span class="na">repo</span>
          <span class="err">#换粗</span><span class="n">key</span><span class="err">，仅当</span><span class="n">pom</span><span class="o">.</span><span class="na">xml</span><span class="err">发生变更才更新</span>
          <span class="n">key</span><span class="o">:</span> <span class="n">v1</span><span class="o">-</span><span class="n">dependencies</span><span class="o">-{{</span> <span class="n">checksum</span> <span class="s2">&quot;pom.xml&quot;</span> <span class="o">}}</span>

          <span class="err">#</span><span class="mf">4.5</span> <span class="err">上传产物</span><span class="o">(</span><span class="err">编译</span><span class="n">jar</span><span class="o">)</span>
      <span class="o">-</span> <span class="n">store_artifacts</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="n">target</span><span class="o">/</span>
          <span class="n">destination</span><span class="o">:</span> <span class="n">circleci</span><span class="o">-</span><span class="n">demo</span><span class="o">-</span><span class="n">jar</span>

            <span class="err">#</span><span class="mf">4.6</span> <span class="err">将</span><span class="n">workspace</span><span class="err">临时存储下来，供</span><span class="n">workflow</span><span class="err">下的其他</span><span class="n">job</span><span class="err">复用</span>
      <span class="o">-</span> <span class="n">persist_to_workspace</span><span class="o">:</span>
          <span class="n">root</span><span class="o">:</span> <span class="o">~/</span>
          <span class="n">paths</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">circleci</span><span class="o">-</span><span class="n">demo</span>



<span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">jobs</span><span class="o">:</span>
  <span class="n">test</span><span class="o">:</span>
      <span class="err">#</span><span class="mi">1</span><span class="o">.</span><span class="err">定义运行的环境</span><span class="o">,</span><span class="err">这里是包含</span><span class="n">jdk8</span><span class="err">的一个</span><span class="n">image</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">openjdk</span><span class="o">:</span><span class="mi">8</span><span class="o">-</span><span class="n">jdk</span>
    <span class="err">#</span><span class="mi">2</span><span class="o">.</span><span class="err">设置</span><span class="n">step</span><span class="err">共享的工作目录</span><span class="o">(</span><span class="n">step</span><span class="err">脚本相对这个目录执行</span><span class="o">)</span>
    <span class="n">working_directory</span><span class="o">:</span> <span class="o">~/</span><span class="n">circleci</span><span class="o">-</span><span class="n">demo</span>

        <span class="err">#</span><span class="mi">3</span><span class="o">.</span><span class="err">定义</span><span class="n">job</span><span class="err">级别的环境变量</span><span class="o">,</span><span class="err">所有</span><span class="n">step</span><span class="err">共享</span>
    <span class="n">environment</span><span class="o">:</span>
      <span class="n">JVM_OPTS</span><span class="o">:</span> <span class="o">-</span><span class="n">Xmx3200m</span>
      <span class="n">MVN_ARGS</span><span class="o">:</span> <span class="o">-</span><span class="n">Dmaven</span><span class="o">.</span><span class="na">repo</span><span class="o">.</span><span class="na">local</span><span class="o">=.</span><span class="n">repo</span>

        <span class="err">#</span><span class="mi">4</span><span class="o">.</span><span class="na">steps</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="err">#</span><span class="mf">4.1</span> <span class="err">将</span><span class="n">build</span><span class="err">临时保留的</span><span class="n">workspace</span><span class="err">恢复到</span><span class="n">job</span><span class="err">中</span>
      <span class="o">-</span> <span class="n">attach_workspace</span><span class="o">:</span>
          <span class="n">at</span><span class="o">:</span> <span class="o">~/</span><span class="n">circleci</span><span class="o">-</span><span class="n">demo</span>

            <span class="err">#</span><span class="mf">4.2</span><span class="err">执行</span><span class="n">mvn</span> <span class="n">test</span><span class="err">测试脚本</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="o">|</span> 
          <span class="n">cd</span> <span class="n">circleci</span><span class="o">-</span><span class="n">demo</span>
          <span class="n">mvn</span> <span class="n">clean</span> <span class="n">test</span> <span class="n">$</span><span class="o">{</span><span class="n">MVN_ARGS</span><span class="o">}</span>
            <span class="err">#</span><span class="mf">4.3</span> <span class="err">上传测试产物</span>
      <span class="o">-</span> <span class="n">store_test_results</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="n">circleci</span><span class="o">-</span><span class="n">demo</span><span class="sr">/target/s</span><span class="n">urefire</span><span class="o">-</span><span class="n">reports</span>




<span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">jobs</span><span class="o">:</span>       
  <span class="n">deploy</span><span class="o">-</span><span class="n">site1</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">openjdk</span><span class="o">:</span><span class="mi">8</span><span class="o">-</span><span class="n">jdk</span> 
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="s1">&#39;deploy sit1&#39;</span>
  <span class="n">deploy</span><span class="o">-</span><span class="n">site2</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">openjdk</span><span class="o">:</span><span class="mi">8</span><span class="o">-</span><span class="n">jdk</span> 
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="s1">&#39;deploy sit2&#39;</span> 


<span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">workflows</span><span class="o">:</span>
  <span class="err">#</span><span class="mi">1</span><span class="o">.</span> <span class="n">workflow</span><span class="err">版本</span>
  <span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
  <span class="err">#</span><span class="mi">2</span><span class="o">.</span> <span class="n">workflow</span> <span class="err">名称</span>
  <span class="n">circleci</span><span class="o">-</span><span class="n">demo</span><span class="o">-</span><span class="n">workflow</span><span class="o">:</span>
    <span class="err">#</span><span class="mf">2.1</span> <span class="n">jobs</span>
    <span class="n">jobs</span><span class="o">:</span>
      <span class="err">#</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span> <span class="n">build</span> <span class="n">job</span><span class="err">，仅在</span><span class="n">master</span><span class="err">分支触发</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">:</span>
          <span class="n">filters</span><span class="o">:</span>
            <span class="n">branches</span><span class="o">:</span>
              <span class="n">only</span><span class="o">:</span> <span class="n">master</span>

      <span class="err">#</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">2</span> <span class="n">build</span> <span class="n">job</span><span class="err">，仅在</span><span class="n">master</span><span class="err">分支触发</span><span class="o">,</span><span class="err">依赖</span><span class="n">build</span> <span class="n">job</span>
      <span class="o">-</span> <span class="n">test</span><span class="o">:</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">build</span>

      <span class="err">#</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">3</span> <span class="err">手动确认</span><span class="n">job</span><span class="err">，依赖</span><span class="n">test</span> <span class="n">job</span>
      <span class="o">-</span> <span class="n">approval</span><span class="o">-</span><span class="n">deploy</span><span class="o">:</span>
          <span class="n">type</span><span class="o">:</span> <span class="n">approval</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">test</span>
      <span class="err">#</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">4</span> <span class="err">发布</span><span class="n">job</span><span class="err">，依赖</span><span class="n">approval</span><span class="o">-</span><span class="n">deploy</span> <span class="n">job</span><span class="o">,</span> <span class="err">和</span><span class="n">deploy</span><span class="o">-</span><span class="n">site2</span><span class="err">并发执行</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">-</span><span class="n">site1</span><span class="o">:</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">approval</span><span class="o">-</span><span class="n">deploy</span>
          <span class="n">filters</span><span class="o">:</span>
            <span class="n">branches</span><span class="o">:</span>
              <span class="n">only</span><span class="o">:</span> <span class="n">master</span>

      <span class="err">#</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">5</span> <span class="err">发布</span><span class="n">job</span><span class="err">，依赖</span><span class="n">approval</span><span class="o">-</span><span class="n">deploy</span> <span class="n">job</span><span class="o">,</span> <span class="err">和</span><span class="n">deploy</span><span class="o">-</span><span class="n">site1</span><span class="err">并发执行</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">-</span><span class="n">site2</span><span class="o">:</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">approval</span><span class="o">-</span><span class="n">deploy</span>
          <span class="n">filters</span><span class="o">:</span>
            <span class="n">branches</span><span class="o">:</span>
              <span class="n">only</span><span class="o">:</span> <span class="n">master</span>      
</pre></div>


<h1 id="_2">组件</h1>
<h2 id="executors">Executors 执行器</h2>
<p>CircleCI设计了executors，支持将job调度到不同类型的执行器上，包括Docker、Linux、Mac、GPU等等</p>
<table>
<thead>
<tr>
<th>executor</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker</td>
<td>通过image执行镜像</td>
</tr>
<tr>
<td>machine</td>
<td>包括linux、unbuntu等</td>
</tr>
<tr>
<td>macos</td>
<td>macos，支持指定os版本</td>
</tr>
<tr>
<td>windows</td>
<td>通过虚拟机运行</td>
</tr>
</tbody>
</table>
<ul>
<li>运行在ubuntu上</li>
</ul>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">machine</span><span class="o">:</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">:</span><span class="mi">201903</span><span class="o">-</span><span class="mi">01</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">checkout</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="s2">&quot;Testing&quot;</span>
          <span class="n">command</span><span class="o">:</span> <span class="n">echo</span> <span class="s2">&quot;Hi&quot;</span>
</pre></div>


<ul>
<li>运行在mac上</li>
</ul>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">macos</span><span class="o">:</span>
      <span class="n">xcode</span><span class="o">:</span> <span class="s2">&quot;11.3.0&quot;</span>
</pre></div>


<h2 id="orbs">orbs 集成能力</h2>
<p>orb是一个可重用的YAML配置包，它将重复的配置压缩成一行代码，包含了jobs、command、executors等等的一个大集合，通过orbs集成了非常丰富（nb）的工具链，集成方包括：AWS、 Azure、ConfigCat、Docker Hub、Google Cloud、Helm等等。</p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">orbs</span><span class="o">:</span>
    <span class="err">#这里的</span><span class="n">hello</span><span class="err">是</span><span class="n">orbs</span><span class="err">的一个引用</span><span class="o">,</span> <span class="n">hello</span><span class="err">等价于</span><span class="n">circleci</span><span class="o">/</span><span class="n">hello</span><span class="o">-</span><span class="n">build</span><span class="err">@</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">5</span>
    <span class="n">hello</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">hello</span><span class="o">-</span><span class="n">build</span><span class="err">@</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">workflows</span><span class="o">:</span>
    <span class="s2">&quot;Hello Workflow&quot;</span><span class="o">:</span>
        <span class="n">jobs</span><span class="o">:</span>
           <span class="err">#</span><span class="n">hello</span><span class="err">等价于</span><span class="n">circleci</span><span class="o">/</span><span class="n">hello</span><span class="o">-</span><span class="n">build</span><span class="err">@</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">5</span><span class="err">，</span><span class="n">hello</span><span class="o">-</span><span class="n">build</span><span class="err">是它的一个</span><span class="n">job</span>
          <span class="o">-</span> <span class="n">hello</span><span class="o">/</span><span class="n">hello</span><span class="o">-</span><span class="n">build</span> 
</pre></div>


<h1 id="yaml">Yaml</h1>
<p>yaml本质是一个map，CircleCI yaml中包含了非常多的key-value对象</p>
<p>yaml语法：根key、jobs key、steps key，它们至今依次是上下级的关系</p>
<p>circleci的yaml文件存储位置(相对代码根目录)：.circleci/config.yml</p>
<div class="hlcode"><pre><span class="err">代码根目录</span>
<span class="err">├──</span> <span class="p">.</span><span class="n">circleci</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">config</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<h2 id="version">version</h2>
<p>定义pipeline的yaml版本，用于发出弃用或破坏更改的警告</p>
<h2 id="orbs-require-21">orbs (require 2.1)</h2>
<p>orb是一个可重用的YAML配置包，它将重复的配置压缩成一行代码<br />
    可以帮助自动化重复的过程，加速项目设置，并使其易于与第三方工具集成</p>
<p>orbs是一个集合的大招了，它是包含了jobs、commands、executors甚至以后还会扩展更多的整体集合</p>
<p>orgs仓库，https://circleci.com/orbs/registry/</p>
<h2 id="commands-require-21">commands (require 2.1)</h2>
<p>commands其实就是一堆step的集合，主要作用就是让多个step合并成一个，并在job中可以直接调用，有点封装的意思</p>
<p>commands内主要包含了三个key：</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Required</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>steps</td>
<td>Y</td>
<td>Sequence</td>
<td>在调用job时运行的一系列step集合</td>
</tr>
<tr>
<td>parameters</td>
<td>N</td>
<td>Map</td>
<td>参数，一个map集合</td>
</tr>
<tr>
<td>description</td>
<td>N</td>
<td>String</td>
<td>command描述</td>
</tr>
</tbody>
</table>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">commands</span><span class="o">:</span>
  <span class="n">sayhello</span><span class="o">:</span> <span class="err">#一个</span><span class="n">command</span><span class="err">其实就是包含一个或多个</span><span class="n">step</span><span class="err">的集合，这个值会作为</span><span class="n">key</span><span class="err">在</span><span class="n">jobs</span><span class="err">中使用</span>
    <span class="n">description</span><span class="o">:</span> <span class="s2">&quot;A very simple command for demonstration purposes&quot;</span>
    <span class="n">parameters</span><span class="o">:</span>
      <span class="n">to</span><span class="o">:</span>
        <span class="n">type</span><span class="o">:</span> <span class="n">string</span>
        <span class="k">default</span><span class="o">:</span> <span class="s2">&quot;Hello World&quot;</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="o">&lt;&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="na">to</span> <span class="o">&gt;&gt;</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="n">haha</span>
<span class="n">jobs</span><span class="o">:</span>
    <span class="n">hello</span><span class="o">-</span><span class="n">job</span><span class="o">:</span>
      <span class="n">steps</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">sayhello</span> <span class="err">#这里可以引用一个</span><span class="n">command</span>
</pre></div>


<h2 id="parameters-require-21">parameters (require 2.1)</h2>
<p>全局参数，和Jenkins中的全局参数一样，不过CircleCI不光在根key中支持parameters，在commands里也支持了</p>
<p>全局parameters</p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">parameters</span><span class="o">:</span>
  <span class="n">image</span><span class="o">-</span><span class="n">tag</span><span class="o">:</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">string</span>
    <span class="k">default</span><span class="o">:</span> <span class="s2">&quot;latest&quot;</span>
  <span class="n">workingdir</span><span class="o">:</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">string</span>
    <span class="k">default</span><span class="o">:</span> <span class="s2">&quot;~/main&quot;</span>
</pre></div>


<p>commands的parameters</p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">commands</span><span class="o">:</span>
  <span class="n">sayhello</span><span class="o">:</span> 
    <span class="n">description</span><span class="o">:</span> <span class="s2">&quot;A very simple command for demonstration purposes&quot;</span>
    <span class="n">parameters</span><span class="o">:</span> <span class="err">#这里的作用范围仅针对本</span><span class="n">command</span><span class="err">的</span><span class="n">step</span>
      <span class="n">to</span><span class="o">:</span>
        <span class="n">type</span><span class="o">:</span> <span class="n">string</span>
        <span class="k">default</span><span class="o">:</span> <span class="s2">&quot;Hello World&quot;</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="o">&lt;&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="na">to</span> <span class="o">&gt;&gt;</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="n">haha</span>
<span class="n">jobs</span><span class="o">:</span>
    <span class="n">hello</span><span class="o">-</span><span class="n">job</span><span class="o">:</span>
      <span class="n">steps</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">sayhello</span> <span class="err">#这里可以引用一个</span><span class="n">command</span>
</pre></div>


<h2 id="executors-require-21">executors (require 2.1)</h2>
<p>executors作用是定义一堆执行环境集，每个executor都是一个执行环境，比如docker、mac、windows啥的，在jobs中，每个job可以通过executor引用一个执行环境并运行</p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">executors</span><span class="o">:</span>
  <span class="n">my</span><span class="o">-</span><span class="n">executor</span><span class="o">:</span> <span class="err">#</span><span class="n">executor</span><span class="err">的</span><span class="n">key</span><span class="err">，</span><span class="n">job</span><span class="err">中的</span><span class="n">executor</span><span class="err">可以通过这个</span><span class="n">key</span><span class="err">引用，从而来指定</span><span class="n">job</span><span class="err">的执行环境</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">ruby</span><span class="o">:</span><span class="mf">2.5</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">browsers</span>

<span class="n">jobs</span><span class="o">:</span>
  <span class="n">my</span><span class="o">-</span><span class="n">job</span><span class="o">:</span>
    <span class="n">executor</span><span class="o">:</span> <span class="n">my</span><span class="o">-</span><span class="n">executor</span> <span class="err">#这里引用</span><span class="n">executors</span><span class="err">的</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="n">my</span><span class="o">-</span><span class="n">executor</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">echo</span> <span class="n">outside</span> <span class="n">the</span> <span class="n">executor</span>
</pre></div>


<blockquote>
<p>这里面定义了一个executor,名字叫my-executor，实际是一个image，在job中通过executor: my-executor引用这个执行环境</p>
</blockquote>
<p>在CircleCI的executors中一共有7种不同类型的executor</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Required</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker</td>
<td>Y</td>
<td>List</td>
<td>docker 执行器</td>
</tr>
<tr>
<td>resource_class</td>
<td>N</td>
<td>String</td>
<td>cpu，ram，disk资产配置</td>
</tr>
<tr>
<td>machine</td>
<td>Y</td>
<td>Map</td>
<td>machine执行器</td>
</tr>
<tr>
<td>macos</td>
<td>Y</td>
<td>Map</td>
<td>mac执行器</td>
</tr>
<tr>
<td>windows</td>
<td>Y</td>
<td>Map</td>
<td>windows执行器</td>
</tr>
<tr>
<td>shell</td>
<td>N</td>
<td>String</td>
<td>自定义shell</td>
</tr>
<tr>
<td>working_directory</td>
<td>N</td>
<td>String</td>
<td>执行steps的工作目录</td>
</tr>
</tbody>
</table>
<h3 id="docker">docker</h3>
<p><img alt="img" src="circleci.assets/640.png" /></p>
<h3 id="machine">machine</h3>
<p><img alt="img" src="circleci.assets/640-20200614122854803.png" /></p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">machine</span><span class="o">:</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">:</span><span class="mi">201903</span><span class="o">-</span><span class="mi">01</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">checkout</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="s2">&quot;Testing&quot;</span>
          <span class="n">command</span><span class="o">:</span> <span class="n">echo</span> <span class="s2">&quot;Hi&quot;</span>
</pre></div>


<h2 id="workflows">workflows</h2>
<p>定义Job编排逻辑</p>
<p>从概念上来看，CircleCI的Pipeline和workflows是同级别的对应关系，都代表一个流水线，在CircleCI中，一个Pipeline(workflows)可能包含一个或多个workflow。</p>
<p>与业界Jenkins、Github actions、TravisCI等CI产品不同的是，CircleCI单独用workflows来描述编排逻辑。</p>
<p>对于使用者来说，相对于之前编排逻辑都写在job里，这种方式看起来更加清晰直观，修改起来也比较方便<br />
支持同时并发配置多个workflow<br />
减少workflow功能升级对job定义的影响</p>
<h3 id="triggers">triggers</h3>
<p>workflows的触发条件，默认是代码push触发</p>
<div class="hlcode"><pre><span class="n">workflows</span><span class="o">:</span>
   <span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
   <span class="n">nightly</span><span class="o">:</span>
     <span class="n">triggers</span><span class="o">:</span>
       <span class="o">-</span> <span class="n">schedule</span><span class="o">:</span>
           <span class="n">cron</span><span class="o">:</span> <span class="s2">&quot;0 0 * * *&quot;</span>
           <span class="n">filters</span><span class="o">:</span>
             <span class="n">branches</span><span class="o">:</span>
               <span class="n">only</span><span class="o">:</span>
                 <span class="o">-</span> <span class="n">master</span>
                 <span class="o">-</span> <span class="n">beta</span>
     <span class="n">jobs</span><span class="o">:</span>
       <span class="o">-</span> <span class="n">test</span>
</pre></div>


<h2 id="jobs">jobs</h2>
<p>一堆job的集合，job是circleci的pipeline中实际运行的一个执行节点，内部包含了最小的运行单位step，</p>
<h3 id="requires">requires</h3>
<p>声明依赖的job</p>
<div class="hlcode"><pre>      <span class="o">-</span> <span class="n">test</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">:</span>
          <span class="nl">requires:</span>
            <span class="o">-</span> <span class="n">hold</span>
</pre></div>


<h3 id="context">context</h3>
<p>在CircleCI组织中设置的全局环境变量</p>
<p><img alt="image-20200614122041056" src="circleci.assets/image-20200614122041056.png" /></p>
<h3 id="type">type</h3>
<p>job类型</p>
<div class="hlcode"><pre>       <span class="err">#手动确认</span><span class="n">job</span>
      <span class="o">-</span> <span class="n">hold</span><span class="o">:</span>
          <span class="nl">type:</span> <span class="n">approval</span>
          <span class="nl">requires:</span>
            <span class="o">-</span> <span class="n">test1</span>
            <span class="o">-</span> <span class="n">test2</span>
      <span class="err">#</span><span class="n">deploy</span> <span class="n">job</span> <span class="err">依赖手动确认</span><span class="n">approval</span> <span class="n">job</span><span class="err">执行</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">:</span>
          <span class="nl">requires:</span>
            <span class="o">-</span> <span class="n">hold</span>
</pre></div>


<h3 id="filters">filters</h3>
<p>job的执行条件（通过分支过滤）</p>
<div class="hlcode"><pre>      <span class="err">#</span><span class="n">build</span> <span class="n">job</span><span class="err">，仅在</span><span class="n">master</span><span class="err">分支触发</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">:</span>
          <span class="nl">filters:</span>
            <span class="nl">branches:</span>
              <span class="nl">only:</span> <span class="n">master</span>
</pre></div>


<h3 id="matrix">matrix</h3>
<p>一次性生成多个job</p>
<div class="hlcode"><pre><span class="n">workflows</span><span class="o">:</span>
  <span class="n">workflow</span><span class="o">:</span>
    <span class="n">jobs</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">build</span><span class="o">-</span><span class="n">v</span><span class="o">&lt;&lt;</span> <span class="n">matrix</span><span class="o">.</span><span class="na">version</span> <span class="o">&gt;&gt;</span>
          <span class="n">matrix</span><span class="o">:</span>
            <span class="n">parameters</span><span class="o">:</span>
              <span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;0.1&quot;</span><span class="o">,</span> <span class="s2">&quot;0.2&quot;</span><span class="o">]</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">deploy</span><span class="o">-</span><span class="n">v</span><span class="o">&lt;&lt;</span> <span class="n">matrix</span><span class="o">.</span><span class="na">version</span> <span class="o">&gt;&gt;</span>
          <span class="n">matrix</span><span class="o">:</span>
            <span class="n">parameters</span><span class="o">:</span>
              <span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;0.1&quot;</span><span class="o">,</span> <span class="s2">&quot;0.2&quot;</span><span class="o">]</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">build</span><span class="o">-</span><span class="n">v</span><span class="o">&lt;&lt;</span> <span class="n">matrix</span><span class="o">.</span><span class="na">version</span> <span class="o">&gt;&gt;</span>
</pre></div>


<ul>
<li>最终实际的workflow将被扩展成这样</li>
</ul>
<div class="hlcode"><pre><span class="n">workflows</span><span class="o">:</span>
  <span class="n">workflow</span><span class="o">:</span>
    <span class="n">jobs</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">build</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mi">1</span>
          <span class="n">version</span><span class="o">:</span> <span class="mf">0.1</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">build</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mi">2</span>
          <span class="n">version</span><span class="o">:</span> <span class="mf">0.2</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">deploy</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mi">1</span>
          <span class="n">version</span><span class="o">:</span> <span class="mf">0.1</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">build</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mi">1</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">deploy</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mi">2</span>
          <span class="n">version</span><span class="o">:</span> <span class="mf">0.2</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">build</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mi">2</span>
</pre></div>


<h3 id="environment">environment</h3>
<p>全局的环境变量，数据结构是key、value的map，这些将覆盖您在CircleCI应用程序中设置的所有环境变量，<strong>优先级最高</strong></p>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">buildpack</span><span class="o">-</span><span class="n">deps</span><span class="o">:</span><span class="n">trusty</span>
    <span class="n">environment</span><span class="o">:</span>
      <span class="n">FOO</span><span class="o">:</span> <span class="n">bar</span>
</pre></div>


<h3 id="parallelism">parallelism</h3>
<p>step并发数</p>
<p>将step里的run并发执行三次，每个脚本的参数通过“ circleci tests split”去切分</p>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">buildpack</span><span class="o">-</span><span class="n">deps</span><span class="o">:</span><span class="n">trusty</span>
    <span class="n">environment</span><span class="o">:</span>
      <span class="n">FOO</span><span class="o">:</span> <span class="n">bar</span>
    <span class="n">parallelism</span><span class="o">:</span> <span class="mi">3</span>
    <span class="n">resource_class</span><span class="o">:</span> <span class="n">large</span>
    <span class="n">working_directory</span><span class="o">:</span> <span class="o">~/</span><span class="n">my</span><span class="o">-</span><span class="n">app</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">go</span> <span class="n">test</span> <span class="o">-</span><span class="n">v</span> <span class="n">$</span><span class="o">(</span><span class="n">go</span> <span class="n">list</span> <span class="o">./...</span> <span class="o">|</span> <span class="n">circleci</span> <span class="n">tests</span> <span class="n">split</span><span class="o">)</span>
</pre></div>


<h3 id="branches">branches</h3>
<p>这个配置主要作用通过分支的匹配来限制job是否执行</p>
<p>branches的子key有以下2个</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Required</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>only</td>
<td>N</td>
<td>List</td>
<td>仅仅执行的分支</td>
</tr>
<tr>
<td>ignore</td>
<td>N</td>
<td>List</td>
<td>忽略执行的分支</td>
</tr>
</tbody>
</table>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">branches</span><span class="o">:</span>
      <span class="err">#这个配置：仅</span><span class="n">master</span><span class="err">和正则匹配</span><span class="n">rc</span><span class="o">-.*</span><span class="err">的分支才会执行</span>
      <span class="n">only</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">master</span>
        <span class="o">-</span> <span class="sr">/rc-.*/</span>
<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">branches</span><span class="o">:</span>
      <span class="n">ignore</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">develop</span>
        <span class="o">-</span> <span class="sr">/feature-.*/</span>
</pre></div>


<h3 id="resource_class">resource_class</h3>
<p>为每个job配置CUP和RAM(内存)<br />
一共有6种不同类型的执行器，不同的执行器有不同的resource_class配置</p>
<h4 id="docker-executor">Docker Executor</h4>
<p><img alt="img" src="circleci.assets/640-20200614163423664.png" /></p>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">buildpack</span><span class="o">-</span><span class="n">deps</span><span class="o">:</span><span class="n">trusty</span>
    <span class="n">resource_class</span><span class="o">:</span> <span class="n">xlarge</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">...</span> <span class="c1">// other config</span>
</pre></div>


<h4 id="machine-executor-linux">Machine Executor (Linux)</h4>
<p><img alt="image-20200614163545468" src="circleci.assets/image-20200614163545468.png" /></p>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">machine</span><span class="o">:</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">:</span><span class="mi">201903</span><span class="o">-</span><span class="mi">01</span> <span class="err">#</span> <span class="n">recommended</span> <span class="n">linux</span> <span class="n">image</span> <span class="o">-</span> <span class="n">includes</span> <span class="n">Ubuntu</span> <span class="mf">16.04</span><span class="o">,</span> <span class="n">docker</span> <span class="mf">18.09</span><span class="o">.</span><span class="mi">3</span><span class="o">,</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="mf">1.23</span><span class="o">.</span><span class="mi">1</span>
    <span class="n">resource_class</span><span class="o">:</span> <span class="n">large</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">...</span> <span class="c1">// other config</span>
</pre></div>


<h4 id="macos-executor">MacOS Executor</h4>
<p>mac只有这两个配置（Mac比较贵，这也是mac官方的配置）</p>
<p><img alt="img" src="circleci.assets/640-20200614163616134.png" /></p>
<div class="hlcode"><pre><span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">macos</span><span class="o">:</span>
      <span class="n">xcode</span><span class="o">:</span> <span class="s2">&quot;11.3.0&quot;</span>
    <span class="n">resource_class</span><span class="o">:</span> <span class="n">large</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">...</span> <span class="c1">// other config</span>
</pre></div>


<h4 id="windows-executor">Windows Executor</h4>
<p><img alt="img" src="circleci.assets/640-20200614163645559.png" /></p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>

<span class="n">orbs</span><span class="o">:</span>
  <span class="n">win</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">windows</span><span class="err">@</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">0</span>

<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">executor</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">win</span><span class="o">/</span><span class="k">default</span>
      <span class="n">size</span><span class="o">:</span> <span class="s2">&quot;medium&quot;</span> <span class="err">#</span> <span class="n">can</span> <span class="n">be</span> <span class="s2">&quot;medium&quot;</span><span class="o">,</span> <span class="s2">&quot;large&quot;</span><span class="o">,</span> <span class="s2">&quot;xlarge&quot;</span><span class="o">,</span> <span class="s2">&quot;2xlarge&quot;</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">Write</span><span class="o">-</span><span class="n">Host</span> <span class="s1">&#39;Hello, Windows&#39;</span>
</pre></div>


<blockquote>
<p>windows和其他executor的resource设置方式不一样是因为，windows是一种orb, 资源配置是其一个参数</p>
</blockquote>
<h4 id="gpu-executor-linux">GPU Executor (Linux)</h4>
<p><img alt="img" src="circleci.assets/640-20200614163803731.png" /></p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>

<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">machine</span><span class="o">:</span>
      <span class="n">resource_class</span><span class="o">:</span> <span class="n">gpu</span><span class="o">.</span><span class="na">nvidia</span><span class="o">.</span><span class="na">small</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">-</span><span class="n">cuda</span><span class="o">-</span><span class="mf">10.1</span><span class="o">:</span><span class="mi">201909</span><span class="o">-</span><span class="mi">23</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">gpus</span> <span class="n">all</span> <span class="n">nvidia</span><span class="o">/</span><span class="n">cuda</span><span class="o">:</span><span class="mf">9.0</span><span class="o">-</span><span class="n">base</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span>
</pre></div>


<h4 id="gpu-executor-windows">GPU Executor (Windows)</h4>
<p><img alt="img" src="circleci.assets/640-20200614163822828.png" /></p>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mf">2.1</span>
<span class="n">orbs</span><span class="o">:</span>
  <span class="n">win</span><span class="o">:</span> <span class="n">circleci</span><span class="o">/</span><span class="n">windows</span><span class="err">@</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">0</span>

<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">executor</span><span class="o">:</span> <span class="n">win</span><span class="o">/</span><span class="n">gpu</span><span class="o">-</span><span class="n">nvidia</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">checkout</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="s1">&#39;&amp;&quot;C:\Program Files\NVIDIA Corporation\NVSMI\nvidia-smi.exe&quot;&#39;</span>
</pre></div>


<h2 id="steps">steps</h2>
<p>CircleCI的缓存通过一个内置step为用户提供，通过唯一key去更新和恢复缓存，值得一提的是，CircleCI扩展了{{ cheksum }}、{{ arch }}去设定缓存生效和更新时机。</p>
<p>CircleCI的缓存可以支持在不同job之间切换，缓存是否失效或覆盖更新这些细节问题，都是交给用户去决定</p>
<h3 id="run">run</h3>
<p>执行自定义脚本<br />
有8个参数，其中command必填，其他选填</p>
<p><img alt="image-20200614164224456" src="circleci.assets/image-20200614164224456.png" /></p>
<p>脚本超时时间（除了output），值是一个字符串，例如“<code>20m</code>”, “<code>1.25h</code>”, “<code>5s</code>” (默认: <code>10m</code>) |<br />
| 8 | when | N | String | 指定在什么情况下执行step，有以下值：<code>always</code>, <code>on_success</code>, <code>on_fail</code> (默认: <code>on_success</code>) </p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">run</span><span class="o">:</span>
    <span class="nl">command:</span> <span class="o">|</span>
      <span class="n">echo</span> <span class="n">Running</span> <span class="n">test</span>
      <span class="n">set</span> <span class="o">+</span><span class="n">e</span>
      <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">results</span>
      <span class="n">make</span> <span class="n">test</span>

<span class="o">-</span> <span class="n">run</span><span class="o">:</span>
    <span class="nl">shell:</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
    <span class="nl">command:</span> <span class="o">|</span>
      <span class="n">echo</span> <span class="n">Running</span> <span class="n">test</span>
      <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">results</span>
      <span class="n">make</span> <span class="n">test</span>
</pre></div>


<ul>
<li>run还有一种简化写法</li>
</ul>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">make</span> <span class="n">test</span>

<span class="cp"># shorthanded command can also have multiple lines</span>
<span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="o">|</span>
    <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">results</span>
    <span class="n">make</span> <span class="n">test</span>
</pre></div>


<h3 id="checkout">checkout</h3>
<p>下载代码</p>
<p><img alt="image-20200614164408981" src="circleci.assets/image-20200614164408981.png" /></p>
<p>这个插件并不支持submodule，如果想使用submodule，需要添加run脚本实现, 这些脚本会自动添加Github或Bitbucket密钥</p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">checkout</span>
<span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">git</span> <span class="n">submodule</span> <span class="n">sync</span>
<span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span> <span class="o">--</span><span class="n">init</span>
</pre></div>


<h3 id="setup_remote_docker">setup_remote_docker</h3>
<p><img alt="image-20200614164509276" src="circleci.assets/image-20200614164509276.png" /></p>
<h3 id="save_cache">save_cache</h3>
<p>保存缓存</p>
<p><img alt="image-20200614172946525" src="circleci.assets/image-20200614172946525.png" /></p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">save_cache</span><span class="o">:</span>
    <span class="nl">key:</span> <span class="n">v1</span><span class="o">-</span><span class="n">myapp</span><span class="o">-</span><span class="p">{{</span> <span class="n">arch</span> <span class="p">}}</span><span class="o">-</span><span class="p">{{</span> <span class="n">checksum</span> <span class="s">&quot;project.clj&quot;</span> <span class="p">}}</span>
    <span class="nl">paths:</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">/</span><span class="p">.</span><span class="n">m2</span>
</pre></div>


<h3 id="restore_cache">restore_cache</h3>
<p>恢复缓存</p>
<p><img alt="image-20200614173013585" src="circleci.assets/image-20200614173013585.png" /></p>
<div class="hlcode"><pre><span class="nl">steps:</span>
  <span class="o">-</span> <span class="n">save_cache</span><span class="o">:</span>
      <span class="nl">key:</span> <span class="n">v1</span><span class="o">-</span><span class="n">myapp</span><span class="o">-</span><span class="n">cache</span>
      <span class="nl">paths:</span>
        <span class="o">-</span> <span class="o">~/</span><span class="n">d1</span>

  <span class="o">-</span> <span class="n">save_cache</span><span class="o">:</span>
      <span class="nl">key:</span> <span class="n">v1</span><span class="o">-</span><span class="n">myapp</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">new</span>
      <span class="nl">paths:</span>
        <span class="o">-</span> <span class="o">~/</span><span class="n">d2</span>

  <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/</span><span class="n">d1</span> <span class="o">~/</span><span class="n">d2</span>

  <span class="o">-</span> <span class="n">restore_cache</span><span class="o">:</span>
      <span class="nl">key:</span> <span class="n">v1</span><span class="o">-</span><span class="n">myapp</span><span class="o">-</span><span class="n">cache</span>
</pre></div>


<h3 id="deploy">deploy</h3>
<p>专门用户部署artifacts的内置step，一个job中可能同时存在多个deploy step</p>
<div class="hlcode"><pre>- deploy:
    command: |
      if [ &quot;<span class="cp">${</span><span class="n">CIRCLE_BRANCH</span><span class="cp">}</span>&quot; == &quot;master&quot; ]; then
        ansible-playbook site.yml
      fi
</pre></div>


<h3 id="store_artifacts">store_artifacts</h3>
<p>用于存储产物的step</p>
<p><img alt="image-20200614173225037" src="circleci.assets/image-20200614173225037.png" /></p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">run</span><span class="o">:</span>
    <span class="nl">name:</span> <span class="n">Build</span> <span class="n">the</span> <span class="n">Jekyll</span> <span class="n">site</span>
    <span class="nl">command:</span> <span class="n">bundle</span> <span class="n">exec</span> <span class="n">jekyll</span> <span class="n">build</span> <span class="o">--</span><span class="n">source</span> <span class="n">jekyll</span> <span class="o">--</span><span class="n">destination</span> <span class="n">jekyll</span><span class="o">/</span><span class="n">_site</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span>
<span class="o">-</span> <span class="n">store_artifacts</span><span class="o">:</span>
    <span class="nl">path:</span> <span class="n">jekyll</span><span class="o">/</span><span class="n">_site</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span>
    <span class="nl">destination:</span> <span class="n">circleci</span><span class="o">-</span><span class="n">docs</span>
</pre></div>


<h3 id="store_test_results">store_test_results</h3>
<p>用于存储测试产物的step</p>
<p><img alt="image-20200614173315146" src="circleci.assets/image-20200614173315146.png" /></p>
<div class="hlcode"><pre><span class="n">test</span><span class="o">-</span><span class="n">results</span>
<span class="err">├──</span> <span class="n">jest</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">results</span><span class="p">.</span><span class="n">xml</span>
<span class="err">├──</span> <span class="n">mocha</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">results</span><span class="p">.</span><span class="n">xml</span>
<span class="err">└──</span> <span class="n">rspec</span>
    <span class="err">└──</span> <span class="n">results</span><span class="p">.</span><span class="n">xml</span>
</pre></div>


<h3 id="persist_to_workspace">persist_to_workspace</h3>
<p>一个特殊的step，用于将job中的一个临时文件保留下来，供工作流中的下一个job使用</p>
<p><img alt="image-20200614173346588" src="circleci.assets/image-20200614173346588.png" /></p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">persist_to_workspace</span><span class="o">:</span>
    <span class="nl">root:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dir</span>
    <span class="nl">paths:</span>
      <span class="o">-</span> <span class="n">foo</span><span class="o">/</span><span class="n">bar</span>
      <span class="o">-</span> <span class="n">baz</span>
</pre></div>


<p>这个step执行完成之后，这些文件将被保留到workspace中</p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dir</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dir</span><span class="o">/</span><span class="n">baz</span>
</pre></div>


<p>paths匹配规则遵循go match语法</p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">persist_to_workspace</span><span class="o">:</span>
    <span class="nl">root:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">workspace</span>
    <span class="nl">paths:</span>
      <span class="o">-</span> <span class="n">target</span><span class="o">/</span><span class="n">application</span><span class="p">.</span><span class="n">jar</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">/*</span>
</pre></div>


<h3 id="attach_workspace">attach_workspace</h3>
<p>将之前persist_to_workspace的文件关联当前job对应目录下</p>
<p><img alt="image-20200614173446001" src="circleci.assets/image-20200614173446001.png" /></p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">attach_workspace</span><span class="o">:</span>
    <span class="nl">at:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">workspace</span> <span class="err">#将</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">workspace</span><span class="err">完整的</span><span class="n">copy</span><span class="err">到这个</span><span class="n">job</span><span class="err">中</span>
</pre></div>


<h3 id="add_ssh_keys">add_ssh_keys</h3>
<p>为容器添加ssh key</p>
<p><img alt="image-20200614173545711" src="circleci.assets/image-20200614173545711.png" /></p>
<div class="hlcode"><pre><span class="nl">steps:</span>
  <span class="o">-</span> <span class="n">add_ssh_keys</span><span class="o">:</span>
      <span class="nl">fingerprints:</span>
        <span class="o">-</span> <span class="s">&quot;b7:35:a6:4e:9b:0d:6d:d4:78:1e:9a:97:2a:66:6b:be&quot;</span>
</pre></div>


<h1 id="example">example</h1>
<h2 id="full-context">full context</h2>
<div class="hlcode"><pre><span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">jobs</span><span class="o">:</span>
  <span class="n">build</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">:</span><span class="mf">14.04</span>

      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">mongo</span><span class="o">:</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">8</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="n">mongod</span><span class="o">,</span> <span class="o">--</span><span class="n">smallfiles</span><span class="o">]</span>

      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">postgres</span><span class="o">:</span><span class="mf">9.4</span><span class="o">.</span><span class="mi">1</span>
        <span class="err">#</span> <span class="n">some</span> <span class="n">containers</span> <span class="n">require</span> <span class="n">setting</span> <span class="n">environment</span> <span class="n">variables</span>
        <span class="n">environment</span><span class="o">:</span>
          <span class="n">POSTGRES_USER</span><span class="o">:</span> <span class="n">root</span>

      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">redis</span><span class="err">@</span><span class="n">sha256</span><span class="o">:</span><span class="mi">54057</span><span class="n">dd7e125ca41afe526a877e8bd35ec2cdd33b9217e022ed37bdcf7d09673</span>

      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">rabbitmq</span><span class="o">:</span><span class="mf">3.5</span><span class="o">.</span><span class="mi">4</span>

    <span class="n">environment</span><span class="o">:</span>
      <span class="n">TEST_REPORTS</span><span class="o">:</span> <span class="sr">/tmp/</span><span class="n">test</span><span class="o">-</span><span class="n">reports</span>

    <span class="n">working_directory</span><span class="o">:</span> <span class="o">~/</span><span class="n">my</span><span class="o">-</span><span class="n">project</span>

    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">checkout</span>

      <span class="o">-</span> <span class="n">run</span><span class="o">:</span>
          <span class="n">command</span><span class="o">:</span> <span class="n">echo</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">devhost</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="sr">/etc/</span><span class="n">hosts</span>

      <span class="err">#</span> <span class="n">Create</span> <span class="n">Postgres</span> <span class="n">users</span> <span class="n">and</span> <span class="n">database</span>
      <span class="err">#</span> <span class="n">Note</span> <span class="n">the</span> <span class="n">YAML</span> <span class="n">heredoc</span> <span class="s1">&#39;|&#39;</span> <span class="k">for</span> <span class="n">nicer</span> <span class="n">formatting</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="o">|</span>
          <span class="n">sudo</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="n">createuser</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="o">--</span><span class="n">superuser</span> <span class="n">ubuntu</span> <span class="o">&amp;&amp;</span>
          <span class="n">sudo</span> <span class="n">createdb</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="n">test_db</span>

      <span class="o">-</span> <span class="n">restore_cache</span><span class="o">:</span>
          <span class="n">keys</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">v1</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">project</span><span class="o">-{{</span> <span class="n">checksum</span> <span class="s2">&quot;project.clj&quot;</span> <span class="o">}}</span>
            <span class="o">-</span> <span class="n">v1</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">project</span><span class="o">-</span>

      <span class="o">-</span> <span class="n">run</span><span class="o">:</span>
          <span class="n">environment</span><span class="o">:</span>
            <span class="n">SSH_TARGET</span><span class="o">:</span> <span class="s2">&quot;localhost&quot;</span>
            <span class="n">TEST_ENV</span><span class="o">:</span> <span class="s2">&quot;linux&quot;</span>
          <span class="n">command</span><span class="o">:</span> <span class="o">|</span>
            <span class="kd">set</span> <span class="o">-</span><span class="n">xu</span>
            <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">$</span><span class="o">{</span><span class="n">TEST_REPORTS</span><span class="o">}</span>
            <span class="n">run</span><span class="o">-</span><span class="n">tests</span><span class="o">.</span><span class="na">sh</span>
            <span class="n">cp</span> <span class="n">out</span><span class="sr">/tests/</span><span class="o">*.</span><span class="n">xml</span> <span class="n">$</span><span class="o">{</span><span class="n">TEST_REPORTS</span><span class="o">}</span>

      <span class="o">-</span> <span class="n">run</span><span class="o">:</span> <span class="o">|</span>
          <span class="kd">set</span> <span class="o">-</span><span class="n">xu</span>
          <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="sr">/tmp/</span><span class="n">artifacts</span>
          <span class="n">create_jars</span><span class="o">.</span><span class="na">sh</span> <span class="n">$</span><span class="o">{</span><span class="n">CIRCLE_BUILD_NUM</span><span class="o">}</span>
          <span class="n">cp</span> <span class="o">*.</span><span class="n">jar</span> <span class="sr">/tmp/</span><span class="n">artifacts</span>

      <span class="o">-</span> <span class="n">save_cache</span><span class="o">:</span>
          <span class="n">key</span><span class="o">:</span> <span class="n">v1</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">project</span><span class="o">-{{</span> <span class="n">checksum</span> <span class="s2">&quot;project.clj&quot;</span> <span class="o">}}</span>
          <span class="n">paths</span><span class="o">:</span>
            <span class="o">-</span> <span class="o">~/.</span><span class="n">m2</span>

      <span class="err">#</span> <span class="n">Save</span> <span class="n">artifacts</span>
      <span class="o">-</span> <span class="n">store_artifacts</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/tmp/</span><span class="n">artifacts</span>
          <span class="n">destination</span><span class="o">:</span> <span class="n">build</span>

      <span class="err">#</span> <span class="n">Upload</span> <span class="n">test</span> <span class="n">results</span>
      <span class="o">-</span> <span class="n">store_test_results</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/tmp/</span><span class="n">test</span><span class="o">-</span><span class="n">reports</span>

  <span class="n">deploy</span><span class="o">-</span><span class="n">stage</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">:</span><span class="mf">14.04</span>
    <span class="n">working_directory</span><span class="o">:</span> <span class="sr">/tmp/</span><span class="n">my</span><span class="o">-</span><span class="n">project</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">Deploy</span> <span class="k">if</span> <span class="n">tests</span> <span class="n">pass</span> <span class="n">and</span> <span class="n">branch</span> <span class="k">is</span> <span class="n">Staging</span>
          <span class="n">command</span><span class="o">:</span> <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="na">yml</span> <span class="o">-</span><span class="n">i</span> <span class="n">staging</span>

  <span class="n">deploy</span><span class="o">-</span><span class="n">prod</span><span class="o">:</span>
    <span class="n">docker</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">ubuntu</span><span class="o">:</span><span class="mf">14.04</span>
    <span class="n">working_directory</span><span class="o">:</span> <span class="sr">/tmp/</span><span class="n">my</span><span class="o">-</span><span class="n">project</span>
    <span class="n">steps</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">run</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">Deploy</span> <span class="k">if</span> <span class="n">tests</span> <span class="n">pass</span> <span class="n">and</span> <span class="n">branch</span> <span class="k">is</span> <span class="n">Master</span>
          <span class="n">command</span><span class="o">:</span> <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="na">yml</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span>

<span class="n">workflows</span><span class="o">:</span>
  <span class="n">version</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">build</span><span class="o">-</span><span class="n">deploy</span><span class="o">:</span>
    <span class="n">jobs</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">build</span><span class="o">:</span>
          <span class="n">filters</span><span class="o">:</span>
            <span class="n">branches</span><span class="o">:</span>
              <span class="n">ignore</span><span class="o">:</span>
                <span class="o">-</span> <span class="n">develop</span>
                <span class="o">-</span> <span class="sr">/feature-.*/</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">-</span><span class="n">stage</span><span class="o">:</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">build</span>
          <span class="n">filters</span><span class="o">:</span>
            <span class="n">branches</span><span class="o">:</span>
              <span class="n">only</span><span class="o">:</span> <span class="n">staging</span>
      <span class="o">-</span> <span class="n">deploy</span><span class="o">-</span><span class="n">prod</span><span class="o">:</span>
          <span class="n">requires</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">build</span>
          <span class="n">filters</span><span class="o">:</span>
            <span class="n">branches</span><span class="o">:</span>
              <span class="n">only</span><span class="o">:</span> <span class="n">master</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>