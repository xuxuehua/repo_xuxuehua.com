<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>prometheus - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Big_data">Big_data</a>&nbsp;&#187;&nbsp;prometheus
    <span class="updated">Page Updated&nbsp;
      2020-08-01 22:37
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">prometheus</div>

  <p>[toc]</p>
<h1 id="prometheus">Prometheus</h1>
<h2 id="_1">监控内容</h2>
<p><img alt="image-20200801224310756" src="prometheus.assets/image-20200801224310756.png" /></p>
<h2 id="_2">架构</h2>
<p><img alt="image-20200801224958022" src="prometheus.assets/image-20200801224958022.png" /></p>
<h2 id="_3">数据模型</h2>
<p>所有的数据存储为时间序列，具有相同度量名称以及标签属于同一个指标</p>
<p>每一个时间序列都由度量标准名称和一组键值（标签）对作为唯一标识</p>
<div class="hlcode"><pre><span class="o">&lt;</span><span class="n">metric</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">{</span><span class="o">&lt;</span><span class="n">label</span> <span class="n">name</span><span class="o">&gt;=&lt;</span><span class="n">label</span> <span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">...}</span>
</pre></div>


<div class="hlcode"><pre><span class="n">api_http_requests</span><span class="p">.</span><span class="n">total</span><span class="p">{</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="s">&quot;/messages&quot;</span><span class="p">}</span>
</pre></div>


<h2 id="_4">指标类型</h2>
<p><img alt="image-20200801231239951" src="prometheus.assets/image-20200801231239951.png" /></p>
<h1 id="installation">installation</h1>
<h2 id="linux">linux</h2>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/prometheus/prometheus/releases/download/v2.20.0/prometheus-2.20.0.linux-amd64.tar.gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="n">prometheus</span><span class="o">-</span><span class="mf">2.20.0</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">prometheus</span><span class="o">-</span><span class="mf">2.20.0</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="n">prometheus</span>
</pre></div>


<p>Save the following basic Prometheus configuration as a file named <code>prometheus.yml</code>, by default it already contained this file</p>
<div class="hlcode"><pre><span class="n">global</span><span class="o">:</span>
  <span class="n">scrape_interval</span><span class="o">:</span>     <span class="mi">15</span><span class="n">s</span> <span class="err">#</span> <span class="n">By</span> <span class="k">default</span><span class="o">,</span> <span class="n">scrape</span> <span class="n">targets</span> <span class="n">every</span> <span class="mi">15</span> <span class="n">seconds</span><span class="o">.</span>

  <span class="err">#</span> <span class="n">Attach</span> <span class="n">these</span> <span class="n">labels</span> <span class="n">to</span> <span class="n">any</span> <span class="n">time</span> <span class="n">series</span> <span class="n">or</span> <span class="n">alerts</span> <span class="n">when</span> <span class="n">communicating</span> <span class="k">with</span>
  <span class="err">#</span> <span class="n">external</span> <span class="n">systems</span> <span class="o">(</span><span class="n">federation</span><span class="o">,</span> <span class="n">remote</span> <span class="n">storage</span><span class="o">,</span> <span class="n">Alertmanager</span><span class="o">).</span>
  <span class="n">external_labels</span><span class="o">:</span>
    <span class="n">monitor</span><span class="o">:</span> <span class="s1">&#39;codelab-monitor&#39;</span>

<span class="err">#</span> <span class="n">A</span> <span class="n">scrape</span> <span class="n">configuration</span> <span class="n">containing</span> <span class="n">exactly</span> <span class="n">one</span> <span class="n">endpoint</span> <span class="n">to</span> <span class="n">scrape</span><span class="o">:</span>
<span class="err">#</span> <span class="n">Here</span> <span class="n">it</span><span class="s1">&#39;s Prometheus itself.</span>
<span class="s1">scrape_configs:</span>
<span class="s1">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
<span class="s1">  - job_name: &#39;</span><span class="n">prometheus</span><span class="s1">&#39;</span>

<span class="s1">    # Override the global default and scrape targets from this job every 5 seconds.</span>
<span class="s1">    scrape_interval: 5s</span>

<span class="s1">    static_configs:</span>
<span class="s1">      - targets: [&#39;</span><span class="n">localhost</span><span class="o">:</span><span class="mi">9090</span><span class="err">&#39;</span><span class="o">]</span>
</pre></div>


<div class="hlcode"><pre><span class="cp"># Start Prometheus.</span>
<span class="cp"># By default, Prometheus stores its database in ./data (flag --storage.tsdb.path).</span>
<span class="p">.</span><span class="o">/</span><span class="n">prometheus</span> <span class="o">--</span><span class="n">config</span><span class="p">.</span><span class="n">file</span><span class="o">=</span><span class="n">prometheus</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<p>or</p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">prometheus</span><span class="p">.</span><span class="n">service</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Prometheus</span> <span class="n">Server</span>
<span class="n">Documentation</span><span class="o">=</span><span class="n">https</span><span class="o">:</span><span class="c1">//prometheus.io/docs/introduction/overview/</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="p">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">on</span><span class="o">-</span><span class="n">failure</span>

<span class="cp">#Change this line if you download the </span>
<span class="cp">#Prometheus on different path user</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span> \
  <span class="o">--</span><span class="n">config</span><span class="p">.</span><span class="n">file</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="p">.</span><span class="n">yml</span> 

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</pre></div>


<h1 id="exporter">exporter</h1>
<h2 id="node_exporter">node_exporter</h2>
<p>linux 系统监控, 监听9100 端口</p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz</span>
<span class="n">mv</span> <span class="n">node_exporter</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span>
</pre></div>


<div class="hlcode"><pre><span class="nx">scrape_configs</span><span class="p">:</span>
  <span class="err">#</span> <span class="nx">The</span> <span class="nx">job</span> <span class="nb">name</span> <span class="nx">is</span> <span class="nx">added</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nb">label</span> <span class="sb">`job=&lt;job_name&gt;`</span> <span class="k">to</span> <span class="nb">any</span> <span class="nx">timeseries</span> <span class="nx">scraped</span> <span class="nb">from</span> <span class="nx">this</span> <span class="nx">config.</span>
  <span class="o">-</span> <span class="nx">job_name</span><span class="p">:</span> <span class="s1">&#39;prometheus&#39;</span>

    <span class="err">#</span> <span class="nx">metrics_path</span> <span class="nx">defaults</span> <span class="k">to</span> <span class="s1">&#39;/metrics&#39;</span>
    <span class="err">#</span> <span class="nb">scheme</span> <span class="nx">defaults</span> <span class="k">to</span> <span class="s1">&#39;http&#39;</span><span class="nx">.</span>
    <span class="nx">file_sd_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="nx">files</span><span class="p">:</span> <span class="err">[</span><span class="s1">&#39;/usr/local/prometheus/sd_config/test.yml&#39;</span><span class="cp">]</span>
        refresh_interval: 5s

#    static_configs:
#    - targets: <span class="cp">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="cp">]</span>
  - job_name: &#39;node&#39;
    file_sd_configs:
      - files: <span class="cp">[</span><span class="s1">&#39;/usr/local/prometheus/sd_config/node.yml&#39;</span><span class="cp">]</span>
        refresh_interval: 5s
</pre></div>


<div class="hlcode"><pre><span class="cp"># cat sd_config/node.yml </span>
<span class="o">-</span> <span class="n">targets</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">target_ip</span><span class="o">:</span><span class="mi">9100</span>
</pre></div>


<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">node_exporter</span><span class="p">.</span><span class="n">service</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">node_exporter</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span> 

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">node_exporter</span><span class="o">/</span><span class="n">node_exporter</span> \
          <span class="o">--</span><span class="n">web</span><span class="p">.</span><span class="n">listen</span><span class="o">-</span><span class="n">address</span><span class="o">=:</span><span class="mi">9100</span>\
          <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">systemd</span>\
          <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">systemd</span><span class="p">.</span><span class="n">unit</span><span class="o">-</span><span class="n">whitelist</span><span class="o">=</span><span class="p">(</span><span class="n">sshd</span><span class="o">|</span><span class="n">nginx</span><span class="p">).</span><span class="n">service</span>\
          <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">processes</span>\
          <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">tcpstat</span>\
          <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">supervisord</span>
<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</pre></div>


<h3 id="query">通过query获取指标</h3>
<p><img alt="image-20200802130114656" src="prometheus.assets/image-20200802130114656.png" /></p>
<h3 id="-collectorsystemd">--collector.systemd监控服务状态</h3>
<div class="hlcode"><pre><span class="n">node_exporter</span> <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">systemd</span> <span class="o">--</span><span class="n">collector</span><span class="p">.</span><span class="n">systemd</span><span class="p">.</span><span class="n">unit</span><span class="o">-</span><span class="n">whitelist</span><span class="o">=</span><span class="p">(</span><span class="n">docker</span><span class="o">|</span><span class="n">sshd</span><span class="o">|</span><span class="n">nginx</span><span class="p">).</span><span class="n">service</span>
</pre></div>


<h1 id="servicde-discovery">servicde discovery</h1>
<h2 id="file_sd_configs">file_sd_configs</h2>
<p>prometheus.yml</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nx">A</span> <span class="nx">scrape</span> <span class="nx">configuration</span> <span class="nx">containing</span> <span class="nx">exactly</span> <span class="nx">one</span> <span class="nx">endpoint</span> <span class="k">to</span> <span class="nx">scrape</span><span class="p">:</span>
<span class="err">#</span> <span class="nx">Here</span> <span class="nx">it</span><span class="s1">&#39;s Prometheus itself.</span>
<span class="s1">scrape_configs:</span>
<span class="s1">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
<span class="s1">  - job_name: &#39;</span><span class="nx">prometheus</span><span class="s1">&#39;</span>

<span class="s1">    # metrics_path defaults to &#39;</span><span class="p">/</span><span class="nx">metrics</span><span class="s1">&#39;</span>
<span class="s1">    # scheme defaults to &#39;</span><span class="nx">http</span><span class="s1">&#39;.</span>
<span class="s1">    file_sd_configs:</span>
<span class="s1">      - files: [&#39;</span><span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">prometheus</span><span class="p">/</span><span class="nx">sd_config</span><span class="o">/*</span><span class="bp">.</span><span class="nx">yml</span><span class="s1">&#39;]</span>
<span class="s1">        refresh_interval: 5s</span>

<span class="s1">#    static_configs:</span>
<span class="s1">#    - targets: [&#39;</span><span class="nx">localhost</span><span class="p">:</span><span class="mi">9090</span><span class="s1">&#39;]</span>
</pre></div>


<p>sd_config/test.yml</p>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">targets</span><span class="o">:</span> <span class="p">[</span><span class="n">localhost</span><span class="o">:</span><span class="mi">9090</span><span class="p">]</span>
  <span class="nl">labels:</span>
    <span class="nl">idc:</span> <span class="n">us</span>
</pre></div>


<h1 id="integrate-with-grafana">integrate with Grafana</h1>
<h1 id="promtool">promtool</h1>
<h2 id="check-config">Check config</h2>
<div class="hlcode"><pre><span class="p">.</span><span class="o">/</span><span class="n">promtool</span> <span class="n">check</span> <span class="n">config</span> <span class="p">.</span><span class="o">/</span><span class="n">prometheus</span><span class="p">.</span><span class="n">yml</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>