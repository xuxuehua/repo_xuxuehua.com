<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>pycryptodome - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python_modules">Python_modules</a>&nbsp;&#187;&nbsp;pycryptodome
    <span class="updated">Page Updated&nbsp;
      2020-06-15 21:57
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">pycryptodome</div>

  <p>[toc]</p>
<h1 id="pycryptodome">pycryptodome</h1>
<h2 id="install-python3">install python3</h2>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">pycryptodome</span>
</pre></div>


<h1 id="faq">FAQ</h1>
<h2 id="modulenotfounderror-no-module-named-crypto">ModuleNotFoundError: No module named 'Crypto'</h2>
<p>Rename the folder in site-packages from crypto to Crypto, below import error will dismiss</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">Crypto</span><span class="p">.</span><span class="n">Cipher</span> <span class="n">import</span> <span class="n">AES</span>
<span class="n">from</span> <span class="n">Crypto</span><span class="p">.</span><span class="n">Hash</span> <span class="n">import</span> <span class="n">SHA256</span>
</pre></div>


<h1 id="example">example</h1>
<h2 id="encrypt-aes">Encrypt aes</h2>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">Crypto</span><span class="p">.</span><span class="n">Cipher</span> <span class="n">import</span> <span class="n">AES</span>
<span class="n">import</span> <span class="n">hashlib</span>

<span class="n">password</span> <span class="o">=</span> <span class="n">b</span><span class="err">&#39;</span><span class="n">qwerty12345</span><span class="err">&#39;</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">password</span><span class="p">).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">b</span><span class="err">&#39;</span><span class="mo">01234567</span><span class="mi">89</span><span class="n">abcdef</span><span class="err">&#39;</span>

<span class="n">IV</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="sc">&#39;\x00&#39;</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span>
<span class="n">encryptor</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">IV</span><span class="o">=</span><span class="n">IV</span><span class="p">)</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">b</span><span class="sc">&#39;j&#39;</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">b</span><span class="sc">&#39;i&#39;</span> <span class="o">*</span> <span class="mi">64</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">encryptor</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="n">decryptor</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">IV</span><span class="o">=</span><span class="n">IV</span><span class="p">)</span>
<span class="n">plain</span> <span class="o">=</span> <span class="n">decryptor</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span>
</pre></div>


<h2 id="encrypt-file">Encrypt file</h2>
<div class="hlcode"><pre><span class="k">import</span> <span class="nx">argparse</span>
<span class="k">import</span> <span class="nx">os</span>
<span class="k">import</span> <span class="nx">struct</span>
<span class="k">import</span> <span class="nx">sys</span>
<span class="k">import</span> <span class="nx">hashlib</span>

<span class="nb">from</span> <span class="nx">Crypto.Cipher</span> <span class="k">import</span> <span class="nx">AES</span>


<span class="nx">def</span> <span class="nx">encrypt_file</span><span class="p">(</span><span class="nb">key</span><span class="p">,</span> <span class="nx">in_filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39; Encrypts a file using AES (CBC mode) with the</span>
<span class="s1">        given key.</span>
<span class="s1">        key:</span>
<span class="s1">            The encryption key - a bytes object that must be</span>
<span class="s1">            either 16, 24 or 32 bytes long. Longer keys</span>
<span class="s1">            are more secure.</span>
<span class="s1">        in_filename:</span>
<span class="s1">            Name of the input file</span>
<span class="s1">        out_filename:</span>
<span class="s1">            If None, &#39;</span><span class="o">&lt;</span><span class="nx">in_filename</span><span class="o">&gt;</span><span class="bp">.</span><span class="nx">enc</span><span class="s1">&#39; will be used.</span>
<span class="s1">        chunksize:</span>
<span class="s1">            Sets the size of the chunk which the function</span>
<span class="s1">            uses to read and encrypt the file. Larger chunk</span>
<span class="s1">            sizes can be faster for some files and machines.</span>
<span class="s1">            chunksize must be divisible by 16.</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nx">out_filename</span><span class="p">:</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="nx">in_filename</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span>

    <span class="n">iv</span> <span class="o">=</span> <span class="nx">os.urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">encrypt_engine</span> <span class="o">=</span> <span class="nx">AES.new</span><span class="p">(</span><span class="nb">key</span><span class="p">,</span> <span class="nx">AES.MODE_CBC</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="nx">os.path.getsize</span><span class="p">(</span><span class="nx">in_filename</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nx">in_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">in_f</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nx">out_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">outfile</span><span class="p">:</span>
            <span class="nx">outfile.write</span><span class="p">(</span><span class="nx">struct.pack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="nx">file_size</span><span class="p">))</span>
            <span class="nx">outfile.write</span><span class="p">(</span><span class="nx">iv</span><span class="p">)</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="nx">in_f.read</span><span class="p">(</span><span class="nx">chunksize</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">len</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nx">break</span>
                <span class="nx">elif</span> <span class="nx">len</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nx">chunk</span> <span class="o">+=</span> <span class="nx">b</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nx">len</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>

                <span class="nx">outfile.write</span><span class="p">(</span><span class="nx">encrypt_engine.encrypt</span><span class="p">(</span><span class="nx">chunk</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">out_filename</span>


<span class="nx">def</span> <span class="nx">decrypt_file</span><span class="p">(</span><span class="nb">key</span><span class="p">,</span> <span class="nx">in_filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">1024</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39; Decrypts a file using AES (CBC mode) with the</span>
<span class="s1">        given key. Parameters are similar to encrypt_file,</span>
<span class="s1">        with one difference: out_filename, if not supplied</span>
<span class="s1">        will be in_filename without its last extension</span>
<span class="s1">        (i.e. if in_filename is &#39;</span><span class="nx">aaa.zip.enc</span><span class="s1">&#39; then</span>
<span class="s1">        out_filename will be &#39;</span><span class="nx">aaa.zip</span><span class="s1">&#39;)</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nx">out_filename</span><span class="p">:</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="nx">os.path.splitext</span><span class="p">(</span><span class="nx">in_filename</span><span class="p">)</span><span class="err">[</span><span class="mi">0</span><span class="cp">]</span>

    with open(in_filename, &#39;rb&#39;) as in_f:
        origin_size = struct.unpack(&#39;<span class="nt">&lt;Q</span><span class="err">&#39;,</span> <span class="na">in_f</span><span class="err">.</span><span class="na">read</span><span class="err">(</span><span class="na">struct</span><span class="err">.</span><span class="na">calcsize</span><span class="err">(&#39;</span><span class="na">Q</span><span class="err">&#39;)))</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span>
        <span class="na">iv =</span><span class="err"> </span><span class="s">in_f.read(16)</span>
        <span class="na">decryptor =</span><span class="err"> </span><span class="s">AES.new(key,</span> <span class="na">AES</span><span class="err">.</span><span class="na">MODE_CBC</span><span class="err">,</span> <span class="na">iv</span><span class="err">)</span>

        <span class="na">with</span> <span class="na">open</span><span class="err">(</span><span class="na">out_filename</span><span class="err">,</span> <span class="err">&#39;</span><span class="na">wb</span><span class="err">&#39;)</span> <span class="na">as</span> <span class="na">outfile:</span>
            <span class="na">while</span> <span class="na">True:</span>
                <span class="na">chunk =</span><span class="err"> </span><span class="s">in_f.read(chunksize)</span>
                <span class="na">if</span> <span class="na">len</span><span class="err">(</span><span class="na">chunk</span><span class="err">)</span> <span class="err">==</span> <span class="na">0:</span>
                    <span class="na">break</span>
                <span class="na">outfile</span><span class="err">.</span><span class="na">write</span><span class="err">(</span><span class="na">decryptor</span><span class="err">.</span><span class="na">decrypt</span><span class="err">(</span><span class="na">chunk</span><span class="err">))</span>

            <span class="na">outfile</span><span class="err">.</span><span class="na">truncate</span><span class="err">(</span><span class="na">origin_size</span><span class="err">)</span>
    <span class="na">return</span> <span class="na">out_filename</span>


<span class="na">if</span> <span class="na">__name__ =</span><span class="s">=</span> <span class="err">&#39;</span><span class="na">__main__</span><span class="err">&#39;</span><span class="na">:</span>
    <span class="na">parser =</span><span class="err"> </span><span class="s">argparse.ArgumentParser(description=&#39;Encrypt/Decrypt</span> <span class="na">AES</span><span class="err">&#39;)</span>
    <span class="na">parser</span><span class="err">.</span><span class="na">add_argument</span><span class="err">(&#39;</span><span class="na">filename</span><span class="err">&#39;,</span> <span class="na">nargs=</span><span class="s">1)</span>
    <span class="na">parser</span><span class="err">.</span><span class="na">add_argument</span><span class="err">(&#39;</span><span class="na">-k</span><span class="err">&#39;,</span> <span class="err">&#39;</span><span class="na">--key</span><span class="err">&#39;,</span> <span class="na">help=</span><span class="s">&#39;key value&#39;</span><span class="err">,</span> <span class="na">required=</span><span class="s">True)</span>
    <span class="na">parser</span><span class="err">.</span><span class="na">add_argument</span><span class="err">(&#39;</span><span class="na">-e</span><span class="err">&#39;,</span> <span class="na">dest=</span><span class="s">&#39;encrypt&#39;</span><span class="err">,</span> <span class="na">help=</span><span class="s">&#39;encrypt&#39;</span><span class="err">,</span> <span class="na">action=</span><span class="s">&#39;store_true&#39;</span><span class="err">)</span>
    <span class="na">parser</span><span class="err">.</span><span class="na">add_argument</span><span class="err">(&#39;</span><span class="na">-d</span><span class="err">&#39;,</span> <span class="na">dest=</span><span class="s">&#39;decrypt&#39;</span><span class="err">,</span> <span class="na">help=</span><span class="s">&#39;decrypt&#39;</span><span class="err">,</span> <span class="na">action=</span><span class="s">&#39;store_true&#39;</span><span class="err">)</span>
    <span class="na">args =</span><span class="err"> </span><span class="s">parser.parse_args()</span>
    <span class="na">infile =</span><span class="err"> </span><span class="s">args.filename</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span>

    <span class="na">key_string =</span><span class="err"> </span><span class="s">args.key</span>
    <span class="na">key_byte =</span><span class="err"> </span><span class="s">key_string.encode(&#39;utf-8&#39;)</span>
    <span class="na">input_key =</span><span class="err"> </span><span class="s">hashlib.sha256(key_byte).digest()</span>

    <span class="na">if</span> <span class="na">args</span><span class="err">.</span><span class="na">encrypt:</span>
        <span class="na">output_filename =</span><span class="err"> </span><span class="s">encrypt_file(input_key,</span> <span class="na">infile</span><span class="err">,</span> <span class="na">out_filename=</span><span class="s">infile</span> <span class="err">+</span> <span class="err">&#39;.</span><span class="na">enc</span><span class="err">&#39;)</span>
        <span class="na">print</span><span class="err">(&#39;</span><span class="na">Encrypted</span> <span class="na">to</span><span class="err">&#39;,</span> <span class="na">output_filename</span><span class="err">)</span>
    <span class="na">elif</span> <span class="na">args</span><span class="err">.</span><span class="na">decrypt:</span>
        <span class="na">output_filename =</span><span class="err"> </span><span class="s">decrypt_file(input_key,</span> <span class="na">infile</span><span class="err">,</span> <span class="na">out_filename=</span><span class="s">infile.replace(&#39;.enc&#39;,</span> <span class="err">&#39;&#39;))</span>
        <span class="na">print</span><span class="err">(&#39;</span><span class="na">Decrypted</span> <span class="na">to</span><span class="err">&#39;,</span> <span class="na">output_filename</span><span class="err">)</span>
    <span class="na">else:</span>
        <span class="na">parser</span><span class="err">.</span><span class="na">print_help</span><span class="err">()</span>
        <span class="na">sys</span><span class="err">.</span><span class="na">exit</span><span class="err">(</span><span class="na">1</span><span class="err">)</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>