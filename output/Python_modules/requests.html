<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>requests - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python_modules">Python_modules</a>&nbsp;&#187;&nbsp;requests
    <span class="updated">Page Updated&nbsp;
      2018-07-28 02:43
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">requests</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#requests">requests</a><ul>
<li><a href="#_1">安装</a></li>
<li><a href="#requests_1">请求 requests</a><ul>
<li><a href="#post">post</a><ul>
<li><a href="#ajaxjson">Ajax.json</a></li>
<li><a href="#_2">上传文件</a></li>
</ul>
</li>
<li><a href="#get">get</a><ul>
<li><a href="#_3">返回值</a></li>
<li><a href="#_4">下载图片</a></li>
<li><a href="#proxy">proxy 处理</a></li>
<li><a href="#ssl">不信任的SSL证书</a></li>
</ul>
</li>
<li><a href="#_5">重定向</a></li>
<li><a href="#headers">自定义请求的headers</a></li>
<li><a href="#timeout">timeout 超时时间</a></li>
</ul>
</li>
<li><a href="#headers_1">headers</a></li>
<li><a href="#_6">解析响应</a><ul>
<li><a href="#_7">获取响应的状态码</a></li>
<li><a href="#json">json</a></li>
<li><a href="#jsonp">jsonp 格式</a></li>
<li><a href="#text">text</a></li>
<li><a href="#_8">二进制</a></li>
<li><a href="#header">header</a><ul>
<li><a href="#user-agent">user-agent (爬虫需更改)</a></li>
</ul>
</li>
<li><a href="#cookie">cookie</a><ul>
<li><a href="#cookie-value">获取cookie value</a></li>
<li><a href="#session">session</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#exception">exception 处理</a><ul>
<li><a href="#401">401</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="requests">requests</h1>
<h2 id="_1">安装</h2>
<ul>
<li>pip 安装</li>
</ul>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">requests</span>
</pre></div>


<ul>
<li>源码安装</li>
</ul>
<div class="hlcode"><pre><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="o">:</span><span class="c1">//github.com/requests/requests.git</span>
<span class="n">cd</span> <span class="n">requests</span>
<span class="n">pip</span> <span class="n">install</span> <span class="p">.</span>
</pre></div>


<h2 id="requests_1">请求 requests</h2>
<h3 id="post">post</h3>
<p>默认情况下，在post方法中使用 data 关键字参数，Requests的行为会表现的像是在发送一个html表单，比如</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">key1</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">value1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">key2</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">value2</span><span class="err">&#39;</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://httpbin.org/post&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="s">&quot;form&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;key2&quot;</span><span class="o">:</span> <span class="s">&quot;value2&quot;</span><span class="p">,</span>
    <span class="s">&quot;key1&quot;</span><span class="o">:</span> <span class="s">&quot;value1&quot;</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>如果需要为多个元素使用同一key的话，可以在data中传入元组，比如</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nt">payload</span> <span class="o">=</span> <span class="o">((</span><span class="s1">&#39;key1&#39;</span><span class="o">,</span> <span class="s1">&#39;value1&#39;</span><span class="o">),</span> <span class="o">(</span><span class="s1">&#39;key1&#39;</span><span class="o">,</span> <span class="s1">&#39;value2&#39;</span><span class="o">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nt">r</span> <span class="o">=</span> <span class="nt">requests</span><span class="nc">.post</span><span class="o">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="o">,</span> <span class="nt">data</span><span class="o">=</span><span class="nt">payload</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nt">print</span><span class="o">(</span><span class="nt">r</span><span class="nc">.text</span><span class="o">)</span>
<span class="p">{</span>
  <span class="o">...</span>
  <span class="s2">&quot;form&quot;</span><span class="o">:</span> <span class="err">{</span>
    <span class="s2">&quot;key1&quot;</span><span class="o">:</span> <span class="cp">[</span>
      <span class="s2">&quot;value1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;value2&quot;</span>
    <span class="cp">]</span>
  <span class="p">}</span><span class="o">,</span>
  <span class="o">...</span>
<span class="err">}</span>
</pre></div>


<p>如果 data 中传的是string而不是dict的话，那么字符串将会被直接发送出去</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">import</span> <span class="n">json</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//api.github.com/some/endpoint&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">some</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">data</span><span class="err">&#39;</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</pre></div>


<p>因为现在很多api接受json字符串格式的post data，Requests为这种方式提供了更简单的写法</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//api.github.com/some/endpoint&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">some</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">data</span><span class="err">&#39;</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
</pre></div>


<h4 id="ajaxjson">Ajax.json</h4>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">first</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="nb">true</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">pn</span><span class="err">&#39;</span><span class="o">:</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">kd</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">python</span><span class="err">&#39;</span>
<span class="p">}</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Iridium</span><span class="o">/</span><span class="mf">2017.11</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">62.0.3202.94</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">Referer</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.lagou.com/jobs/list_python?labelWords=&amp;fromSearch=true&amp;suginput=&#39;</span>
<span class="p">}</span>

<span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.lagou.com/jobs/positionAjax.json?city=%E5%8C%97%E4%BA%AC&amp;needAddtionalResult=false&#39;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>


<blockquote>
<p>headers 里面的Referer 是必须的</p>
<p>url是Ajax.json 生成的</p>
</blockquote>
<h4 id="_2">上传文件</h4>
<p>最简单的方式</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/post&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">file</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">report</span><span class="p">.</span><span class="n">xls</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">rb</span><span class="err">&#39;</span><span class="p">)}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="s">&quot;files&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;file&quot;</span><span class="o">:</span> <span class="s">&quot;&lt;censored...binary...data&gt;&quot;</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>你可以显式地设置文件名，文件类型和请求头：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/post&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">file</span><span class="err">&#39;</span><span class="o">:</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">report</span><span class="p">.</span><span class="n">xls</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">report</span><span class="p">.</span><span class="n">xls</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">rb</span><span class="err">&#39;</span><span class="p">),</span> <span class="err">&#39;</span><span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="p">.</span><span class="n">ms</span><span class="o">-</span><span class="n">excel</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">Expires</span><span class="err">&#39;</span><span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">})}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="s">&quot;files&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;file&quot;</span><span class="o">:</span> <span class="s">&quot;&lt;censored...binary...data&gt;&quot;</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<h3 id="get">get</h3>
<p>无参数的调用</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.xuxuehua.com&#39;)</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>


<p>在Requests里，我们一般使用<code>params</code>关键字参数的方式，传入dict来传递url参数。比如，假设我们想传递<code>key1=value1</code>和<code>key2=value2</code>这2个参数，我们可以用下面的代码</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">key1</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">value1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">key2</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">value2</span><span class="err">&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/get&#39;, params=payload)</span>
</pre></div>


<p>可以通过url方法来查看requests帮我们构造的编码后的url</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
<span class="nl">http:</span><span class="c1">//httpbin.org/get?key2=value2&amp;key1=value1</span>
</pre></div>


<p>我们还可以为同一个key传递一组数据，比如</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">key1</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">value1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">key2</span><span class="err">&#39;</span><span class="o">:</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">value2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">value3</span><span class="err">&#39;</span><span class="p">]}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/get&#39;, params=payload)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
<span class="nl">http:</span><span class="c1">//httpbin.org/get?key1=value1&amp;key2=value2&amp;key2=value3</span>
</pre></div>


<h4 id="_3">返回值</h4>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.xuxuehua.com&#39;)</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span> <span class="err">#</span> <span class="err">返回</span><span class="n">unicode</span><span class="err">格式数据</span><span class="p">,</span><span class="err">是</span><span class="n">str</span><span class="err">类型</span><span class="p">,</span> <span class="err">可以指定解码方式</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span> <span class="err">#</span> <span class="err">返回字节流数据，即原生字符串，就是从网页直接抓下来的，没有经过任何解码，</span><span class="n">bytes</span><span class="err">类型</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">url</span><span class="p">)</span> <span class="err">#</span> <span class="err">返回完整</span><span class="n">url</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span> <span class="err">#</span> <span class="err">返回响应头部字节编码</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span> <span class="err">#</span> <span class="err">返回响应码</span>
</pre></div>


<h4 id="_4">下载图片</h4>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Downding</span> <span class="o">%</span><span class="n">s</span><span class="err">&#39;</span> <span class="o">%</span><span class="n">url</span><span class="p">)</span>
    <span class="n">local_filename</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
    <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="n">local_filename</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">wb</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">f</span><span class="o">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="n">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="o">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">local_filename</span>
</pre></div>


<h4 id="proxy">proxy 处理</h4>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">http</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="mf">210.73.202.121</span><span class="o">:</span><span class="mi">53281</span><span class="err">&#39;</span>
<span class="p">}</span>

<span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/ip&#39;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxy</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="p">{</span>
  <span class="s">&quot;origin&quot;</span><span class="o">:</span> <span class="s">&quot;210.73.202.121&quot;</span>
<span class="p">}</span>
</pre></div>


<h4 id="ssl">不信任的SSL证书</h4>
<div class="hlcode"><pre><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>
</pre></div>


<h3 id="_5">重定向</h3>
<p>默认情况下，除了HEAD请求, Requests 会自动处理所有重定向。</p>
<p>如果你使用的是GET、OPTIONS、POST、PUT、PATCH 或者 DELETE，那么你可以通过 allow_redirects 参数禁用重定向处理：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//github.com&#39;, allow_redirects=False)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">301</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">history</span>
<span class="p">[]</span>
</pre></div>


<p>可以使用<code>history</code>方法来追踪重定向</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//github.com&#39;)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">url</span>
<span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/&#39;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">200</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">history</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">301</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>


<p>如果你使用了 HEAD 方法，你也可以启用重定向：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//github.com&#39;, allow_redirects=True)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">url</span>
<span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">history</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">301</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>


<h3 id="headers">自定义请求的headers</h3>
<p>有时候我们需要自定义一些请求的headers，比如我们可能需要将jwt的token放到headers里以完成鉴权。</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//api.github.com/some/endpoint&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">my</span><span class="o">-</span><span class="n">app</span><span class="o">/</span><span class="mf">0.0.1</span><span class="err">&#39;</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>


<h3 id="timeout">timeout 超时时间</h3>
<p>使用timeout 参数可以设定等待连接的秒数，如果等待超时，Requests会抛出异常</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nx">requests.get</span><span class="p">(</span><span class="s1">&#39;http://github.com&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="nx">Traceback</span> <span class="p">(</span><span class="nx">most</span> <span class="nx">recent</span> <span class="nb">call</span> <span class="nb">last</span><span class="p">):</span>
  <span class="nb">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">1</span><span class="p">,</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span>
<span class="nx">requests.exceptions.Timeout</span><span class="p">:</span> <span class="nx">HTTPConnectionPool</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;github.com&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span> <span class="nx">Request</span> <span class="nx">timed</span> <span class="nx">out.</span> <span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>


<p>timeout 仅对连接过程有效，与响应体的下载无关。 timeout 并不是整个下载响应的时间限制，而是如果服务器在 timeout 秒内没有应答，将会引发一个异常（更精确地说，是在 timeout 秒内没有从基础套接字上接收到任何字节的数据时)。</p>
<h2 id="headers_1">headers</h2>
<div class="hlcode"><pre><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;user-agent&quot;</span><span class="o">:</span> <span class="s">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Iridium/2017.11 Safari/537.36 Chrome/62.0.3202.94&quot;</span>
<span class="p">}</span>
</pre></div>


<h2 id="_6">解析响应</h2>
<h3 id="_7">获取响应的状态码</h3>
<p>使用<code>status_code</code> 就可以了。</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/get&#39;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">200</span>
</pre></div>


<p>为方便引用，Requests还附带了一个内置的状态码查询对象：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="p">.</span><span class="n">codes</span><span class="p">.</span><span class="n">ok</span>
<span class="n">True</span>
</pre></div>


<p>如果发送了一个错误请求(一个 4XX 客户端错误，或者 5XX 服务器错误响应)，我们可以通过 Response.raise_for_status() 来抛出异常：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">bad_r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/status/404&#39;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bad_r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">404</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bad_r</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span><span class="o">:</span>
  <span class="n">File</span> <span class="s">&quot;requests/models.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">832</span><span class="p">,</span> <span class="n">in</span> <span class="n">raise_for_status</span>
    <span class="n">raise</span> <span class="n">http_error</span>
<span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">HTTPError</span><span class="o">:</span> <span class="mi">404</span> <span class="n">Client</span> <span class="n">Error</span>
</pre></div>


<p>如果在测试用例中直接使用<code>raise_for_status()</code>方法，如果有异常抛出的话，用例会自动失败</p>
<h3 id="json">json</h3>
<p>可以把json字符串转成python的dict数据类型</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">requests</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//api.github.com/events&#39;)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">:</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">:</span>
<span class="p">[{</span><span class="err">&#39;</span><span class="n">actor</span><span class="err">&#39;</span><span class="o">:</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">avatar_url</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//avatars.githubusercontent.com/u/37750057?&#39;,</span>
   <span class="err">&#39;</span><span class="n">display_login</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">lazar</span><span class="o">-</span><span class="n">eric2</span><span class="err">&#39;</span><span class="p">,</span>
   <span class="err">&#39;</span><span class="n">gravatar_id</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;&#39;</span><span class="p">,</span>
   <span class="err">&#39;</span><span class="n">id</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">37750057</span><span class="p">,</span>
   <span class="p">.....</span>
   <span class="p">......</span>
</pre></div>


<blockquote>
<p>需要引起注意的是r.json()解析成功了并不代表请求是成功的。很多服务器在响应失败的时候也会返回json字符串，如果要判断响应的状态的话，建议使用<code>r.raise_for_status()</code> 或者使用<code>check r.status_code</code>来判断返回值是否符合预期</p>
</blockquote>
<h3 id="jsonp">jsonp 格式</h3>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">re</span>
<span class="n">import</span> <span class="n">json</span>

<span class="n">spot_instance_prices_url</span> <span class="o">=</span> <span class="s">&quot;https://website.spot.ec2.aws.a2z.com/spot.js&quot;</span>

<span class="n">r</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">_jsonp</span>

<span class="n">def</span> <span class="n">loads_jsonp</span><span class="p">(</span><span class="n">_jsonp</span><span class="p">)</span><span class="o">:</span>
    <span class="nl">try:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.*?({.*}).*&quot;</span><span class="p">,</span><span class="n">_jsonp</span><span class="p">,</span><span class="n">re</span><span class="p">.</span><span class="n">S</span><span class="p">).</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="nl">except:</span>
    <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Invalid</span> <span class="n">Input</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<h3 id="text">text</h3>
<p><code>text</code> 方法会拿到请求的响应内容，比如以再github的timeline接口为例</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">import</span> <span class="n">requests</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//api.github.com/events&#39;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="n">u</span><span class="err">&#39;</span><span class="p">[{</span><span class="s">&quot;repository&quot;</span><span class="o">:</span><span class="p">{</span><span class="s">&quot;open_issues&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;url&quot;</span><span class="o">:</span><span class="s">&quot;https://github.com/...</span>
</pre></div>


<p>Requests会自动去解码server端返回的内容，大部分的unicode字符集都会被无缝解码。</p>
<p>当你发送请求的时候，Requests会根据HTTP headers来推断编码，并在<code>r.text</code>调用的时候使用。我们可以查看和修改Requests的编码，比如</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">encoding</span>
<span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">ISO</span><span class="o">-</span><span class="mi">8859</span><span class="o">-</span><span class="mi">1</span><span class="err">&#39;</span>
</pre></div>


<h3 id="_8">二进制</h3>
<p>有时候服务器返回的数据不是文本的，而是二进制的，这时候我们就需要处理二进制的内容。</p>
<p>Requests中可以使用content方法来返回二进制的响应内容，比如</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">content</span>
<span class="n">b</span><span class="err">&#39;</span><span class="p">[{</span><span class="s">&quot;repository&quot;</span><span class="o">:</span><span class="p">{</span><span class="s">&quot;open_issues&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;url&quot;</span><span class="o">:</span><span class="s">&quot;https://github.com/...</span>
</pre></div>


<p>如果响应是gzip压缩过的，Requests会自动解压。</p>
<p>下面这个例子演示了如何从服务器返回的二进制内容创建图片。</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">from</span> <span class="n">PIL</span> <span class="n">import</span> <span class="n">Image</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">from</span> <span class="n">io</span> <span class="n">import</span> <span class="n">BytesIO</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>
</pre></div>


<h3 id="header">header</h3>
<p><code>r.headers</code> 可以拿到Python 字典形式展示的服务器响应头：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span>
<span class="p">{</span>
    <span class="err">&#39;</span><span class="n">content</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">transfer</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">chunked</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">connection</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">close</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">server</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.0.4</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">x</span><span class="o">-</span><span class="n">runtime</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="mi">148</span><span class="n">ms</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">etag</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="s">&quot;e1ca502697e5c9317743dc078f67693f&quot;</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">&#39;</span>
<span class="p">}</span>
</pre></div>


<p>但是这个字典比较特殊：它是仅为 HTTP 头部而生的。根据<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">RFC 2616</a>， HTTP 头部是大小写不敏感的。</p>
<p>因此，我们可以使用任意大写形式来访问这些响应头字段：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="err">&#39;</span><span class="p">]</span>
<span class="err">&#39;</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">&#39;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="err">&#39;</span><span class="p">)</span>
<span class="err">&#39;</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">&#39;</span>
</pre></div>


<h4 id="user-agent">user-agent (爬虫需更改)</h4>
<div class="hlcode"><pre><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_1</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">62.0.3202.94</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>

<span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">).</span><span class="n">text</span>
</pre></div>


<h3 id="cookie">cookie</h3>
<p>如果某个响应中包含一些 cookie，你可以快速访问它们：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//example.com/some/cookie/setting/url&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">cookies</span><span class="p">[</span><span class="err">&#39;</span><span class="n">example_cookie_name</span><span class="err">&#39;</span><span class="p">]</span>
<span class="err">&#39;</span><span class="n">example_cookie_value</span><span class="err">&#39;</span>
</pre></div>


<p>要想发送你的cookies到服务器，可以使用 cookies 参数：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/cookies&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">dict</span><span class="p">(</span><span class="n">cookies_are</span><span class="o">=</span><span class="err">&#39;</span><span class="n">working</span><span class="err">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;cookies&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s">&quot;cookies_are&quot;</span><span class="o">:</span> <span class="s">&quot;working&quot;</span><span class="p">}}</span><span class="err">&#39;</span>
</pre></div>


<p>Cookie 的返回对象为 <a href="http://docs.python-requests.org/zh_CN/latest/api.html#requests.cookies.RequestsCookieJar">RequestsCookieJar</a>，它的行为和字典类似，但界面更为完整，适合跨域名跨路径使用。你还可以把 Cookie Jar 传到 Requests 中：</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">jar</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="n">RequestsCookieJar</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">jar</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="err">&#39;</span><span class="n">tasty_cookie</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">yum</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="err">&#39;</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="err">&#39;</span><span class="o">/</span><span class="n">cookies</span><span class="err">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">jar</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="err">&#39;</span><span class="n">gross_cookie</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">blech</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="err">&#39;</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="err">&#39;</span><span class="o">/</span><span class="n">elsewhere</span><span class="err">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/cookies&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">jar</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;cookies&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s">&quot;tasty_cookie&quot;</span><span class="o">:</span> <span class="s">&quot;yum&quot;</span><span class="p">}}</span><span class="err">&#39;</span>
</pre></div>


<h4 id="cookie-value">获取cookie value</h4>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.baidu.com/&#39;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="n">get_dict</span><span class="p">())</span>
</pre></div>


<h4 id="session">session</h4>
<p>共享cookie免登录</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.shanbay.com/api/v1/account/login/web/&#39;</span>
<span class="n">zone_url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.shanbay.com/checkin/user/xxxxx/&#39;</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Iridium</span><span class="o">/</span><span class="mf">2017.11</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">62.0.3202.94</span><span class="err">&#39;</span>
<span class="p">}</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;username&quot;</span><span class="o">:</span><span class="s">&quot;xxx&quot;</span><span class="p">,</span><span class="s">&quot;password&quot;</span><span class="o">:</span><span class="s">&quot;xxx&quot;</span><span class="p">}</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">zone_url</span><span class="p">)</span>

<span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">shanbay</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">f</span><span class="o">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>


<h1 id="exception">exception 处理</h1>
<p>All exceptions that Requests explicitly raises inherit from </p>
<div class="hlcode"><pre><span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span>
</pre></div>


<p>catch the base-class exception, which will handle all cases:</p>
<div class="hlcode"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="n">thing</span><span class="p">})</span>
<span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c"># This is the correct syntax</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>


<p>can catch them separately and do different things.</p>
<div class="hlcode"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="n">thing</span><span class="p">})</span>
<span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
    <span class="c"># Maybe set up for a retry, or continue in a retry loop</span>
<span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TooManyRedirects</span><span class="p">:</span>
    <span class="c"># Tell the user their URL was bad and try a different one</span>
<span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c"># catastrophic error. bail.</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">url</span><span class="o">=</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.google.com/blahblah&#39;</span>

<span class="nl">try:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="n">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">HTTPError</span> <span class="n">as</span> <span class="n">errh</span><span class="o">:</span>
    <span class="n">print</span> <span class="p">(</span><span class="s">&quot;Http Error:&quot;</span><span class="p">,</span><span class="n">errh</span><span class="p">)</span>
<span class="n">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">ConnectionError</span> <span class="n">as</span> <span class="n">errc</span><span class="o">:</span>
    <span class="n">print</span> <span class="p">(</span><span class="s">&quot;Error Connecting:&quot;</span><span class="p">,</span><span class="n">errc</span><span class="p">)</span>
<span class="n">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">Timeout</span> <span class="n">as</span> <span class="n">errt</span><span class="o">:</span>
    <span class="n">print</span> <span class="p">(</span><span class="s">&quot;Timeout Error:&quot;</span><span class="p">,</span><span class="n">errt</span><span class="p">)</span>
<span class="n">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="n">as</span> <span class="n">err</span><span class="o">:</span>
    <span class="n">print</span> <span class="p">(</span><span class="s">&quot;OOps: Something Else&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>

<span class="n">Http</span> <span class="n">Error</span><span class="o">:</span> <span class="mi">404</span> <span class="n">Client</span> <span class="n">Error</span><span class="o">:</span> <span class="n">Not</span> <span class="n">Found</span> <span class="k">for</span> <span class="n">url</span><span class="o">:</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.google.com/blahblah</span>
</pre></div>


<h2 id="401">401</h2>
<p>If you want http errors (e.g. 401 Unauthorized) to raise exceptions, you can call <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response.raise_for_status"><code>Response.raise_for_status</code></a>. That will raise an <code>HTTPError</code>, if the response was an http error.</p>
<div class="hlcode"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s1">&#39;http://www.google.com/nothere&#39;</span><span class="o">)</span>
    <span class="n">r</span><span class="o">.</span><span class="na">raise_for_status</span><span class="o">()</span>
<span class="n">except</span> <span class="n">requests</span><span class="o">.</span><span class="na">exceptions</span><span class="o">.</span><span class="na">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="o">:</span>
    <span class="n">raise</span> <span class="n">SystemExit</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">SystemExit</span><span class="o">:</span> <span class="mi">404</span> <span class="n">Client</span> <span class="n">Error</span><span class="o">:</span> <span class="n">Not</span> <span class="n">Found</span> <span class="k">for</span> <span class="n">url</span><span class="o">:</span> <span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">nothere</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>