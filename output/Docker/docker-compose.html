<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>docker-compose - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Docker">Docker</a>&nbsp;&#187;&nbsp;docker-compose
    <span class="updated">Page Updated&nbsp;
      2018-10-24 15:17
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">docker-compose</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#compose">compose</a><ul>
<li><a href="#_1">分层</a></li>
<li><a href="#compose_1">Compose 模板文件</a></li>
</ul>
</li>
<li><a href="#docker-compose">docker-compose 命令</a><ul>
<li><a href="#options">options 命令选项</a></li>
<li><a href="#build">build 构建</a></li>
<li><a href="#config">config</a></li>
<li><a href="#down">down</a></li>
<li><a href="#exec">exec</a></li>
<li><a href="#help">help</a></li>
<li><a href="#images">images</a></li>
<li><a href="#kill">kill</a></li>
<li><a href="#logs">logs</a></li>
<li><a href="#pause">pause</a></li>
<li><a href="#port">port</a></li>
<li><a href="#ps">ps</a></li>
<li><a href="#pull">pull</a></li>
<li><a href="#push">push</a></li>
<li><a href="#restart">restart</a></li>
<li><a href="#rm">rm</a></li>
<li><a href="#run">run</a></li>
<li><a href="#scale">scale</a></li>
<li><a href="#start">start</a></li>
<li><a href="#stop">stop</a></li>
<li><a href="#top">top</a></li>
<li><a href="#unpause">unpause</a></li>
<li><a href="#up">up</a></li>
<li><a href="#version">version</a></li>
</ul>
</li>
<li><a href="#docker-composeyml">docker-compose.yml 属性</a><ul>
<li><a href="#version_1">version</a></li>
<li><a href="#services">services</a></li>
<li><a href="#build_1">build</a></li>
<li><a href="#command">command</a></li>
<li><a href="#dns">dns</a></li>
<li><a href="#dns_search">dns_search</a></li>
<li><a href="#environment">environment</a></li>
<li><a href="#env_file">env_file</a></li>
<li><a href="#expose">expose</a></li>
<li><a href="#image">image</a></li>
<li><a href="#network_mode">network_mode</a></li>
<li><a href="#ports">ports</a></li>
<li><a href="#volumes">volumes</a></li>
<li><a href="#logs_1">logs</a></li>
<li><a href="#links">links</a></li>
</ul>
</li>
<li><a href="#example">example</a><ul>
<li><a href="#haproxy">haproxy</a><ul>
<li><a href="#docker-composeyml_1">docker-compose.yml</a></li>
</ul>
</li>
<li><a href="#django">使用 Django</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="compose">compose</h1>
<p>Docker Compose 是 Docker 官方编排（Orchestration）项目之一，负责快速在集群中部署分布式应用。</p>
<p>Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。从功能上看，跟 OpenStack 中的 Heat 十分类似。<br />
Compose 定位是 「定义和运行多个 Docker 容器的应用（Defining and running multi-container Docker applications）」，其前身是开源项目 Fig。</p>
<p>Docker Compose 运行目录下的所有文件（docker-compose.yml）组成一个工程,一个工程包含多个服务，每个服务中定义了容器运行的镜像、参数、依赖，一个服务可包括多个容器实例</p>
<h2 id="_1">分层</h2>
<p>Docker Compose 将所管理的容器分为三层</p>
<p>服务 (service)：一个应用容器，实际上可以运行多个相同镜像的实例。</p>
<p>项目 (project)：由一组关联的应用容器组成的一个完整业务单元。</p>
<p>容器（container）: 容器进程</p>
<h2 id="compose_1">Compose 模板文件</h2>
<p>模板文件是使用 Compose 的核心</p>
<p>默认的模板文件名称为 docker-compose.yml，格式为 YAML 格式。</p>
<div class="hlcode"><pre><span class="nl">version:</span> <span class="s">&quot;3&quot;</span>
<span class="nl">services:</span>
  <span class="nl">webapp:</span>
    <span class="nl">image:</span> <span class="n">examples</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">ports:</span>
      <span class="o">-</span> <span class="s">&quot;80:80&quot;</span>
    <span class="nl">volumes:</span>
      <span class="o">-</span> <span class="s">&quot;/data&quot;</span>
</pre></div>


<p>每个服务都必须通过 image 指令指定镜像或 build 指令（需要 Dockerfile）等来自动构建生成镜像。</p>
<p>如果使用 build 指令，在 Dockerfile 中设置的选项(例如：CMD, EXPOSE, VOLUME, ENV 等) 将会自动被获取，无需在 docker-compose.yml 中再次设置。</p>
<h1 id="docker-compose">docker-compose 命令</h1>
<p>对于 Compose 来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>
<p>执行 <code>docker-compose [COMMAND] --help</code> 或者 <code>docker-compose help [COMMAND]</code> 可以查看具体某个命令的使用格式。</p>
<div class="hlcode"><pre><span class="nx">docker</span><span class="na">-compose</span> <span class="err">[</span><span class="na">-f</span><span class="o">=&lt;</span><span class="nx">arg</span><span class="o">&gt;</span><span class="nx">...</span><span class="cp">]</span> <span class="cp">[</span><span class="nx">options</span><span class="cp">]</span> <span class="cp">[</span><span class="nb">COMMAND</span><span class="cp">]</span> <span class="cp">[</span><span class="nx">ARGS...</span><span class="cp">]</span>
</pre></div>


<h2 id="options">options 命令选项</h2>
<div class="hlcode"><pre><span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="o">--</span><span class="n">file</span> <span class="kt">FILE</span> <span class="err">指定使用的</span> <span class="n">Compose</span> <span class="err">模板文件，默认为</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">yml</span><span class="err">，可以多次指定。</span>

<span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="o">--</span><span class="n">project</span><span class="o">-</span><span class="n">name</span> <span class="n">NAME</span> <span class="err">指定项目名称，默认将使用所在目录名称作为项目名。</span>

<span class="o">--</span><span class="n">x</span><span class="o">-</span><span class="n">networking</span> <span class="err">使用</span> <span class="n">Docker</span> <span class="err">的可拔插网络后端特性</span>

<span class="o">--</span><span class="n">x</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">driver</span> <span class="n">DRIVER</span> <span class="err">指定网络后端的驱动，默认为</span> <span class="n">bridge</span>

<span class="o">--</span><span class="n">verbose</span> <span class="err">输出更多调试信息。</span>

<span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">version</span> <span class="err">打印版本并退出。</span>
</pre></div>


<h2 id="build">build 构建</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">build</span> <span class="p">[</span><span class="n">options</span><span class="p">][</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>构建（重新构建）项目中的服务容器。</p>
<p>服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 web_db。</p>
<p>可以随时在项目目录下运行 docker-compose build 来重新构建服务。</p>
<div class="hlcode"><pre><span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">rm</span> <span class="err">删除构建过程中的临时容器。</span>

<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span> <span class="err">构建镜像过程中不使用</span> <span class="n">cache</span><span class="err">（这将加长构建过程）。</span>

<span class="o">--</span><span class="n">pull</span> <span class="err">始终尝试通过</span> <span class="n">pull</span> <span class="err">来获取更新版本的镜像。</span>
</pre></div>


<h2 id="config">config</h2>
<p>验证 Compose 文件格式是否正确，若正确则显示配置，若格式错误显示错误原因。</p>
<h2 id="down">down</h2>
<p>此命令将会停止 up 命令所启动的容器，并移除网络</p>
<h2 id="exec">exec</h2>
<p>进入指定的容器。</p>
<h2 id="help">help</h2>
<p>获得一个命令的帮助。</p>
<h2 id="images">images</h2>
<p>列出 Compose 文件中包含的镜像。</p>
<h2 id="kill">kill</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">kill</span> <span class="p">[</span><span class="n">options</span><span class="p">][</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>通过发送 SIGKILL 信号来强制停止服务容器。</p>
<p>支持通过 -s 参数来指定发送的信号，例如通过如下指令发送 SIGINT 信号。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">kill</span> <span class="o">-</span><span class="n">s</span> <span class="n">SIGINT</span>
</pre></div>


<h2 id="logs">logs</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">logs</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>查看服务容器的输出。默认情况下，docker-compose 将对不同的服务输出使用不同的颜色来区分。可以通过 --no-color 来关闭颜色。</p>
<h2 id="pause">pause</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">pause</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>暂停一个服务容器。</p>
<h2 id="port">port</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">port</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="n">SERVICE</span> <span class="n">PRIVATE_PORT</span>
</pre></div>


<p>打印某个容器端口所映射的公共端口。</p>
<p>--protocol=proto 指定端口协议，tcp（默认值）或者 udp。</p>
<p>--index=index 如果同一服务存在多个容器，指定命令对象容器的序号（默认为 1）。</p>
<h2 id="ps">ps</h2>
<p>列出项目中目前的所有容器。</p>
<p>-q 只打印容器的 ID 信息</p>
<h2 id="pull">pull</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">pull</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>拉取服务依赖的镜像。设置指定服务运气容器的个数，以 service=num 形式指定</p>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">scale</span> <span class="n">user</span><span class="o">=</span><span class="mi">3</span> <span class="n">movie</span><span class="o">=</span><span class="mi">3</span>
</pre></div>


<div class="hlcode"><pre><span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">pull</span><span class="o">-</span><span class="n">failures</span> <span class="err">忽略拉取镜像过程中的错误</span>
</pre></div>


<h2 id="push">push</h2>
<p>推送服务依赖的镜像到 Docker 镜像仓库。</p>
<h2 id="restart">restart</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">restart</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>重启项目中的服务。</p>
<div class="hlcode"><pre><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">timeout</span> <span class="n">TIMEOUT</span> <span class="err">指定重启前停止容器的超时（默认为</span> <span class="mi">10</span> <span class="err">秒）。</span>
</pre></div>


<h2 id="rm">rm</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">rm</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>删除所有（停止状态的）服务容器。推荐先执行 docker-compose stop 命令来停止容器。</p>
<div class="hlcode"><pre><span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="o">--</span><span class="n">force</span> <span class="err">强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。</span>

<span class="o">-</span><span class="n">v</span> <span class="err">删除容器所挂载的数据卷。</span>
</pre></div>


<h2 id="run">run</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">run</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="n">PORT</span><span class="p">...]</span> <span class="p">[</span><span class="o">-</span><span class="n">e</span> <span class="n">KEY</span><span class="o">=</span><span class="n">VAL</span><span class="p">...]</span> <span class="n">SERVICE</span> <span class="p">[</span><span class="n">COMMAND</span><span class="p">]</span> <span class="p">[</span><span class="n">ARGS</span><span class="p">...]</span>
</pre></div>


<p>在指定服务上执行一个命令</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">run</span> <span class="n">ubuntu</span> <span class="n">ping</span> <span class="n">docker</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<blockquote>
<p>将会启动一个 ubuntu 服务容器，并执行 ping docker.com 命令。</p>
</blockquote>
<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>
<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>
<p>两个不同点：</p>
<p>给定命令将会覆盖原有的自动运行命令；</p>
<p>不会自动创建端口，以避免冲突。</p>
<p>如果不希望自动启动关联的容器，可以使用 --no-deps 选项，例如</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">run</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">deps</span> <span class="n">web</span> <span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">shell</span>
</pre></div>


<blockquote>
<p>将不会启动 web 容器所关联的其它容器。</p>
</blockquote>
<div class="hlcode"><pre><span class="o">-</span><span class="n">d</span> <span class="err">后台运行容器。</span>

<span class="o">--</span><span class="n">name</span> <span class="n">NAME</span> <span class="err">为容器指定一个名字。</span>

<span class="o">--</span><span class="n">entrypoint</span> <span class="n">CMD</span> <span class="err">覆盖默认的容器启动指令。</span>

<span class="o">-</span><span class="n">e</span> <span class="n">KEY</span><span class="o">=</span><span class="n">VAL</span> <span class="err">设置环境变量值，可多次使用选项来设置多个环境变量。</span>

<span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="err">指定运行容器的用户名或者</span> <span class="n">uid</span><span class="err">。</span>

<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">deps</span> <span class="err">不自动启动关联的服务容器。</span>

<span class="o">--</span><span class="n">rm</span> <span class="err">运行命令后自动删除容器，</span><span class="n">d</span> <span class="err">模式下将忽略。</span>

<span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="o">--</span><span class="n">publish</span><span class="o">=</span><span class="p">[]</span> <span class="err">映射容器端口到本地主机。</span>

<span class="o">--</span><span class="n">service</span><span class="o">-</span><span class="n">ports</span> <span class="err">配置服务端口并映射到本地主机。</span>

<span class="o">-</span><span class="n">T</span> <span class="err">不分配伪</span> <span class="n">tty</span><span class="err">，意味着依赖</span> <span class="n">tty</span> <span class="err">的指令将无法运行</span>
</pre></div>


<h2 id="scale">scale</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">scale</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">SERVICE</span><span class="o">=</span><span class="n">NUM</span><span class="p">...]</span>
</pre></div>


<p>设置指定服务运行的容器个数。</p>
<p>通过 service=num 的参数来设置数量。例如：</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">scale</span> <span class="n">web</span><span class="o">=</span><span class="mi">3</span> <span class="n">db</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<blockquote>
<p>将启动 3 个容器运行 web 服务，2 个容器运行 db 服务。</p>
</blockquote>
<p>一般的，当指定数目多于该服务当前实际运行容器，将新创建并启动容器；反之，将停止容器。</p>
<div class="hlcode"><pre><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">timeout</span> <span class="n">TIMEOUT</span> <span class="err">停止容器时候的超时（默认为</span> <span class="mi">10</span> <span class="err">秒）</span>
</pre></div>


<h2 id="start">start</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">start</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>启动已经存在的服务容器。</p>
<h2 id="stop">stop</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">stop</span> <span class="p">[</span><span class="n">options</span><span class="p">][</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>停止已经处于运行状态的容器，但不删除它。通过 docker-compose start 可以再次启动这些容器。</p>
<div class="hlcode"><pre><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">timeout</span> <span class="n">TIMEOUT</span> <span class="err">停止容器时候的超时（默认为</span> <span class="mi">10</span> <span class="err">秒）</span>
</pre></div>


<h2 id="top">top</h2>
<p>查看各个服务容器内运行的进程。</p>
<h2 id="unpause">unpause</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">unpause</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>恢复处于暂停状态中的服务。</p>
<h2 id="up">up</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">SERVICE</span><span class="p">...]</span>
</pre></div>


<p>当服务的配置发生更改时，可使用 docker-compose up 命令更新配置</p>
<p>此时，Compose 会删除旧容器并创建新容器，新容器会以不同的 IP 地址加入网络，名称保持不变，任何指向旧容起的连接都会被关闭，重新找到新容器并连接上去</p>
<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>
<p>默认情况，docker-compose up 启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>
<p>当通过 Ctrl-C 停止命令时，所有容器将会停止。</p>
<p>如果使用 docker-compose up -d，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>
<p>默认情况，如果服务容器已经存在，docker-compose up 将会尝试停止容器，然后重新创建（保持使用 volumes-from 挂载的卷），以保证新启动的服务匹配 docker-compose.yml 文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用 docker-compose up --no-recreate。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用 docker-compose up --no-deps -d <SERVICE_NAME> 来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>
<div class="hlcode"><pre><span class="o">-</span><span class="n">d</span> <span class="err">在后台运行服务容器。</span>

<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">color</span> <span class="err">不使用颜色来区分不同的服务的控制台输出。</span>

<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">deps</span> <span class="err">不启动服务所链接的容器。</span>

<span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">recreate</span> <span class="err">强制重新创建容器，不能与</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">recreate</span> <span class="err">同时使用。</span>

<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">recreate</span> <span class="err">如果容器已经存在了，则不重新创建，不能与</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">recreate</span> <span class="err">同时使用。</span>

<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">build</span> <span class="err">不自动构建缺失的服务镜像。</span>

<span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">timeout</span> <span class="n">TIMEOUT</span> <span class="err">停止容器时候的超时（默认为</span> <span class="mi">10</span> <span class="err">秒）</span>
</pre></div>


<h2 id="version">version</h2>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">version</span>
</pre></div>


<p>打印版本信息。</p>
<h1 id="docker-composeyml">docker-compose.yml 属性</h1>
<h2 id="version_1">version</h2>
<p>指定 docker-compose.yml 文件的写法格式</p>
<h2 id="services">services</h2>
<p>多个容器集合</p>
<h2 id="build_1">build</h2>
<p>配置构建时，Compose 会利用它自动构建镜像，该值可以是一个路径，也可以是一个对象，用于指定 Dockerfile 参数</p>
<div class="hlcode"><pre><span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">dir</span>
<span class="o">---------------</span>
<span class="nl">build:</span>
    <span class="nl">context:</span> <span class="p">.</span><span class="o">/</span><span class="n">dir</span>
    <span class="nl">dockerfile:</span> <span class="n">Dockerfile</span>
    <span class="nl">args:</span>
        <span class="nl">buildno:</span> <span class="mi">1</span>
</pre></div>


<h2 id="command">command</h2>
<p>覆盖容器启动后默认执行的命令</p>
<div class="hlcode"><pre><span class="n">command</span><span class="o">:</span> <span class="n">bundle</span> <span class="n">exec</span> <span class="n">thin</span> <span class="o">-</span><span class="n">p</span> <span class="mi">3000</span>
<span class="o">----------------------------------</span>
<span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="n">bundle</span><span class="o">,</span><span class="n">exec</span><span class="o">,</span><span class="n">thin</span><span class="o">,-</span><span class="n">p</span><span class="o">,</span><span class="mi">3000</span><span class="o">]</span>
</pre></div>


<h2 id="dns">dns</h2>
<p>配置 dns 服务器，可以是一个值或列表</p>
<div class="hlcode"><pre><span class="gh">dns: 8.8.8.8</span>
<span class="gh">------------</span>
dns:
    - 8.8.8.8
    <span class="m">-</span> 9.9.9.9
</pre></div>


<h2 id="dns_search">dns_search</h2>
<p>配置 DNS 搜索域，可以是一个值或列表</p>
<div class="hlcode"><pre><span class="n">dns_search</span><span class="o">:</span> <span class="n">example</span><span class="o">.</span><span class="na">com</span>
<span class="o">------------------------</span>
<span class="n">dns_search</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">dc1</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span>
    <span class="o">-</span> <span class="n">dc2</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span>
</pre></div>


<h2 id="environment">environment</h2>
<p>环境变量配置，可以用数组或字典两种方式</p>
<div class="hlcode"><pre><span class="n">environment</span><span class="o">:</span>
    <span class="n">RACK_ENV</span><span class="o">:</span> <span class="n">development</span>
    <span class="n">SHOW</span><span class="o">:</span> <span class="s1">&#39;ture&#39;</span>
<span class="o">-------------------------</span>
<span class="n">environment</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">RACK_ENV</span><span class="o">=</span><span class="n">development</span>
    <span class="o">-</span> <span class="n">SHOW</span><span class="o">=</span><span class="n">ture</span>
</pre></div>


<h2 id="env_file">env_file</h2>
<p>从文件中获取环境变量，可以指定一个文件路径或路径列表，其优先级低于 environment 指定的环境变量</p>
<div class="hlcode"><pre><span class="nl">env_file:</span> <span class="p">.</span><span class="n">env</span>
<span class="o">---------------</span>
<span class="nl">env_file:</span>
    <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">common</span><span class="p">.</span><span class="n">env</span>
</pre></div>


<h2 id="expose">expose</h2>
<p>暴露端口，只将端口暴露给连接的服务，而不暴露给主机</p>
<div class="hlcode"><pre><span class="nl">expose:</span>
    <span class="o">-</span> <span class="s">&quot;3000&quot;</span>
    <span class="o">-</span> <span class="s">&quot;8000&quot;</span>
</pre></div>


<h2 id="image">image</h2>
<p>指定服务所使用的镜像</p>
<div class="hlcode"><pre><span class="n">image</span><span class="o">:</span> <span class="n">java</span>
</pre></div>


<h2 id="network_mode">network_mode</h2>
<p>设置网络模式</p>
<div class="hlcode"><pre><span class="nl">network_mode:</span> <span class="s">&quot;bridge&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;host&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;none&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;service:[service name]&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;container:[container name/id]&quot;</span>
</pre></div>


<h2 id="ports">ports</h2>
<p>对外暴露的端口定义，和 expose 对应</p>
<div class="hlcode"><pre><span class="nl">ports:</span>   <span class="err">#</span> <span class="err">暴露端口信息</span>  <span class="o">-</span> <span class="s">&quot;宿主机端口:容器暴露端口&quot;</span>
<span class="o">-</span> <span class="s">&quot;8763:8763&quot;</span>
<span class="o">-</span> <span class="s">&quot;8763:8763&quot;</span>
</pre></div>


<h2 id="volumes">volumes</h2>
<p>卷挂载路径</p>
<div class="hlcode"><pre><span class="nl">volumes:</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">lib</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">var</span>
</pre></div>


<h2 id="logs_1">logs</h2>
<p>日志输出信息</p>
<div class="hlcode"><pre><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">color</span>          <span class="err">单色输出，不显示其他颜</span><span class="p">.</span>
<span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="o">--</span><span class="n">follow</span>        <span class="err">跟踪日志输出，就是可以实时查看日志</span>
<span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">timestamps</span>    <span class="err">显示时间戳</span>
<span class="o">--</span><span class="n">tail</span>              <span class="err">从日志的结尾显示，</span><span class="o">--</span><span class="n">tail</span><span class="o">=</span><span class="mi">200</span>
</pre></div>


<h2 id="links">links</h2>
<p>服务之间可以使用服务名称相互访问，links 允许定义一个别名，从而使用该别名访问其它服务, 避免ip方式导致的容器重启动态改变的无法连接情况</p>
<div class="hlcode"><pre><span class="nl">version:</span> <span class="sc">&#39;2&#39;</span>
<span class="nl">services:</span>
    <span class="nl">web:</span>
        <span class="nl">build:</span> <span class="p">.</span>
        <span class="nl">links:</span>
            <span class="o">-</span> <span class="s">&quot;db:database&quot;</span>
    <span class="nl">db:</span>
        <span class="nl">image:</span> <span class="n">postgres</span>
</pre></div>


<blockquote>
<p>这样 Web 服务就可以使用 db 或 database 作为 hostname 访问 db 服务了</p>
</blockquote>
<h1 id="example">example</h1>
<h2 id="haproxy">haproxy</h2>
<p>我们创建一个经典的 Web 项目：一个 Haproxy，挂载三个 Web 容器。</p>
<p>创建一个 compose-haproxy-web 目录，作为项目工作目录，并在其中分别创建两个子目录：haproxy 和 web。</p>
<ul>
<li>web 子目录</li>
</ul>
<p>这里用 Python 程序来提供一个简单的 HTTP 服务，打印出访问者的 IP 和 实际的本地 IP。</p>
<p>编写一个 index.py 作为服务器文件，代码为</p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/usr/bin/python</span>
<span class="c">#authors: yeasy.github.com</span>
<span class="c">#date: 2013-07-05</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">BaseHTTPServer</span>
<span class="kn">from</span> <span class="nn">SimpleHTTPServer</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="k">class</span> <span class="nc">HandlerClass</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ifname</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="mh">0x8915</span><span class="p">,</span>  <span class="c"># SIOCGIFADDR</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;256s&#39;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="p">)[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="s">&quot;200&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;pickle_data.txt&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">request</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip_address</span><span class="p">(</span><span class="s">&#39;eth0&#39;</span><span class="p">)</span>
        <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address_string</span><span class="p">()</span>
        <span class="n">addr_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">server</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addr_pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ts</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">del</span> <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span>
            <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">num</span><span class="p">,</span><span class="n">ts</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;index.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt;&lt;center&gt;&lt;h1&gt;&lt;font color=</span><span class="se">\&quot;</span><span class="s">blue</span><span class="se">\&quot;</span><span class="s"> face=</span><span class="se">\&quot;</span><span class="s">Georgia, Arial</span><span class="se">\&quot;</span><span class="s"> size=8&gt;&lt;em&gt;HA&lt;/em&gt;&lt;/font&gt; Webpage Visit Results&lt;/h1&gt;&lt;/center&gt;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">guest</span> <span class="o">=</span> <span class="s">&quot;LOCAL: &quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guest</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time_now</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p style=</span><span class="se">\&quot;</span><span class="s">font-size:150%</span><span class="se">\&quot;</span><span class="s"> &gt;#&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;: &lt;font color=</span><span class="se">\&quot;</span><span class="s">red</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s">&quot;&lt;/font&gt; requests &quot;</span> <span class="o">+</span> <span class="s">&quot;from &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">blue</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">guest</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">blue</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt&lt;/p&gt;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p style=</span><span class="se">\&quot;</span><span class="s">font-size:150%</span><span class="se">\&quot;</span><span class="s"> &gt;#&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;: &lt;font color=</span><span class="se">\&quot;</span><span class="s">maroon</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s">&quot;&lt;/font&gt; requests &quot;</span> <span class="o">+</span> <span class="s">&quot;from &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">navy</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">guest</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">navy</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt&lt;/p&gt;&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/body&gt; &lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;pickle_data.txt&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ServerClass</span>  <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span>
        <span class="n">Protocol</span>     <span class="o">=</span> <span class="s">&quot;HTTP/1.0&quot;</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s">&quot;0.0.0.0&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="mi">80</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">HandlerClass</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">Protocol</span>
        <span class="n">httpd</span> <span class="o">=</span> <span class="n">ServerClass</span><span class="p">((</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">HandlerClass</span><span class="p">)</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;Serving HTTP on&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;...&quot;</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<ul>
<li>生成一个临时的 index.html 文件，其内容会被 index.py 更新。</li>
</ul>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">touch</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>
</pre></div>


<ul>
<li>Dockerfile</li>
</ul>
<div class="hlcode"><pre><span class="n">FROM</span> <span class="n">python</span><span class="o">:</span><span class="mf">2.7</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">ADD</span> <span class="p">.</span> <span class="o">/</span><span class="n">code</span>
<span class="n">EXPOSE</span> <span class="mi">80</span>
<span class="n">CMD</span> <span class="n">python</span> <span class="n">index</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<ul>
<li>haproxy 目录 </li>
</ul>
<p>编写 haproxy.cfg 文件，内容为</p>
<div class="hlcode"><pre><span class="n">global</span>
  <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span>
  <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local1</span> <span class="n">notice</span>

<span class="n">defaults</span>
  <span class="n">log</span> <span class="n">global</span>
  <span class="n">mode</span> <span class="n">http</span>
  <span class="n">option</span> <span class="n">httplog</span>
  <span class="n">option</span> <span class="n">dontlognull</span>
  <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5000</span><span class="n">ms</span>
  <span class="n">timeout</span> <span class="n">client</span> <span class="mi">50000</span><span class="n">ms</span>
  <span class="n">timeout</span> <span class="n">server</span> <span class="mi">50000</span><span class="n">ms</span>

<span class="n">listen</span> <span class="n">stats</span>
    <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">70</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span>

<span class="n">frontend</span> <span class="n">balancer</span>
    <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">80</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">default_backend</span> <span class="n">web_backends</span>

<span class="n">backend</span> <span class="n">web_backends</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">option</span> <span class="n">forwardfor</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">server</span> <span class="n">weba</span> <span class="n">weba</span><span class="o">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">server</span> <span class="n">webb</span> <span class="n">webb</span><span class="o">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">server</span> <span class="n">webc</span> <span class="n">webc</span><span class="o">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">option</span> <span class="n">httpchk</span> <span class="n">GET</span> <span class="o">/</span>
    <span class="n">http</span><span class="o">-</span><span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="mi">200</span>
</pre></div>


<h3 id="docker-composeyml_1">docker-compose.yml</h3>
<p>编写 docker-compose.yml 文件，这个是 Compose 使用的主模板文件。内容十分简单，指定 3 个 web 容器，以及 1 个 haproxy 容器。</p>
<div class="hlcode"><pre><span class="nl">version:</span> <span class="s">&quot;3&quot;</span>
<span class="nl">services:</span>
  <span class="nl">weba:</span>
    <span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="mi">80</span>
  <span class="nl">webb:</span>
    <span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="mi">80</span>
  <span class="nl">webc:</span>
    <span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="mi">80</span>
  <span class="nl">haproxy:</span>
    <span class="nl">image:</span> <span class="n">haproxy</span><span class="o">:</span><span class="n">latest</span>
    <span class="nl">volumes:</span>
        <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">haproxy</span><span class="o">:/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">override</span>
        <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span><span class="o">:</span><span class="n">ro</span>
    <span class="nl">ports:</span>
        <span class="o">-</span> <span class="s">&quot;80:80&quot;</span>
        <span class="o">-</span> <span class="s">&quot;70:70&quot;</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="s">&quot;80&quot;</span>
        <span class="o">-</span> <span class="s">&quot;70&quot;</span>
</pre></div>


<ul>
<li>运行 compose 项目</li>
</ul>
<p>现在 compose-haproxy-web 目录结构如下：</p>
<div class="hlcode"><pre><span class="n">compose</span><span class="o">-</span><span class="n">haproxy</span><span class="o">-</span><span class="n">web</span>
<span class="err">├──</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">yml</span>
<span class="err">├──</span> <span class="n">haproxy</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span>
<span class="err">└──</span> <span class="n">web</span>
    <span class="err">├──</span> <span class="n">Dockerfile</span>
    <span class="err">├──</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>
    <span class="err">└──</span> <span class="n">index</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>在该目录下执行 docker-compose up 命令，会整合输出所有容器的输出。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_webb_1</span><span class="p">...</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_webc_1</span><span class="p">...</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_weba_1</span><span class="p">...</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_haproxy_1</span><span class="p">...</span>
<span class="n">Attaching</span> <span class="n">to</span> <span class="n">composehaproxyweb_webb_1</span><span class="p">,</span> <span class="n">composehaproxyweb_webc_1</span><span class="p">,</span> <span class="n">composehaproxyweb_weba_1</span><span class="p">,</span> <span class="n">composehaproxyweb_haproxy_1</span>
</pre></div>


<blockquote>
<p>此时访问本地的 80 端口，会经过 haproxy 自动转发到后端的某个 web 容器上，刷新页面，可以观察到访问的容器地址的变化。<br />
访问本地 70 端口，可以查看到 haproxy 的统计信息。</p>
</blockquote>
<h2 id="django">使用 Django</h2>
<ul>
<li>将使用 Docker Compose 配置并运行一个 Django/PostgreSQL 应用。</li>
</ul>
<p>第一步 编辑 Dockerfile 文件来指定 Docker 容器要安装内容</p>
<ul>
<li>应用将使用安装了 Python 以及必要依赖包的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 镜像创建 和 Dockerfile 使用。</li>
</ul>
<div class="hlcode"><pre><span class="n">FROM</span> <span class="n">python</span><span class="o">:</span><span class="mi">3</span>
<span class="n">ENV</span> <span class="n">PYTHONUNBUFFERED</span> <span class="mi">1</span>
<span class="n">RUN</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">code</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">ADD</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="n">ADD</span> <span class="p">.</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
</pre></div>


<p>第二步，在 requirements.txt 文件里面写明需要安装的具体依赖包名</p>
<div class="hlcode"><pre><span class="n">Django</span><span class="o">&gt;=</span><span class="mf">1.8</span><span class="p">,</span><span class="o">&lt;</span><span class="mf">2.0</span>
<span class="n">psycopg2</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>