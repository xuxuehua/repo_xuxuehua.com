<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>replication 复制 - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Mysql">Mysql</a>&nbsp;&#187;&nbsp;replication 复制
    <span class="updated">Page Updated&nbsp;
      2019-01-16 12:18
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">replication 复制</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">复制</a><ul>
<li><a href="#_2">主从复制</a><ul>
<li><a href="#_3">主节点</a></li>
<li><a href="#_4">从节点</a></li>
</ul>
</li>
<li><a href="#_5">复制架构</a><ul>
<li><a href="#_6">一主多从</a><ul>
<li><a href="#_7">复制实现细节分析</a></li>
<li><a href="#gtid">GTID</a></li>
</ul>
</li>
<li><a href="#_8">一从多主</a></li>
<li><a href="#_9">半同步复制</a></li>
<li><a href="#_10">配置注意点</a><ul>
<li><a href="#_11">限制只读方式</a></li>
<li><a href="#_12">阻止所有用户</a></li>
<li><a href="#_13">保证复制的事务安全</a></li>
</ul>
</li>
<li><a href="#mmm">MMM</a></li>
<li><a href="#mha">MHA</a><ul>
<li><a href="#mha-manager">MHA Manager</a></li>
<li><a href="#mha-node">MHA Node</a></li>
</ul>
</li>
<li><a href="#galera-cluster">Galera Cluster</a><ul>
<li><a href="#percona-cluster">Percona-Cluster</a></li>
<li><a href="#mariadb-cluster">MariaDB-Cluster</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_14">二进制日志事件记录格式</a><ul>
<li><a href="#statement">STATEMENT</a></li>
<li><a href="#row">ROW</a></li>
<li><a href="#mixed">MIXED</a></li>
</ul>
</li>
<li><a href="#_15">复制相关的文件</a><ul>
<li><a href="#masterinfo">master.info</a></li>
<li><a href="#reply-loginfo">reply-log.info</a></li>
</ul>
</li>
<li><a href="#_16">常用操作</a><ul>
<li><a href="#_17">清理日志</a></li>
<li><a href="#_18">复制监控</a></li>
<li><a href="#_19">从服务器是否落后于主服务器</a></li>
<li><a href="#_20"></a></li>
<li><a href="#_21">判断主从结点数据是否一致</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_22">基于二进制日志的主从复制</a></li>
<li><a href="#gtid_1">基于GTID的主从复制</a></li>
<li><a href="#_23">半同步复制</a></li>
<li><a href="#_24">主从复制案例</a><ul>
<li><a href="#_25">主节点</a><ul>
<li><a href="#binlog">查看binlog</a></li>
</ul>
</li>
<li><a href="#_26">从节点</a></li>
<li><a href="#_27">测试</a></li>
</ul>
</li>
<li><a href="#_28">主主复制案例 （慎用）</a><ul>
<li><a href="#id">自动增长ID</a></li>
<li><a href="#_29">配置步骤</a><ul>
<li><a href="#1">节点1</a></li>
<li><a href="#2">节点2</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_30">半同步复制案例</a><ul>
<li><a href="#master">Master</a></li>
<li><a href="#slave">Slave</a></li>
</ul>
</li>
<li><a href="#_31">复制过滤器</a><ul>
<li><a href="#_32">二进制日志方式</a></li>
<li><a href="#_33">中继日志方式</a><ul>
<li><a href="#example">example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ssl">基于SSL复制</a></li>
</ul>
</div>
<h1 id="_1">复制</h1>
<p>每个节点都有相同的数据集</p>
<p>实现数据分布，负载均衡读，备份，高可用和故障切换</p>
<p>slave会从master读取binlog来进行数据同步</p>
<h2 id="_2">主从复制</h2>
<p>1 master将改变记录到二进制日志（binary log）。这些记录过程叫做二进制日志事件，binary log events； </p>
<p>2 slave将master的binary log events拷贝到它的中继日志（relay log）； </p>
<p>3 slave重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化的 </p>
<h3 id="_3">主节点</h3>
<p>Dump Thread： 为每个Slave的I/O Thread 启动一个dump线程，用于向其发送binary log events</p>
<h3 id="_4">从节点</h3>
<p>I/O Thread： 从master请求二进制日志事件，并保存于中继日志中</p>
<p>SQL Thread： 从中继日志中读取日志事件，在本地完成重放</p>
<h2 id="_5">复制架构</h2>
<h3 id="_6">一主多从</h3>
<p>从服务器还可以再有从服务器</p>
<p>MySQL之间数据复制的基础是二进制日志文件（binary log file）。一台MySQL数据库一旦启用二进制日志后，其作为master，它的数据库中所有操作都会以“事件”的方式记录在二进制日志中，其他数据库作为slave通过一个I/O线程与主服务器保持通信，并监控master的二进制日志文件的变化，如果发现master二进制日志文件发生变化，则会把变化复制到自己的中继日志中，然后slave的一个SQL线程会把相关的“事件”执行到自己的数据库中，以此实现从数据库和主数据库的一致性，也就实现了主从复制。</p>
<p>mysql实现主从复制的方案主要有两种：基于二进制日志的主从复制和基于GTID的主从复制。</p>
<p>传统复制是基于主库的二进制日志进行复制，在主站和从站之间同步二进制日志文件和日志文件中的位置标识。</p>
<p>三个工作线程</p>
<ul>
<li>主服务器提供了一个工作线程I/O dump thread</li>
<li>从服务器有两个工作线程，I/O thread和SQL thread</li>
</ul>
<p>执行过程</p>
<ul>
<li>主库把接收到的SQL请求记录到自己的binlog日志文件</li>
<li>从库的I/O thread请求主库I/O dump thread，获得binglog日志，并追加到relay log日志文件</li>
<li>从库的SQL thread执行relay log中的SQL语句</li>
</ul>
<h4 id="_7">复制实现细节分析</h4>
<p>MySQL主从复制功能使用<strong>三个线程实现</strong>，<strong>一个在主服务器上</strong>，<strong>两个在从服务器上</strong></p>
<p>1.Binlog转储线程。</p>
<p>当从服务器与主服务器连接时，主服务器会创建一个线程将二进制日志内容发送到从服务器。<br />
该线程可以使用 语句 <code>SHOW PROCESSLIST</code>(下面有示例介绍) 在服务器 sql 控制台输出中标识为Binlog Dump线程。</p>
<p>二进制日志转储线程获取服务器上二进制日志上的锁，用于读取要发送到从服务器的每个事件。一旦事件被读取，即使在将事件发送到从服务器之前，锁会被释放。</p>
<p>2.从服务器I/O线程。</p>
<p>当在从服务器sql 控制台发出 <code>START SLAVE</code>语句时，从服务器将创建一个I/O线程，该线程连接到主服务器，并要求它发送记录在主服务器上的二进制更新日志。</p>
<p>从机I/O线程读取主服务器Binlog Dump线程发送的更新 （参考上面 Binlog转储线程 介绍），并将它们复制到自己的本地文件二进制日志中。</p>
<p>该线程的状态显示详情 Slave_IO_running 在输出端 使用 命令<code>SHOW SLAVE STATUS</code></p>
<p>使用<code>\G</code>语句终结符,而不是分号,是为了，易读的垂直布局</p>
<p>这个命令在上面 <strong>查看从服务器状态</strong> 用到过</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">SLAVE</span> <span class="n">STATUS</span><span class="err">\</span><span class="n">G</span>
</pre></div>


<p>3.从服务器SQL线程。</p>
<p>从服务器创建一条SQL线程来读取由主服务器I/O线程写入的二级制日志，并执行其中包含的事件。</p>
<p>在前面的描述中，每个主/从连接有三个线程。主服务器为每个当前连接的从服务器创建一个二进制日志转储线程，每个从服务器都有自己的I/O和SQL线程。<br />
从服务器使用两个线程将读取更新与主服务器更新事件，并将其执行为独立任务。因此，如果语句执行缓慢，则读取语句的任务不会减慢。</p>
<p>例如，如果从服务器开始几分钟没有运行，或者即使SQL线程远远落后，它的I/O线程也可以从主服务器建立连接时，快速获取所有二进制日志内容。</p>
<p>如果从服务器在SQL线程执行所有获取的语句之前停止，则I/O线程至少获取已经读取到的内容，以便将语句的安全副本存储在自己的二级制日志文件中，准备下次执行主从服务器建立连接，继续同步。</p>
<p>使用命令 <code>SHOW PROCESSLIST\G</code> 可以查看有关复制的信息</p>
<p>命令 SHOW FULL PROCESSLISTG</p>
<p><strong>在 Master 主服务器 执行的数据示例</strong></p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span>  <span class="n">SHOW</span> <span class="n">FULL</span> <span class="n">PROCESSLIST</span><span class="err">\</span><span class="n">G</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
     <span class="nl">Id:</span> <span class="mi">22</span>
   <span class="nl">User:</span> <span class="n">repl</span>
   <span class="nl">Host:</span> <span class="n">node2</span><span class="o">:</span><span class="mi">39114</span>
     <span class="nl">db:</span> <span class="nb">NULL</span>
<span class="nl">Command:</span> <span class="n">Binlog</span> <span class="n">Dump</span>
   <span class="nl">Time:</span> <span class="mi">4435</span>
  <span class="nl">State:</span> <span class="n">Master</span> <span class="n">has</span> <span class="n">sent</span> <span class="n">all</span> <span class="n">binlog</span> <span class="n">to</span> <span class="n">slave</span><span class="p">;</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">more</span> <span class="n">updates</span>
   <span class="nl">Info:</span> <span class="nb">NULL</span>
</pre></div>


<p>Id: 22是Binlog Dump服务连接的从站的复制线程<br />
Host: node2:39114 是从服务，主机名 级及端口<br />
State: 信息表示所有更新都已同步发送到从服务器，并且主服务器正在等待更多更新发生。<br />
如果Binlog Dump在主服务器上看不到 线程，意味着主从复制没有配置成功; 也就是说，没有从服务器连接主服务器。</p>
<p>命令 SHOW PROCESSLISTG</p>
<p><strong>在 Slave 从服务器 ，查看两个线程的更新状态</strong></p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">PROCESSLIST</span><span class="err">\</span><span class="n">G</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
     <span class="nl">Id:</span> <span class="mi">6</span>
   <span class="nl">User:</span> <span class="n">system</span> <span class="n">user</span>
   <span class="nl">Host:</span> 
     <span class="n">db</span><span class="o">:</span> <span class="nb">NULL</span>
<span class="nl">Command:</span> <span class="n">Connect</span>
   <span class="nl">Time:</span> <span class="mi">6810</span>
  <span class="nl">State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
   <span class="nl">Info:</span> <span class="nb">NULL</span>
<span class="o">***************************</span> <span class="mf">2.</span> <span class="n">row</span> <span class="o">***************************</span>
     <span class="nl">Id:</span> <span class="mi">7</span>
   <span class="nl">User:</span> <span class="n">system</span> <span class="n">user</span>
   <span class="nl">Host:</span> 
     <span class="n">db</span><span class="o">:</span> <span class="nb">NULL</span>
<span class="nl">Command:</span> <span class="n">Connect</span>
   <span class="nl">Time:</span> <span class="mi">3069</span>
  <span class="nl">State:</span> <span class="n">Slave</span> <span class="n">has</span> <span class="n">read</span> <span class="n">all</span> <span class="n">relay</span> <span class="n">log</span><span class="p">;</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">more</span> <span class="n">updates</span>
   <span class="nl">Info:</span> <span class="nb">NULL</span>
</pre></div>


<p><strong>Id: 6</strong>是与主服务器通信的I/O线程<br />
<strong>Id: 7</strong>是正在处理存储在中继日志中的更新的SQL线程</p>
<p>在 运行 <code>SHOW PROCESSLIST</code> 命令时，两个线程都空闲，等待进一步更新</p>
<p>如果在主服务器上在设置的超时，时间内 Binlog Dump线程没有活动，则主服务器会和从服务器断开连接。超时取决于的 <strong>服务器系统变量</strong> 值 net_write_timeout(在中止写入之前等待块写入连接的秒数，默认10秒)和 net_retry_count;(如果通信端口上的读取或写入中断，请在重试次数，默认10次) 设置 <a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html">服务器系统变量</a></p>
<p>该SHOW SLAVE STATUS语句提供了有关从服务器上复制处理的附加信息。请参见 第16.1.7.1节“检查复制状态”。</p>
<h4 id="gtid">GTID</h4>
<p>基于GTID（全局事务标识符）复制是事务性的，因此不需要指定二进制日志文件和文件中的位置，这大大简化了许多常见的复制任务。只要在主站上提交的所有事务也都应用于从站，使用gtids进行复制可确保主站和从站之间的数据一致性。</p>
<h3 id="_8">一从多主</h3>
<h3 id="_9">半同步复制</h3>
<p>master及slave都需要安装插件支持 </p>
<p>MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。半同步复制情况下，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。</p>
<p>确保slave库I/O thread接收完master库的binlog，已经写入到relay log，才通知master库的等待线程该操作已正常结束；</p>
<p>等待超时，会关闭半同步复制，自动切换至异步复制，直到至少有一台slave库通知master库已经接收到binlog信息再恢复     提升了主从之间的数据一致性</p>
<h3 id="_10">配置注意点</h3>
<h4 id="_11">限制只读方式</h4>
<p>在从服务器上设置<code>read_only=ON</code>， 此限制对拥有Super权限的用户均无效</p>
<h4 id="_12">阻止所有用户</h4>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">TABLES</span> <span class="n">WITH</span> <span class="n">RAED</span> <span class="n">LOCK</span><span class="p">;</span>
</pre></div>


<h4 id="_13">保证复制的事务安全</h4>
<p>在master 节点启用参数<code>sync_binlog=ON</code></p>
<p>针对InnoDB存储引擎， 开启</p>
<div class="hlcode"><pre><span class="n">innodb_flush_logs_at_trx_commit</span><span class="o">=</span><span class="n">ON</span>
<span class="n">innodb_support_xa</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>Slave 节点</p>
<div class="hlcode"><pre><span class="n">skip_slave_start</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>master 节点</p>
<div class="hlcode"><pre><span class="n">sync_master_info</span>
</pre></div>


<p>slave 节点</p>
<div class="hlcode"><pre><span class="n">sync_relay_log</span>
<span class="n">sync_relay_log_info</span>
</pre></div>


<h3 id="mmm">MMM</h3>
<p>Multi   Master MySQL</p>
<h3 id="mha">MHA</h3>
<p>Master HA</p>
<p>对主节点进行监控，可实现自动转移至其他从节点</p>
<p>通过提升某一从节点为新的主节点</p>
<h4 id="mha-manager">MHA Manager</h4>
<p>通常部署在一台独立机器上管理多个master/slave集群，每个集群成为一个application</p>
<h4 id="mha-node">MHA Node</h4>
<p>运行在每台MySQL服务器上，通过监控具备解析和清理logs功能的脚本来加快故障转移</p>
<h3 id="galera-cluster">Galera Cluster</h3>
<p>实现多主节点模型的机制</p>
<p>通过wresp协议协议在全局事件复制</p>
<p>任何一结点都可读写</p>
<p>工作较为底层，能为服务提供数据复制的组件</p>
<h4 id="percona-cluster">Percona-Cluster</h4>
<p>即整合过Galera Cluster的Percona MySQL 分支版本</p>
<p>至少需要三个结点</p>
<h4 id="mariadb-cluster">MariaDB-Cluster</h4>
<h2 id="_14">二进制日志事件记录格式</h2>
<h3 id="statement">STATEMENT</h3>
<h3 id="row">ROW</h3>
<h3 id="mixed">MIXED</h3>
<h2 id="_15">复制相关的文件</h2>
<h3 id="masterinfo"><code>master.info</code></h3>
<p>用于保存slave 连接至master 时想你管的信息，如账号，密码，服务器地址等</p>
<h3 id="reply-loginfo"><code>reply-log.info</code></h3>
<p>保存在当前slave结点上已经复制的当前二进制日志和本地replay log 日志的对应关系</p>
<h2 id="_16">常用操作</h2>
<h3 id="_17">清理日志</h3>
<div class="hlcode"><pre><span class="n">PURGE</span>
</pre></div>


<h3 id="_18">复制监控</h3>
<div class="hlcode"><pre><span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="n">show</span> <span class="n">binlog</span> <span class="n">events</span><span class="p">;</span>
<span class="n">show</span> <span class="n">binary</span> <span class="n">logs</span><span class="p">;</span>

<span class="n">show</span> <span class="n">slave</span> <span class="n">status</span><span class="p">;</span>
<span class="n">show</span> <span class="n">processlist</span><span class="p">;</span>
</pre></div>


<h3 id="_19">从服务器是否落后于主服务器</h3>
<div class="hlcode"><pre><span class="n">show</span> <span class="n">slave</span> <span class="n">status</span><span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
</pre></div>


<h3 id="_20"></h3>
<h3 id="_21">判断主从结点数据是否一致</h3>
<div class="hlcode"><pre><span class="n">percona</span><span class="o">-</span><span class="n">tools</span>
</pre></div>


<h1 id="_22">基于二进制日志的主从复制</h1>
<p><strong>2.1 配置要求</strong></p>
<p>1）主库开启二进制日志</p>
<p>2）主库和各个从库配置唯一的server_id</p>
<p><strong>2.2 主库创建复制用户</strong></p>
<p>从库需要使用一个用户来连接主库，可以使用添加复制权限的生产应用用户。为了减少对应用用户的影响，建议单独创建一个仅有复制权限的用户。</p>
<p>CREATE USER 'repl'@'%' IDENTIFIED BY 'password';</p>
<p>GRANT REPLICATION SLAVE ON <em>.</em> TO 'repl'@'%';</p>
<p><strong>2.3 获取主库的二进制日志位置</strong></p>
<p>1）在主库打开一个连接，执行下列命令清除所有表并阻止写入语句：</p>
<p>mysql&gt; FLUSH TABLES WITH READ LOCK;</p>
<p>2）重新打开一个连接，执行下列命令获取二进制日志的位置：</p>
<p>mysql &gt; SHOW MASTER STATUS;</p>
<p>+--------------------+----------+--------------+------------------+-------------------+|</p>
<p>File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p>
<p>+--------------------+----------+--------------+------------------+-------------------+|</p>
<p>mysql_bin.000003 | 154 | | | |</p>
<p>+--------------------+----------+--------------+------------------+-------------------+</p>
<p>3）对于配置一个新的主从复制环境，主库没有初始数据需要同步到从库，则在第一个连接中释放锁：</p>
<p>mysql&gt; UNLOCK TABLES;</p>
<p><strong>2.4 配置从库</strong></p>
<p>配置前先需要确认是否为从库设置了唯一的server_id。然后在从库上执行下面语句，请将参数值替换为实际值：</p>
<p>mysql&gt; CHANGE MASTER TO MASTER_HOST='master_host_name', MASTER_USER='replication_user_name', MASTER_PASSWORD='replication_password', MASTER_LOG_FILE='recorded_log_file_name', MASTER_LOG_POS=recorded_log_position;</p>
<p>如果需要配置多源的复制，需要为每一个主库指定一个通道:</p>
<p>mysql&gt; CHANGE MASTER TO MASTER_HOST='master_host_name', MASTER_USER='replication_user_name', MASTER_PASSWORD='replication_password', MASTER_LOG_FILE='recorded_log_file_name', MASTER_LOG_POS=recorded_log_position FOR CHANNEL 'master-1';</p>
<p><strong>2.5 启动主从复制</strong></p>
<p>在从库上执行：</p>
<p>mysql&gt; START SLAVE;</p>
<p><strong>2.6 查看复制状态</strong></p>
<p>在从库上执行：</p>
<p>mysql&gt; SHOW SLAVE STATUSG;</p>
<p>当Slave_IO_Running和Slave_SQL_Running都为YES的时候就表示主从同步设置成功了。接下来就可以进行一些验证了，比如在主master数据库的test数据库的一张表中插入一条数据，在slave的test库的相同数据表中查看是否有新增的数据即可验证主从复制功能是否有效，还可以关闭slave（mysql&gt;stop slave;）,然后再修改master，看slave是否也相应修改（停止slave后，master的修改不会同步到slave），就可以完成主从复制功能的验证了。</p>
<p><strong>2.基于二进制日志的主从复制</strong></p>
<p><strong>2.1 配置要求</strong></p>
<p>1）主库开启二进制日志</p>
<p>2）主库和各个从库配置唯一的server_id</p>
<p><strong>2.2 主库创建复制用户</strong></p>
<p>从库需要使用一个用户来连接主库，可以使用添加复制权限的生产应用用户。为了减少对应用用户的影响，建议单独创建一个仅有复制权限的用户。</p>
<p>CREATE USER 'repl'@'%' IDENTIFIED BY 'password';</p>
<p>GRANT REPLICATION SLAVE ON <em>.</em> TO 'repl'@'%';</p>
<p><strong>2.3 获取主库的二进制日志位置</strong></p>
<p>1）在主库打开一个连接，执行下列命令清除所有表并阻止写入语句：</p>
<p>mysql&gt; FLUSH TABLES WITH READ LOCK;</p>
<p>2）重新打开一个连接，执行下列命令获取二进制日志的位置：</p>
<p>mysql &gt; SHOW MASTER STATUS;</p>
<p>+--------------------+----------+--------------+------------------+-------------------+|</p>
<p>File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</p>
<p>+--------------------+----------+--------------+------------------+-------------------+|</p>
<p>mysql_bin.000003 | 154 | | | |</p>
<p>+--------------------+----------+--------------+------------------+-------------------+</p>
<p>3）对于配置一个新的主从复制环境，主库没有初始数据需要同步到从库，则在第一个连接中释放锁：</p>
<p>mysql&gt; UNLOCK TABLES;</p>
<p><strong>2.4 配置从库</strong></p>
<p>配置前先需要确认是否为从库设置了唯一的server_id。然后在从库上执行下面语句，请将参数值替换为实际值：</p>
<p>mysql&gt; CHANGE MASTER TO MASTER_HOST='master_host_name', MASTER_USER='replication_user_name', MASTER_PASSWORD='replication_password', MASTER_LOG_FILE='recorded_log_file_name', MASTER_LOG_POS=recorded_log_position;</p>
<p>如果需要配置多源的复制，需要为每一个主库指定一个通道:</p>
<p>mysql&gt; CHANGE MASTER TO MASTER_HOST='master_host_name', MASTER_USER='replication_user_name', MASTER_PASSWORD='replication_password', MASTER_LOG_FILE='recorded_log_file_name', MASTER_LOG_POS=recorded_log_position FOR CHANNEL 'master-1';</p>
<p><strong>2.5 启动主从复制</strong></p>
<p>在从库上执行：</p>
<p>mysql&gt; START SLAVE;</p>
<p><strong>2.6 查看复制状态</strong></p>
<p>在从库上执行：</p>
<p>mysql&gt; SHOW SLAVE STATUSG;</p>
<p>当Slave_IO_Running和Slave_SQL_Running都为YES的时候就表示主从同步设置成功了。接下来就可以进行一些验证了，比如在主master数据库的test数据库的一张表中插入一条数据，在slave的test库的相同数据表中查看是否有新增的数据即可验证主从复制功能是否有效，还可以关闭slave（mysql&gt;stop slave;）,然后再修改master，看slave是否也相应修改（停止slave后，master的修改不会同步到slave），就可以完成主从复制功能的验证了。</p>
<h1 id="gtid_1">基于GTID的主从复制</h1>
<p><strong>3.1 配置要求</strong></p>
<ol>
<li>
<p>主库开启二进制日志</p>
</li>
<li>
<p>主库和各个从库配置唯一的server_id</p>
</li>
</ol>
<p><strong>3.2 主库创建复制用户</strong></p>
<p>从库需要使用一个用户来连接主库，可以使用添加复制权限的生产应用用户。为了减少对应用用户的影响，建议单独创建一个仅有复制权限的用户。</p>
<p>CREATE USER 'repl'@'%' IDENTIFIED BY 'password';</p>
<p>GRANT REPLICATION SLAVE ON <em>.</em> TO 'repl'@'%';</p>
<p><strong>3.3 在主库和从库的/etc/my.cnf文件中[mysqld]添加启用GTID的变量：</strong></p>
<p>gtid_mode=ON</p>
<p>enforce-gtid-consistency=true</p>
<p>配置完成后重启mysql。</p>
<p>systemctl restart mysqld</p>
<p><strong>3.4 配置从库</strong></p>
<p>配置前先需要确认是否为从库设置了唯一的server_id。然后在从库上执行下面语句，请将参数值替换为实际值：</p>
<p>mysql&gt;CHANGE MASTER TO MASTER_HOST = '128.<em>.</em>.*',MASTER_PORT = 3306,MASTER_USER = 'repl',MASTER_PASSWORD = 'password',MASTER_AUTO_POSITION = 1;</p>
<p>如果需要配置多源的复制，需要为每一个主库指定一个通道:</p>
<p>mysql&gt;CHANGE MASTER TO MASTER_HOST = '128.<em>.</em>.*',MASTER_PORT = 3306,MASTER_USER = 'repl',MASTER_PASSWORD = 'password',MASTER_AUTO_POSITION = 1 FOR CHANNEL 'master-1';</p>
<p><strong>3.5 启动主从复制</strong></p>
<p>在从库上执行：</p>
<p>mysql&gt; START SLAVE;</p>
<h1 id="_23">半同步复制</h1>
<p><strong>安装插件</strong></p>
<p>在主库上执行：</p>
<p>INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';</p>
<p>在从库上执行：</p>
<p>INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';</p>
<p>查看插件状态：</p>
<p>SELECT PLUGIN_NAME,PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME LIKE '%semi%';</p>
<p><strong>4.2 配置参数</strong></p>
<p>主库参数：</p>
<p>rpl_semi_sync_master_enabled=1 #主库启用半同步复制</p>
<p>rpl_semi_sync_master_timeout=1000 #主库等待从库的超时时间，超时切换回异步复制，默认值10000（10s）</p>
<p>rpl_semi_sync_master_wait_point=AFTER_SYNC #等待点模式（AFTER_SYNC表示主库等待从库接收到binlog写到本地的relay-log里，才提交到存储引擎层，然后把请求返回给客户端；</p>
<p>AFTER_COMMIT表示主库写入binlog，边提交，边等待从库收到binlog写到本地的relay-log）</p>
<p>rpl_semi_sync_master_wait_for_slave_count=1 #主库等待从库的个数</p>
<p>从库参数：</p>
<p>rpl_semi_sync_slave_enabled=1 #从库启用半同步复制</p>
<p><strong>4.3 半同步复制状态监控</strong></p>
<p>Rpl_semi_sync_master_status #主库是否运行在半同步模式</p>
<p>Rpl_semi_sync_master_clients #半同步从库的个数</p>
<p>Rpl_semi_sync_master_yes_tx #从库确认成功的提交事务数</p>
<p>Rpl_semi_sync_master_no_tx #从库未确认成功的提交事务数</p>
<p>Rpl_semi_sync_slave_status #从库是否可运行半同步复制</p>
<h1 id="_24">主从复制案例</h1>
<div class="hlcode"><pre><span class="n">wget</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">c</span> <span class="n">http</span><span class="o">:</span><span class="c1">//dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span>

<span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">mysql57</span><span class="o">-</span><span class="n">community</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">el7</span><span class="o">-</span><span class="mf">10.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>

<span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">community</span><span class="o">-</span><span class="n">server</span> 

<span class="n">systemctl</span> <span class="n">start</span> <span class="n">mysqld</span>

<span class="n">grep</span> <span class="s">&quot;password&quot;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mysqld</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>开启mysql的远程访问</p>
<p>执行以下命令开启远程访问限制（注意：下面命令开启的IP是 192.168.0.1，如要开启所有的，用%代替IP）：</p>
<div class="hlcode"><pre><span class="n">grant</span> <span class="n">all</span> <span class="n">privileges</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">root</span><span class="sc">&#39;@&#39;</span><span class="mf">192.168.0.1</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">password</span><span class="err">&#39;</span> <span class="n">with</span> <span class="n">grant</span> <span class="n">option</span><span class="p">;</span>
</pre></div>


<p>然后再输入下面两行命令</p>
<div class="hlcode"><pre><span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span> 
<span class="n">exit</span><span class="p">;</span>
</pre></div>


<p>为firewalld添加开放端口</p>
<p>添加mysql端口3306</p>
<div class="hlcode"><pre><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="o">/</span><span class="n">tcp</span> <span class="o">--</span><span class="n">permanent</span>
</pre></div>


<p>然后再重新载入</p>
<div class="hlcode"><pre><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>


<p>修改mysql的字符编码（不修改会产生中文乱码问题）</p>
<p>显示原来编码：</p>
<div class="hlcode"><pre><span class="n">show</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">character</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
</pre></div>


<p>修改/etc/my.cnf</p>
<div class="hlcode"><pre><span class="k">[mysqld]</span>
<span class="na">character-set-server</span><span class="o">=</span><span class="s">utf8mb4</span>
<span class="k">[mysql]</span>
<span class="na">default-character-set</span><span class="o">=</span><span class="s">utf8mb4</span>
</pre></div>


<h2 id="_25">主节点</h2>
<p>启动二进制日志</p>
<p>为当前节点设置一个全局的唯一ID号</p>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">character</span><span class="o">-</span><span class="n">set</span><span class="o">-</span><span class="n">server</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<blockquote>
<p>/var/lib/mysql/master-bin.index                                              <br />
/var/lib/mysql/master-bin.000001                                             <br />
/var/lib/mysql/master-bin.000002                                            <br />
/var/lib/mysql/master-bin.000003  </p>
<p>可以指定绝对路径 <code>log-bin=/var/log/mysql/mysql-bin</code></p>
</blockquote>
<div class="hlcode"><pre><span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%log_bin%&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                   <span class="o">|</span> <span class="nx">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">log_bin</span>                         <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="nx">log_bin_trust_function_creators</span> <span class="o">|</span> <span class="nx">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nx">sql_log_bin</span>                     <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>


<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">SHOW</span> <span class="nx">MASTER</span> <span class="nx">LOGS</span><span class="p">;</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="nx">Log_name</span>         <span class="o">|</span> <span class="nx">File_size</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000001</span> <span class="o">|</span>     <span class="mi">28415</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000002</span> <span class="o">|</span>   <span class="mi">1038814</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000003</span> <span class="o">|</span>       <span class="mi">264</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000004</span> <span class="o">|</span>       <span class="mi">245</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="mi">4</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>

<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">SHOW</span> <span class="nx">GLOBAL</span> <span class="nx">VARIABLES</span> <span class="nx">LIKE</span> <span class="s1">&#39;%server%&#39;</span><span class="p">;</span>
<span class="o">+----------------------+-----------------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>        <span class="o">|</span> <span class="nx">Value</span>           <span class="o">|</span>
<span class="o">+----------------------+-----------------+</span>
<span class="o">|</span> <span class="nx">character_set_server</span> <span class="o">|</span> <span class="nx">utf8</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">collation_server</span>     <span class="o">|</span> <span class="nx">utf8_general_ci</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">server_id</span>            <span class="o">|</span> <span class="mi">1</span>               <span class="o">|</span>
<span class="o">+----------------------+-----------------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>
</pre></div>


<p>创建有复制权限的用户账号</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">user</span>  <span class="err">&#39;</span><span class="n">replica_user</span><span class="sc">&#39;@&#39;</span><span class="o">%</span><span class="err">&#39;</span>  <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">replica_passwd</span><span class="err">&#39;</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">CLIENT</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">208.73.201</span><span class="p">.</span><span class="o">%</span><span class="err">&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">PRIVILEGES</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>需要指定为 <code>*.*</code>   而不能单独对某个库、表授权</p>
</blockquote>
<p>为了主从数据库一致，将进行先锁表，并且导出数据</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">TABLES</span> <span class="n">WITH</span> <span class="n">READ</span> <span class="n">LOCK</span>
</pre></div>


<div class="hlcode"><pre><span class="n">mysqldump</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">--</span><span class="n">databases</span> <span class="n">DB_master</span> <span class="o">&gt;</span> <span class="n">DB_masterSlave</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<p>登陆数据库查看Pos值并且解锁数据表</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">unlock</span> <span class="n">tables</span><span class="p">;</span>
</pre></div>


<p>将备份的sql导入到slave节点</p>
<div class="hlcode"><pre><span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">DB_masterSlave</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<h3 id="binlog">查看binlog</h3>
<p>查看主服务器的运行状态</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+-------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span> <span class="n">Executed_Gtid_Set</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+-------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span>     <span class="mi">1190</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>                   <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+-------------------+</span>
</pre></div>


<p>查看从服务器主机列表</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">hosts</span><span class="p">;</span>
<span class="o">+-----------+------+------+-----------+--------------------------------------+</span>
<span class="o">|</span> <span class="n">Server_id</span> <span class="o">|</span> <span class="n">Host</span> <span class="o">|</span> <span class="n">Port</span> <span class="o">|</span> <span class="n">Master_id</span> <span class="o">|</span> <span class="n">Slave_UUID</span>                           <span class="o">|</span>
<span class="o">+-----------+------+------+-----------+--------------------------------------+</span>
<span class="o">|</span>         <span class="mi">2</span> <span class="o">|</span>      <span class="o">|</span> <span class="mi">3306</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="mi">6</span><span class="n">b831bf2</span><span class="o">-</span><span class="mi">8</span><span class="n">ae7</span><span class="o">-</span><span class="mf">11e7</span><span class="o">-</span><span class="n">a178</span><span class="o">-</span><span class="mo">000</span><span class="n">c29cb5cbc</span> <span class="o">|</span>
<span class="o">+-----------+------+------+-----------+--------------------------------------+</span>
</pre></div>


<p>获取binlog文件列表</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">binary</span> <span class="n">logs</span><span class="p">;</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="n">Log_name</span>         <span class="o">|</span> <span class="n">File_size</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span>      <span class="mi">1190</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
</pre></div>


<p>只查看第一个binlog文件的内容</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">binlog</span> <span class="n">events</span><span class="p">;</span>
<span class="o">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Log_name</span>         <span class="o">|</span> <span class="n">Pos</span> <span class="o">|</span> <span class="n">Event_type</span>     <span class="o">|</span> <span class="n">Server_id</span> <span class="o">|</span> <span class="n">End_log_pos</span> <span class="o">|</span> <span class="n">Info</span>                                                                                                                                                                                                  <span class="o">|</span>
<span class="o">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span>   <span class="mi">4</span> <span class="o">|</span> <span class="n">Format_desc</span>    <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">123</span> <span class="o">|</span> <span class="n">Server</span> <span class="n">ver</span><span class="o">:</span> <span class="mf">5.7.19</span><span class="o">-</span><span class="n">log</span><span class="p">,</span> <span class="n">Binlog</span> <span class="n">ver</span><span class="o">:</span> <span class="mi">4</span>                                                                                                                                                                 <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">123</span> <span class="o">|</span> <span class="n">Previous_gtids</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">154</span> <span class="o">|</span>                                                                                                                                                                                                       <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">420</span> <span class="o">|</span> <span class="n">Anonymous_Gtid</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">485</span> <span class="o">|</span> <span class="n">SET</span> <span class="err">@@</span><span class="n">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">ANONYMOUS</span><span class="err">&#39;</span>                                                                                                                                                                  <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">485</span> <span class="o">|</span> <span class="n">Query</span>          <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">629</span> <span class="o">|</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">replication</span><span class="sc">&#39;@&#39;</span><span class="mf">192.168.252.124</span><span class="err">&#39;</span>                                                                                                                                     <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">629</span> <span class="o">|</span> <span class="n">Anonymous_Gtid</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">694</span> <span class="o">|</span> <span class="n">SET</span> <span class="err">@@</span><span class="n">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">ANONYMOUS</span><span class="err">&#39;</span>                                                                                                                                                                  <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">694</span> <span class="o">|</span> <span class="n">Query</span>          <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">847</span> <span class="o">|</span> <span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="err">`</span><span class="n">replication_wwww</span><span class="p">.</span><span class="n">ymq</span><span class="p">.</span><span class="n">io</span><span class="err">`</span>                                                                                                                                                             <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">847</span> <span class="o">|</span> <span class="n">Anonymous_Gtid</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">912</span> <span class="o">|</span> <span class="n">SET</span> <span class="err">@@</span><span class="n">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">ANONYMOUS</span><span class="err">&#39;</span>                                                                                                                                                                  <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">912</span> <span class="o">|</span> <span class="n">Query</span>          <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>        <span class="mi">1190</span> <span class="o">|</span> <span class="n">use</span> <span class="err">`</span><span class="n">replication_wwww</span><span class="p">.</span><span class="n">ymq</span><span class="p">.</span><span class="n">io</span><span class="err">`</span><span class="p">;</span> <span class="n">CREATE</span> <span class="n">TABLE</span> <span class="err">`</span><span class="n">sync_test</span><span class="err">`</span> <span class="p">(</span><span class="err">`</span><span class="n">id</span><span class="err">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="n">NOT</span> <span class="nb">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span> <span class="err">`</span><span class="n">name</span><span class="err">`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">(</span><span class="err">`</span><span class="n">id</span><span class="err">`</span><span class="p">)</span> <span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">2</span> <span class="n">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="o">|</span>
<span class="o">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
</pre></div>


<p>查看指定binlog文件的内容</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">binlog</span> <span class="n">events</span> <span class="n">in</span> <span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Log_name</span>         <span class="o">|</span> <span class="n">Pos</span> <span class="o">|</span> <span class="n">Event_type</span>     <span class="o">|</span> <span class="n">Server_id</span> <span class="o">|</span> <span class="n">End_log_pos</span> <span class="o">|</span> <span class="n">Info</span>                                                                                                                                                                                                  <span class="o">|</span>
<span class="o">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span>   <span class="mi">4</span> <span class="o">|</span> <span class="n">Format_desc</span>    <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">123</span> <span class="o">|</span> <span class="n">Server</span> <span class="n">ver</span><span class="o">:</span> <span class="mf">5.7.19</span><span class="o">-</span><span class="n">log</span><span class="p">,</span> <span class="n">Binlog</span> <span class="n">ver</span><span class="o">:</span> <span class="mi">4</span>                                                                                                                                                                 <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">123</span> <span class="o">|</span> <span class="n">Previous_gtids</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">154</span> <span class="o">|</span>                                                                                                                                                                                                       <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">420</span> <span class="o">|</span> <span class="n">Anonymous_Gtid</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">485</span> <span class="o">|</span> <span class="n">SET</span> <span class="err">@@</span><span class="n">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">ANONYMOUS</span><span class="err">&#39;</span>                                                                                                                                                                  <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">485</span> <span class="o">|</span> <span class="n">Query</span>          <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">629</span> <span class="o">|</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">replication</span><span class="sc">&#39;@&#39;</span><span class="mf">192.168.252.124</span><span class="err">&#39;</span>                                                                                                                                     <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">629</span> <span class="o">|</span> <span class="n">Anonymous_Gtid</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">694</span> <span class="o">|</span> <span class="n">SET</span> <span class="err">@@</span><span class="n">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">ANONYMOUS</span><span class="err">&#39;</span>                                                                                                                                                                  <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">694</span> <span class="o">|</span> <span class="n">Query</span>          <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">847</span> <span class="o">|</span> <span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="err">`</span><span class="n">replication_wwww</span><span class="p">.</span><span class="n">ymq</span><span class="p">.</span><span class="n">io</span><span class="err">`</span>                                                                                                                                                             <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">847</span> <span class="o">|</span> <span class="n">Anonymous_Gtid</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>         <span class="mi">912</span> <span class="o">|</span> <span class="n">SET</span> <span class="err">@@</span><span class="n">SESSION</span><span class="p">.</span><span class="n">GTID_NEXT</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">ANONYMOUS</span><span class="err">&#39;</span>                                                                                                                                                                  <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span> <span class="mi">912</span> <span class="o">|</span> <span class="n">Query</span>          <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>        <span class="mi">1190</span> <span class="o">|</span> <span class="n">use</span> <span class="err">`</span><span class="n">replication_wwww</span><span class="p">.</span><span class="n">ymq</span><span class="p">.</span><span class="n">io</span><span class="err">`</span><span class="p">;</span> <span class="n">CREATE</span> <span class="n">TABLE</span> <span class="err">`</span><span class="n">sync_test</span><span class="err">`</span> <span class="p">(</span><span class="err">`</span><span class="n">id</span><span class="err">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="n">NOT</span> <span class="nb">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span> <span class="err">`</span><span class="n">name</span><span class="err">`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">(</span><span class="err">`</span><span class="n">id</span><span class="err">`</span><span class="p">)</span> <span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">2</span> <span class="n">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="o">|</span>
<span class="o">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
</pre></div>


<h2 id="_26">从节点</h2>
<p>启动中继日志</p>
<p>为当前节点设置一个全局唯一的ID号</p>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">index</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="p">.</span><span class="n">index</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">7</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>Master log info</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">MASTER</span> <span class="n">LOGS</span><span class="p">;</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="n">Log_name</span>         <span class="o">|</span> <span class="n">File_size</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span>     <span class="mi">28415</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000002</span> <span class="o">|</span>   <span class="mi">1038814</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span> <span class="o">|</span>       <span class="mi">264</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>       <span class="mi">499</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>使用有复制权限的用户账号连接至主服务器，并启动复制线程</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">208.73.201.156</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">499</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">SLAVE</span> <span class="n">STATUS</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">499</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">4</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">No</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">No</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">499</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">245</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="nb">NULL</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>


<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">START</span> <span class="n">SLAVE</span><span class="p">;</span>   <span class="err">#不指定参数默认启动</span><span class="n">IO_THREAD</span><span class="o">|</span><span class="n">SQL_THREAD</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">SLAVE</span> <span class="n">STATUS</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">master</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">499</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">4</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Connecting</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">499</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">245</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="nb">NULL</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">1130</span>
                <span class="nl">Last_IO_Error:</span> <span class="n">error</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">master</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="err">@</span><span class="mf">208.73.201.156</span><span class="o">:</span><span class="mi">3306</span><span class="err">&#39;</span> <span class="o">-</span> <span class="n">retry</span><span class="o">-</span><span class="n">time</span><span class="o">:</span> <span class="mi">60</span>  <span class="n">retries</span><span class="o">:</span> <span class="mi">86400</span>  <span class="n">message</span><span class="o">:</span> <span class="n">Host</span> <span class="err">&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">not</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">this</span> <span class="n">MariaDB</span> <span class="n">server</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p><code>Slave_IO_State</code> #从站的当前状态<br />
<code>Slave_IO_Running： Yes</code> #读取主程序二进制日志的I/O线程是否正在运行<br />
<code>Slave_SQL_Running： Yes</code> #执行读取主服务器中二进制日志事件的SQL线程是否正在运行。与I/O线程一样<br />
<code>Seconds_Behind_Master</code>#是否为0，0就是已经同步了</p>
</blockquote>
<p><strong>必须都是 Yes</strong></p>
<p>如果不是原因主要有以下 4 个方面：</p>
<p>1、网络不通<br />
2、密码不对<br />
3、MASTER_LOG_POS 不对 ps<br />
4、mysql 的 <code>auto.cnf</code> server-uuid 一样（可能你是复制的mysql）</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">find</span> <span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="err">&#39;</span><span class="k">auto</span><span class="p">.</span><span class="n">cnf</span><span class="err">&#39;</span>
<span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">auto</span><span class="p">.</span><span class="n">cnf</span>
<span class="p">[</span><span class="k">auto</span><span class="p">]</span>
<span class="n">server</span><span class="o">-</span><span class="n">uuid</span><span class="o">=</span><span class="mi">6</span><span class="n">b831bf3</span><span class="o">-</span><span class="mi">8</span><span class="n">ae7</span><span class="o">-</span><span class="mf">11e7</span><span class="o">-</span><span class="n">a178</span><span class="o">-</span><span class="mo">000</span><span class="n">c29cb5cbc</span> <span class="err">#</span> <span class="err">按照这个</span><span class="mi">16</span><span class="err">进制格式，修改</span><span class="n">server</span><span class="o">-</span><span class="n">uuid</span><span class="err">，重启</span><span class="n">mysql</span><span class="err">即可</span>
</pre></div>


<p>可能需要操作</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_password</span> <span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>清理之前的配置</p>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">reset</span> <span class="n">slave</span> <span class="n">all</span><span class="p">;</span> 
</pre></div>


<h2 id="_27">测试</h2>
<p>主节点</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>     <span class="mi">1259</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">mydb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mydb</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>     <span class="mi">1342</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>从节点</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">1259</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">1289</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">1259</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">1587</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="nl">ERROR:</span> <span class="n">No</span> <span class="n">query</span> <span class="n">specified</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">1342</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">1372</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">1342</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">1670</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h1 id="_28">主主复制案例 （慎用）</h1>
<h2 id="id">自动增长ID</h2>
<p>在一个节点使用奇数id</p>
<div class="hlcode"><pre><span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">1</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>另一个节点使用偶数id</p>
<div class="hlcode"><pre><span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">2</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<h2 id="_29">配置步骤</h2>
<p>各个节点使用一个唯一的server_id</p>
<h3 id="1">节点1</h3>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">relay_log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
<span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">1</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>查看状态</p>
<div class="hlcode"><pre><span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%log_bin%&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                   <span class="o">|</span> <span class="nx">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">log_bin</span>                         <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="nx">log_bin_trust_function_creators</span> <span class="o">|</span> <span class="nx">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nx">sql_log_bin</span>                     <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>

<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%relay_log%&#39;</span><span class="p">;</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                    <span class="o">|</span> <span class="nx">Value</span>          <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">innodb_recovery_update_relay_log</span> <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">max_relay_log_size</span>               <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log</span>                        <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span>      <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_index</span>                  <span class="o">|</span>                <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_info_file</span>              <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_purge</span>                  <span class="o">|</span> <span class="nx">ON</span>             <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_recovery</span>               <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_space_limit</span>            <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log</span>                   <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log_info</span>              <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="mi">10</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>
</pre></div>


<p>授权账户</p>
<div class="hlcode"><pre><span class="n">grant</span> <span class="n">replication</span> <span class="n">slave</span><span class="p">,</span> <span class="n">replication</span> <span class="n">client</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_host</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">511</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.14</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>log_file 及其pos 需去主机器上<code>show master status</code>查看</p>
</blockquote>
<h3 id="2">节点2</h3>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">relay_log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">5</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
<span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">2</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>查看状态</p>
<div class="hlcode"><pre><span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%log_bin%&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                   <span class="o">|</span> <span class="nx">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">log_bin</span>                         <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="nx">log_bin_trust_function_creators</span> <span class="o">|</span> <span class="nx">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nx">sql_log_bin</span>                     <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="nx">sec</span><span class="p">)</span>

<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%relay_log%&#39;</span><span class="p">;</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                    <span class="o">|</span> <span class="nx">Value</span>          <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">innodb_recovery_update_relay_log</span> <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">max_relay_log_size</span>               <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log</span>                        <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span>      <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_index</span>                  <span class="o">|</span>                <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_info_file</span>              <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_purge</span>                  <span class="o">|</span> <span class="nx">ON</span>             <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_recovery</span>               <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_space_limit</span>            <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log</span>                   <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log_info</span>              <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="mi">10</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="nx">sec</span><span class="p">)</span>
</pre></div>


<p>授权账户</p>
<div class="hlcode"><pre><span class="n">grant</span> <span class="n">replication</span> <span class="n">slave</span><span class="p">,</span> <span class="n">replication</span> <span class="n">client</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_host</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">208.73.201.156</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">512</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>log_file 及其pos 需去主机器上<code>show master status</code>查看</p>
</blockquote>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">validate_password_policy</span><span class="o">=</span><span class="err">&#39;</span><span class="n">low</span><span class="err">&#39;</span><span class="p">;</span>
</pre></div>


<h1 id="_30">半同步复制案例</h1>
<h2 id="master">Master</h2>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<div class="hlcode"><pre><span class="n">datadir</span> <span class="o">=</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>创建有复制权限的用户账号</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">CLIENT</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>  <span class="err">#</span> <span class="err">对端</span><span class="n">IP</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">PRIVILEGES</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">MASTER</span> <span class="n">STATUS</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>      <span class="mi">500</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>开始配置半同步, 安装插件</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">install</span> <span class="n">plugin</span> <span class="n">rpl_semi_sync_master</span> <span class="n">SONAME</span> <span class="err">&#39;</span><span class="n">semisync_master</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">plugins</span><span class="p">;</span>
<span class="o">+--------------------------------+--------+--------------------+--------------------+---------+</span>
<span class="o">|</span> <span class="n">Name</span>                           <span class="o">|</span> <span class="n">Status</span> <span class="o">|</span> <span class="n">Type</span>               <span class="o">|</span> <span class="n">Library</span>            <span class="o">|</span> <span class="n">License</span> <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+--------------------+---------+</span>
<span class="o">|</span> <span class="n">binlog</span>                         <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">STORAGE</span> <span class="n">ENGINE</span>     <span class="o">|</span> <span class="nb">NULL</span>               <span class="o">|</span> <span class="n">GPL</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master</span>           <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">REPLICATION</span>        <span class="o">|</span> <span class="n">semisync_master</span><span class="p">.</span><span class="n">so</span> <span class="o">|</span> <span class="n">GPL</span>     <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+--------------------+---------+</span>
<span class="mi">41</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_enabled</span>       <span class="o">|</span> <span class="n">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_timeout</span>       <span class="o">|</span> <span class="mi">10000</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_trace_level</span>   <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_wait_no_slave</span> <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">rpl_semi_sync_master_enabled</span><span class="o">=</span><span class="n">ON</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_enabled</span>       <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_timeout</span>       <span class="o">|</span> <span class="mi">10000</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_trace_level</span>   <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_wait_no_slave</span> <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>slave 启动之后</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">status</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                              <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_clients</span>               <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_avg_wait_time</span>     <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_wait_time</span>         <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_waits</span>             <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_times</span>              <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_tx</span>                 <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_status</span>                <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_timefunc_failures</span>     <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_avg_wait_time</span>      <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_wait_time</span>          <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_waits</span>              <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_pos_backtraverse</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_sessions</span>         <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_yes_tx</span>                <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="mi">14</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>开始测试</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">mydb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.05</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">mydb</span>
<span class="n">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">table</span> <span class="n">tb1</span> <span class="p">(</span><span class="n">id</span> <span class="kt">int</span><span class="p">,</span> <span class="n">name</span> <span class="kt">char</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.06</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">status</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+--------------------------------------------+--------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                              <span class="o">|</span> <span class="n">Value</span>  <span class="o">|</span>
<span class="o">+--------------------------------------------+--------+</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_clients</span>               <span class="o">|</span> <span class="mi">1</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_avg_wait_time</span>     <span class="o">|</span> <span class="mi">56081</span>  <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_wait_time</span>         <span class="o">|</span> <span class="mi">112162</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_waits</span>             <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_times</span>              <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_tx</span>                 <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_status</span>                <span class="o">|</span> <span class="n">ON</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_timefunc_failures</span>     <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_avg_wait_time</span>      <span class="o">|</span> <span class="mi">56189</span>  <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_wait_time</span>          <span class="o">|</span> <span class="mi">112378</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_waits</span>              <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_pos_backtraverse</span> <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_sessions</span>         <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_yes_tx</span>                <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span>
<span class="o">+--------------------------------------------+--------+</span>
<span class="mi">14</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h2 id="slave">Slave</h2>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<div class="hlcode"><pre><span class="n">datadir</span> <span class="o">=</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span>
<span class="n">relay_log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">5</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<div class="hlcode"><pre><span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_host</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">45.77.120.103</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">757</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">45.77.120.103</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">757</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="mf">.000002</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">529</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">757</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">817</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="nl">ERROR:</span> <span class="n">No</span> <span class="n">query</span> <span class="n">specified</span>
</pre></div>


<p>开始配置半同步</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">stop</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.67</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">install</span> <span class="n">plugin</span> <span class="n">rpl_semi_sync_slave</span> <span class="n">SONAME</span> <span class="err">&#39;</span><span class="n">semisync_slave</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.02</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">plugins</span><span class="p">;</span>
<span class="o">+--------------------------------+--------+--------------------+-------------------+---------+</span>
<span class="o">|</span> <span class="n">Name</span>                           <span class="o">|</span> <span class="n">Status</span> <span class="o">|</span> <span class="n">Type</span>               <span class="o">|</span> <span class="n">Library</span>           <span class="o">|</span> <span class="n">License</span> <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+-------------------+---------+</span>
<span class="o">|</span> <span class="n">binlog</span>                         <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">STORAGE</span> <span class="n">ENGINE</span>     <span class="o">|</span> <span class="nb">NULL</span>              <span class="o">|</span> <span class="n">GPL</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave</span>            <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">REPLICATION</span>        <span class="o">|</span> <span class="n">semisync_slave</span><span class="p">.</span><span class="n">so</span> <span class="o">|</span> <span class="n">GPL</span>     <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+-------------------+---------+</span>
<span class="mi">41</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                   <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_enabled</span>     <span class="o">|</span> <span class="n">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_trace_level</span> <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">2</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">rpl_semi_sync_slave_enabled</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                   <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_enabled</span>     <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_trace_level</span> <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">2</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h1 id="_31">复制过滤器</h1>
<p>让从节点复制指定的数据库，或指定数据库的指定表</p>
<h2 id="_32">二进制日志方式</h2>
<p>主服务器仅向二进制日志中记录与特定数据库(特定表)相关的事件</p>
<p>时间还是无法实现，不建议使用</p>
<div class="hlcode"><pre><span class="n">binlog_do_db</span><span class="o">=</span>       <span class="err">#数据库白名单列表</span>
<span class="n">binlog_ignore_db</span><span class="o">=</span>   <span class="err">#数据库黑名单列表</span>
</pre></div>


<h2 id="_33">中继日志方式</h2>
<p>从服务器SQL_THREAD在replay中继日志中的事件时，仅读取与特定数据库(特定表)相关的时间并应用于本地</p>
<p>但会造成网络及磁盘IO浪费</p>
<div class="hlcode"><pre><span class="n">replicate_do_db</span>
<span class="n">replicate_ignore_db</span>
<span class="n">replicate_do_table</span><span class="o">=</span>
<span class="n">replicate_ignore_table</span><span class="o">=</span>
<span class="n">replicate_wild_do_table</span><span class="o">=</span>
<span class="n">replicate_wild_ignore_table</span><span class="o">=</span>
</pre></div>


<h3 id="example">example</h3>
<p>从服务器仅复制mydb</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">replicate</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+----------------------------------+-----------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                    <span class="o">|</span> <span class="n">Value</span>     <span class="o">|</span>
<span class="o">+----------------------------------+-----------+</span>
<span class="o">|</span> <span class="n">replicate_annotate_row_events</span>    <span class="o">|</span> <span class="n">OFF</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_do_db</span>                  <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_do_table</span>               <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_events_marked_for_skip</span> <span class="o">|</span> <span class="n">replicate</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_ignore_db</span>              <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_ignore_table</span>           <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_wild_do_table</span>          <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_wild_ignore_table</span>      <span class="o">|</span>           <span class="o">|</span>
<span class="o">+----------------------------------+-----------+</span>
<span class="mi">8</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">stop</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">replicate_do_db</span><span class="o">=</span><span class="n">mydb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">45.77.120.103</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">943</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="mf">.000005</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">529</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span> <span class="n">mydb</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">943</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">1287</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="nl">ERROR:</span> <span class="n">No</span> <span class="n">query</span> <span class="n">specified</span>
</pre></div>


<p>主节点创建数据库</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">testdb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.06</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mydb</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">testdb</span>             <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">6</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">tb1</span> <span class="n">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.06</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">tb1</span><span class="p">;</span>
<span class="o">+------+------+</span>
<span class="o">|</span> <span class="n">id</span>   <span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="n">a</span>    <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>从节点测试</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mydb</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">mydb</span>
<span class="n">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">tb1</span><span class="p">;</span>
<span class="o">+------+------+</span>
<span class="o">|</span> <span class="n">id</span>   <span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="n">a</span>    <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h1 id="ssl">基于SSL复制</h1>
<p>前提，支持SSL</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">ssl</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+---------------+----------+</span>
<span class="o">|</span> <span class="n">Variable_name</span> <span class="o">|</span> <span class="n">Value</span>    <span class="o">|</span>
<span class="o">+---------------+----------+</span>
<span class="o">|</span> <span class="n">have_openssl</span>  <span class="o">|</span> <span class="n">DISABLED</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">have_ssl</span>      <span class="o">|</span> <span class="n">DISABLED</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_ca</span>        <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_capath</span>    <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_cert</span>      <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_cipher</span>    <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_key</span>       <span class="o">|</span>          <span class="o">|</span>
<span class="o">+---------------+----------+</span>
<span class="mi">7</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>这里需要重新编译mariadb</p>
</blockquote>
<ol>
<li>master 配置证书和私钥：并且创建一个要求必须使用SS了连接的复制账号</li>
<li>slave 端使用<code>CHANGE MASTER TO</code> 命令时指明ssl相关选项</li>
</ol>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>