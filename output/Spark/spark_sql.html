<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>spark_sql - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Spark">Spark</a>&nbsp;&#187;&nbsp;spark_sql
    <span class="updated">Page Updated&nbsp;
      2020-07-04 11:31
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">spark_sql</div>

  <p>[toc]</p>
<h1 id="spark-sql">Spark SQL</h1>
<p>不过在实际的开发过程中，我们并不是总需要在 RDD 的层次进行编程</p>
<p>SparkSQL 摒弃了 Shark 的（将 SQL 语句转化为 Spark RDD 的）执行引擎，换成自己团队重新开发的执行引擎</p>
<p>Spark SQL 不仅将关系型数据库的处理模式和 Spark 的函数式编程相结合，还兼容多种数据格式，包括 Hive、RDD、JSON 文件、CSV 文件等</p>
<p>Spark SQL 本质上是一个库。它运行在 Spark 的核心执行引擎之上</p>
<p>使用 Spark SQL 会让开发者觉得好像是在操作一个关系型数据库一样，而不是在操作 RDD。这是它优于原生的 RDD API 的地方。</p>
<h2 id="_1">特点</h2>
<p>RDD 和 DataSet 都是类型安全的，而 DataFrame 并不是类型安全的。这是因为它不存储每一列的信息如名字和类型。</p>
<p>若使用 DataFrame API 时，我们可以选择一个并不存在的列，这个错误只有在代码被执行时才会抛出。如果使用 DataSet API，在编译时就会检测到这个错误</p>
<p>基于 DataFrame 和 DataSet API 开发出的程序会被自动优化，使得开发人员不需要操作底层的 RDD API 来进行手动优化，大大提升开发效率。</p>
<p>RDD API 对于非结构化的数据处理有独特的优势，比如文本流数据，而且更方便我们做底层的操作。所以在开发中，我们还是需要根据实际情况来选择使用哪种 API</p>
<h2 id="spark-sql_1">Spark SQL 架构</h2>
<p><img alt="image-20200704113326185" src="spark_sql.assets/image-20200704113326185.png" /></p>
<h1 id="_2">组件</h1>
<h2 id="dataset">DataSet</h2>
<p>就是数据集的意思，它是 Spark 1.6 新引入的接口</p>
<p>同弹性分布式数据集类似，DataSet 也是不可变分布式的数据单元，它既有与 RDD 类似的各种转换和动作函数定义，而且还享受 Spark SQL 优化过的执行引擎，使得数据搜索效率更高</p>
<p>DataSet 支持的转换和动作也和 RDD 类似，比如 map、filter、select、count、show 及把数据写入文件系统中</p>
<p>同样地，DataSet 上的转换操作也不会被立刻执行，只是先生成新的 DataSet，只有当遇到动作操作，才会把之前的转换操作一并执行，生成结果</p>
<p>DataSet 所描述的数据都被组织到有名字的列中，就像关系型数据库中的表一样</p>
<p><img alt="image-20200704142932545" src="spark_sql.assets/image-20200704142932545.png" /></p>
<blockquote>
<p>左侧的 RDD 虽然以 People 为类型参数，但 Spark 框架本身不了解 People 类的内部结构。所有的操作都以 People 为单位执行</p>
<p>右侧的 DataSet 却提供了详细的结构信息与每列的数据类型</p>
<p>这让 Spark SQL 可以清楚地知道该数据集中包含哪些列，每列的名称和类型各是什么。也就是说，DataSet 提供数据表的 schema 信息。这样的结构使得 DataSet API 的执行效率更高。</p>
</blockquote>
<h2 id="dataframe-deprecated-by-datasetrow">DataFrame (Deprecated by DataSet[Row])</h2>
<p>DataFrame 可以被看作是一种特殊的 DataSet。它也是关系型数据库中表一样的结构化存储机制，也是分布式不可变的数据结构</p>
<p>它的每一列并不存储类型信息，所以在编译时并不能发现类型错误。DataFrame 每一行的类型固定为 Row，他可以被当作 DataSet[Row]来处理，我们必须要通过解析才能获取各列的值</p>
<p>在 Spark 2.0 中，DataFrame 和 DataSet 被统一。DataFrame 作为 DataSet[Row]存在</p>
<p>在弱类型的语言，如 Python 中，DataFrame API 依然存在，但是在 Java 中，DataFrame API 已经不复存在了</p>
<p>DataFrame 是高级 API，提供类似于 SQL 的 query 接口，方便熟悉关系型数据库的开发人员使用</p>
<p>若DataSet 我们可以用类似 people.name 来访问一个人的名字，而对于 DataFrame 我们一定要用类似 people.get As [String] (“name”) 来访问</p>
<h1 id="rdddataframedataset">RDD、DataFrame、DataSet 对比</h1>
<p><img alt="image-20200704144113543" src="spark_sql.assets/image-20200704144113543.png" /></p>
<h2 id="_3">场景</h2>
<p>DataSet适用于每列类型程序都很确定时使用，而DataFrame适用于列的类型不确定，类似于generic的类型，拿到数据后根据数据类型再进行不同的处理。</p>
<h1 id="spark-sql-shell">spark-sql Shell</h1>
<p>Spark还提供了Spark SQL的Shell工具spark-sql, 方便进行解释交互</p>
<h1 id="example">example</h1>
<h2 id="dataframe-for-wordcount">DataFrame for wordCount</h2>
<p>在 DataFrame 的世界中，我们可以把所有的词语放入一张表，表中的每一行代表一个词语，当然这个表只有一列。我们可以对这个表用一个 groupBy() 操作把所有相同的词语聚合起来，然后用 count() 来统计出每个 group 的数量</p>
<p>虽然 Scala 和 Java 支持对 DataFrame 进行 flatMap 操作，但是 Python 并不支持。</p>
<p>要用到两个新的操作explode 和 split, 把包含多个词语的句子进行分割和拆分</p>
<p>split 是 pyspark.sql.functions 库提供的一个函数，它作用于 DataFrame 的某一列，可以把列中的字符串按某个分隔符分割成一个字符串数组。</p>
<p>explode 同样是 pyspark.sql.functions 库提供的一个函数，通俗点的翻译是“爆炸”，它也作用于 DataFrame 的某一列，可以为列中的数组或者 map 中每一个元素创建一个新的 Row</p>
<p>DataFrame 中，每一行只有一列，每一列都是一个包含很多词语的句子，我们可以先对这一列做 split，生成一个新的列，列中每个元素是一个词语的数组；再对这个列做 explode，可以把数组中的每个元素都生成一个新的 Row。这样，就实现了类似的 flatMap 功能。</p>
<p><img alt="image-20200705110131252" src="spark_sql.assets/image-20200705110131252.png" /></p>
<p>接下来我们只需要对 Word 这一列做 groupBy，就可以统计出每个词语出现的频率</p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/apache/spark/master/README.md </span>
</pre></div>


<div class="hlcode"><pre><span class="nx">from</span> <span class="nx">pyspark</span><span class="p">.</span><span class="nx">sql</span> <span class="kr">import</span> <span class="nx">SparkSession</span>
<span class="nx">from</span> <span class="nx">pyspark</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">functions</span> <span class="kr">import</span> <span class="nx">explode</span>
<span class="nx">from</span> <span class="nx">pyspark</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">functions</span> <span class="kr">import</span> <span class="nx">split</span>


<span class="k">if</span> <span class="nx">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="o">:</span>
    <span class="err">#</span> <span class="err">初始化</span><span class="nx">SparkSession</span><span class="err">程序入口</span>
    <span class="nx">spark</span> <span class="o">=</span> <span class="nx">SparkSession</span><span class="p">.</span><span class="nx">builder</span><span class="p">.</span><span class="nx">appName</span><span class="p">(</span><span class="s2">&quot;WordCount&quot;</span><span class="p">).</span><span class="nx">getOrCreate</span><span class="p">()</span>
    <span class="err">#</span> <span class="err">读入文档</span>
    <span class="nx">lines</span> <span class="o">=</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;/tmp/README.md&quot;</span><span class="p">)</span>
    <span class="err">#</span> <span class="err">针对</span><span class="nx">df</span><span class="err">特定的计算格式</span>
    <span class="nx">words</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span>
        <span class="nx">explode</span><span class="p">(</span>
            <span class="nx">split</span><span class="p">(</span><span class="nx">lines</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="p">).</span><span class="nx">alias</span><span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="err">#</span> <span class="err">返回的</span><span class="nx">RDD</span><span class="err">进行计数</span>
    <span class="nx">wordCounts</span> <span class="o">=</span> <span class="nx">words</span><span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">).</span><span class="nx">count</span><span class="p">()</span>
    <span class="nx">wordCounts</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
    <span class="nx">spark</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="o">+---------------+-----+</span>                                                         
<span class="o">|</span>           <span class="nx">word</span><span class="o">|</span><span class="nx">count</span><span class="o">|</span>
<span class="o">+---------------+-----+</span>
<span class="o">|</span>     <span class="cp">[</span><span class="o">!</span><span class="err">[</span><span class="nx">PySpark</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>         <span class="nx">online</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>         <span class="nx">graphs</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>     <span class="err">[</span><span class="s2">&quot;Building|    1|</span>
<span class="s2">|  documentation|    3|</span>
<span class="s2">|       command,|    2|</span>
<span class="s2">|    abbreviated|    1|</span>
<span class="s2">|       overview|    1|</span>
<span class="s2">|           rich|    1|</span>
<span class="s2">|            set|    2|</span>
<span class="s2">|    -DskipTests|    1|</span>
<span class="s2">| 1,000,000,000:|    2|</span>
<span class="s2">|           name|    1|</span>
<span class="s2">|   [&quot;</span><span class="nx">Specifying</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>         <span class="nx">stream</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>           <span class="nb">run</span><span class="p">:</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>            <span class="ow">not</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>       <span class="nx">programs</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>          <span class="nx">tests</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span><span class="nx">.</span><span class="p">/</span><span class="nx">dev</span><span class="p">/</span><span class="nb">run</span><span class="na">-tests</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">+---------------+-----+</span>
<span class="nx">only</span> <span class="nx">showing</span> <span class="nb">top</span> <span class="mi">20</span> <span class="k">rows</span>
</pre></div>


<h2 id="batch-job-house-data-processing">Batch Job (house data processing)</h2>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.dcc.fc.up.pt/~ltorgo/Regression/cal_housing.tgz</span>
</pre></div>


<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">numpy</span>
</pre></div>


<p>PySpark的SQL库只有DataFrame，并没有DataSet。不过在Scala和Java中，DataSet已经成为了统一的SQL入口</p>
<p>这是由语言特性决定的，Python是动态类型的语言，而DataSet是强类型的，要求在编译时检测类型安全。</p>
<p>把数据集读入 Spark</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">pyspark</span><span class="p">.</span><span class="n">sql</span> <span class="n">import</span> <span class="n">SparkSession</span>

<span class="cp"># 初始化SparkSession和SparkContext</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">master</span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">).</span><span class="n">appName</span><span class="p">(</span>
    <span class="s">&quot;California Housing&quot;</span><span class="p">).</span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.executor.memory&quot;</span><span class="p">,</span> <span class="s">&quot;1gb&quot;</span><span class="p">).</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sparkContext</span>

<span class="cp"># 读取数据并创建RDD</span>
<span class="n">rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">textFile</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">spark_test</span><span class="o">/</span><span class="n">CaliforniaHousing</span><span class="o">/</span><span class="n">cal_housing</span><span class="p">.</span><span class="n">data</span><span class="err">&#39;</span><span class="p">)</span>

<span class="cp"># 读取数据每个属性的定义并创建RDD</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">textFile</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">spark_test</span><span class="o">/</span><span class="n">CaliforniaHousing</span><span class="o">/</span><span class="n">cal_housing</span><span class="p">.</span><span class="n">domain</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>把房屋信息数据和每个属性的定义读入了 Spark，并创建了两个相应的 RDD, 用 collect() 函数来把数据输出在 Shell 上</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">:</span> <span class="n">header</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>                                                                                                                                                  <span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">:</span> 
<span class="p">[</span><span class="err">&#39;</span><span class="n">longitude</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">latitude</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">housingMedianAge</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">totalRooms</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">totalBedrooms</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">population</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">households</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">medianIncome</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="n">medianHouseValue</span><span class="o">:</span> <span class="n">continuous</span><span class="p">.</span> <span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>collect() 函数会把所有数据都加载到内存中，如果数据很大的话，有可能会造成内存泄漏，所以要小心使用。平时比较常见的方法是用 take() 函数去只读取 RDD 中的某几个元素</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">:</span> <span class="n">rdd</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                       <span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">:</span>                                                                        
<span class="p">[</span><span class="err">&#39;</span><span class="o">-</span><span class="mf">122.230000</span><span class="p">,</span><span class="mf">37.880000</span><span class="p">,</span><span class="mf">41.000000</span><span class="p">,</span><span class="mf">880.000000</span><span class="p">,</span><span class="mf">129.000000</span><span class="p">,</span><span class="mf">322.000000</span><span class="p">,</span><span class="mf">126.000000</span><span class="p">,</span><span class="mf">8.325200</span><span class="p">,</span><span class="mf">452600.000000</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="o">-</span><span class="mf">122.220000</span><span class="p">,</span><span class="mf">37.860000</span><span class="p">,</span><span class="mf">21.000000</span><span class="p">,</span><span class="mf">7099.000000</span><span class="p">,</span><span class="mf">1106.000000</span><span class="p">,</span><span class="mf">2401.000000</span><span class="p">,</span><span class="mf">1138.000000</span><span class="p">,</span><span class="mf">8.301400</span><span class="p">,</span><span class="mf">358500.000000</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<p>用 map 函数把大字符串分隔成数组，这会方便我们的后续操作</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">:</span> <span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">line</span><span class="o">:</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))</span>                                                                                                                       
<span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">:</span> <span class="n">rdd</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                       <span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">:</span> 
<span class="p">[[</span><span class="err">&#39;</span><span class="o">-</span><span class="mf">122.230000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">37.880000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">41.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">880.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">129.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">322.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">126.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">8.325200</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">452600.000000</span><span class="err">&#39;</span><span class="p">],</span>
 <span class="p">[</span><span class="err">&#39;</span><span class="o">-</span><span class="mf">122.220000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">37.860000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">21.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">7099.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">1106.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">2401.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">1138.000000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">8.301400</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="err">&#39;</span><span class="mf">358500.000000</span><span class="err">&#39;</span><span class="p">]]</span>
</pre></div>


<p>Spark SQL 的 DataFrame API 在查询结构化数据时更方便使用，而且性能更好。在这个例子中你可以看到，数据的 schema 是定义好的，我们需要去查询各个列，所以 DataFrame API 显然更加适用</p>
<p>先把 RDD 转换为 DataFrame, 即把之前用数组代表的对象，转换成为 Row 对象，再用 toDF() 函数转换成 DataFrame</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">pyspark</span><span class="p">.</span><span class="n">sql</span> <span class="n">import</span> <span class="n">Row</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">rdd</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">line</span><span class="o">:</span> <span class="n">Row</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">latitude</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">housingMedianAge</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                             <span class="n">totalRooms</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                             <span class="n">totalBedRooms</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                             <span class="n">population</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                             <span class="n">households</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                             <span class="n">medianIncome</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                             <span class="n">medianHouseValue</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])).</span><span class="n">toDF</span><span class="p">()</span>

<span class="n">df</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="o">+-----------+----------------+---------+-----------+----------------+------------+-----------+-------------+-----------+</span>
<span class="o">|</span> <span class="n">households</span><span class="o">|</span><span class="n">housingMedianAge</span><span class="o">|</span> <span class="n">latitude</span><span class="o">|</span>  <span class="n">longitude</span><span class="o">|</span><span class="n">medianHouseValue</span><span class="o">|</span><span class="n">medianIncome</span><span class="o">|</span> <span class="n">population</span><span class="o">|</span><span class="n">totalBedRooms</span><span class="o">|</span> <span class="n">totalRooms</span><span class="o">|</span>
<span class="o">+-----------+----------------+---------+-----------+----------------+------------+-----------+-------------+-----------+</span>
<span class="o">|</span> <span class="mf">126.000000</span><span class="o">|</span>       <span class="mf">41.000000</span><span class="o">|</span><span class="mf">37.880000</span><span class="o">|-</span><span class="mf">122.230000</span><span class="o">|</span>   <span class="mf">452600.000000</span><span class="o">|</span>    <span class="mf">8.325200</span><span class="o">|</span> <span class="mf">322.000000</span><span class="o">|</span>   <span class="mf">129.000000</span><span class="o">|</span> <span class="mf">880.000000</span><span class="o">|</span>
<span class="o">|</span><span class="mf">1138.000000</span><span class="o">|</span>       <span class="mf">21.000000</span><span class="o">|</span><span class="mf">37.860000</span><span class="o">|-</span><span class="mf">122.220000</span><span class="o">|</span>   <span class="mf">358500.000000</span><span class="o">|</span>    <span class="mf">8.301400</span><span class="o">|</span><span class="mf">2401.000000</span><span class="o">|</span>  <span class="mf">1106.000000</span><span class="o">|</span><span class="mf">7099.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">177.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.240000</span><span class="o">|</span>   <span class="mf">352100.000000</span><span class="o">|</span>    <span class="mf">7.257400</span><span class="o">|</span> <span class="mf">496.000000</span><span class="o">|</span>   <span class="mf">190.000000</span><span class="o">|</span><span class="mf">1467.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">219.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.250000</span><span class="o">|</span>   <span class="mf">341300.000000</span><span class="o">|</span>    <span class="mf">5.643100</span><span class="o">|</span> <span class="mf">558.000000</span><span class="o">|</span>   <span class="mf">235.000000</span><span class="o">|</span><span class="mf">1274.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">259.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.250000</span><span class="o">|</span>   <span class="mf">342200.000000</span><span class="o">|</span>    <span class="mf">3.846200</span><span class="o">|</span> <span class="mf">565.000000</span><span class="o">|</span>   <span class="mf">280.000000</span><span class="o">|</span><span class="mf">1627.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">193.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.250000</span><span class="o">|</span>   <span class="mf">269700.000000</span><span class="o">|</span>    <span class="mf">4.036800</span><span class="o">|</span> <span class="mf">413.000000</span><span class="o">|</span>   <span class="mf">213.000000</span><span class="o">|</span> <span class="mf">919.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">514.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.250000</span><span class="o">|</span>   <span class="mf">299200.000000</span><span class="o">|</span>    <span class="mf">3.659100</span><span class="o">|</span><span class="mf">1094.000000</span><span class="o">|</span>   <span class="mf">489.000000</span><span class="o">|</span><span class="mf">2535.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">647.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.250000</span><span class="o">|</span>   <span class="mf">241400.000000</span><span class="o">|</span>    <span class="mf">3.120000</span><span class="o">|</span><span class="mf">1157.000000</span><span class="o">|</span>   <span class="mf">687.000000</span><span class="o">|</span><span class="mf">3104.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">595.000000</span><span class="o">|</span>       <span class="mf">42.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">226700.000000</span><span class="o">|</span>    <span class="mf">2.080400</span><span class="o">|</span><span class="mf">1206.000000</span><span class="o">|</span>   <span class="mf">665.000000</span><span class="o">|</span><span class="mf">2555.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">714.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.250000</span><span class="o">|</span>   <span class="mf">261100.000000</span><span class="o">|</span>    <span class="mf">3.691200</span><span class="o">|</span><span class="mf">1551.000000</span><span class="o">|</span>   <span class="mf">707.000000</span><span class="o">|</span><span class="mf">3549.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">402.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">281500.000000</span><span class="o">|</span>    <span class="mf">3.203100</span><span class="o">|</span> <span class="mf">910.000000</span><span class="o">|</span>   <span class="mf">434.000000</span><span class="o">|</span><span class="mf">2202.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">734.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">241800.000000</span><span class="o">|</span>    <span class="mf">3.270500</span><span class="o">|</span><span class="mf">1504.000000</span><span class="o">|</span>   <span class="mf">752.000000</span><span class="o">|</span><span class="mf">3503.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">468.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">213500.000000</span><span class="o">|</span>    <span class="mf">3.075000</span><span class="o">|</span><span class="mf">1098.000000</span><span class="o">|</span>   <span class="mf">474.000000</span><span class="o">|</span><span class="mf">2491.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">174.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">191300.000000</span><span class="o">|</span>    <span class="mf">2.673600</span><span class="o">|</span> <span class="mf">345.000000</span><span class="o">|</span>   <span class="mf">191.000000</span><span class="o">|</span> <span class="mf">696.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">620.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">159200.000000</span><span class="o">|</span>    <span class="mf">1.916700</span><span class="o">|</span><span class="mf">1212.000000</span><span class="o">|</span>   <span class="mf">626.000000</span><span class="o">|</span><span class="mf">2643.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">264.000000</span><span class="o">|</span>       <span class="mf">50.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">140000.000000</span><span class="o">|</span>    <span class="mf">2.125000</span><span class="o">|</span> <span class="mf">697.000000</span><span class="o">|</span>   <span class="mf">283.000000</span><span class="o">|</span><span class="mf">1120.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">331.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.270000</span><span class="o">|</span>   <span class="mf">152500.000000</span><span class="o">|</span>    <span class="mf">2.775000</span><span class="o">|</span> <span class="mf">793.000000</span><span class="o">|</span>   <span class="mf">347.000000</span><span class="o">|</span><span class="mf">1966.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">303.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.850000</span><span class="o">|-</span><span class="mf">122.270000</span><span class="o">|</span>   <span class="mf">155500.000000</span><span class="o">|</span>    <span class="mf">2.120200</span><span class="o">|</span> <span class="mf">648.000000</span><span class="o">|</span>   <span class="mf">293.000000</span><span class="o">|</span><span class="mf">1228.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">419.000000</span><span class="o">|</span>       <span class="mf">50.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.260000</span><span class="o">|</span>   <span class="mf">158700.000000</span><span class="o">|</span>    <span class="mf">1.991100</span><span class="o">|</span> <span class="mf">990.000000</span><span class="o">|</span>   <span class="mf">455.000000</span><span class="o">|</span><span class="mf">2239.000000</span><span class="o">|</span>
<span class="o">|</span> <span class="mf">275.000000</span><span class="o">|</span>       <span class="mf">52.000000</span><span class="o">|</span><span class="mf">37.840000</span><span class="o">|-</span><span class="mf">122.270000</span><span class="o">|</span>   <span class="mf">162900.000000</span><span class="o">|</span>    <span class="mf">2.603300</span><span class="o">|</span> <span class="mf">690.000000</span><span class="o">|</span>   <span class="mf">298.000000</span><span class="o">|</span><span class="mf">1503.000000</span><span class="o">|</span>
<span class="o">+-----------+----------------+---------+-----------+----------------+------------+-----------+-------------+-----------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">20</span> <span class="n">rows</span>
</pre></div>


<p>这里每一列的数据格式都是 string，但是，它们其实都是数字，所以我们可以通过 cast() 函数把每一列的类型转换成 float</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">pyspark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">types</span> <span class="n">import</span> <span class="n">FloatType</span>

<span class="n">def</span> <span class="n">convertColumn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">newType</span><span class="p">)</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="n">in</span> <span class="n">names</span><span class="o">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="n">cast</span><span class="p">(</span><span class="n">newType</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">households</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">housingMedianAge</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">latitude</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">longitude</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">medianHouseValue</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">medianIncome</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">population</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">totalBedRooms</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">totalRooms</span><span class="err">&#39;</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">convertColumn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span>
</pre></div>


<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">describe</span>                                                                                                                                                       <span class="n">Out</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">DataFrame</span><span class="p">.</span><span class="n">describe</span> <span class="n">of</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">households</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">housingMedianAge</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">latitude</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">longitude</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">medianHouseValue</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">medianIncome</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">population</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">totalBedRooms</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">totalRooms</span><span class="o">:</span> <span class="kt">float</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                                                                                                                                                        <span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+</span>
<span class="o">|</span><span class="n">households</span><span class="o">|</span><span class="n">housingMedianAge</span><span class="o">|</span><span class="n">latitude</span><span class="o">|</span><span class="n">longitude</span><span class="o">|</span><span class="n">medianHouseValue</span><span class="o">|</span><span class="n">medianIncome</span><span class="o">|</span><span class="n">population</span><span class="o">|</span><span class="n">totalBedRooms</span><span class="o">|</span><span class="n">totalRooms</span><span class="o">|</span>
<span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+</span>
<span class="o">|</span>     <span class="mf">126.0</span><span class="o">|</span>            <span class="mf">41.0</span><span class="o">|</span>   <span class="mf">37.88</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.23</span><span class="o">|</span>        <span class="mf">452600.0</span><span class="o">|</span>      <span class="mf">8.3252</span><span class="o">|</span>     <span class="mf">322.0</span><span class="o">|</span>        <span class="mf">129.0</span><span class="o">|</span>     <span class="mf">880.0</span><span class="o">|</span>
<span class="o">|</span>    <span class="mf">1138.0</span><span class="o">|</span>            <span class="mf">21.0</span><span class="o">|</span>   <span class="mf">37.86</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.22</span><span class="o">|</span>        <span class="mf">358500.0</span><span class="o">|</span>      <span class="mf">8.3014</span><span class="o">|</span>    <span class="mf">2401.0</span><span class="o">|</span>       <span class="mf">1106.0</span><span class="o">|</span>    <span class="mf">7099.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mf">177.0</span><span class="o">|</span>            <span class="mf">52.0</span><span class="o">|</span>   <span class="mf">37.85</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.24</span><span class="o">|</span>        <span class="mf">352100.0</span><span class="o">|</span>      <span class="mf">7.2574</span><span class="o">|</span>     <span class="mf">496.0</span><span class="o">|</span>        <span class="mf">190.0</span><span class="o">|</span>    <span class="mf">1467.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mf">219.0</span><span class="o">|</span>            <span class="mf">52.0</span><span class="o">|</span>   <span class="mf">37.85</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.25</span><span class="o">|</span>        <span class="mf">341300.0</span><span class="o">|</span>      <span class="mf">5.6431</span><span class="o">|</span>     <span class="mf">558.0</span><span class="o">|</span>        <span class="mf">235.0</span><span class="o">|</span>    <span class="mf">1274.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mf">259.0</span><span class="o">|</span>            <span class="mf">52.0</span><span class="o">|</span>   <span class="mf">37.85</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.25</span><span class="o">|</span>        <span class="mf">342200.0</span><span class="o">|</span>      <span class="mf">3.8462</span><span class="o">|</span>     <span class="mf">565.0</span><span class="o">|</span>        <span class="mf">280.0</span><span class="o">|</span>    <span class="mf">1627.0</span><span class="o">|</span>
<span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>


<p>转换成数字有很多优势。比如，我们可以按某一列，对所有对象进行排序，也可以计算平均值等</p>
<p>统计出所有建造年限各有多少个房子</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s">&quot;housingMedianAge&quot;</span><span class="p">).</span><span class="n">count</span><span class="p">().</span><span class="n">sort</span><span class="p">(</span><span class="s">&quot;housingMedianAge&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="n">False</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>                                                                            <span class="o">+----------------+-----+</span>                                                        
<span class="o">|</span><span class="n">housingMedianAge</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="o">+----------------+-----+</span>
<span class="o">|</span>            <span class="mf">52.0</span><span class="o">|</span> <span class="mi">1273</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">51.0</span><span class="o">|</span>   <span class="mi">48</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">50.0</span><span class="o">|</span>  <span class="mi">136</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">49.0</span><span class="o">|</span>  <span class="mi">134</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">48.0</span><span class="o">|</span>  <span class="mi">177</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">47.0</span><span class="o">|</span>  <span class="mi">198</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">46.0</span><span class="o">|</span>  <span class="mi">245</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">45.0</span><span class="o">|</span>  <span class="mi">294</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">44.0</span><span class="o">|</span>  <span class="mi">356</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">43.0</span><span class="o">|</span>  <span class="mi">353</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">42.0</span><span class="o">|</span>  <span class="mi">368</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">41.0</span><span class="o">|</span>  <span class="mi">296</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">40.0</span><span class="o">|</span>  <span class="mi">304</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">39.0</span><span class="o">|</span>  <span class="mi">369</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">38.0</span><span class="o">|</span>  <span class="mi">394</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">37.0</span><span class="o">|</span>  <span class="mi">537</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">36.0</span><span class="o">|</span>  <span class="mi">862</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">35.0</span><span class="o">|</span>  <span class="mi">824</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">34.0</span><span class="o">|</span>  <span class="mi">689</span><span class="o">|</span>
<span class="o">|</span>            <span class="mf">33.0</span><span class="o">|</span>  <span class="mi">615</span><span class="o">|</span>
<span class="o">+----------------+-----+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">20</span> <span class="n">rows</span>
</pre></div>


<h3 id="_4">预处理</h3>
<p>通过上面的数据分析，你可能会发现这些数据还是不够直观</p>
<ol>
<li>房价的值普遍都很大，我们可以把它调整成相对较小的数字；</li>
</ol>
<p>大多数房价都是十万起的，所以可以用 withColumn() 函数把所有房价都除以 100000</p>
<div class="hlcode"><pre><span class="nx">from</span> <span class="nx">pyspark</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">functions</span> <span class="kr">import</span> <span class="nx">col</span>                                                                                                                             
<span class="nx">df</span> <span class="o">=</span> <span class="nx">df</span><span class="p">.</span><span class="nx">withColumn</span><span class="p">(</span><span class="s1">&#39;medianHouseValue&#39;</span><span class="p">,</span> <span class="nx">col</span><span class="p">(</span><span class="s1">&#39;medianHouseValue&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">100000</span><span class="p">)</span>                                                                                            

<span class="nx">In</span> <span class="cp">[</span><span class="mi">33</span><span class="cp">]</span><span class="o">:</span> <span class="nx">df</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                        <span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+</span>
<span class="o">|</span><span class="nx">households</span><span class="o">|</span><span class="nx">housingMedianAge</span><span class="o">|</span><span class="nx">latitude</span><span class="o">|</span><span class="nx">longitude</span><span class="o">|</span><span class="nx">medianHouseValue</span><span class="o">|</span><span class="nx">medianIncome</span><span class="o">|</span><span class="nx">population</span><span class="o">|</span><span class="nx">totalBedRooms</span><span class="o">|</span><span class="nx">totalRooms</span><span class="o">|</span>
<span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+</span>
<span class="o">|</span>     <span class="mf">126.0</span><span class="o">|</span>            <span class="mf">41.0</span><span class="o">|</span>   <span class="mf">37.88</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.23</span><span class="o">|</span>           <span class="mf">4.526</span><span class="o">|</span>      <span class="mf">8.3252</span><span class="o">|</span>     <span class="mf">322.0</span><span class="o">|</span>        <span class="mf">129.0</span><span class="o">|</span>     <span class="mf">880.0</span><span class="o">|</span>
<span class="o">|</span>    <span class="mf">1138.0</span><span class="o">|</span>            <span class="mf">21.0</span><span class="o">|</span>   <span class="mf">37.86</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.22</span><span class="o">|</span>           <span class="mf">3.585</span><span class="o">|</span>      <span class="mf">8.3014</span><span class="o">|</span>    <span class="mf">2401.0</span><span class="o">|</span>       <span class="mf">1106.0</span><span class="o">|</span>    <span class="mf">7099.0</span><span class="o">|</span>
<span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+</span>
<span class="nx">only</span> <span class="nx">showing</span> <span class="nx">top</span> <span class="mi">2</span> <span class="nx">rows</span>
</pre></div>


<ol>
<li>有的属性没什么意义，比如所有房子的总房间数和总卧室数，我们更加关心的是平均房间数；</li>
</ol>
<p>添加三个新的列：</p>
<p>每个家庭的平均房间数：roomsPerHousehold </p>
<p>每个家庭的平均人数：populationPerHousehold</p>
<p>卧室在总房间的占比：bedroomsPerRoom</p>
<div class="hlcode"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;roomsPerHousehold&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s">&quot;totalRooms&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">col</span><span class="p">(</span><span class="s">&quot;households&quot;</span><span class="p">)).</span>\
    <span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;populationPerHousehold&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s">&quot;population&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">col</span><span class="p">(</span><span class="s">&quot;households&quot;</span><span class="p">)).</span>\
    <span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;bedroomsPerRoom&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s">&quot;totalBedRooms&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">col</span><span class="p">(</span><span class="s">&quot;totalRooms&quot;</span><span class="p">))</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                                                                                                                                        <span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+-----------------+----------------------+-------------------+</span>
<span class="o">|</span><span class="n">households</span><span class="o">|</span><span class="n">housingMedianAge</span><span class="o">|</span><span class="n">latitude</span><span class="o">|</span><span class="n">longitude</span><span class="o">|</span><span class="n">medianHouseValue</span><span class="o">|</span><span class="n">medianIncome</span><span class="o">|</span><span class="n">population</span><span class="o">|</span><span class="n">totalBedRooms</span><span class="o">|</span><span class="n">totalRooms</span><span class="o">|</span><span class="n">roomsPerHousehold</span><span class="o">|</span><span class="n">populationPerHousehold</span><span class="o">|</span>    <span class="n">bedroomsPerRoom</span><span class="o">|</span>
<span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+-----------------+----------------------+-------------------+</span>
<span class="o">|</span>     <span class="mf">126.0</span><span class="o">|</span>            <span class="mf">41.0</span><span class="o">|</span>   <span class="mf">37.88</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.23</span><span class="o">|</span>           <span class="mf">4.526</span><span class="o">|</span>      <span class="mf">8.3252</span><span class="o">|</span>     <span class="mf">322.0</span><span class="o">|</span>        <span class="mf">129.0</span><span class="o">|</span>     <span class="mf">880.0</span><span class="o">|</span><span class="mf">6.984126984126984</span><span class="o">|</span>    <span class="mf">2.5555555555555554</span><span class="o">|</span><span class="mf">0.14659090909090908</span><span class="o">|</span>
<span class="o">|</span>    <span class="mf">1138.0</span><span class="o">|</span>            <span class="mf">21.0</span><span class="o">|</span>   <span class="mf">37.86</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.22</span><span class="o">|</span>           <span class="mf">3.585</span><span class="o">|</span>      <span class="mf">8.3014</span><span class="o">|</span>    <span class="mf">2401.0</span><span class="o">|</span>       <span class="mf">1106.0</span><span class="o">|</span>    <span class="mf">7099.0</span><span class="o">|</span><span class="mf">6.238137082601054</span><span class="o">|</span>     <span class="mf">2.109841827768014</span><span class="o">|</span><span class="mf">0.15579659106916466</span><span class="o">|</span>
<span class="o">|</span>     <span class="mf">177.0</span><span class="o">|</span>            <span class="mf">52.0</span><span class="o">|</span>   <span class="mf">37.85</span><span class="o">|</span>  <span class="o">-</span><span class="mf">122.24</span><span class="o">|</span>           <span class="mf">3.521</span><span class="o">|</span>      <span class="mf">7.2574</span><span class="o">|</span>     <span class="mf">496.0</span><span class="o">|</span>        <span class="mf">190.0</span><span class="o">|</span>    <span class="mf">1467.0</span><span class="o">|</span><span class="mf">8.288135593220339</span><span class="o">|</span>    <span class="mf">2.8022598870056497</span><span class="o">|</span><span class="mf">0.12951601908657123</span><span class="o">|</span>
<span class="o">+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+-----------------+----------------------+-------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">3</span> <span class="n">rows</span>    
</pre></div>


<p>有的列是我们并不关心的，比如经纬度，这个数值很难有线性的意义。所以我们可以只留下重要的信息列</p>
<div class="hlcode"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;medianHouseValue&quot;</span><span class="p">,</span>
               <span class="s">&quot;totalBedRooms&quot;</span><span class="p">,</span>
               <span class="s">&quot;population&quot;</span><span class="p">,</span>
               <span class="s">&quot;households&quot;</span><span class="p">,</span>
               <span class="s">&quot;medianIncome&quot;</span><span class="p">,</span>
               <span class="s">&quot;roomsPerHousehold&quot;</span><span class="p">,</span>
               <span class="s">&quot;populationPerHousehold&quot;</span><span class="p">,</span>
               <span class="s">&quot;bedroomsPerRoom&quot;</span><span class="p">)</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                                                                                                                                        <span class="o">+----------------+-------------+----------+----------+------------+-----------------+----------------------+-------------------+</span>
<span class="o">|</span><span class="n">medianHouseValue</span><span class="o">|</span><span class="n">totalBedRooms</span><span class="o">|</span><span class="n">population</span><span class="o">|</span><span class="n">households</span><span class="o">|</span><span class="n">medianIncome</span><span class="o">|</span><span class="n">roomsPerHousehold</span><span class="o">|</span><span class="n">populationPerHousehold</span><span class="o">|</span>    <span class="n">bedroomsPerRoom</span><span class="o">|</span>
<span class="o">+----------------+-------------+----------+----------+------------+-----------------+----------------------+-------------------+</span>
<span class="o">|</span>           <span class="mf">4.526</span><span class="o">|</span>        <span class="mf">129.0</span><span class="o">|</span>     <span class="mf">322.0</span><span class="o">|</span>     <span class="mf">126.0</span><span class="o">|</span>      <span class="mf">8.3252</span><span class="o">|</span><span class="mf">6.984126984126984</span><span class="o">|</span>    <span class="mf">2.5555555555555554</span><span class="o">|</span><span class="mf">0.14659090909090908</span><span class="o">|</span>
<span class="o">|</span>           <span class="mf">3.585</span><span class="o">|</span>       <span class="mf">1106.0</span><span class="o">|</span>    <span class="mf">2401.0</span><span class="o">|</span>    <span class="mf">1138.0</span><span class="o">|</span>      <span class="mf">8.3014</span><span class="o">|</span><span class="mf">6.238137082601054</span><span class="o">|</span>     <span class="mf">2.109841827768014</span><span class="o">|</span><span class="mf">0.15579659106916466</span><span class="o">|</span>
<span class="o">|</span>           <span class="mf">3.521</span><span class="o">|</span>        <span class="mf">190.0</span><span class="o">|</span>     <span class="mf">496.0</span><span class="o">|</span>     <span class="mf">177.0</span><span class="o">|</span>      <span class="mf">7.2574</span><span class="o">|</span><span class="mf">8.288135593220339</span><span class="o">|</span>    <span class="mf">2.8022598870056497</span><span class="o">|</span><span class="mf">0.12951601908657123</span><span class="o">|</span>
<span class="o">+----------------+-------------+----------+----------+------------+-----------------+----------------------+-------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">3</span> <span class="n">rows</span>             
</pre></div>


<ol>
<li>在我们想要构建的线性模型中，房价是结果，其他属性是输入参数。所以我们需要把它们分离处理；</li>
</ol>
<p>把 DataFrame 转换成 RDD，然后用 map() 函数把每个对象分成两部分：房价和一个包含其余属性的列表，然后再转换回 DataFrame</p>
<p>两部分重新标记为“label”和“features”，label 代表的是房价，features 代表包括其余参数的列表</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">pyspark</span><span class="p">.</span><span class="n">ml</span><span class="p">.</span><span class="n">linalg</span> <span class="n">import</span> <span class="n">DenseVector</span>

<span class="n">input_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DenseVector</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="p">])))</span>
<span class="n">df_</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;label&quot;</span><span class="p">,</span> <span class="s">&quot;features&quot;</span><span class="p">])</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">:</span> <span class="n">df_</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                                                                                                                                       <span class="o">+-----+--------------------+</span>                                                    
<span class="o">|</span><span class="n">label</span><span class="o">|</span>            <span class="n">features</span><span class="o">|</span>
<span class="o">+-----+--------------------+</span>
<span class="o">|</span><span class="mf">4.526</span><span class="o">|</span><span class="p">[</span><span class="mf">129.0</span><span class="p">,</span><span class="mf">322.0</span><span class="p">,</span><span class="mf">126.</span><span class="p">...</span><span class="o">|</span>
<span class="o">|</span><span class="mf">3.585</span><span class="o">|</span><span class="p">[</span><span class="mf">1106.0</span><span class="p">,</span><span class="mf">2401.0</span><span class="p">,</span><span class="mf">11.</span><span class="p">..</span><span class="o">|</span>
<span class="o">|</span><span class="mf">3.521</span><span class="o">|</span><span class="p">[</span><span class="mf">190.0</span><span class="p">,</span><span class="mf">496.0</span><span class="p">,</span><span class="mf">177.</span><span class="p">...</span><span class="o">|</span>
<span class="o">+-----+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">3</span> <span class="n">rows</span>
</pre></div>


<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                        <span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">:</span> 
<span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="n">medianHouseValue</span><span class="o">=</span><span class="mf">4.526</span><span class="p">,</span> <span class="n">totalBedRooms</span><span class="o">=</span><span class="mf">129.0</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="mf">322.0</span><span class="p">,</span> <span class="n">households</span><span class="o">=</span><span class="mf">126.0</span><span class="p">,</span> <span class="n">medianIncome</span><span class="o">=</span><span class="mf">8.325200080871582</span><span class="p">,</span> <span class="n">roomsPerHousehold</span><span class="o">=</span><span class="mf">6.984126984126984</span><span class="p">,</span> <span class="n">populationPerHousehold</span><span class="o">=</span><span class="mf">2.5555555555555554</span><span class="p">,</span> <span class="n">bedroomsPerRoom</span><span class="o">=</span><span class="mf">0.14659090909090908</span><span class="p">),</span>
 <span class="n">Row</span><span class="p">(</span><span class="n">medianHouseValue</span><span class="o">=</span><span class="mf">3.585</span><span class="p">,</span> <span class="n">totalBedRooms</span><span class="o">=</span><span class="mf">1106.0</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="mf">2401.0</span><span class="p">,</span> <span class="n">households</span><span class="o">=</span><span class="mf">1138.0</span><span class="p">,</span> <span class="n">medianIncome</span><span class="o">=</span><span class="mf">8.301400184631348</span><span class="p">,</span> <span class="n">roomsPerHousehold</span><span class="o">=</span><span class="mf">6.238137082601054</span><span class="p">,</span> <span class="n">populationPerHousehold</span><span class="o">=</span><span class="mf">2.109841827768014</span><span class="p">,</span> <span class="n">bedroomsPerRoom</span><span class="o">=</span><span class="mf">0.15579659106916466</span><span class="p">)]</span>
</pre></div>


<ol>
<li>有的属性最小值和最大值范围很大，我们可以把它们标准化处理。</li>
</ol>
<p>数据的标准化我们可以借助 Spark 的机器学习库 Spark ML 来完成。Spark ML 也是基于 DataFrame，它提供了大量机器学习的算法实现、数据流水线（pipeline）相关工具和很多常用功能</p>
<p>新增了一个 features_scaled 的列，它里面每个数据都是标准化过的，我们应该用它，而非 features 来训练模型</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">pyspark</span><span class="p">.</span><span class="n">ml</span><span class="p">.</span><span class="n">feature</span> <span class="n">import</span> <span class="n">StandardScaler</span>

<span class="n">standardScaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s">&quot;features&quot;</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s">&quot;features_scaled&quot;</span><span class="p">)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">standardScaler</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_</span><span class="p">)</span>
<span class="n">scaled_df</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_</span><span class="p">)</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="o">:</span> <span class="n">scaled_df</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                 <span class="o">+-----+--------------------+--------------------+</span>                               
<span class="o">|</span><span class="n">label</span><span class="o">|</span>            <span class="n">features</span><span class="o">|</span>     <span class="n">features_scaled</span><span class="o">|</span>
<span class="o">+-----+--------------------+--------------------+</span>
<span class="o">|</span><span class="mf">4.526</span><span class="o">|</span><span class="p">[</span><span class="mf">129.0</span><span class="p">,</span><span class="mf">322.0</span><span class="p">,</span><span class="mf">126.</span><span class="p">...</span><span class="o">|</span><span class="p">[</span><span class="mf">0.30623297630686</span><span class="p">...</span><span class="o">|</span>
<span class="o">|</span><span class="mf">3.585</span><span class="o">|</span><span class="p">[</span><span class="mf">1106.0</span><span class="p">,</span><span class="mf">2401.0</span><span class="p">,</span><span class="mf">11.</span><span class="p">..</span><span class="o">|</span><span class="p">[</span><span class="mf">2.62553233949917</span><span class="p">...</span><span class="o">|</span>
<span class="o">+-----+--------------------+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">2</span> <span class="n">rows</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">:</span> <span class="n">scaled_df</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                 <span class="n">Out</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">:</span> 
<span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="mf">4.526</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">DenseVector</span><span class="p">([</span><span class="mf">129.0</span><span class="p">,</span> <span class="mf">322.0</span><span class="p">,</span> <span class="mf">126.0</span><span class="p">,</span> <span class="mf">8.3252</span><span class="p">,</span> <span class="mf">6.9841</span><span class="p">,</span> <span class="mf">2.5556</span><span class="p">,</span> <span class="mf">0.1466</span><span class="p">]),</span> <span class="n">features_scaled</span><span class="o">=</span><span class="n">DenseVector</span><span class="p">([</span><span class="mf">0.3062</span><span class="p">,</span> <span class="mf">0.2843</span><span class="p">,</span> <span class="mf">0.3296</span><span class="p">,</span> <span class="mf">4.3821</span><span class="p">,</span> <span class="mf">2.8228</span><span class="p">,</span> <span class="mf">0.2461</span><span class="p">,</span> <span class="mf">2.5264</span><span class="p">])),</span>
 <span class="n">Row</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="mf">3.585</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">DenseVector</span><span class="p">([</span><span class="mf">1106.0</span><span class="p">,</span> <span class="mf">2401.0</span><span class="p">,</span> <span class="mf">1138.0</span><span class="p">,</span> <span class="mf">8.3014</span><span class="p">,</span> <span class="mf">6.2381</span><span class="p">,</span> <span class="mf">2.1098</span><span class="p">,</span> <span class="mf">0.1558</span><span class="p">]),</span> <span class="n">features_scaled</span><span class="o">=</span><span class="n">DenseVector</span><span class="p">([</span><span class="mf">2.6255</span><span class="p">,</span> <span class="mf">2.1202</span><span class="p">,</span> <span class="mf">2.9765</span><span class="p">,</span> <span class="mf">4.3696</span><span class="p">,</span> <span class="mf">2.5213</span><span class="p">,</span> <span class="mf">0.2031</span><span class="p">,</span> <span class="mf">2.6851</span><span class="p">]))]</span>
</pre></div>


<h3 id="_5">创建模型</h3>
<p>完成预处理，开始构建线性回归模型</p>
<p>把数据集分为训练集和测试集，训练集用来训练模型，测试集用来评估模型的正确性</p>
<p>DataFrame 的 randomSplit() 函数可以很容易的随机分割数据，这里我们将 80% 的数据用于训练，剩下 20% 作为测试集</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]</span><span class="o">:</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">.8</span><span class="p">,</span> <span class="mf">.2</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>                                                                                                 
<span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]</span><span class="o">:</span> <span class="n">train_data</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                                                                                                                                <span class="o">+-------+--------------------+--------------------+</span>                             
<span class="o">|</span>  <span class="n">label</span><span class="o">|</span>            <span class="n">features</span><span class="o">|</span>     <span class="n">features_scaled</span><span class="o">|</span>
<span class="o">+-------+--------------------+--------------------+</span>
<span class="o">|</span><span class="mf">0.14999</span><span class="o">|</span><span class="p">[</span><span class="mf">73.0</span><span class="p">,</span><span class="mf">85.0</span><span class="p">,</span><span class="mf">38.0</span><span class="p">,</span><span class="mf">1.</span><span class="p">..</span><span class="o">|</span><span class="p">[</span><span class="mf">0.17329463000311</span><span class="p">...</span><span class="o">|</span>
<span class="o">|</span>  <span class="mf">0.225</span><span class="o">|</span><span class="p">[</span><span class="mf">73.0</span><span class="p">,</span><span class="mf">216.0</span><span class="p">,</span><span class="mf">63.0</span><span class="p">,...</span><span class="o">|</span><span class="p">[</span><span class="mf">0.17329463000311</span><span class="p">...</span><span class="o">|</span>
<span class="o">+-------+--------------------+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">2</span> <span class="n">rows</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">:</span> <span class="n">df</span><span class="p">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">train_data</span><span class="p">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">test_data</span><span class="p">.</span><span class="n">count</span><span class="p">()</span>                                                                                                                 <span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">:</span> <span class="p">(</span><span class="mi">20640</span><span class="p">,</span> <span class="mi">16490</span><span class="p">,</span> <span class="mi">4150</span><span class="p">)</span>  
</pre></div>


<p>用 Spark ML 提供的 LinearRegression 功能，我们可以很容易得构建一个线性回归模型</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">pyspark</span><span class="p">.</span><span class="n">ml</span><span class="p">.</span><span class="n">regression</span> <span class="n">import</span> <span class="n">LinearRegression</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">featuresCol</span><span class="o">=</span><span class="err">&#39;</span><span class="n">features_scaled</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s">&quot;label&quot;</span><span class="p">,</span>
                      <span class="n">maxIter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">elasticNetParam</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">linearModel</span> <span class="o">=</span> <span class="n">lr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>


<h3 id="_6">模型评估</h3>
<p>用 linearModel 的 transform() 函数来预测测试集中的房价，并与真实情况进行对比</p>
<p>用 RDD 的 zip() 函数把预测值和真实值放在一起，这样可以方便地进行比较。比如让我们看一下前两个对比结果</p>
<div class="hlcode"><pre><span class="n">predicted</span> <span class="o">=</span> <span class="n">linearModel</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="err">&#39;</span><span class="n">prediction</span><span class="err">&#39;</span><span class="p">).</span><span class="n">rdd</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="err">&#39;</span><span class="n">label</span><span class="err">&#39;</span><span class="p">).</span><span class="n">rdd</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">predictionAndLabel</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">:</span> <span class="n">predicted</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                                                                                                                                                 <span class="o">+-------+--------------------+--------------------+------------------+</span>          
<span class="o">|</span>  <span class="n">label</span><span class="o">|</span>            <span class="n">features</span><span class="o">|</span>     <span class="n">features_scaled</span><span class="o">|</span>        <span class="n">prediction</span><span class="o">|</span>
<span class="o">+-------+--------------------+--------------------+------------------+</span>
<span class="o">|</span><span class="mf">0.14999</span><span class="o">|</span><span class="p">[</span><span class="mf">239.0</span><span class="p">,</span><span class="mf">490.0</span><span class="p">,</span><span class="mf">164.</span><span class="p">...</span><span class="o">|</span><span class="p">[</span><span class="mf">0.56736187083210</span><span class="p">...</span><span class="o">|</span><span class="mf">1.5774952857305953</span><span class="o">|</span>
<span class="o">|</span><span class="mf">0.14999</span><span class="o">|</span><span class="p">[</span><span class="mf">267.0</span><span class="p">,</span><span class="mf">628.0</span><span class="p">,</span><span class="mf">225.</span><span class="p">...</span><span class="o">|</span><span class="p">[</span><span class="mf">0.63383104398397</span><span class="p">...</span><span class="o">|</span>  <span class="mf">2.16066705987466</span><span class="o">|</span>
<span class="o">|</span>  <span class="mf">0.175</span><span class="o">|</span><span class="p">[</span><span class="mf">168.0</span><span class="p">,</span><span class="mf">259.0</span><span class="p">,</span><span class="mf">138.</span><span class="p">...</span><span class="o">|</span><span class="p">[</span><span class="mf">0.39881503891126</span><span class="p">...</span><span class="o">|</span><span class="mf">1.6517987034312944</span><span class="o">|</span>
<span class="o">|</span>    <span class="mf">0.3</span><span class="o">|</span><span class="p">[</span><span class="mf">183.0</span><span class="p">,</span><span class="mf">500.0</span><span class="p">,</span><span class="mf">177.</span><span class="p">...</span><span class="o">|</span><span class="p">[</span><span class="mf">0.43442352452834</span><span class="p">...</span><span class="o">|</span><span class="mf">1.7276344592008637</span><span class="o">|</span>
<span class="o">|</span>  <span class="mf">0.325</span><span class="o">|</span><span class="p">[</span><span class="mf">49.0</span><span class="p">,</span><span class="mf">51.0</span><span class="p">,</span><span class="mf">20.0</span><span class="p">,</span><span class="mf">4.</span><span class="p">..</span><span class="o">|</span><span class="p">[</span><span class="mf">0.11632105301578</span><span class="p">...</span><span class="o">|</span><span class="mf">2.1126359101532257</span><span class="o">|</span>
<span class="o">+-------+--------------------+--------------------+------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>


<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]</span><span class="o">:</span> <span class="n">predictionAndLabel</span><span class="p">[</span><span class="mi">900</span><span class="o">:</span> <span class="mi">905</span><span class="p">]</span>                                                                                                                                      <span class="n">Out</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span><span class="o">:</span> 
<span class="p">[(</span><span class="mf">1.4103335361084612</span><span class="p">,</span> <span class="mf">1.625</span><span class="p">),</span>
 <span class="p">(</span><span class="mf">1.3338291551275154</span><span class="p">,</span> <span class="mf">1.625</span><span class="p">),</span>
 <span class="p">(</span><span class="mf">2.0351285249310935</span><span class="p">,</span> <span class="mf">1.627</span><span class="p">),</span>
 <span class="p">(</span><span class="mf">2.119015947064881</span><span class="p">,</span> <span class="mf">1.628</span><span class="p">),</span>
 <span class="p">(</span><span class="mf">1.5197966364548035</span><span class="p">,</span> <span class="mf">1.631</span><span class="p">)]</span>
</pre></div>


<p>我们的模型预测的结果有些偏小，这可能有多个因素造成。最直接的原因就是房价与我们挑选的列并没有强线性关系，而且我们使用的参数也可能不够准确</p>
<h2 id="streaming-job">Streaming Job</h2>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>