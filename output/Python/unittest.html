<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>unittest - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python">Python</a>&nbsp;&#187;&nbsp;unittest
    <span class="updated">Page Updated&nbsp;
      2019-09-24 08:43
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">unittest</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">软件测试</a><ul>
<li><a href="#_2">好的测试</a></li>
</ul>
</li>
<li><a href="#_3">单元测试</a><ul>
<li><a href="#_4">流程</a></li>
<li><a href="#_5">实践注意点</a></li>
</ul>
</li>
<li><a href="#_6">结构</a><ul>
<li><a href="#testcase">TestCase 测试用例</a><ul>
<li><a href="#setup">setUp</a></li>
<li><a href="#setupclass">setUpClass</a></li>
<li><a href="#teardown">tearDown</a></li>
<li><a href="#teardownclass">tearDownClass</a></li>
</ul>
</li>
<li><a href="#testsuite">TestSuite 测试套件</a></li>
</ul>
</li>
<li><a href="#hello-world">Hello World</a><ul>
<li><a href="#patching-itself">patching itself</a></li>
</ul>
</li>
<li><a href="#_7">分类及特点</a><ul>
<li><a href="#_8">集成测试</a></li>
</ul>
</li>
<li><a href="#_9">控制执行</a><ul>
<li><a href="#skip">跳过 skip</a></li>
<li><a href="#expectedfailure">执行失败 expectedFailure</a></li>
</ul>
</li>
<li><a href="#mockpatch">mock.patch 补丁</a><ul>
<li><a href="#looking-up">looking up</a></li>
<li><a href="#mockpatchobject">mock.patch.object</a></li>
<li><a href="#mockpatchdict">mock.patch.dict</a></li>
</ul>
</li>
<li><a href="#mock">mock</a><ul>
<li><a href="#magicmock">MagicMock</a></li>
<li><a href="#mock-side-effect">Mock Side Effect</a><ul>
<li><a href="#multiple-calls">Multiple calls</a></li>
<li><a href="#return_value">return_value</a></li>
<li><a href="#raising-exceptions">Raising exceptions</a></li>
<li><a href="#dynamic-results">Dynamic results</a></li>
<li><a href="#tracking-calls">Tracking calls</a></li>
<li><a href="#resetting-calls">Resetting calls</a></li>
</ul>
</li>
<li><a href="#mockpropertymock">mock.PropertyMock</a></li>
<li><a href="#mockmock_open">mock.mock_open</a></li>
</ul>
</li>
<li><a href="#assertion-methods">Assertion Methods 断言方法</a><ul>
<li><a href="#asserttruex-msgnone">assertTrue(x, msg=None)</a></li>
<li><a href="#assertfalsex-msgnone">assertFalse(x, msg=None)</a></li>
<li><a href="#assertisnonex-msgnone">assertIsNone(x, msg=None)</a></li>
<li><a href="#assertisnotnonex-msgnone">assertIsNotNone(x, msg=None)</a></li>
<li><a href="#assertequala-b-msgnone">assertEqual(a, b, msg=None)</a></li>
<li><a href="#assertnotequala-b-msgnone">assertNotEqual(a, b, msg=None)</a></li>
<li><a href="#assertisa-b-msgnone">assertIs(a, b, msg=None)</a></li>
<li><a href="#assertisnota-b-msgnone">assertIsNot(a, b, msg=None)</a></li>
<li><a href="#assertina-b-msgnone">assertIn(a, b, msg=None)</a></li>
<li><a href="#assertnotina-b-msgnone">assertNotIn(a, b, msg=None)</a></li>
<li><a href="#assertisinstancea-b-msgnone">assertIsInstance(a, b, msg=None)</a></li>
<li><a href="#assertnotisinstancea-b-msgnone">assertNotIsInstance(a, b, msg=None)</a></li>
<li><a href="#assertalmostequala-b-places7-msgnone-deltanone">assertAlmostEqual(a, b, places=7, msg=None, delta=None)</a></li>
<li><a href="#assertnotalmostequala-b-places7-msgnone-deltanone">assertNotAlmostEqual(a, b, places=7, msg=None, delta=None)</a></li>
<li><a href="#assertgreatera-b-msgnone">assertGreater(a, b, msg=None)</a></li>
<li><a href="#assertgreaterequala-b-msgnone">assertGreaterEqual(a, b, msg=None)</a></li>
<li><a href="#assertlessa-b-msgnone">assertLess(a, b, msg=None)</a></li>
<li><a href="#assertlessequala-b-msgnone">assertLessEqual(a, b, msg=None)</a></li>
<li><a href="#assertitemsequala-b-msgnone">assertItemsEqual(a, b, msg=None)</a></li>
<li><a href="#assertregextext-regexp-msgnone">assertRegex(text, regexp, msg=None)</a></li>
<li><a href="#assertnotregextext-regexp-msgnone">assertNotRegex(text, regexp, msg=None)</a></li>
<li><a href="#assertraisesexc-fun-args-kwds">assertRaises(exc, fun, args, *kwds)</a></li>
<li><a href="#assertraiseregexpexc-r-fun-args-kwds">assertRaiseRegexp(exc, r, fun, args, *kwds)</a></li>
<li><a href="#assertcountequala-b-msgnone">assertCountEqual(a, b, msg=None)</a></li>
<li><a href="#assertmultilineequala-b-msgnone">assertMultiLineEqual(a, b, msg=None)</a></li>
<li><a href="#assertsequenceequala-b-msgnone">assertSequenceEqual(a, b, msg=None)</a></li>
<li><a href="#assertlistequala-b-msgnone">assertListEqual(a, b, msg=None)</a></li>
<li><a href="#asserttupleequala-b-msgnone">assertTupleEqual(a, b, msg=None)</a></li>
<li><a href="#assertsetequala-b-msgnone">assertSetEqual(a, b, msg=None)</a></li>
<li><a href="#assertdictequala-b-msgnone">assertDictEqual(a, b, msg=None)</a></li>
<li><a href="#assertdictcontainssubseta-b">assertDictContainsSubset(a, b)</a></li>
</ul>
</li>
<li><a href="#mocking-patching-examples">mocking &amp; patching examples</a><ul>
<li><a href="#mocking-imported-function">mocking imported function</a></li>
<li><a href="#patch-object-of-class">Patch object of class</a></li>
<li><a href="#assert-patched-function-is-called">Assert patched function is called</a></li>
<li><a href="#assert-mocked-method-is-called-with-arguments">Assert mocked method is called with arguments</a></li>
<li><a href="#assert-patched-function-is-called-with-arguments">Assert patched function is called with arguments</a></li>
<li><a href="#mock-object-methods">Mock object methods</a></li>
<li><a href="#mock-object-attributes">Mock object attributes</a></li>
<li><a href="#mock-chained-method-calls">Mock chained method calls</a></li>
<li><a href="#patch-open-file">Patch open file</a></li>
<li><a href="#get-arguments-passed-to-mocked-method">Get arguments passed to mocked method</a></li>
</ul>
</li>
<li><a href="#_10">模块化</a></li>
</ul>
</div>
<h1 id="_1">软件测试</h1>
<p>等价类划分方法，是将所有可能的输入数据划分成若干个子集，在每个子集中，如果任意一个输入数据对于揭露程序中潜在错误都具有同等效果，那么这样的子集就构成了一个等价类。后续只要从每个等价类中任意选取一个值进行测试，就可以用少量具有代表性的测试输入取得较好的测试覆盖结果。</p>
<p>边界值分析方法，是选取输入、输出的边界值进行测试。因为通常大量的软件错误是发生在输入或输出范围的边界上，所以需要对边界值进行重点测试，通常选取正好等于、刚刚大于或刚刚小于边界的值作为测试数据。</p>
<h2 id="_2">好的测试</h2>
<p>一个“好的”测试用例，必须具备以下三个特征。</p>
<p>整体完备性： “好的”测试用例一定是一个完备的整体，是有效测试用例组成的集合，能够完全覆盖测试需求。</p>
<p>等价类划分的准确性： 指的是对于每个等价类都能保证只要其中一个输入测试通过，其他输入也一定测试通过。</p>
<p>等价类集合的完备性： 需要保证所有可能的边界值和边界条件都已经正确识别。</p>
<p><img alt="image-20200721083108310" src="unittest.assets/image-20200721083108310.png" /></p>
<h1 id="_3">单元测试</h1>
<p>单元测试，通俗易懂地讲，就是编写测试来验证某一个模块的功能正确性，一般会指定输入，验证输出是否<br />
符合预期</p>
<p>“预计输出” 绝对不是只有函数返回值这么简单，还应该包括函数执行完成后所改写的所有数据</p>
<p>具体来看有以下几大类</p>
<p>被测试函数的返回值；被测试函数的输出参数；被测试函数所改写的成员变量；被测试函数所改写的全局变量；被测试函数中进行的文件更新；被测试函数中进行的数据库更新；被测试函数中进行的消息队列更新；</p>
<h2 id="_4">流程</h2>
<p>并不是所有的代码都要进行单元测试，通常只有底层模块或者核心模块的测试中才会采用单元测试。</p>
<p>为了能够衡量单元测试的代码覆盖率，通常你还需要引入计算代码覆盖率的工具</p>
<p>最后你需要把单元测试执行、代码覆盖率统计和持续集成流水线做集成，以确保每次代码递交，都会自动触发单元测试，并在单元测试执行过程中自动统计代码覆盖率，最后以“单元测试通过率”和“代码覆盖率”为标准来决定本次代码递交是否能够被接受。</p>
<h2 id="_5">实践注意点</h2>
<p>单元测试本身并不复杂，但在实践中又经常需要十填许多坑，如：事务的传递可能导致单元测试结束后事务回滚失败（若用内存数据库又存在解决sql兼容性的烦恼），多线程执行单元测试导致测试结果不正确，对第三方接口做mock困难，实现逻辑中会周期性计划任务的功能也不好做单元测试。</p>
<p>涉及数据库的单元测试建议不要操作真实的数据库，而是使用dbmock。</p>
<h1 id="_6">结构</h1>
<p><img alt="image-20200722194905953" src="unittest.assets/image-20200722194905953.png" /></p>
<h2 id="testcase">TestCase 测试用例</h2>
<p>TestCase是创建不同的测试用例的父类</p>
<h3 id="setup">setUp</h3>
<p>单元测试顺利运行的预备方法。</p>
<p>每次执行测试用例之前调用。无参数，无返回值。该方法抛出的异常都视为error，而不是测试不通过。没有默认的实现</p>
<p><strong>每个测试case运行前</strong>运行</p>
<h3 id="setupclass">setUpClass</h3>
<p>setUpClass():必须使用@classmethod 装饰器,<strong>所有case运行前只运行一次</strong></p>
<h3 id="teardown">tearDown</h3>
<p>单元测试顺利运行的预备方法。</p>
<p>每次执行测试用例之后调用。无参数，无返回值。测试方法抛出异常，该方法也正常调用，该方法抛出的异常都视为error，而不是测试不通过。只要setUp()调用成功，该方法才会被调用。没有默认的实现。通过setup 和 tesrDown组装一个module成为一个固定的测试装置。</p>
<p><strong>每个测试case运行完后</strong>执行</p>
<h3 id="teardownclass">tearDownClass</h3>
<p>tearDownClass():必须使用@classmethod装饰器,<strong>所有case运行完后只运行一次</strong></p>
<h2 id="testsuite">TestSuite 测试套件</h2>
<p>测试套件也可以表示其他测试套件的集合。unittest.TestSuite 为创建测试套件提供了一个父类。TestSuite没有定义任何的单元测试，它只将单元测试或其他测试套件聚集起来。</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">unittest</span>

<span class="n">class</span> <span class="n">MyUnitTestA</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">test_a2</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_a2</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">test_a1</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_a1</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">will_not_be_called_by_default</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">This</span> <span class="n">method</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="n">called</span> <span class="n">by</span> <span class="k">default</span><span class="err">&#39;</span><span class="p">)</span>


<span class="n">class</span> <span class="n">MyUnitTestB</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">test_b2</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_b2</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">test_b1</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_b1</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">not_be_called_by_default</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">This</span> <span class="n">method</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="n">called</span> <span class="n">by</span> <span class="k">default</span><span class="err">&#39;</span><span class="p">)</span>


<span class="n">def</span> <span class="n">suite</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;Inside suite()&quot;</span><span class="p">)</span>

    <span class="n">suite_a</span> <span class="o">=</span> <span class="n">unittest</span><span class="p">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="n">MyUnitTestA</span><span class="p">)</span>

    <span class="n">suite_b</span> <span class="o">=</span> <span class="n">unittest</span><span class="p">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="n">MyUnitTestB</span><span class="p">)</span>

    <span class="n">suite_b</span><span class="p">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">MyUnitTestB</span><span class="p">(</span><span class="s">&quot;not_be_called_by_default&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">unittest</span><span class="p">.</span><span class="n">TestSuite</span><span class="p">((</span><span class="n">suite_a</span><span class="p">,</span> <span class="n">suite_b</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="o">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">defaultTest</span><span class="o">=</span><span class="err">&#39;</span><span class="n">suite</span><span class="err">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Inside</span> <span class="n">suite</span><span class="p">()</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">test_a1</span>
<span class="p">.</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_a2</span>
<span class="p">.</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_b1</span>
<span class="p">.</span><span class="n">This</span> <span class="n">is</span> <span class="n">test_b2</span>
<span class="p">.</span><span class="n">This</span> <span class="n">method</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="n">called</span> <span class="n">by</span> <span class="k">default</span>
<span class="p">.</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">5</span> <span class="n">tests</span> <span class="n">in</span> <span class="mf">0.000</span><span class="n">s</span>

<span class="n">OK</span>
</pre></div>


<h1 id="hello-world">Hello World</h1>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">unittest</span>
<span class="cp"># 将要被测试的排序函数 </span>
  <span class="n">def</span> <span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">:</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">:</span>
          <span class="k">for</span> <span class="n">j</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">:</span>
              <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">:</span>
                  <span class="n">tmp</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                  <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

<span class="cp"># 编写子类继承unittest.TestCase </span>
<span class="n">class</span> <span class="n">TestSort</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>  <span class="err">#</span> <span class="err">以</span><span class="n">test</span><span class="err">开头的函数将会被测试</span><span class="p">,</span> <span class="err">即只有</span><span class="n">test</span><span class="err">开头才会被测试</span>
        <span class="n">def</span> <span class="n">test_sort</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
                <span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
                <span class="err">#</span> <span class="n">assert</span> <span class="err">结果跟我们期待的一样</span> 
                <span class="n">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
        <span class="err">##</span> <span class="err">如果在</span><span class="n">Jupyter</span><span class="err">下，请用如下方式运行单元测试</span> 
        <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">first</span><span class="o">-</span><span class="n">arg</span><span class="o">-</span><span class="n">is</span><span class="o">-</span><span class="n">ignored</span><span class="err">&#39;</span><span class="p">],</span> <span class="n">exit</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>
<span class="cp"># 如果是命令行下运行，则: </span>
        <span class="err">##</span> <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Ran</span> <span class="mi">2</span> <span class="n">tests</span> <span class="n">in</span> <span class="mf">0.002</span><span class="n">s</span>
<span class="n">OK</span>
</pre></div>


<div class="hlcode"><pre><span class="n">import</span> <span class="n">unittest</span>

<span class="n">class</span> <span class="n">MyTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>  <span class="err">#</span> <span class="err">继承</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span>

    <span class="err">@</span><span class="n">classmethod</span>
    <span class="n">def</span> <span class="n">setUpClass</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="err">必须使用</span> <span class="err">@</span><span class="n">classmethod</span> <span class="err">装饰器</span><span class="p">,</span><span class="err">所有</span><span class="n">test</span><span class="err">运行前运行一次</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;这是所有</span><span class="n">case</span><span class="err">的前置条件&#39;</span><span class="p">)</span>

    <span class="err">@</span><span class="n">classmethod</span>
    <span class="n">def</span> <span class="n">tearDownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="err">必须使用</span> <span class="err">@</span><span class="n">classmethod</span> <span class="err">装饰器</span><span class="p">,</span> <span class="err">所有</span><span class="n">test</span><span class="err">运行完后运行一次</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;这是所有</span><span class="n">case</span><span class="err">的后置条件&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="err">每个测试用例执行之前的操作</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;这是每条</span><span class="n">case</span><span class="err">的前置条件&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">tearDown</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="err">每个用例执行之后的操作</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;这是每条</span><span class="n">case</span><span class="err">的后置条件&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">test_Third</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>  <span class="err">#</span> <span class="err">测试用例的命名必须以</span><span class="n">test</span><span class="err">开头，否则不予执行</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="mo">03</span><span class="o">:</span> <span class="err">第三条</span><span class="k">case</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">test_First</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="mo">01</span><span class="o">:</span> <span class="err">第一条</span><span class="k">case</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="err">@</span><span class="n">unittest</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="err">&#39;不执行这条</span><span class="k">case</span><span class="err">&#39;</span><span class="p">)</span>  <span class="err">#</span> <span class="err">跳过这条</span><span class="k">case</span>
    <span class="n">def</span> <span class="n">test_Second</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="mo">02</span><span class="o">:</span> <span class="err">第二条</span><span class="k">case</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">test_Fourth</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="mo">04</span><span class="o">:</span> <span class="err">第四条</span><span class="k">case</span><span class="err">&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span> <span class="err">#</span> <span class="err">使用</span><span class="n">main</span><span class="p">()</span><span class="err">直接运行时，将按</span><span class="n">case</span><span class="err">的名称顺序执行</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="p">.</span><span class="n">TestSuite</span><span class="p">()</span>
    <span class="n">suite</span><span class="p">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">MyTestCase</span><span class="p">(</span><span class="s">&quot;test_Third&quot;</span><span class="p">))</span>  <span class="err">#</span> <span class="err">将需要执行的</span><span class="n">case</span><span class="err">添加到</span><span class="n">Test</span> <span class="n">Suite</span><span class="err">中，没有添加的不会被执行</span>
    <span class="n">suite</span><span class="p">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">MyTestCase</span><span class="p">(</span><span class="s">&quot;test_Second&quot;</span><span class="p">))</span>
    <span class="n">suite</span><span class="p">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">MyTestCase</span><span class="p">(</span><span class="s">&quot;test_First&quot;</span><span class="p">))</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="p">.</span><span class="n">TextTestRunner</span><span class="p">()</span>
    <span class="n">runner</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>  <span class="err">#</span> <span class="err">将根据</span><span class="n">case</span><span class="err">添加的先后顺序执行</span>
</pre></div>


<h2 id="patching-itself">patching itself</h2>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">import</span> <span class="n">unittest</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">class</span> <span class="n">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">exists_patcher</span> <span class="o">=</span> <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">MyClass</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">file_exists</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">mock_exists</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">exists_patcher</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">mock_exists</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">False</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">tearDown</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">exists_patcher</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">test_process_file</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">my_obj</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="p">...</span>         <span class="n">my_obj</span><span class="p">.</span><span class="n">process_file</span><span class="p">(</span><span class="err">&#39;</span><span class="n">my_file</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>         <span class="n">my_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="err">&#39;</span><span class="n">my_file</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">MyTest</span><span class="p">(</span><span class="err">&#39;</span><span class="n">test_process_file</span><span class="err">&#39;</span><span class="p">).</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">class</span> <span class="n">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">exists_patcher</span> <span class="o">=</span> <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">MyClass</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">file_exists</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">process_file_patcher</span> <span class="o">=</span> <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">MyClass</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">process_file</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">mock_exists</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">exists_patcher</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">mock_process_file</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">process_file_patcher</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">tearDown</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">stopall</span><span class="p">()</span>
</pre></div>


<h1 id="_7">分类及特点</h1>
<p>小型测试，针对单个函数的测试，关注其内部逻辑，mock所有需要的服务。小型测试带来优秀的代码质量、良好的异常处理、优雅的错误报告</p>
<p>中型测试，验证两个或多个制定的模块应用之间的交互</p>
<p>大型测试，也被称为“系统测试”或“端到端测试”。大型测试在一个较高层次上运行，验证系统作为一个整体是如何工作的</p>
<h2 id="_8">集成测试</h2>
<p>集成测试则要把好几个单元组装到一起才能测试，测试通过的前提条件是，所有这些单元都写好了，这个周期就明显比单元测试要长；系统测试则要把整个系统的各个模块都连在一起，各种数据都准备好，才可能通过。</p>
<h1 id="_9">控制执行</h1>
<h2 id="skip">跳过 skip</h2>
<div class="hlcode"><pre>    <span class="err">@</span><span class="n">unittest</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="s">&quot;Skip test_1&quot;</span><span class="p">)</span>
    <span class="n">def</span> <span class="n">test_1</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">In</span> <span class="n">the</span> <span class="n">test_1</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>


<h2 id="expectedfailure">执行失败 expectedFailure</h2>
<p>期望一些测试用例执行失败。例如，测试可能由于开发环境与生产环境的差异而失败，或者是由于预期的数据库内容的存在或不存在而导致失败</p>
<div class="hlcode"><pre>    <span class="err">@</span><span class="n">unittest</span><span class="p">.</span><span class="n">expectedFailure</span>
    <span class="n">def</span> <span class="n">test_2</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">In</span> <span class="n">the</span> <span class="n">test_2</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>


<h1 id="mockpatch">mock.patch 补丁</h1>
<p>patch给开发者提供了非常便利的函数mock方法。它可以应用Python的decoration模式或是context manager概念，快速自然地mock所需的函数</p>
<p>补丁可以使用不同的方式来调用，即patch、patch.object、patch.dict以及patch.multiple等4种方式</p>
<p>patch装饰器函数将target作为一个必需的参数，后面是可选参数的长列表。这里只有（new）一个是可选参数。其他可选参数信息可以参照unittest文档</p>
<div class="hlcode"><pre><span class="n">patch</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>在前面的函数中，参数target是你想打补丁的目标。它可以是任何函数、类方法或者对象。</p>
<p>target是被导入的，应该由字符串表示，类似于典型的导入语句（但是没有import关键字）</p>
</blockquote>
<div class="hlcode"><pre>    <span class="n">def</span> <span class="n">test_compute_with_patch</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">with</span> <span class="n">unittest</span><span class="p">.</span><span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="n">__main__</span><span class="p">.</span><span class="n">MyClassA</span><span class="p">.</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span><span class="o">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">MyClassA</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">from</span> <span class="n">unittest</span><span class="p">.</span><span class="n">mock</span> <span class="n">import</span> <span class="n">patch</span>

<span class="err">@</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="n">sort</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">test_sort</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mock_sort</span><span class="p">)</span><span class="o">:</span>
    <span class="p">...</span>
<span class="n">with</span> <span class="n">patch</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">__init__</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="n">None</span><span class="p">)</span><span class="o">:</span>
    <span class="p">...</span>
</pre></div>


<blockquote>
<p>在with语句里面，我们通过patch，将A类的构造函数mock为一个do nothing的函数，这样就可以很方便地避免一些复杂的初始化(initialization)</p>
</blockquote>
<p>另一种patch的常见用法，是mock类的成员函数，这个技巧我们在工作中也经常会用到，比如说一个类的构 造函数非常复杂，而测试其中一个成员函数并不依赖所有初始化的object</p>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="err">@</span><span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="n">__main__</span><span class="p">.</span><span class="n">MyClass</span><span class="p">.</span><span class="n">file_exists</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span> <span class="n">def</span> <span class="n">test_process_file</span><span class="p">(</span><span class="n">mock_exists</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">mock_exists</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">False</span>
<span class="p">...</span>     <span class="n">my_obj</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="p">...</span>     <span class="n">my_obj</span><span class="p">.</span><span class="n">process_file</span><span class="p">(</span><span class="err">&#39;</span><span class="n">my_file</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">my_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="err">&#39;</span><span class="n">my_file</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">test_process_file</span><span class="p">()</span>
</pre></div>


<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">from</span> <span class="n">StringIO</span> <span class="n">import</span> <span class="n">StringIO</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">foo</span><span class="p">()</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">print</span> <span class="err">&#39;</span><span class="n">Something</span><span class="err">&#39;</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">with</span> <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">StringIO</span><span class="p">)</span> <span class="n">as</span> <span class="n">mock_stdout</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">foo</span><span class="p">()</span>
<span class="p">...</span>     <span class="n">assert</span> <span class="n">mock_stdout</span><span class="p">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">Something</span><span class="err">\\</span><span class="n">n</span><span class="err">&#39;</span>
</pre></div>


<h2 id="looking-up">looking up</h2>
<div class="hlcode"><pre><span class="c"># a.py</span>
<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c"># b.py</span>
<span class="kn">from</span> <span class="nn">a</span> <span class="kn">import</span> <span class="n">MyClass</span>

<span class="k">def</span> <span class="nf">my_func</span><span class="p">():</span>
    <span class="n">my_obj</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>


<span class="c"># test_b.py</span>
<span class="kn">import</span> <span class="nn">b</span>

<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&#39;MyClass&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="n">mock_my_class</span><span class="p">):</span>
    <span class="n">b</span><span class="o">.</span><span class="n">my_func</span><span class="p">()</span>
</pre></div>


<div class="hlcode"><pre><span class="c"># b.py</span>
<span class="kn">import</span> <span class="nn">a</span>

<span class="k">def</span> <span class="nf">my_func</span><span class="p">():</span>
    <span class="n">my_obj</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">MyClass</span><span class="p">()</span>


<span class="c"># test_b.py</span>
<span class="kn">import</span> <span class="nn">b</span>

<span class="nd">@mock.patch</span><span class="p">(</span><span class="s">&#39;a.MyClass&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="n">mock_my_class</span><span class="p">):</span>
    <span class="n">b</span><span class="o">.</span><span class="n">my_func</span><span class="p">()</span>
</pre></div>


<h2 id="mockpatchobject">mock.patch.object</h2>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="err">@</span><span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">MyClass</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">file_exists</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span> <span class="n">def</span> <span class="n">test_process_file</span><span class="p">(</span><span class="n">mock_exists</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>
</pre></div>


<h2 id="mockpatchdict">mock.patch.dict</h2>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">import</span> <span class="n">os</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">with</span> <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">dict</span><span class="p">(</span><span class="err">&#39;</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">new_key</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">new_value</span><span class="err">&#39;</span><span class="p">})</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">print</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="err">&#39;</span><span class="n">new_key</span><span class="err">&#39;</span><span class="p">]</span>
<span class="p">...</span>
<span class="n">new_value</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">assert</span> <span class="err">&#39;</span><span class="n">new_key</span><span class="err">&#39;</span> <span class="n">not</span> <span class="n">in</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span>
</pre></div>


<h1 id="mock">mock</h1>
<p>mock是单元测试中最核心重要的一环。mock的意思，便是通过一个虚假对象，来代替被测试函数或模块需要的对象。 </p>
<p>Mock库提供了一种灵活的方法来创建空对象，这些对象可以用来替换正在测试的程序中的某些部分。</p>
<p>举个例子，比如你要测一个后端API逻辑的功能性，但一般后端API都依赖于数据库、文件系统、网络等。这 样，你就需要通过mock，来创建一些虚假的数据库层、文件系统层、网络层对象，以便可以简单地对核心 后端逻辑单元进行测试。</p>
<p>Python mock则主要使用mock</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">unittest</span>
<span class="n">from</span> <span class="n">unittest</span><span class="p">.</span><span class="n">mock</span> <span class="n">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">call</span>


<span class="n">class</span> <span class="n">MyClassA</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">foo</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="mi">100</span>

    <span class="n">def</span> <span class="n">foo2</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">200</span>

    <span class="n">def</span> <span class="n">compute</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">foo</span><span class="p">()</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">foo2</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">x1</span> <span class="o">=</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Result</span><span class="o">:</span> <span class="err">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="n">class</span> <span class="n">TestA</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">test_compute</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">MyClassA</span><span class="p">()</span>

        <span class="n">mockObj</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">a</span><span class="p">.</span><span class="n">foo</span> <span class="o">=</span> <span class="n">mockObj</span><span class="p">.</span><span class="n">foo</span>
        <span class="n">a</span><span class="p">.</span><span class="n">foo2</span> <span class="o">=</span> <span class="n">mockObj</span><span class="p">.</span><span class="n">foo2</span>

        <span class="n">a</span><span class="p">.</span><span class="n">foo</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">a</span><span class="p">.</span><span class="n">foo2</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">300</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">mock</span> <span class="n">result</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

        <span class="n">test_call_list</span> <span class="o">=</span> <span class="n">mockObj</span><span class="p">.</span><span class="n">mock_calls</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">test_call_list</span> <span class="o">=</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">test_call_list</span><span class="p">)</span>

        <span class="n">reference_call_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="p">.</span><span class="n">foo</span><span class="p">(),</span> <span class="n">call</span><span class="p">.</span><span class="n">foo2</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">test_call_list</span><span class="p">,</span> <span class="n">reference_call_list</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="o">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">x1</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">300</span>
<span class="nl">Result:</span>  <span class="mi">400</span>
<span class="n">mock</span> <span class="n">result</span> <span class="mi">400</span>
<span class="n">test_call_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="p">.</span><span class="n">foo</span><span class="p">(),</span> <span class="n">call</span><span class="p">.</span><span class="n">foo2</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
<span class="p">.</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">in</span> <span class="mf">0.000</span><span class="n">s</span>

<span class="n">OK</span>
</pre></div>


<h2 id="magicmock">MagicMock</h2>
<p>MagicMock类是Mock类的一个子类。它本质上提供了你期望从Mock类中所能得到的一切功能。另外，它还为很多Python中的魔法方法提供默认的实现。</p>
<p>魔法方法是这样一种特殊的方法：其名称都以双下划线为前缀和后缀。一些魔法方法的例子包括<code>__init__</code>、<code>__iter__</code>、<code>__len__</code>等。</p>
<p>MagicMock对象</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">unittest</span>

<span class="n">from</span> <span class="n">unittest</span><span class="p">.</span><span class="n">mock</span> <span class="n">import</span> <span class="n">MagicMock</span>


<span class="n">class</span> <span class="n">A</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">m1</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">m2</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">m3</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">m2</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">pass</span>

    <span class="n">def</span> <span class="n">m3</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span><span class="o">:</span>
        <span class="n">pass</span>

    <span class="n">def</span> <span class="n">test_m1</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
        <span class="n">a</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="err">&#39;</span><span class="n">custom_val</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="p">.</span><span class="n">m3</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">a</span><span class="p">.</span><span class="n">m1</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">m2</span><span class="p">.</span><span class="n">called</span><span class="p">)</span>  <span class="err">#</span> <span class="err">验证</span><span class="n">m2</span><span class="err">被</span><span class="n">call</span><span class="err">过</span>
        <span class="n">a</span><span class="p">.</span><span class="n">m3</span><span class="p">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s">&quot;custom_val&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="err">验证</span><span class="n">m3</span><span class="err">被指定参数</span><span class="n">call</span><span class="err">过</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="o">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">first</span><span class="o">-</span><span class="n">arg</span><span class="o">-</span><span class="n">is</span><span class="o">-</span><span class="n">ignored</span><span class="err">&#39;</span><span class="p">],</span> <span class="n">exit</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Ran</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">in</span> <span class="mf">0.001</span><span class="n">s</span>

<span class="n">OK</span>
</pre></div>


<blockquote>
<p>我们需要对m1()进行单元测试，但是m1()取决于m2()和m3()。如果m2()和m3()的内部比较复杂, 你就不能只是简单地调用m1()函数来进行测试，可能需要解决很多依赖项的问题。</p>
<p>有了mock其实就很好办了。我们可以把m2()替换为一个返回具体数值的value，把m3()替换为另一个mock(空函数)。这样，测试m1()就很容易了，我们可以测试m1()调用m2()，并且用m2()的返回值调用m3()。</p>
</blockquote>
<h2 id="mock-side-effect">Mock Side Effect</h2>
<p>通过side_effect指定它的副作用，这个副作用就是当你调用这个mock对象是会调用的函数,也可以选择抛出一个异常，来对程序的错误状态进行测试。</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">unittest</span><span class="p">.</span><span class="n">mock</span> <span class="n">import</span> <span class="n">MagicMock</span>

<span class="n">def</span> <span class="n">side_effect</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="nl">else:</span>
        <span class="k">return</span> <span class="mi">2</span>

<span class="n">mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">mock</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">side_effect</span>

<span class="n">print</span><span class="p">(</span><span class="n">mock</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">print</span><span class="p">(</span><span class="n">mock</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="mi">1</span>
<span class="mi">2</span>
</pre></div>


<blockquote>
<p>测试的是输入参数是否为负数，输入小于0则输出为1 ，否则输出为2</p>
</blockquote>
<h3 id="multiple-calls">Multiple calls</h3>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">True</span><span class="p">,</span> <span class="n">False</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">False</span>
</pre></div>


<h3 id="return_value">return_value</h3>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">foo</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">val</span><span class="err">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">foo</span><span class="p">(</span><span class="err">&#39;</span><span class="n">bar</span><span class="err">&#39;</span><span class="p">)</span>
<span class="err">&#39;</span><span class="n">val</span><span class="err">&#39;</span>
</pre></div>


<h3 id="raising-exceptions">Raising exceptions</h3>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">open_file</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">IOError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">File</span> <span class="n">not</span> <span class="n">found</span><span class="err">&#39;</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">open_file</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>
<span class="nl">IOError:</span> <span class="n">File</span> <span class="n">not</span> <span class="n">found</span>
</pre></div>


<h3 id="dynamic-results">Dynamic results</h3>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">file1</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">True</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">file2</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">False</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">side_effect</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">side_effect</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file1</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file2</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">False</span>
</pre></div>


<h3 id="tracking-calls">Tracking calls</h3>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">called</span>
<span class="n">True</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">call_count</span>
<span class="mi">4</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">call_args</span>
<span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file2</span><span class="err">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file1</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file2</span><span class="err">&#39;</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">method_calls</span>
<span class="p">[]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file1</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file2</span><span class="err">&#39;</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">method_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">.</span><span class="n">foo</span><span class="p">(</span><span class="err">&#39;</span><span class="n">bar</span><span class="err">&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">.</span><span class="n">open_file</span><span class="p">(),</span>
 <span class="n">call</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file1</span><span class="err">&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">.</span><span class="n">file_exists</span><span class="p">(</span><span class="err">&#39;</span><span class="n">file2</span><span class="err">&#39;</span><span class="p">)]</span>
</pre></div>


<h3 id="resetting-calls">Resetting calls</h3>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">reset_mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">call_count</span>
<span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_obj</span><span class="p">.</span><span class="n">file_exists</span><span class="p">.</span><span class="n">call_args_list</span>
<span class="p">[]</span>
</pre></div>


<h2 id="mockpropertymock">mock.PropertyMock</h2>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">class</span> <span class="n">Storage</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
<span class="p">...</span>     <span class="err">@</span><span class="n">property</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">subfolder_dir</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">subfolder_base</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">get_file_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">subfolder_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">class</span> <span class="n">StorageTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="err">@</span><span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">Storage</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">subfolder_dir</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">...</span>                        <span class="n">new_callable</span><span class="o">=</span><span class="n">mock</span><span class="p">.</span><span class="n">PropertyMock</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">def</span> <span class="n">test_get_file_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mock_subfolder</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">mock_subfolder</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">base_dir</span><span class="o">/</span><span class="n">subfolder</span><span class="err">&#39;</span>
<span class="p">...</span>         <span class="n">storage</span> <span class="o">=</span> <span class="n">api</span><span class="p">.</span><span class="n">Storage</span><span class="p">(</span><span class="err">&#39;</span><span class="n">base_dir</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>         <span class="n">file_path</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">get_file_path</span><span class="p">(</span><span class="err">&#39;</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>         <span class="n">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">base_dir</span><span class="o">/</span><span class="n">subfolder</span><span class="o">/</span><span class="n">filename</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<h2 id="mockmock_open">mock.mock_open</h2>
<div class="hlcode"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">read</span><span class="p">()</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">path</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">f</span><span class="o">:</span>
<span class="p">...</span>         <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">def</span> <span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">path</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">f</span><span class="o">:</span>
<span class="p">...</span>         <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mock</span><span class="p">.</span><span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="err">&#39;</span><span class="n">some_data</span><span class="err">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">with</span> <span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="n">__builtin__</span><span class="p">.</span><span class="n">open</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span><span class="o">:</span>
<span class="p">...</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">read</span><span class="p">()</span>
<span class="p">...</span>     <span class="n">write</span><span class="p">(</span><span class="err">&#39;</span><span class="n">something</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">return_value</span>
<span class="o">&gt;&gt;&gt;</span> <span class="err">#</span> <span class="n">Read</span> <span class="n">checks</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">path</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">some_data</span><span class="err">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="err">#</span> <span class="n">Write</span> <span class="n">checks</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">path</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span>
</pre></div>


<h1 id="assertion-methods">Assertion Methods 断言方法</h1>
<h2 id="asserttruex-msgnone">assertTrue(x, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测bool(x) is True</span>
<span class="n">assertTrue</span><span class="p">(</span><span class="n">x</span> <span class="p">[,</span><span class="n">msg</span><span class="p">])</span>

<span class="cp"># 检测某个元素是否在页面上</span>
<span class="n">assertTrue</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">is_dispalyed</span><span class="p">())</span>
</pre></div>


<h2 id="assertfalsex-msgnone">assertFalse(x, msg=None)</h2>
<div class="hlcode"><pre><span class="kt">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">is</span> <span class="n">False</span>
</pre></div>


<h2 id="assertisnonex-msgnone">assertIsNone(x, msg=None)</h2>
<div class="hlcode"><pre><span class="n">x</span> <span class="n">is</span> <span class="n">None</span>
</pre></div>


<h2 id="assertisnotnonex-msgnone">assertIsNotNone(x, msg=None)</h2>
<div class="hlcode"><pre><span class="n">x</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span>
</pre></div>


<h2 id="assertequala-b-msgnone">assertEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测 a == b</span>
<span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="p">[,</span><span class="n">msg</span><span class="p">])</span><span class="o">:</span>

<span class="cp"># 常用语检测元素属性等</span>
<span class="n">assertEqual</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">&quot;10&quot;</span><span class="p">)</span>
</pre></div>


<h2 id="assertnotequala-b-msgnone">assertNotEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测 a! == b</span>
<span class="n">assertNotEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="p">[,</span><span class="n">msg</span><span class="p">])</span><span class="o">:</span>
</pre></div>


<h2 id="assertisa-b-msgnone">assertIs(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">a</span> <span class="n">is</span> <span class="n">b</span>
</pre></div>


<h2 id="assertisnota-b-msgnone">assertIsNot(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">a</span> <span class="n">is</span> <span class="n">not</span> <span class="n">b</span>
</pre></div>


<h2 id="assertina-b-msgnone">assertIn(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">a</span> <span class="n">in</span> <span class="n">b</span>
</pre></div>


<h2 id="assertnotina-b-msgnone">assertNotIn(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">a</span> <span class="n">not</span> <span class="n">in</span> <span class="n">b</span>
</pre></div>


<h2 id="assertisinstancea-b-msgnone">assertIsInstance(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>


<h2 id="assertnotisinstancea-b-msgnone">assertNotIsInstance(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">not</span> <span class="n">isinstnace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>


<h2 id="assertalmostequala-b-places7-msgnone-deltanone">assertAlmostEqual(a, b, places=7, msg=None, delta=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测round(a-b,7)==0</span>
<span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertnotalmostequala-b-places7-msgnone-deltanone">assertNotAlmostEqual(a, b, places=7, msg=None, delta=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测round(a-b,7)!=0</span>
<span class="n">assertNotAlmostEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertgreatera-b-msgnone">assertGreater(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测a &gt; b</span>
<span class="n">assertGreater</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertgreaterequala-b-msgnone">assertGreaterEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测a &gt;= b</span>
<span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">a</span> <span class="p">,</span><span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertlessa-b-msgnone">assertLess(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp">#检测 a &lt; b</span>
<span class="n">assertLess</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertlessequala-b-msgnone">assertLessEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测 a &lt;= b</span>
<span class="n">assertLessEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertitemsequala-b-msgnone">assertItemsEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="n">sorted</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">sorted</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>


<p>Works with unhashable objects</p>
<h2 id="assertregextext-regexp-msgnone">assertRegex(text, regexp, msg=None)</h2>
<div class="hlcode"><pre><span class="err">检测正则是否匹配给定的</span><span class="n">text</span>

<span class="cp"># 检测r.search(s)</span>
<span class="n">assertRegexpMatches</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> 

<span class="cp"># 检测not r.search(s)</span>
<span class="n">assertNotRegexpMatches</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> 
</pre></div>


<h2 id="assertnotregextext-regexp-msgnone">assertNotRegex(text, regexp, msg=None)</h2>
<h2 id="assertraisesexc-fun-args-kwds">assertRaises(exc, fun, <em>args, </em>*kwds)</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">unittest</span>
<span class="n">import</span> <span class="n">sys</span>


<span class="cp"># 除法函数</span>
<span class="n">def</span> <span class="n">div</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>

<span class="cp"># 测试用例</span>
<span class="n">class</span> <span class="n">demoRaiseTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">test_raise</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ZeroDivisionError</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="cp"># 主函数</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>


<h2 id="assertraiseregexpexc-r-fun-args-kwds">assertRaiseRegexp(exc, r, fun, <em>args, </em>*kwds)</h2>
<h2 id="assertcountequala-b-msgnone">assertCountEqual(a, b, msg=None)</h2>
<h2 id="assertmultilineequala-b-msgnone">assertMultiLineEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测string</span>
<span class="n">assertMultiLineEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="assertsequenceequala-b-msgnone">assertSequenceEqual(a, b, msg=None)</h2>
<h2 id="assertlistequala-b-msgnone">assertListEqual(a, b, msg=None)</h2>
<div class="hlcode"><pre><span class="cp"># 检测lists</span>
<span class="n">assertListEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</pre></div>


<h2 id="asserttupleequala-b-msgnone">assertTupleEqual(a, b, msg=None)</h2>
<h2 id="assertsetequala-b-msgnone">assertSetEqual(a, b, msg=None)</h2>
<h2 id="assertdictequala-b-msgnone">assertDictEqual(a, b, msg=None)</h2>
<h2 id="assertdictcontainssubseta-b">assertDictContainsSubset(a, b)</h2>
<p>All the key/value pairs in a exist in b </p>
<h1 id="mocking-patching-examples">mocking &amp; patching examples</h1>
<h2 id="mocking-imported-function">mocking imported function</h2>
<p>Application code (<strong>main.py</strong>)</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">myproject.helpers</span> <span class="kn">import</span> <span class="n">complex_function</span>

<span class="c"># function_a is coupled to the output of complex_function</span>
<span class="k">def</span> <span class="nf">function_a</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">complex_function</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>


<p>Test code for <code>function_a()</code></p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">myproject.main</span> <span class="kn">import</span> <span class="n">function_a</span>

<span class="k">def</span> <span class="nf">test_function_a</span><span class="p">():</span>
    <span class="c"># note that you must pass the name as it is imported on the application code</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">&quot;myproject.main.complex_function&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">complex_function_mock</span><span class="p">:</span>

        <span class="c"># we dont care what the return value of the dependency is</span>
        <span class="n">complex_function_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>

        <span class="c"># we just want our function to work</span>
        <span class="k">assert</span> <span class="n">function_a</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;FOO&quot;</span>
</pre></div>


<h2 id="patch-object-of-class">Patch object of class</h2>
<p>application code</p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">sayhi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;hi my name is: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c"># instantiates MyClass and calls a method on the object</span>
<span class="k">def</span> <span class="nf">function_b</span><span class="p">():</span>
    <span class="n">param1</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>

    <span class="c"># returns &quot;hi my name is: foo&quot;</span>
    <span class="k">return</span> <span class="n">param1</span><span class="o">.</span><span class="n">sayhi</span><span class="p">()</span>
</pre></div>


<p>test code</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="k">def</span> <span class="nf">test_function_b</span><span class="p">():</span>

    <span class="c"># mock an object of class </span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">MyClass</span><span class="p">,</span> <span class="s">&#39;sayhi&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s">&quot;hi i&#39;m a mock object&quot;</span><span class="p">):</span>

        <span class="c"># the MyClass object used within function_b will</span>
        <span class="c"># be replaced by a mock defined in the</span>
        <span class="c"># patch.object call above</span>
        <span class="k">assert</span> <span class="n">function_b</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;hi i&#39;m a mock object&quot;</span>
</pre></div>


<h2 id="assert-patched-function-is-called">Assert patched function is called</h2>
<p>Application code (<strong>main.py</strong>)</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">myproject.helpers</span> <span class="kn">import</span> <span class="n">complex_function</span>

<span class="k">def</span> <span class="nf">function_a</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">complex_function</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>


<p>Test code:</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">myproject.main</span> <span class="kn">import</span> <span class="n">function_a</span>

<span class="k">def</span> <span class="nf">test_called_patch</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">&quot;myproject.main.complex_function&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">patched_function</span><span class="p">:</span>
        <span class="n">function_a</span><span class="p">()</span>

    <span class="n">patched_function</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
</pre></div>


<h2 id="assert-mocked-method-is-called-with-arguments">Assert mocked method is called with arguments</h2>
<div class="hlcode"><pre><span class="nx">from</span> <span class="nx">unittest</span><span class="p">.</span><span class="nx">mock</span> <span class="kr">import</span> <span class="nx">Mock</span>


<span class="nx">def</span> <span class="nx">function_with_call</span><span class="p">(</span><span class="nx">some_obj</span><span class="p">,</span> <span class="nx">argument</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="nx">some_obj</span><span class="p">.</span><span class="nx">some_method</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span>


<span class="nx">def</span> <span class="nx">test_called</span><span class="p">()</span><span class="o">:</span>
    <span class="nx">mock</span> <span class="o">=</span> <span class="nx">Mock</span><span class="p">()</span>
    <span class="nx">mock</span><span class="p">.</span><span class="nx">some_method</span> <span class="o">=</span> <span class="nx">Mock</span><span class="p">(</span><span class="nx">return_value</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span>

    <span class="nx">function_with_call</span><span class="p">(</span><span class="nx">mock</span><span class="p">,</span> <span class="s2">&quot;foo bar&quot;</span><span class="p">)</span>

    <span class="err">#</span> <span class="nx">will</span> <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">method</span> <span class="nx">was</span> <span class="nx">called</span> <span class="nx">one</span> <span class="nx">or</span> <span class="nx">more</span> <span class="nx">times</span>
    <span class="nx">mock</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">assert_called_with</span><span class="p">(</span><span class="s2">&quot;foo bar&quot;</span><span class="p">)</span>
</pre></div>


<h2 id="assert-patched-function-is-called-with-arguments">Assert patched function is called with arguments</h2>
<p>application code (<strong>main.py</strong>)</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">myproject.helpers</span> <span class="kn">import</span> <span class="n">complex_function_with_params</span>

<span class="c"># this function takes both params, modifies them and send to </span>
<span class="c"># complex_function_with_params</span>
<span class="k">def</span> <span class="nf">function_e</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">complex_function_with_params</span><span class="p">(</span><span class="n">param1</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">param2</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</pre></div>


<p>test code</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">myproject.main</span> <span class="kn">import</span> <span class="n">function_e</span>

<span class="k">def</span> <span class="nf">test_called_with_patch</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">&quot;myproject.main.complex_function_with_params&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">patched_function</span><span class="p">:</span>
        <span class="c"># function_e converts the params to upper case and</span>
        <span class="c"># calls another function with those</span>
        <span class="n">function_e</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">)</span>

    <span class="n">patched_function</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s">&quot;FOO&quot;</span><span class="p">,</span> <span class="s">&quot;BAR&quot;</span><span class="p">)</span>
</pre></div>


<h2 id="mock-object-methods">Mock object methods</h2>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span>

<span class="c"># function_c takes a parameter and calls .sayhi() on it</span>
<span class="k">def</span> <span class="nf">function_c</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">sayhi</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_function_c</span><span class="p">():</span>

    <span class="n">mock_obj</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_obj</span><span class="o">.</span><span class="n">sayhi</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>

    <span class="c"># function_c takes as input a MyClass object, calls sayhi() on it</span>
    <span class="c"># and makes the result upper case</span>
    <span class="k">assert</span> <span class="n">function_c</span><span class="p">(</span><span class="n">mock_obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;FOO&quot;</span>
</pre></div>


<h2 id="mock-object-attributes">Mock object attributes</h2>
<p>application code</p>
<div class="hlcode"><pre><span class="c"># function_d takes a parameter and uses its .name attribute</span>
<span class="k">def</span> <span class="nf">function_d</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span>

    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>


<p>test code</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span>

<span class="k">def</span> <span class="nf">test_function_d</span><span class="p">():</span>

    <span class="n">mock_obj</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>

    <span class="k">assert</span> <span class="n">function_d</span><span class="p">(</span><span class="n">mock_obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;FOO&quot;</span>
</pre></div>


<h2 id="mock-chained-method-calls">Mock chained method calls</h2>
<div class="hlcode"><pre><span class="nx">from</span> <span class="nx">unittest</span><span class="p">.</span><span class="nx">mock</span> <span class="kr">import</span> <span class="nx">Mock</span>

<span class="err">#</span> <span class="k">this</span> <span class="kd">function</span> <span class="nx">calls</span> <span class="nx">a</span> <span class="nx">chain</span> <span class="nx">of</span> <span class="nx">methods</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">given</span> <span class="nx">object</span>
<span class="nx">def</span> <span class="nx">my_function</span><span class="p">(</span><span class="nx">some_object</span><span class="p">)</span><span class="o">:</span>

    <span class="nx">output</span> <span class="o">=</span> <span class="nx">some_object</span><span class="p">.</span><span class="nx">foo</span><span class="p">().</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span><span class="p">().</span><span class="nx">quux</span><span class="p">()</span>

    <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">upper</span><span class="p">()</span>


<span class="nx">def</span> <span class="nx">test_chained</span><span class="p">()</span><span class="o">:</span>
    <span class="nx">mock_obj</span> <span class="o">=</span> <span class="nx">Mock</span><span class="p">()</span>

    <span class="nx">result_1</span> <span class="o">=</span> <span class="nx">mock_obj</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">return_value</span>
    <span class="nx">result_2</span> <span class="o">=</span> <span class="nx">result_1</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span><span class="p">.</span><span class="nx">return_value</span>
    <span class="nx">result_2</span><span class="p">.</span><span class="nx">quux</span><span class="p">.</span><span class="nx">return_value</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span>

    <span class="nx">assert</span> <span class="nx">my_function</span><span class="p">(</span><span class="nx">mock_obj</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;HELLO WORLD&quot;</span>
</pre></div>


<h2 id="patch-open-file">Patch open file</h2>
<p>application code (<strong>main.py</strong>)</p>
<div class="hlcode"><pre><span class="c"># reads a file and converts the contents to upper case</span>
<span class="k">def</span> <span class="nf">file_contents_to_uppercase</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">contents</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>


<p>test code</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">mock_open</span><span class="p">,</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">myproject.main</span> <span class="kn">import</span> <span class="n">file_contents_to_uppercase</span>

<span class="k">def</span> <span class="nf">test_file_contents_to_upper_case</span><span class="p">():</span>
    <span class="c"># pass the desired content as parameter</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s">&quot;foo bar&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">&#39;myproject.main.open&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="c"># it does not matter what file path you pass,</span>
        <span class="c"># the file contents are mocked</span>
        <span class="k">assert</span> <span class="n">file_contents_to_uppercase</span><span class="p">(</span><span class="s">&quot;path/to/file&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;FOO BAR&quot;</span>
</pre></div>


<h2 id="get-arguments-passed-to-mocked-method">Get arguments passed to mocked method</h2>
<div class="hlcode"><pre><span class="nx">from</span> <span class="nx">unittest</span><span class="p">.</span><span class="nx">mock</span> <span class="kr">import</span> <span class="nx">Mock</span>

<span class="nx">def</span> <span class="nx">function_e</span><span class="p">(</span><span class="nx">some_obj</span><span class="p">,</span> <span class="nx">argument</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="nx">some_obj</span><span class="p">.</span><span class="nx">some_method</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span>

<span class="nx">def</span> <span class="nx">test_arguments</span><span class="p">()</span><span class="o">:</span>

    <span class="nx">mock</span> <span class="o">=</span> <span class="nx">Mock</span><span class="p">()</span> <span class="err">#</span> <span class="nx">mock</span> <span class="nx">object</span>
    <span class="nx">mock</span><span class="p">.</span><span class="nx">some_method</span> <span class="o">=</span> <span class="nx">Mock</span><span class="p">(</span><span class="nx">return_value</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span> <span class="err">#</span> <span class="nx">mock</span> <span class="nx">method</span>

    <span class="nx">function_e</span><span class="p">(</span><span class="nx">mock</span><span class="p">,</span> <span class="s2">&quot;foo bar&quot;</span><span class="p">)</span>

    <span class="nx">mock</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">assert_called</span><span class="p">()</span>

    <span class="err">#</span> <span class="nx">arguments</span> <span class="nx">passed</span> <span class="nx">to</span> <span class="nx">method</span> <span class="nx">some_method</span>
    <span class="nx">arguments_tuple</span> <span class="o">=</span> <span class="nx">mock</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">call_args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span>

    <span class="nx">assert</span> <span class="s2">&quot;foo bar&quot;</span> <span class="k">in</span> <span class="nx">arguments_tuple</span>
</pre></div>


<h1 id="_10">模块化</h1>
<p>高质量单元测试，不仅要求我们提高Test Coverage，尽量让所写的测试能够cover每个模块中的每条语句;<br />
还要求我们从测试的角度审视codebase，去思考怎么模块化代码，以便写出高质量的单元测试。</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">work</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">:</span>
      <span class="err">#</span> <span class="n">pre</span> <span class="n">process</span>
      <span class="p">...</span>
      <span class="p">...</span>
      <span class="err">#</span> <span class="n">sort</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">:</span>
          <span class="k">for</span> <span class="n">j</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span><span class="o">:</span>
              <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">:</span>
                  <span class="n">tmp</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                  <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
      <span class="err">#</span> <span class="n">post</span> <span class="n">process</span>
      <span class="p">...</span>
      <span class="p">...</span>
      <span class="n">Return</span> <span class="n">arr</span>
</pre></div>


<p>正确的测试方法，应该是先模块化代码，写成下面的形式</p>
<div class="hlcode"><pre>  <span class="n">def</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">:</span>
      <span class="p">...</span>
      <span class="p">...</span>
      <span class="k">return</span> <span class="n">arr</span>
  <span class="n">def</span> <span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">:</span>
      <span class="p">...</span>
      <span class="p">...</span>
      <span class="k">return</span> <span class="n">arr</span>
  <span class="n">def</span> <span class="n">postprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">:</span>
      <span class="p">...</span>
      <span class="k">return</span> <span class="n">arr</span>

  <span class="n">def</span> <span class="n">work</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="n">postprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">arr</span>
</pre></div>


<p>接着再进行相应的测试，测试三个子函数的功能正确性;然后通过mock子函数，调用work()函数，来验证<br />
三个子函数被call过</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">unittest</span><span class="p">.</span><span class="n">mock</span> <span class="n">import</span> <span class="n">patch</span>
  <span class="n">def</span> <span class="n">test_preprocess</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
      <span class="p">...</span>
  <span class="n">def</span> <span class="n">test_sort</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
      <span class="p">...</span>
  <span class="n">def</span> <span class="n">test_postprocess</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
      <span class="p">...</span>
  <span class="err">@</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="o">%</span><span class="n">s</span><span class="p">.</span><span class="n">preprocess</span><span class="err">&#39;</span><span class="p">)</span>
  <span class="err">@</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="o">%</span><span class="n">s</span><span class="p">.</span><span class="n">sort</span><span class="err">&#39;</span><span class="p">)</span>
  <span class="err">@</span><span class="n">patch</span><span class="p">(</span><span class="err">&#39;</span><span class="o">%</span><span class="n">s</span><span class="p">.</span><span class="n">postprocess</span><span class="err">&#39;</span><span class="p">)</span>
  <span class="n">def</span> <span class="n">test_work</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">mock_post_process</span><span class="p">,</span> <span class="n">mock_sort</span><span class="p">,</span> <span class="n">mock_preprocess</span><span class="p">)</span><span class="o">:</span>
      <span class="n">work</span><span class="p">()</span>
      <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_post_process</span><span class="p">.</span><span class="n">called</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_sort</span><span class="p">.</span><span class="n">called</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_preprocess</span><span class="p">.</span><span class="n">called</span><span class="p">)</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>