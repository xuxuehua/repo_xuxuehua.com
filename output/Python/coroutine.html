<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>coroutine 协程 - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python">Python</a>&nbsp;&#187;&nbsp;coroutine 协程
    <span class="updated">Page Updated&nbsp;
      2019-08-15 08:51
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">coroutine 协程</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#coroutine">coroutine 协程</a><ul>
<li><a href="#_1">优势</a></li>
<li><a href="#c10m">C10M问题</a></li>
<li><a href="#_2">同步</a></li>
<li><a href="#_3">异步</a></li>
<li><a href="#_4">阻塞</a></li>
<li><a href="#_5">非阻塞</a></li>
<li><a href="#async">async</a></li>
<li><a href="#await">await</a></li>
</ul>
</li>
<li><a href="#unixio">Unix下I/O 模型</a><ul>
<li><a href="#io">阻塞式I/O （常用）</a></li>
<li><a href="#io_1">非阻塞式I/O</a></li>
<li><a href="#io_2">I/O复用</a></li>
<li><a href="#io_3">信号驱动式I/O （使用少）</a></li>
<li><a href="#io_4">异步I/O</a></li>
<li><a href="#io_5">IO多路复用（实际常用）</a><ul>
<li><a href="#select">select</a></li>
<li><a href="#poll">poll</a></li>
<li><a href="#epoll-only-linux">epoll （only Linux)</a><ul>
<li><a href="#_6">回调模式（不常用）</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#asyncio-io">asyncio （异步IO并发）</a><ul>
<li><a href="#_7">特点</a></li>
<li><a href="#_8">局限性</a></li>
<li><a href="#_9">上下文切换</a></li>
<li><a href="#hello-world">hello world</a></li>
<li><a href="#event-loop">event loop</a></li>
<li><a href="#create_task">create_task()</a><ul>
<li><a href="#add_done_callback">add_done_callback() 回调</a></li>
</ul>
</li>
<li><a href="#gather">gather()</a></li>
<li><a href="#run">run()</a></li>
</ul>
</li>
<li><a href="#_10">原理</a><ul>
<li><a href="#_11">错误处理</a></li>
<li><a href="#_12">生产者消费者模型</a></li>
</ul>
</li>
<li><a href="#example">example</a><ul>
<li><a href="#_13">效率对比</a></li>
</ul>
</li>
<li><a href="#vs-asyncio">多线程 vs Asyncio</a></li>
<li><a href="#_14">多进程</a></li>
</ul>
</div>
<h1 id="coroutine">coroutine 协程</h1>
<p>协程是实现并发编程的一种方式。</p>
<p>协程相对于多线程，其为单线程</p>
<p>是一种可以暂停的函数，可以在暂停的地方传入值</p>
<p>协程需要配合事件循环来使用的</p>
<h2 id="_1">优势</h2>
<p>协程解决了</p>
<ol>
<li>
<p>回调模式编写难的问题</p>
</li>
<li>
<p>同步编程的并发性不高</p>
</li>
<li>
<p>多线程编程需要线程间同步（Lock）的问题</p>
</li>
</ol>
<p>实现了</p>
<ol>
<li>采用同步的方式编写异步代码</li>
<li>使用单线程去切换任务</li>
</ol>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>         <span class="n">await</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  

<span class="o">&gt;&gt;&gt;</span>
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.16</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">2.87</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">5.04</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">10</span> <span class="n">s</span>
</pre></div>


<h2 id="c10m">C10M问题</h2>
<p>如何利用8核心CPU，64GB内存，在10Gbps的网络上保持1000万的并发连接</p>
<h2 id="_2">同步</h2>
<p>代码调用IO操作时，必须等待IO操作完成才能返回</p>
<h2 id="_3">异步</h2>
<p>代码调用IO操作时，不必等待IO操作完成返回</p>
<h2 id="_4">阻塞</h2>
<p>调用函数时，当前线程被挂起</p>
<h2 id="_5">非阻塞</h2>
<p>调用函数时，当前线程不会被挂起，而是立即返回</p>
<h2 id="async">async</h2>
<p>声明异步函数， 而调用异步函数，便可以得到一个协程对象coroutine object</p>
<h2 id="await">await</h2>
<p>可以通过await方法调用协程对象，await 执行的效果，和 Python 正常执行是一样的，也就是说程序会阻塞在这里，进入被调用的协程函数，执行完毕返回后再继续，而这也是 await 的字面意思</p>
<p>await是同步调用</p>
<h1 id="unixio">Unix下I/O 模型</h1>
<h2 id="io">阻塞式I/O （常用）</h2>
<p>通常我们使用的I/O都是阻塞式I/O，在编程时使用的大多数也是阻塞式I/O。在默认情况下，所有的套接字(socket)都是阻塞的。</p>
<p>浪费时间很严重</p>
<p><img alt="image-20200823121558035" src="coroutine.assets/image-20200823121558035.png" /></p>
<p><strong>优点</strong><br />
阻塞式I/O很容易上手，一般程序按照read-process的顺序进行处理就好。通常来说我们编写的第一个TCP的C/S程序就是阻塞式I/O模型的。并且该模型定位错误，在阻塞时整个进程将被挂起，基本不会占用CPU资源。</p>
<p><strong>缺点</strong><br />
该模型的缺点也十分明显。作为服务器，需要处理同时多个的套接字，使用该模型对具有多个的客户端并发的场景时就显得力不从心。<br />
当然也有补救方法，我们使用多线程技术来弥补这个缺陷。但是多线程在具有大量连接时，多线程技术带来的资源消耗也不容小看：</p>
<blockquote>
<p>如果我们现在有1000个连接时，就需要开启1000个线程来处理这些连接，于是就会出现下面的情况</p>
<ul>
<li>线程有内存开销，假设每个线程需要512K的存放栈，那么1000个连接就需要月512M的内存。当并发量高的时候，这样的内存开销是无法接受的。</li>
<li>线程切换有CPU开销，这个CPU开销体现在上下文切换上，如果线程数越多，那么大多数CPU时间都用于上下文切换，这样每个线程的时间槽会非常短，CPU真正处理数据的时间就会少了非常多。</li>
</ul>
</blockquote>
<h2 id="io_1">非阻塞式I/O</h2>
<p>有阻塞I/O，那么也会有非阻塞I/O，在上文说过默认情况下，所有的套接字都是阻塞的，那么通过设置套接字的NONBLOCK(一般在<code>open()</code>,<code>socket()</code>等调用中设置)标志或者设置<code>recv</code>、<code>send</code>等输入输出函数的<strong>MSG_DONTWAIT</strong>标志就可以实现非阻塞操作。</p>
<p><img alt="image-20200823121804401" src="coroutine.assets/image-20200823121804401.png" /></p>
<blockquote>
<p>可以看到，前三次<em>recvfrom</em>时没有数据可以返回，此时内核不阻塞进程，转而立即返回一个<strong>EWOULDBLOCK</strong>错误。</p>
<p>第四次调用<em>recvfrom</em>时已经有一个数据报准备好了，此时它将被复制到应用进程的缓冲区，于是<em>recvfrom</em>调用成功返回。<br />
当一个应用进程像这样对一个非阻塞描述符循环调用<em>recvfrom</em>时，我们称之为<strong>轮询(polling)</strong></p>
</blockquote>
<p><strong>优点</strong>：<br />
这种I/O方式也有明显的优势，即不会阻塞在内核的等待数据过程，每次发起的I/O请求可以立即返回，不用阻塞等待。在数据量收发不均，等待时间随机性极强的情况下比较常用。</p>
<p><strong>缺点</strong><br />
轮询这一个特征就已近暴露了这个I/O模型的缺点。轮询将会不断地询问内核，这将占用大量的CPU时间，系统资源利用率较低。同时，该模型也不便于使用，需要编写复杂的代码。</p>
<h2 id="io_2">I/O复用</h2>
<p>在出现大量的链接时，使用多线程+阻塞I/O的编程模型会占用大量的内存。那么I/O复用技术在内存占用方面，就有着很好的控制。<br />
当前的高性能反向代理服务器<strong>Nginx</strong>使用的就是I/O复用模型(epoll),它以高性能和低资源消耗著称，在大规模并发上也有着很好的表现。</p>
<p><img alt="image-20200823222847200" src="coroutine.assets/image-20200823222847200.png" /></p>
<p>那到底什么是I/O复用(I/O multiplexing)。根据我的理解，复用指的是复用线程，从阻塞式I/O来看，基本一个套接字就霸占了整个线程。例如当对一个套接字调用<em>recvfrom</em>调用时，整个线程将被阻塞挂起，直到数据报准备完毕。<br />
多路复用就是复用一个线程的I/O模型，Linux中拥有几个调用来实现I/O复用的系统调用——<code>select</code>,<code>poll</code>,<code>epoll</code>（Linux 2.6+）</p>
<p>线程将阻塞在上面的三个系统调用中的某一个之上，而不是阻塞在真正的I/O系统调用上。I/O复用允许对多个套接字进行监听，当有某个套接字准备就绪(可读/可写/异常)时，系统调用将会返回。<br />
然后我们可能将重新启用一个线程并调用<em>recvfrom</em>来将特定套接字中的数据报从内核缓冲区复制到进程缓冲区。</p>
<p><strong>优点</strong><br />
I/O复用技术的优势在于，只需要使用一个线程就可以管理多个socket，系统不需要建立新的进程或者线程，也不必维护这些线程和进程，所以它也是很大程度上减少了资源占用。<br />
另外I/O复用技术还可以同时监听不同协议的套接字</p>
<p><strong>缺点</strong><br />
在只处理连接数较小的场合，使用select的服务器不一定比多线程+阻塞I/O模型效率高，可能延迟更大，因为单个连接处理需要2次系统调用，占用时间会有增加。</p>
<h2 id="io_3">信号驱动式I/O （使用少）</h2>
<p>当然你可能会想到使用信号这一机制来避免I/O时线程陷入阻塞状态。那么内核开发者怎么可能会想不到。</p>
<p><img alt="image-20200823223039254" src="coroutine.assets/image-20200823223039254.png" /></p>
<blockquote>
<p>首先开启套接字的信号驱动式I/O功能，并通过<em>sigaction</em>系统调用来安装一个信号处理函数，我们进程不会被阻塞。<br />
当数据报准备好读取时，内核就为该进程产生一个<strong>SIGIO</strong>信号，此时我们可以在信号处理函数中调用<em>recvfrom</em>读取数据报，并通知数据已经准备好，正在等待处理。</p>
</blockquote>
<p><strong>优点</strong><br />
很明显，我们的线程并没有在等待数据时被阻塞，可以提高资源的利用率<br />
<strong>缺点</strong><br />
其实在Unix中，信号是一个被过度设计的机制(这句话来自知乎大神,有待考究)<br />
信号I/O在大量IO操作时可能会因为<strong>信号队列溢出</strong>导致没法通知——这个是一个非常严重的问题。</p>
<h2 id="io_4">异步I/O</h2>
<p>前面说过这4种I/O模型都可以划分为同步I/O方式，那我们来看看为什么。<br />
了解了４种I/O模型的调用过程后，我们可以注意到，在数据从内核缓冲区复制到用户缓冲区时，都需要进程显示调用<em>recvfrom</em>，并且这个复制过程是阻塞的。<br />
也就是说真正I/O过程(这里的I/O有点狭义，指的是内核缓冲区到用户缓冲区)是同步阻塞的，不同的是各个I/O模型在数据报准备好之前的动作不一样。</p>
<p>异步I/O，是由POSIX规范定义的。这个规范定义了一些函数，这些函数的工作机制是：告知内核启动某个操作，并让内核在整个操作完成后再通知我们。(包括将数据从内核复制到我们进程的缓冲区)</p>
<p>POSIX的aio_系列函数， aio函数比较复杂</p>
<p>目前高并发框架并不使用aio，而都是io多路复用技术，成熟并稳定</p>
<p>异步I/O在Linux2.6才引入，而且到现在仍然未成熟。<br />
虽然有知名的异步I/O库 <code>glibc</code>，但是听说<code>glibc</code>采用多线程模拟，但存在一些bug和设计上的不合理。</p>
<p><img alt="image-20200823223955308" src="coroutine.assets/image-20200823223955308.png" /></p>
<h2 id="io_5">IO多路复用（实际常用）</h2>
<p>IO多路复用就是通过一种机制，一个进程可以监视多个描述符（socket），一旦某个描述符就绪（一般是读就绪或者是写就绪），能够通知程序进行相应的读写操作。</p>
<p>但select，poll， epoll本质上都是同步I/O，都需要读写事件就绪之后自己负责读写，即这个自己读写的过程是阻塞的。</p>
<p>而异步I/O（aio系列函数）则无需自己负责进行读写，异步I/O的实现会负责把数据从内核copy到用户空间</p>
<h3 id="select">select</h3>
<p>select 函数监视的文件描述符为3类， writefsd， readfds，execptfds</p>
<p>调用后select函数会阻塞，直到有描述符就绪（即有数据读写，或者except）或者超时（timeout所指定的等待时间，如果立刻返回设置为null即可），函数返回。</p>
<p>select函数返回后，可以通过遍历所有的fdset找到就绪描述符</p>
<p>在并发不高，同时连接很活跃的情况下，select 比epoll要好</p>
<p>select目前几乎在所有平台上都支持</p>
<p>缺点是单个进程能够监视的文件描述符的数量存在最大限制，Linux一般是1024，可以通过修改宏定义甚至重新编译内核的方式提升限制，但是也会造成效率低下</p>
<h3 id="poll">poll</h3>
<p>不同于select使用三个位图来表示三个fdset的方式，poll使用一个pollfd的指针实现</p>
<p>pollfd结构包含了要监视的event和发生的event，不再适用select的参数-值的传递方式。</p>
<p>pollfd没有最大数量限制（但数量过大后性能也会下降）</p>
<p>和selec函数一样，poll返回后，需要轮询pollfd来获取就绪的socket，但事实上，同时连接的大量客户端再一个时刻只有很少的处于就绪状态，因此随着监视的socket数量增长，效率也会线性下降</p>
<h3 id="epoll-only-linux">epoll （only Linux)</h3>
<p>Linux 2.6 内核中提出，是之前select 和poll的增强版本。</p>
<p>epoll也没有最大socket的数量限制，epoll使用一个文件描述符，管理多个描述符，将用户关系的文件描述符的事件，存放到内核的一个事件表中，这样用户空间和内核空间的copy只需要一次即可</p>
<p>epoll的查询采用红黑树的方式提高效率</p>
<p>在高并发的情况下，连接活跃度不是很高（如网站访问），epoll比select 要好</p>
<h4 id="_6">回调模式（不常用）</h4>
<p>不停的请求socket的状态并调用对应的回调函数 (回调函数代码很难维护， 可读性差，异常处理困难)</p>
<p>select本身是不支持register 模式，socket 状态变化后的回调是由程序员完成的</p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">loop</span><span class="p">():</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">ready</span><span class="p">:</span>
            <span class="n">call_back</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">data</span>
            <span class="n">call_back</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>完成回调+事件循环+select(epoll), 只有一个线程，减少了线程切换的IO消耗，减少了内存的使用</p>
</blockquote>
<h1 id="asyncio-io">asyncio （异步IO并发）</h1>
<p>由于多线程的局限性， （多线程运行中容易被打断，即出现race condition情况， 再者，线程切换本身存在一定的损耗， 线程数不能无限增加，若I/O操作非常频繁，多线程很可能满足不了高效率，高质量需求）</p>
<p>异步IO并发编程的核心模块， 产生来解决这些问题</p>
<p>Asyncio也是单线程的，只有一个主线程，可以进行多个不同的任务(就是future对象)， 不同的任务被event loop对象控制</p>
<h2 id="_7">特点</h2>
<p>包含各种特定系统实现的模块化事件循环</p>
<p>对TCP， UDP， SSL， 子进程，延时调用以及其他的具体支持</p>
<p>模仿future 模块，但适用于时间循环使用的Future 类</p>
<p>基于yield from的协议和任务，可以用顺序的编码方式并发代码</p>
<p>必须使用一个将产生阻塞IO的调用时，有接口可以把这个时间转移到线程池</p>
<p>模仿threading模块中的同步语法，可以用在单线程内的协程之间</p>
<h2 id="_8">局限性</h2>
<p>常用的requests库不兼容asyncio ，只能使用aiohttp库</p>
<p>pymysql， mysql-client 并不支持asyncio，所以并发性并不高</p>
<p>使用asyncio在任务调度有更多主权，但是逻辑书写要注意，很容易出错</p>
<h2 id="_9">上下文切换</h2>
<p>操作系统及多线程/多进程中称为“上下文切换” (context switch)。其中“上下文”记录了某个线程执行的状态，包括线程里用到的各个变量，线程的调用栈等。而“切换”指的就是保存某个线程当前的运行状态，之后再从之前的状态中恢复。只不过线程相关的工作是由操作系统完成，而协程则是由应用程序自己来完成。</p>
<p>与线程不同的时，协程完成的功能通常较小，所以会有需求将不同的协程串起来，我们暂时称它为协程链 (coroutine chain)。</p>
<h2 id="hello-world">hello world</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>
<span class="n">import</span> <span class="n">time</span>


<span class="n">async</span> <span class="n">def</span> <span class="n">get_html</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;start get_html&quot;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;end get_html&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_html</span><span class="p">(</span><span class="s">&quot;https://www.xurick.com&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
    <span class="n">print</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">start</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="n">end</span> <span class="n">get_html</span>
<span class="mf">2.0054919719696045</span>
</pre></div>


<h2 id="event-loop">event loop</h2>
<p>若任务有两个状态，</p>
<p>预备状态：任务当前空闲，随时准备运行。</p>
<p>等待状态：任务已经运行，但正在等待外部的操作完成，如I/O操作</p>
<p>event loop会维护这两个任务列表，并且选取预备状态的一个任务，使其运行，一直到把这个任务控制权交还给event loop 为止。</p>
<p>当任务把控制权交还给event loop， event loop会根据其是否完成，放置在不同的状态列表中，然后遍历等待状态列表中的任务，查看其是否完成。</p>
<ul>
<li>完成就放到预备状态</li>
<li>未完成就继续放在等待状态</li>
</ul>
<p>这样，所有任务被重新放置在合适的列表后，开始新的循环，直到所有任务完成。</p>
<p>根据event loop的特点， 任务运行时不会被外部的一些因素打断，因此Asyncio内的操作不会出现race condition情况，也就不会出现线程安全的问题</p>
<h2 id="create_task">create_task()</h2>
<p>可以通过 asyncio.create_task() 来创建任务</p>
<p>asyncio.create_task(coro)表示对输入的协程 coro创建一个任务，安排其执行，并返回次任务对象</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="p">]</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="k">for</span> <span class="n">task</span> <span class="n">in</span> <span class="n">tasks</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>         <span class="n">await</span> <span class="n">task</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.52</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">1.77</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">4.29</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">4.01</span> <span class="n">s</span>
</pre></div>


<h3 id="add_done_callback">add_done_callback() 回调</h3>
<p>协程实现callback函数, 即绑定特定回调函数获得返回值</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="p">]</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="k">for</span> <span class="n">task</span> <span class="n">in</span> <span class="n">tasks</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>         <span class="n">task</span><span class="p">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">lambda</span> <span class="n">future</span><span class="o">:</span> <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">result</span><span class="o">:</span> <span class="err">&#39;</span><span class="p">,</span> <span class="n">future</span><span class="p">.</span><span class="n">result</span><span class="p">()))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.12</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">1.85</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">3.97</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">4</span> <span class="n">s</span>
</pre></div>


<h2 id="gather">gather()</h2>
<p>另一种task写法， 针对await的一系列操作，如果只是单个future，只用asyncio.wait() 即可</p>
<p>asyncio.gather(*coro, loop=None, return_exception=False) 表示在event loop中运行coro序列中的所有任务</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="p">]</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.56</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">2.5</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">5.05</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">4.01</span> <span class="n">s</span>
</pre></div>


<h2 id="run">run()</h2>
<p>asyncio.run 来触发运行, 是Asyncio的root call， 表示拿到event loop，直到结束才关闭这个event loop</p>
<p>asyncio.run 这个函数是 Python 3.7 之后才有的特性，可以让 Python 的协程接口变得非常简单，你不用去理会事件循环怎么定义和怎么使用的问题，一个非常好的编程规范是，asyncio.run(main()) 作为主程序的入口函数，在程序运行周期内，只调用一次 asyncio.run。</p>
<h1 id="_10">原理</h1>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_1</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_2</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">before</span> <span class="n">await</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">worker_1</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_1</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">worker_2</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_2</span><span class="err">&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">before</span> <span class="n">await</span>
<span class="n">worker_1</span> <span class="n">start</span>
<span class="n">worker_1</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_1</span>
<span class="n">worker_2</span> <span class="n">start</span>
<span class="n">worker_2</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_2</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">3</span> <span class="n">s</span>
</pre></div>


<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_1</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="err">#</span> <span class="mf">2.</span> <span class="err">从当前任务切出，调度</span><span class="n">worker2</span>  <span class="err">#</span> <span class="mf">3.</span> <span class="err">事件调度器这时候开始暂停调度，等待</span><span class="mi">1</span><span class="err">秒后，</span><span class="n">sleep</span><span class="err">完成，事件调度器控制器交给</span><span class="n">task1</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">4.</span> <span class="err">完成任务退出</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_2</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="err">#</span> <span class="mf">3.</span> <span class="err">从当前任务切出</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">6.</span> <span class="mi">2</span><span class="err">秒后事件调度器将控制器交给</span><span class="n">task2</span><span class="err">，</span> <span class="err">输出结果</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">task1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_1</span><span class="p">())</span> 
    <span class="n">task2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_2</span><span class="p">())</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">before</span> <span class="n">await</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">task1</span>     <span class="err">#</span> <span class="mf">1.</span> <span class="err">从</span><span class="n">main</span><span class="err">任务中切出，调度</span><span class="n">worker1</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_1</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">5.</span> <span class="err">完成</span><span class="n">task1</span><span class="err">，</span> <span class="err">控制器交给主任务，</span> <span class="err">输出结果</span>
    <span class="n">await</span> <span class="n">task2</span> 
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_2</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">7.</span> <span class="err">输出结果，协程结束</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>   

<span class="o">&gt;&gt;&gt;</span>

<span class="n">before</span> <span class="n">await</span>
<span class="n">worker_1</span> <span class="n">start</span>
<span class="n">worker_2</span> <span class="n">start</span>
<span class="n">worker_1</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_1</span>
<span class="n">worker_2</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_2</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">2.01</span> <span class="n">s</span>
</pre></div>


<h2 id="_11">错误处理</h2>
<p>worker3执行过长会被cancel掉</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_1</span><span class="p">()</span><span class="o">:</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_2</span><span class="p">()</span><span class="o">:</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">0</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_3</span><span class="p">()</span><span class="o">:</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">3</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">task_1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_1</span><span class="p">())</span>
    <span class="n">task_2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_2</span><span class="p">())</span>
    <span class="n">task_3</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_3</span><span class="p">())</span>

    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">task_3</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="n">task_1</span><span class="p">,</span> <span class="n">task_2</span><span class="p">,</span> <span class="n">task_3</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>

<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ZeroDivisionError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">division</span> <span class="n">by</span> <span class="n">zero</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">CancelledError</span><span class="p">()]</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">2</span> <span class="n">s</span>
</pre></div>


<h2 id="_12">生产者消费者模型</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>
<span class="n">import</span> <span class="n">random</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
    <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">await</span> <span class="n">queue</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="n">consumer_1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">consumer_1</span><span class="err">&#39;</span><span class="p">))</span>
    <span class="n">consumer_2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">consumer_2</span><span class="err">&#39;</span><span class="p">))</span>

    <span class="n">producer_1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">producer_1</span><span class="err">&#39;</span><span class="p">))</span>
    <span class="n">producer_2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">producer_2</span><span class="err">&#39;</span><span class="p">))</span>

    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">consumer_1</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="n">consumer_2</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="n">consumer_1</span><span class="p">,</span> <span class="n">consumer_2</span><span class="p">,</span> <span class="n">producer_1</span><span class="p">,</span> <span class="n">producer_2</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>

<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">6</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">10</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">6</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">10</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">4</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">4</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">8</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">8</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">10</span> <span class="n">s</span>
</pre></div>


<h1 id="example">example</h1>
<h2 id="_13">效率对比</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>
<span class="n">import</span> <span class="n">requests</span>
<span class="n">from</span> <span class="n">bs4</span> <span class="n">import</span> <span class="n">BeautifulSoup</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://movie.douban.com/cinema/later/beijing&quot;</span>
    <span class="n">init_page</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">content</span>
    <span class="n">init_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">init_page</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">all_movies</span> <span class="o">=</span> <span class="n">init_soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">id</span><span class="o">=</span><span class="err">&#39;</span><span class="n">showing</span><span class="o">-</span><span class="n">soon</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">each_movie</span> <span class="n">in</span> <span class="n">all_movies</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;item&quot;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">all_a_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">all_li_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">li</span><span class="err">&#39;</span><span class="p">)</span>

        <span class="n">movie_name</span> <span class="o">=</span> <span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">text</span>
        <span class="n">url_to_fetch</span> <span class="o">=</span> <span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="err">&#39;</span><span class="n">href</span><span class="err">&#39;</span><span class="p">]</span>
        <span class="n">movie_date</span> <span class="o">=</span> <span class="n">all_li_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>

        <span class="n">response_item</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_to_fetch</span><span class="p">).</span><span class="n">content</span>
        <span class="n">soup_item</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response_item</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">img_tag</span> <span class="o">=</span> <span class="n">soup_item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">img</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="p">{}</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">movie_name</span><span class="p">,</span> <span class="n">movie_date</span><span class="p">,</span> <span class="n">img_tag</span><span class="p">[</span><span class="err">&#39;</span><span class="n">src</span><span class="err">&#39;</span><span class="p">]))</span>

<span class="o">%</span><span class="n">time</span> <span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">1.3</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">46.2</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">1.35</span> <span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">19.8</span> <span class="n">s</span>
</pre></div>


<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">aiohttp</span>
<span class="n">import</span> <span class="n">time</span>
<span class="n">from</span> <span class="n">bs4</span> <span class="n">import</span> <span class="n">BeautifulSoup</span>

<span class="n">def</span> <span class="n">cost_time</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Time</span> <span class="n">costs</span><span class="o">:</span> <span class="p">{}</span><span class="n">s</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="n">async</span> <span class="n">def</span> <span class="n">fetch_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">header</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;User-Agent&quot;</span><span class="o">:</span> <span class="s">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Safari/537.36&quot;</span><span class="p">}</span>
    <span class="n">async</span> <span class="n">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">(</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>  <span class="n">connector</span><span class="o">=</span><span class="n">aiohttp</span><span class="p">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">ssl</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">as</span> <span class="n">session</span><span class="o">:</span>
        <span class="n">async</span> <span class="n">with</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="n">as</span> <span class="n">response</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">await</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">()</span>

<span class="err">@</span><span class="n">cost_time</span>
<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://movie.douban.com/cinema/later/beijing&quot;</span>
    <span class="n">init_page</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">init_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">init_page</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">movie_names</span><span class="p">,</span> <span class="n">urls_to_fetch</span><span class="p">,</span> <span class="n">movie_dates</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">all_movies</span> <span class="o">=</span> <span class="n">init_soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">id</span><span class="o">=</span><span class="err">&#39;</span><span class="n">showing</span><span class="o">-</span><span class="n">soon</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">each_movie</span> <span class="n">in</span> <span class="n">all_movies</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;item&quot;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">all_a_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">all_li_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">li</span><span class="err">&#39;</span><span class="p">)</span>

        <span class="n">movie_names</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">text</span><span class="p">)</span>
        <span class="n">urls_to_fetch</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="err">&#39;</span><span class="n">href</span><span class="err">&#39;</span><span class="p">])</span>
        <span class="n">movie_dates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_li_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span><span class="p">)</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">fetch_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls_to_fetch</span><span class="p">]</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">movie_name</span><span class="p">,</span> <span class="n">movie_date</span><span class="p">,</span> <span class="n">page</span> <span class="n">in</span> <span class="n">zip</span><span class="p">(</span><span class="n">movie_names</span><span class="p">,</span> <span class="n">movie_dates</span><span class="p">,</span> <span class="n">pages</span><span class="p">)</span><span class="o">:</span>
        <span class="n">soup_item</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">img_tag</span> <span class="o">=</span> <span class="n">soup_item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">img</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="p">{}</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">movie_name</span><span class="p">,</span> <span class="n">movie_date</span><span class="p">,</span> <span class="n">img_tag</span><span class="p">[</span><span class="err">&#39;</span><span class="n">src</span><span class="err">&#39;</span><span class="p">]))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Time</span> <span class="n">costs</span><span class="o">:</span> <span class="mf">1.5269999948941404e-06</span><span class="n">s</span>
</pre></div>


<h1 id="vs-asyncio">多线程 vs Asyncio</h1>
<div class="hlcode"><pre><span class="k">if</span> <span class="n">io_bound</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">io_slow</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Use</span> <span class="n">Asyncio</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="nl">else:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Use</span> <span class="n">multi</span><span class="o">-</span><span class="n">threading</span><span class="err">&#39;</span><span class="p">)</span>
<span class="k">else</span> <span class="k">if</span> <span class="n">cpu_bound</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Use</span> <span class="n">multi</span><span class="o">-</span><span class="n">processing</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>如果是 I/O bound，并且 I/O 操作很慢，需要很多任务 / 线程协同实现，那么使用 Asyncio 更合适。</p>
<p>如果是 I/O bound，但是 I/O 操作很快，只需要有限数量的任务 / 线程，那么使用多线程就可以了。</p>
<p>如果是 CPU bound，则需要使用多进程来提高程序运行效率。</p>
<h1 id="_14">多进程</h1>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">time</span>
<span class="n">def</span> <span class="n">cpu_bound</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">number</span><span class="p">)))</span>

<span class="n">def</span> <span class="n">calculate_sums</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">number</span> <span class="n">in</span> <span class="n">numbers</span><span class="o">:</span>
        <span class="n">cpu_bound</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>  
    <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000000</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
    <span class="n">calculate_sums</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Calculation</span> <span class="n">takes</span> <span class="p">{}</span> <span class="n">seconds</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Calculation</span> <span class="n">takes</span> <span class="mf">17.826206894</span> <span class="n">seconds</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>