<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>rds - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Aws">Aws</a>&nbsp;&#187;&nbsp;rds
    <span class="updated">Page Updated&nbsp;
      2019-06-20 17:43
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">rds</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#relational-database-service">Relational Database Service</a><ul>
<li><a href="#sql-vs-nosql">SQL vs NoSQL</a></li>
<li><a href="#db-instances">DB Instances</a></li>
<li><a href="#rds-security">RDS Security</a></li>
</ul>
</li>
<li><a href="#aurora">Aurora</a><ul>
<li><a href="#multi-master">Multi-master</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="relational-database-service">Relational Database Service</h1>
<p>关系型数据库，mysql/postgres为主，可管理，性能可预测（花钱买），无缝集成ec2（低延迟连接）</p>
<p>5 Read Replicas for MySQL and Postgres SQL</p>
<p>异步复制数据</p>
<h2 id="sql-vs-nosql">SQL vs NoSQL</h2>
<p><img alt="image-20200327144332107" src="rds.assets/image-20200327144332107.png" /></p>
<p><img alt="image-20200327144348257" src="rds.assets/image-20200327144348257.png" /></p>
<h2 id="db-instances">DB Instances</h2>
<p>Isolated database env</p>
<p>Can contain mulple user created databases</p>
<p>Backups works are enabled by default</p>
<p>Restore your database to a point in time</p>
<h2 id="rds-security">RDS Security</h2>
<p>Run DB instance in a VPC</p>
<p>Use IAM policies for accessing </p>
<p>Use Security groups</p>
<p>Use SSL connection</p>
<h1 id="aurora">Aurora</h1>
<p>一篇是 AWS Aurora 的论文 <a href="http://www.allthingsdistributed.com/files/p1041-verbitski.pdf">Amazon Aurora: Design Considerations for High Throughput Cloud –Native Relation Databases</a>。</p>
<p>Aurora 是 AWS 将 MySQL 的计算和存储分离后，计算节点 scale up，存储节点 scale out。并把其 redo log 独立设计成一个存储服务，把分布式的数据方面的东西全部甩给了底层存储系统。从而提高了整体的吞吐量和水平的扩展能力。</p>
<p>Aurora 要写 6 份拷贝，但是其只需要把一个 Quorum 中的日志写成功就可以了。如下所示。可以看到，将存储服务做成一个跨数据中心的服务，提高数据库容灾，降低性能影响。</p>
<p><img alt="img" src="rds.assets/70eac246964e3ef8ad5100944bf5bdeb.png" /></p>
<p>对于存储服务的设计，核心的原理就是 latency 一定要低，毕竟写 6 个 copy 是一件开销很大的事。所以，基本上来说，Aurora 用的是异步模型，然后拼命地做并行处理，其中用到的也是 Gossip 协议。如下所示。</p>
<p><img alt="img" src="rds.assets/7f89ba6764ede9fc4df223e541179381.png" /></p>
<p>在上面这个图中，我们可以看到，完成前两步，就可以 ACK 回调用方。也就是说，只要数据在本地落地了，就可以返回成功了。然后，对于六个副本，这个 log 会同时发送到 6 个存储结点，只需要有大于 4 个成功 ACK，就算写成功了。第 4 步我们可以看到用的是 Gossip 协议。然后，第 5 步产生 cache 页，便于查询。第 6 步在 S3 做 Snapshot，类似于 Checkpoint。</p>
<p>第二篇比较有代表的论文是 Google 的 <a href="http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/spanner-osdi2012.pdf">Spanner: Google’s Globally-Distributed Database</a>。<br />
Spanner 是 Google 的全球分布式数据库 Globally-Distributed Database) 。Spanner 的扩展性达到了令人咋舌的全球级，可以扩展到数百万台机器，数以百计的数据中心，上万亿的行。更给力的是，除了夸张的扩展性之外，它还能同时通过同步复制和多版本来满足外部一致性，可用性也是很好的。</p>
<p>下面是 Spanserver 的一个架构。</p>
<p><img alt="img" src="rds.assets/116a697f8753877308661a69a9af0a8e.png" /></p>
<p>我们可以看到，每个数据中心都会有一套 Colossus，这是第二代的 GFS。每个机器有 100-1000 个 tablet，也就是相当数据库表中的行集，物理存储就是数据文件。比如，一张表有 2000 行，然后有 20 个 tablet，那么每个 tablet 分别有 100 行数据。</p>
<p>在 tablet 上层通过 Paxos 协议进行分布式跨数据中心的一致性数据同步。Paxos 会选出一个 replica 做 Leader，这个 Leader 的寿命默认是 10s，10s 后重选。Leader 就相当于复制数据的 master，其他 replica 的数据都是从它那里复制的。读请求可以走任意的 replica，但是写请求只有去 Leader。这些 replica 统称为一个 Paxos Group。</p>
<p>Group 之间也有数据交互传输，Google 定义了最小传输复制单元 directory，是一些有共同前缀的 key 记录，这些 key 也有相同的 replica 配置属性。</p>
<p><img alt="img" src="rds.assets/e85a1bf5efac06601fd6c5e9b75aa068.png" /></p>
<p>目前，基于 Spanner 论文的开源实现有两个，一个是 Google 公司自己的人出来做的<a href="https://github.com/cockroachdb/cockroach">CockroachDB</a>，另一个是国人做的<a href="https://github.com/pingcap/tidb">TiDB</a>。</p>
<p><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/46103.pdf">Spanner: Becoming a SQL System</a></p>
<p>可以预见到，过去的分库分表并通过一个数据访问的代理服务的玩法，应该在不久就会过时就会成为历史。真正的现代化的分布式数据存储就是 Aurora 和 Spanner 这样的方式。</p>
<h2 id="multi-master">Multi-master</h2>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>