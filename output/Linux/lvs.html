<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>lvs - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Linux">Linux</a>&nbsp;&#187;&nbsp;lvs
    <span class="updated">Page Updated&nbsp;
      2020-04-07 12:53
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">lvs</div>

  <p>[toc]</p>
<h1 id="lvs">lvs</h1>
<p>LVS  Linux Virtual Server  不能和iptables共存</p>
<p>本身也是工作在内核上工作在input链上，强行修改规则，转发到postrouting发出去</p>
<p>ipvsadm（用户空间） 管理集群服务的命令行工具</p>
<p>ipvs （内核空间）</p>
<h2 id="lvs-nat">LVS-NAT 地址转换</h2>
<p>集群节点跟director必须在同一个IP网络中</p>
<p>RIP通常是私有IP地址，仅用于各个集群节点间的通信</p>
<p>director位于client和real server之间，并负责处理进出的所有通信</p>
<p>real server必须将网关指向DIP</p>
<p>支持端口映射</p>
<p>real server 可以是任意操作系统</p>
<p>较大规模应用场景中，director易称为系统瓶颈  </p>
<h2 id="lvs-dr">LVS-DR 直接路由 （一般在生产环境中使用）</h2>
<p>director并不修改任何IP地址，而是通过修改mac地址进行转发。</p>
<p>director仅处理入站请求</p>
<p>各个集群节点必须和director在同一个物理网络中</p>
<p>RIP地址可以不用是私有地址，使用公网地址便于远程管理和监控</p>
<p>director仅负责处理入站请求，响应报文则由director直接发往客户端</p>
<p>real server 不能将网关指向DIP</p>
<p>不支持端口映射</p>
<h2 id="lvs-tun">LVS-TUN 隧道 （用的很少）</h2>
<p>集群节点可以跨越互联网Internet</p>
<p>real server的RIP必须是公网地址</p>
<p>director 仅负责处理入站请求，响应报文则由real server直接发往客户端</p>
<p>real server 网关不能指向director</p>
<p>只有支持隧道功能的OS才能用于real server</p>
<p>不支持端口映射</p>
<h1 id="_1">调度方法</h1>
<h2 id="_2">静态调度方法</h2>
<p>rr： Round Robin 轮询，轮调</p>
<p>wrr：Weight Round Robin 加权的</p>
<p>sh： Source Hash， 源地址hash。 根据源地址，绑定session (Session Affilinity)</p>
<p>dh：Destination Hash，以目标地址为标准挑选</p>
<h2 id="_3">动态调度方法</h2>
<p>lc： 最少连接</p>
<p>​     active * 256 + inactive</p>
<p>​     比较后，谁的小就挑选谁</p>
<p>wlc： 加权最少连接 （lvs 默认方式）</p>
<p>​     ( active * 256 + inactive ) / weight ,</p>
<p>​     取最小值</p>
<p>sed： 最短期望延迟</p>
<p>​     不再计算非活动连接</p>
<p>​     ((active+1) * 256)  / weigth</p>
<p>​     取最小值</p>
<p>nq:  Never Queue </p>
<p>​     </p>
<p>LBLC： Locality-Based Least-Connection 基于本地的最少连接</p>
<p>​     类似DH</p>
<p>​     </p>
<p>LBLCR:  Replication 基于本地的，带复制功能的最少连接</p>
<h1 id="example">example</h1>
<h2 id="health_checksh">health_check.sh</h2>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="hlcode"><pre>#!/usr/bin/env bash#declare -a RSSTATUS
VIP=192.168.10.3
CPORT=80FAIL_BACK=127.0.0.1
RS=(&quot;192.168.10.7&quot; &quot;192.168.10.8&quot;)
RW=(&quot;2&quot; &quot;1&quot;)
RPORT=80TYPE=g
CHKLOOP=3LOG=/var/log/ipvsmonitor.log

addrs() {
    ipvsadm -a -t <span class="nv">$VIP</span>:<span class="nv">$CPORT</span> -r $1:<span class="nv">$RPORT</span> -<span class="nv">$TYPE</span> -w $2
    [ $? -eq 0 ] <span class="err">&amp;&amp;</span> return 0 || return 1}

delrs() {
    ipvsadm -d -t <span class="nv">$VIP</span>:<span class="nv">$CPORT</span> -r $1:<span class="nv">$RPORT</span>
    [ $? -eq 0 ] <span class="err">&amp;&amp;</span> return 0 || return 1}

checkrs() {
    local I=1    while [ <span class="nv">$I</span> -le <span class="nv">$CHKLOOP</span> ]; do        if curl --connect-timeout 1 http://$1 <span class="err">&amp;</span>&gt; /dev/null; then            return 0        fi        let I++
    done    return 1}

initstatus() {
    local I
    local COUNT=0;
    for I in <span class="cp">${</span><span class="n">RS</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="cp">}</span>; do        if checkrs <span class="nv">$I</span>; then            RSSTATUS[<span class="nv">$COUNT</span>]=1        else            RSSTATUS[<span class="nv">$COUNT</span>]=0        fi    let COUNT++
    done}

initstatus
while :; do    let COUNT=0    for I in <span class="cp">${</span><span class="n">RS</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="cp">}</span>; do        if checkrs <span class="nv">$I</span>; then            if [ <span class="cp">${</span><span class="n">RSSTATUS</span><span class="p">[</span><span class="err">$</span><span class="n">COUNT</span><span class="p">]</span><span class="cp">}</span> -eq 0 ]; then                addrs <span class="nv">$I</span> <span class="cp">${</span><span class="n">RW</span><span class="p">[</span><span class="err">$</span><span class="n">COUNT</span><span class="p">]</span><span class="cp">}</span>
                [ $? -eq 0 ] <span class="err">&amp;&amp;</span> RSSTATUS[<span class="nv">$COUNT</span>]=1 <span class="err">&amp;&amp;</span> echo &quot;`date + &#39;%F %H:%M:%S&#39;`, <span class="nv">$I</span> is back.&quot; &gt;&gt; <span class="nv">$LOG</span>            fi        else            if [ <span class="cp">${</span><span class="n">RSSTATUS</span><span class="p">[</span><span class="err">$</span><span class="n">COUNT</span><span class="p">]</span><span class="cp">}</span> -eq 1 ]; then                delrs <span class="nv">$I</span>
                [ $? -eq 0 ] <span class="err">&amp;&amp;</span> RSSTATUS[<span class="nv">$COUNT</span>]=0 <span class="err">&amp;&amp;</span> echo &quot;`date + &#39;%F %H:%M:%S&#39;`, <span class="nv">$I</span> is gone.&quot; &gt;&gt; <span class="nv">$LOG</span>            fi        fi        let COUNT++
    done    sleep 5done
</pre></div>
</td></tr></table>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-12-12 14:54:32</p>
      </span>
    </div>

    
    
  </body>
</html>