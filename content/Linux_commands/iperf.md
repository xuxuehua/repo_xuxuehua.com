---
title: "iperf"
date: 2021-02-24 09:29
---
[toc]





# iperf

一个网络性能测试工具



## 特点

iperf可以测试TCP和UDP带宽质量

iperf可以测量最大TCP带宽，具有多种参数和UDP特性

iperf可以报告带宽，延迟抖动和数据包丢失

利用iperf这一特性，可以用来测试一些网络设备如路由器，防火墙，交换机等的性能。





## 原理解析

　　iperf工具可以用来测量TCP或者是UDP的网络吞吐量，即bandwidth（带宽）测试。

　　iPerf的主要目标是帮助调整特定路径上的TCP连接。 众所周知，TCP最基本的调整问题是调整TCP窗口大小，它控制在任何一点在网络中可以有多少数据。如果它太小，发送者将会在一段时间内处于空闲状态，从而影响发送TCP的性能。**TCP窗口大小的理论值是：瓶颈带宽与往返延时的乘积**，即：

> bottleneck bandwidth * round trip time

　　例如瓶颈链路是45 Mbit/sec，使用ping命令测量到的往返时延是42ms。那么TCP窗口的理论值是

> 45 Mbit/sec *42 ms = (45e6)* (42e-3) = 1890000 bits= 230 KByte

在实际测试中，可以以计算得到的TCP窗口为基准，在这个值（如上面为230KByte）的基础上，升高或者降低TCP窗口大小，可以得到一个性能的提升。

　　 带宽测试一般来说采用UDP模式测试，因为在UDP模式下能测出极限带宽、路径时延、丢包率，这些测试项会在带宽测试报告中打印出来。在进行测试时，先以链路理论带宽作为数据发送速率进行测试，例如，从客户端到服务器之间的链路的理论带宽为1000Mbps，先用 **-b 1000M**进行测试，然后根据测试结果（包括实际带宽，时延抖动和丢包率），再以实际带宽作为数据发送速率进行测试，会发现时延抖动和丢包率比第一次好很多，重复测试几次，就能得出稳定的实际带宽。

　　iperf是基于server-client模式工作的，因此，要使用iperf测试带宽，需要建立一个服务端（用于丢弃流量）和一个客户端（用于产生流量）。iperf服务端或者是客户端，都是使用的同一个命令，不过是启动命令的选项不同而已。

### 



# 参数选项

| **命令行选项**                                               | **描述**                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 客户端与服务器共用选项                                       |                                                              |
| -f, --format [bkmaBKMA]                                      | 格式化带宽数输出。支持的格式有：'b' = bits/sec 'B' = Bytes/sec'k' = Kbits/sec 'K' = KBytes/sec'm' = Mbits/sec 'M' = MBytes/sec'g' = Gbits/sec 'G' = GBytes/sec'a' = adaptive bits/sec 'A' = adaptive Bytes/sec自适应格式是kilo-和mega-二者之一。除了带宽之外的字段都输出为字节，除非指定输出的格式，默认的参数是a。注意：在计算字节byte时，Kilo = 1024， Mega = 1024^2，Giga = 1024^3。通常，在网络中，Kilo = 1000， Mega = 1000^2， and Giga = 1000^3，所以，Iperf也按此来计算比特（位）。如果这些困扰了你，那么请使用-f b参数，然后亲自计算一下。 |
| -i, --interval #                                             | 设置每次报告之间的时间间隔，单位为秒。如果设置为非零值，就会按照此时间间隔输出测试报告。默认值为零。 |
| -l, --len #[KM]                                              | 设置读写缓冲区的长度。TCP方式默认为8KB，UDP方式默认为1470字节。 |
| -m, --print_mss                                              | 输出TCP MSS值（通过TCP_MAXSEG支持）。MSS值一般比MTU值小40字节。通常情况 |
| -p, --port #                                                 | 设置端口，与服务器端的监听端口一致。默认是5001端口，与ttcp的一样。 |
| -u, --udp                                                    | 使用UDP方式而不是TCP方式。参看-b选项。                       |
| -w, --window #[KM]                                           | 设置套接字缓冲区为指定大小。对于TCP方式，此设置为TCP窗口大小。对于UDP方式，此设置为接受UDP数据包的缓冲区大小，限制可以接受数据包的最大值。 |
| -B, --bind host                                              | 绑定到主机的多个地址中的一个。对于客户端来说，这个参数设置了出栈接口。对于服务器端来说，这个参数设置入栈接口。这个参数只用于具有多网络接口的主机。在Iperf的UDP模式下，此参数用于绑定和加入一个多播组。使用范围在224.0.0.0至239.255.255.255的多播地址。参考-T参数。 |
| -C, --compatibility                                          | 与低版本的Iperf使用时，可以使用兼容模式。不需要两端同时使用兼容模式，但是强烈推荐两端同时使用兼容模式。某些情况下，使用某些数据流可以引起1.7版本的服务器端崩溃或引起非预期的连接尝试。 |
| -M, --mss #ip头减去40字节。在以太网中，MSS值 为1460字节（MTU1500字节）。许多操作系统不支持此选项。 |                                                              |
| -N, --nodelay                                                | 设置TCP无延迟选项，禁用Nagle's运算法则。通常情况此选项对于交互程序，例如telnet，是禁用的。 |
| -V (from v1.6 or higher)                                     | 绑定一个IPv6地址。服务端：$ iperf -s –V客户端：$ iperf -c -V 注意：在1.6.3或更高版本中，指定IPv6地址不需要使用-B参数绑定，在1.6之前的版本则需要。在大多数操作系统中，将响应IPv4客户端映射的IPv4地址。 |
| 服务器端专用选项                                             |                                                              |
| -s, --server                                                 | Iperf服务器模式                                              |
| -D (v1.2或更高版本)                                          | Unix平台下Iperf作为后台守护进程运行。在Win32平台下，Iperf将作为服务运行。 |
| -R(v1.2或更高版本，仅用于Windows)                            | 卸载Iperf服务（如果它在运行）。                              |
| -o(v1.2或更高版本，仅用于Windows)                            | 重定向输出到指定文件                                         |
| -c, --client host                                            | 如果Iperf运行在服务器模式，并且用-c参数指定一个主机，那么Iperf将只接受指定主机的连接。此参数不能工作于UDP模式。 |
| -P, --parallel #                                             | 服务器关闭之前保持的连接数。默认是0，这意味着永远接受连接。  |
| 客户端专用选项                                               |                                                              |
| -b, --bandwidth #[KM]                                        | UDP模式使用的带宽，单位bits/sec。此选项与-u选项相关。默认值是1 Mbit/sec。 |
| -c, --client host                                            | 运行Iperf的客户端模式，连接到指定的Iperf服务器端。           |
| -d, --dualtest                                               | 运行双测试模式。这将使服务器端反向连接到客户端，使用-L 参数中指定的端口（或默认使用客户端连接到服务器端的端口）。这些在操作的同时就立即完成了。如果你想要一个交互的测试，请尝试-r参数。 |
| -n, --num #[KM]                                              | 传送的缓冲器数量。通常情况，Iperf按照10秒钟发送数据。-n参数跨越此限制，按照指定次数发送指定长度的数据，而不论该操作耗费多少时间。参考-l与-t选项。 |
| -r, --tradeoff                                               | 往复测试模式。当客户端到服务器端的测试结束时，服务器端通过-l选项指定的端口（或默认为客户端连接到服务器端的端口），反向连接至客户端。当客户端连接终止时，反向连接随即开始。如果需要同时进行双向测试，请尝试-d参数。 |
| -t, --time #                                                 | 设置传输的总时间。Iperf在指定的时间内，重复的发送指定长度的数据包。默认是10秒钟。参考-l与-n选项。 |
| -L, --listenport #                                           | 指定服务端反向连接到客户端时使用的端口。默认使用客户端连接至服务端的端口。 |
| -P, --parallel #                                             | 线程数。指定客户端与服务端之间使用的线程数。默认是1线程。需要客户端与服务器端同时使用此参数。 |
| -S, --tos #                                                  | 出栈数据包的服务类型。许多路由器忽略TOS字段。你可以指定这个值，使用以"0x"开始的16进制数，或以"0"开始的8进制数或10进制数。例如，16进制'0x10' = 8进制'020' = 十进制'16'。TOS值1349就是：IPTOS_LOWDELAY minimize delay 0x10IPTOS_THROUGHPUT maximize throughput 0x08IPTOS_RELIABILITY maximize reliability 0x04IPTOS_LOWCOST minimize cost 0x02 |
| -T, --ttl #                                                  | 出栈多播数据包的TTL值。这本质上就是数据通过路由器的跳数。默认是1，链接本地。 |
| -F (from v1.2 or higher)                                     | 使用特定的数据流测量带宽，例如指定的文件。$ iperf -c -F      |
| -I (from v1.2 or higher)                                     | 与-F一样，由标准输入输出文件输入数据。                       |
| 杂项                                                         |                                                              |
| -h, --help                                                   | 显示命令行参考并退出 。                                      |
| -v, --version                                                | 显示版本信息和编译信息并退出。                               |









# example

带宽测试通常采用UDP模式，因为能测出极限带宽、时延抖动、丢包率。在进行测试时，首先以链路理论带宽作为数据发送速率进行测试，例如，从客户端到服务器之间的链路的理论带宽为100Mbps，先用-b 100M进行测试，然后根据测试结果（包括实际带宽，时延抖动和丢包率），再以实际带宽作为数据发送速率进行测试，会发现时延抖动和丢包率比第一次好很多，重复测试几次，就能得出稳定的实际带宽。

## **UDP模式**

服务器端：

```
iperf -u -s
```

客户端：

```
iperf -u -c 192.168.1.1 -b 100M -t 60
```

在udp模式下，以100Mbps为数据发送速率，客户端到服务器192.168.1.1上传带宽测试，测试时间为60秒。

```
iperf -u -c 192.168.1.1 -b 5M -P 30 -t 60
```

客户端同时向服务器端发起30个连接线程，以5Mbps为数据发送速率。

```
iperf -u -c 192.168.1.1 -b 100M -d -t 60
```

以100M为数据发送速率，进行上下行带宽测试。

## TCP模式

服务器端：

```
iperf -s
```

客户端：

```
iperf -c 192.168.1.1 -t 60
```

在tcp模式下，客户端到服务器192.168.1.1上传带宽测试，测试时间为60秒。

```
iperf -c 192.168.1.1 -P 30 -t 60
```

客户端同时向服务器端发起30个连接线程。

```
iperf -c 192.168.1.1 -d -t 60
```

进行上下行带宽测试。